<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Comando de Voz PRO ‚Ä¢ Controle de Gastos PRO</title>

  <style>
    :root{
      --bg:#07101f;
      --grad1: rgba(86,156,255,.22);
      --grad2: rgba(57,217,138,.16);
      --grad3: rgba(255,93,93,.12);
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.72);
      --accent:#569cff;
      --good:#39d98a;
      --warn:#ffd166;
      --danger:#ff5d5d;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --glass: blur(14px);
    }

    .light{
      --panel: rgba(0,0,0,.04);
      --panel2: rgba(0,0,0,.06);
      --stroke: rgba(0,0,0,.08);
      --text:#0d1222;
      --muted: rgba(13,18,34,.68);
      --shadow: 0 18px 60px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1000px 700px at 20% 10%, var(--grad1), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, var(--grad2), transparent 60%),
        radial-gradient(800px 600px at 70% 90%, var(--grad3), transparent 60%),
        var(--bg);
    }

    .wrap{
      max-width:980px;
      margin:auto;
      padding:16px;
      padding-bottom:120px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    h1{margin:0;font-size:24px}
    h2{margin:0;font-size:18px}
    h3{margin:0;font-size:14px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:850;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:color-mix(in srgb, var(--accent), transparent 55%);
    }
    .btn.good{
      background:var(--good);
      color:#062114;
      border-color:color-mix(in srgb, var(--good), transparent 55%);
    }
    .btn.warn{
      background:var(--warn);
      color:#2a1a00;
      border-color:color-mix(in srgb, var(--warn), transparent 55%);
    }
    .btn.danger{
      background:var(--danger);
      color:#2b0707;
      border-color:color-mix(in srgb, var(--danger), transparent 55%);
    }
    .btn:active{transform:translateY(1px)}

    .card{
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter:var(--glass);
      margin-bottom:14px;
    }

    .grid2{
      display:grid;
      grid-template-columns:1.25fr .95fr;
      gap:14px;
    }
    .grid22{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row > *{flex:1}

    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--warn);
      box-shadow:0 0 0 4px rgba(255,209,102,.12);
    }
    .dot.ok{
      background:var(--good);
      box-shadow:0 0 0 4px rgba(57,217,138,.12);
    }
    .dot.err{
      background:var(--danger);
      box-shadow:0 0 0 4px rgba(255,93,93,.12);
    }

    .bigMicWrap{
      display:flex;
      justify-content:center;
      margin:16px 0 18px;
    }

    .bigMic{
      width:146px;
      height:146px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:58px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      box-shadow:0 24px 60px rgba(0,0,0,.35);
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(135deg, rgba(86,156,255,.98), rgba(57,217,138,.55));
      color:#04152c;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .bigMic:active{transform:scale(.98)}
    .bigMic.listening{
      animation:pulse 1.2s infinite;
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(255,255,255,.28), transparent 60%),
        linear-gradient(135deg, rgba(255,93,93,.98), rgba(255,209,102,.65));
      color:#1d1200;
    }

    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(255,93,93,.38), 0 24px 60px rgba(0,0,0,.35);}
      70%{ box-shadow:0 0 0 18px rgba(255,93,93,0), 0 24px 60px rgba(0,0,0,.35);}
      100%{ box-shadow:0 0 0 0 rgba(255,93,93,0), 0 24px 60px rgba(0,0,0,.35);}
    }

    .center{text-align:center}
    .box{
      min-height:88px;
      white-space:pre-wrap;
      line-height:1.45;
      font-size:15px;
      padding:14px;
      border-radius:18px;
      border:1px dashed var(--stroke);
      background:rgba(255,255,255,.04);
    }
    .result{
      min-height:132px;
      white-space:pre-wrap;
      line-height:1.5;
      font-size:15px;
      padding:14px;
      border-radius:18px;
      border:1px dashed var(--stroke);
      background:rgba(255,255,255,.04);
    }

    .item{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      line-height:1.45;
    }

    .list{
      display:grid;
      gap:10px;
    }

    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;
      white-space:pre-wrap;
      line-height:1.45;
    }

    .ok{color:var(--good);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .err{color:var(--danger);font-weight:900}

    .chipRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }

    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
    }
    @media (max-width:700px){
      .grid22{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Comando de Voz PRO</h1>
        <div class="small">Fale o comando, revise o texto e toque em <b>Executar comando</b>.</div>
      </div>
      <div class="row" style="max-width:320px">
        <button class="btn" onclick="goBack()">‚Üê Voltar</button>
        <button class="btn" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
      </div>
    </div>

    <div class="card">
      <div class="heroTop">
        <div>
          <h2>Fale como √°udio de WhatsApp</h2>
          <div class="small" style="margin-top:6px">
            Exemplos:
            <br>‚Ä¢ adicionar gasto mercado 120 categoria alimenta√ß√£o
            <br>‚Ä¢ adicionar gasto fixo internet 99 categoria casa vence dia 11
            <br>‚Ä¢ adicionar investimento fixo reserva 3000 em 12 meses vence dia 10
            <br>‚Ä¢ marcar internet como pago
            <br>‚Ä¢ desmarcar internet como pago
            <br>‚Ä¢ remover gasto mercado
            <br>‚Ä¢ remover gasto fixo internet
            <br>‚Ä¢ remover investimento fixo reserva
            <br>‚Ä¢ adicionar categoria farm√°cia
            <br>‚Ä¢ mostrar resumo do m√™s
            <br>‚Ä¢ abrir notifica√ß√µes
          </div>
        </div>
        <div class="badge">
          <span class="dot" id="micDot"></span>
          <span id="micStatus">Parado</span>
        </div>
      </div>

      <div class="bigMicWrap">
        <button class="bigMic" id="bigMic" onclick="toggleRecording()" title="Gravar comando">üéôÔ∏è</button>
      </div>

      <div class="center small" id="hintText">Toque no microfone para come√ßar a ouvir.</div>

      <div style="margin-top:14px">
        <div class="small" style="margin-bottom:6px">Texto reconhecido</div>
        <div class="box" id="transcriptBox">Nenhum comando ainda.</div>
      </div>

      <div class="chipRow">
        <div class="chip" onclick="fillExample('adicionar gasto mercado 120 categoria alimenta√ß√£o')">Exemplo gasto</div>
        <div class="chip" onclick="fillExample('adicionar gasto fixo internet 99 categoria casa vence dia 11')">Exemplo fixo</div>
        <div class="chip" onclick="fillExample('adicionar investimento fixo reserva 3000 em 12 meses vence dia 10')">Exemplo investimento</div>
        <div class="chip" onclick="fillExample('mostrar resumo do m√™s')">Exemplo resumo</div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn" onclick="clearTranscript()">Limpar</button>
        <button class="btn warn" onclick="toggleRecording()">Ouvir novamente</button>
        <button class="btn good" onclick="executeVoiceCommand()">Executar comando</button>
      </div>
    </div>

    <div class="grid2">
      <div>
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">√öltimo resultado</div>
          <div id="resultBox" class="result">Nenhuma a√ß√£o executada ainda.</div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Diagn√≥stico</div>
          <div id="debugBox" class="mono">Aguardando...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Comandos aceitos</div>
          <div class="list small">
            <div class="item"><b>Adicionar gasto normal</b><br>Ex.: adicionar gasto mercado 120 categoria alimenta√ß√£o</div>
            <div class="item"><b>Adicionar gasto fixo</b><br>Ex.: adicionar gasto fixo internet 99 categoria casa vence dia 11</div>
            <div class="item"><b>Adicionar investimento fixo</b><br>Ex.: adicionar investimento fixo reserva 3000 em 12 meses vence dia 10</div>
            <div class="item"><b>Adicionar categoria</b><br>Ex.: adicionar categoria farm√°cia</div>
            <div class="item"><b>Marcar como pago</b><br>Ex.: marcar internet como pago</div>
            <div class="item"><b>Desmarcar como pago</b><br>Ex.: desmarcar internet como pago</div>
            <div class="item"><b>Remover gasto</b><br>Ex.: remover gasto mercado</div>
            <div class="item"><b>Remover gasto fixo</b><br>Ex.: remover gasto fixo internet</div>
            <div class="item"><b>Remover investimento fixo</b><br>Ex.: remover investimento fixo reserva</div>
            <div class="item"><b>Mostrar resumo do m√™s</b></div>
            <div class="item"><b>Abrir notifica√ß√µes</b></div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">A√ß√µes r√°pidas</div>
          <div class="grid22">
            <button class="btn" onclick="fillExample('mostrar resumo do m√™s')">Resumo do m√™s</button>
            <button class="btn" onclick="requestNotificationPermission()">Ativar notifica√ß√µes</button>
            <button class="btn" onclick="fillExample('abrir notifica√ß√µes')">Abrir notifica√ß√µes</button>
            <button class="btn" onclick="location.href='./index.html'">Abrir in√≠cio</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Investimentos","Outros"];

let auth = null;
let USER = null;
let USER_ID = null;

let recognition = null;
let listening = false;
let lastTranscript = "";

function dbg(msg){
  document.getElementById("debugBox").textContent = String(msg);
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeText(s){
  return String(s || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();
}

function titleCase(s){
  return String(s || "")
    .split(" ")
    .filter(Boolean)
    .map(p => p.charAt(0).toUpperCase() + p.slice(1))
    .join(" ");
}

function money(n){
  return Number(n || 0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function currentMonthKey(){
  return new Date().toISOString().slice(0,7);
}

function todayISO(){
  return new Date().toISOString().slice(0,10);
}

function kMes(){ return "gastos_pro_state_" + USER_ID; }
function kCat(){ return "categorias_" + USER_ID; }
function kFix(){ return "fixos_" + USER_ID; }
function kInv(){ return "inv_fixos_" + USER_ID; }

function loadState(){
  let state = { meses:{} };
  let categorias = [...DEFAULT_CATEGORIAS];
  let fixos = [];
  let investFixos = [];

  try{
    const raw = localStorage.getItem(kMes());
    if(raw) state = JSON.parse(raw) || { meses:{} };
  }catch(e){}

  try{
    const raw = localStorage.getItem(kCat());
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed) && parsed.length) categorias = parsed;
    }
  }catch(e){}

  try{
    const raw = localStorage.getItem(kFix());
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) fixos = parsed;
    }
  }catch(e){}

  try{
    const raw = localStorage.getItem(kInv());
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) investFixos = parsed;
    }
  }catch(e){}

  if(!categorias.some(c=>normalizeText(c)==="investimentos")){
    categorias.splice(categorias.length-1,0,"Investimentos");
  }

  if(!state.meses || typeof state.meses !== "object") state.meses = {};

  return { state, categorias, fixos, investFixos };
}

function saveState(all){
  localStorage.setItem(kMes(), JSON.stringify(all.state));
  localStorage.setItem(kCat(), JSON.stringify(all.categorias));
  localStorage.setItem(kFix(), JSON.stringify(all.fixos));
  localStorage.setItem(kInv(), JSON.stringify(all.investFixos));
}

function getMesData(all, monthKey){
  const m = monthKey || currentMonthKey();
  if(!all.state.meses[m]){
    all.state.meses[m] = {
      salary:0,
      meta:0,
      items:[],
      saved:[],
      hiddenFixos:[],
      investStatus:{}
    };
  }
  const d = all.state.meses[m];
  if(!Array.isArray(d.items)) d.items = [];
  if(!Array.isArray(d.saved)) d.saved = [];
  if(!Array.isArray(d.hiddenFixos)) d.hiddenFixos = [];
  if(!d.investStatus || typeof d.investStatus !== "object") d.investStatus = {};
  return d;
}

function setMicStatus(text, type){
  document.getElementById("micStatus").textContent = text;
  const dot = document.getElementById("micDot");
  dot.classList.remove("ok","err");
  if(type === "ok") dot.classList.add("ok");
  if(type === "err") dot.classList.add("err");
}

function setTranscript(text){
  lastTranscript = String(text || "").trim();
  document.getElementById("transcriptBox").textContent = lastTranscript || "Nenhum comando ainda.";
}

function fillExample(text){
  setTranscript(text);
  setResult(`Exemplo carregado:<br><b>${escapeHtml(text)}</b>`);
}

function setResult(html){
  document.getElementById("resultBox").innerHTML = html;
}

function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
}

function goBack(){
  location.href = "./index.html";
}

function clearTranscript(){
  setTranscript("");
  setResult("Nenhuma a√ß√£o executada ainda.");
}

function ensureSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    setMicStatus("Sem suporte", "err");
    dbg("SpeechRecognition n√£o suportado neste navegador.");
    return false;
  }

  recognition = new SR();
  recognition.lang = "pt-BR";
  recognition.interimResults = true;
  recognition.continuous = false;

  recognition.onstart = () => {
    listening = true;
    document.getElementById("bigMic").classList.add("listening");
    document.getElementById("hintText").textContent = "Ouvindo... fale seu comando.";
    setMicStatus("Ouvindo...", "ok");
  };

  recognition.onresult = (event) => {
    let finalText = "";
    let partialText = "";
    for(let i = event.resultIndex; i < event.results.length; i++){
      const txt = event.results[i][0].transcript || "";
      if(event.results[i].isFinal) finalText += txt + " ";
      else partialText += txt + " ";
    }
    const merged = (finalText || partialText).trim();
    if(merged) setTranscript(merged);
  };

  recognition.onerror = (event) => {
    listening = false;
    document.getElementById("bigMic").classList.remove("listening");
    document.getElementById("hintText").textContent = "Erro ao ouvir. Tente novamente.";
    setMicStatus("Erro", "err");
    dbg("Erro SpeechRecognition: " + (event.error || "desconhecido"));
  };

  recognition.onend = () => {
    listening = false;
    document.getElementById("bigMic").classList.remove("listening");
    document.getElementById("hintText").textContent = "Se o texto ficou certo, toque em Executar comando.";
    if(lastTranscript) setMicStatus("Pronto", "ok");
    else setMicStatus("Parado", "");
  };

  return true;
}

function toggleRecording(){
  if(!recognition && !ensureSpeech()) return;
  try{
    if(listening) recognition.stop();
    else recognition.start();
  }catch(e){
    dbg("Falha ao iniciar/parar grava√ß√£o: " + e.message);
  }
}

function parseCategory(text, categorias){
  const normalized = normalizeText(text);

  for(const c of categorias){
    const nc = normalizeText(c);
    if(normalized.includes("categoria " + nc)) return c;
  }

  if(normalized.includes("casa")) return "Casa";
  if(normalized.includes("alimentacao")) return "Alimenta√ß√£o";
  if(normalized.includes("transporte")) return "Transporte";
  if(normalized.includes("lazer")) return "Lazer";
  if(normalized.includes("pets")) return "Pets";
  if(normalized.includes("investimentos")) return "Investimentos";
  return "Outros";
}

function extractAmount(text){
  const t = normalizeText(text).replace(/,/g, ".");
  const matches = t.match(/\d+(\.\d+)?/g);
  if(!matches || !matches.length) return 0;
  return Number(matches[0] || 0);
}

function extractAllNumbers(text){
  const t = normalizeText(text).replace(/,/g, ".");
  const matches = t.match(/\d+(\.\d+)?/g);
  return (matches || []).map(Number).filter(n => !Number.isNaN(n));
}

function extractDueDay(text){
  const t = normalizeText(text);
  const m =
    t.match(/vence dia (\d{1,2})/) ||
    t.match(/vencimento dia (\d{1,2})/) ||
    t.match(/dia (\d{1,2}) e o prazo/) ||
    t.match(/dia (\d{1,2}) prazo/) ||
    t.match(/prazo dia (\d{1,2})/) ||
    t.match(/pagar dia (\d{1,2})/) ||
    t.match(/ate dia (\d{1,2})/);
  return m ? Number(m[1]) : 0;
}

function extractMonths(text){
  const t = normalizeText(text);
  const m = t.match(/em (\d{1,3}) meses?/) || t.match(/(\d{1,3}) meses?/);
  return m ? Number(m[1]) : 0;
}

function cleanDesc(raw){
  let t = normalizeText(raw);

  t = t
    .replace(/^adicionar\s+/, "")
    .replace(/^criar\s+/, "")
    .replace(/^anotar\s+/, "")
    .replace(/^colocar\s+/, "")
    .replace(/^novo\s+/, "")
    .replace(/^nova\s+/, "")
    .replace(/^uma\s+/, "")
    .replace(/^um\s+/, "")
    .replace(/^remover\s+/, "")
    .replace(/^apagar\s+/, "")
    .replace(/^deletar\s+/, "")
    .replace(/^excluir\s+/, "")
    .replace(/^marcar\s+/, "")
    .replace(/^desmarcar\s+/, "");

  t = t
    .replace(/\bgasto fixo\b/g, "")
    .replace(/\bgasto\b/g, "")
    .replace(/\binvestimento fixo\b/g, "")
    .replace(/\binvestimento\b/g, "")
    .replace(/\bcategoria\b/g, "")
    .replace(/\bfixo\b/g, "")
    .replace(/\bcomo pago\b/g, "")
    .replace(/\bpago\b/g, "")
    .replace(/\bpendente\b/g, "")
    .replace(/\bvencer\b/g, "")
    .replace(/\bvence\b/g, "")
    .replace(/\bdia \d{1,2}\b/g, "")
    .replace(/\bcategoria [a-zA-Z√Ä-√ø√ß√á]+\b/g, "")
    .replace(/\bem \d{1,3} meses?\b/g, "")
    .replace(/\d+(\.\d+)?/g, "")
    .replace(/\s+/g, " ")
    .trim();

  return titleCase(t);
}

function monthSummaryHtml(all){
  const d = getMesData(all, currentMonthKey());
  const salary = Number(d.salary || 0);
  const spent = (d.items || []).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved || []).reduce((a,b)=>a+Number(b.value||0),0);
  const left = salary - spent;

  const byCat = {};
  (d.items || []).forEach(it=>{
    const c = it.category || "Outros";
    byCat[c] = (byCat[c] || 0) + Number(it.amount || 0);
  });
  const topCats = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,3);

  return (
    `<span class="ok">Resumo do m√™s atual.</span><br><br>` +
    `‚Ä¢ Sal√°rio: <b>${money(salary)}</b><br>` +
    `‚Ä¢ Gastos: <b>${money(spent)}</b><br>` +
    `‚Ä¢ Guardado: <b>${money(saved)}</b><br>` +
    `‚Ä¢ Sobra: <b>${money(left)}</b><br><br>` +
    `${topCats.length ? `Top categorias:<br>${topCats.map(([c,v])=>`‚Ä¢ ${escapeHtml(c)}: <b>${money(v)}</b>`).join("<br>")}` : `Sem categorias registradas no m√™s.`}`
  );
}

function requestNotificationPermission(){
  if(!("Notification" in window)){
    setResult(`<span class="err">Seu navegador n√£o suporta notifica√ß√µes.</span>`);
    return;
  }
  Notification.requestPermission().then((perm)=>{
    if(perm === "granted"){
      setResult(`<span class="ok">Notifica√ß√µes ativadas com sucesso.</span>`);
    }else{
      setResult(`<span class="warn">Notifica√ß√µes n√£o foram permitidas.</span>`);
    }
  }).catch(()=>{
    setResult(`<span class="err">N√£o foi poss√≠vel ativar notifica√ß√µes.</span>`);
  });
}

function tryAddCategoria(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("adicionar categoria") || t.includes("criar categoria"))) return null;

  let nome = t
    .replace("adicionar categoria","")
    .replace("criar categoria","")
    .trim();

  if(!nome) return { ok:false, msg:"N√£o entendi o nome da categoria." };

  nome = titleCase(nome);

  if(all.categorias.some(c => normalizeText(c) === normalizeText(nome))){
    return { ok:false, msg:`A categoria "${escapeHtml(nome)}" j√° existe.` };
  }

  all.categorias.push(nome);
  saveState(all);
  return { ok:true, msg:`Categoria <b>${escapeHtml(nome)}</b> adicionada com sucesso.` };
}

function tryAddGastoFixo(cmd, all){
  const t = normalizeText(cmd);
  if(!t.includes("gasto fixo")) return null;

  const valor = extractAmount(t);
  const categoria = parseCategory(t, all.categorias);
  const diaPagar = extractDueDay(t);
  const desc = cleanDesc(t);

  if(!desc) return { ok:false, msg:"N√£o entendi a descri√ß√£o do gasto fixo." };
  if(!valor || valor <= 0) return { ok:false, msg:"N√£o entendi o valor do gasto fixo." };

  all.fixos.push({
    id: uid(),
    desc,
    amount: valor,
    category: categoria,
    diaPagar: diaPagar || 0,
    isFixo: true
  });

  saveState(all);

  return {
    ok:true,
    msg:
      `Gasto fixo adicionado:<br>` +
      `‚Ä¢ <b>${escapeHtml(desc)}</b><br>` +
      `‚Ä¢ Valor: <b>${money(valor)}</b><br>` +
      `‚Ä¢ Categoria: <b>${escapeHtml(categoria)}</b><br>` +
      `‚Ä¢ Vence: <b>${diaPagar ? ("dia " + diaPagar) : "sem prazo"}</b>`
  };
}

function tryAddInvestimentoFixo(cmd, all){
  const t = normalizeText(cmd);
  if(!t.includes("investimento fixo")) return null;

  const nums = extractAllNumbers(t);
  const metaFinal = nums[0] || 0;
  const prazoMeses = extractMonths(t) || nums[1] || 0;
  const diaPagar = extractDueDay(t);
  const nome = cleanDesc(t);

  if(!nome) return { ok:false, msg:"N√£o entendi o nome do investimento fixo." };
  if(!metaFinal || metaFinal <= 0) return { ok:false, msg:"N√£o entendi a meta final do investimento fixo." };
  if(!prazoMeses || prazoMeses <= 0) return { ok:false, msg:"N√£o entendi o prazo em meses." };

  const mensal = Math.round(((metaFinal / prazoMeses) || 0) * 100) / 100;
  const id = uid();

  all.investFixos.push({
    id,
    nome,
    metaFinal,
    prazoMeses,
    mensal,
    diaPagar: diaPagar || 0
  });

  const d = getMesData(all, currentMonthKey());
  d.investStatus[id] = false;

  saveState(all);

  return {
    ok:true,
    msg:
      `Investimento fixo adicionado:<br>` +
      `‚Ä¢ <b>${escapeHtml(nome)}</b><br>` +
      `‚Ä¢ Meta final: <b>${money(metaFinal)}</b><br>` +
      `‚Ä¢ Prazo: <b>${prazoMeses} meses</b><br>` +
      `‚Ä¢ Mensal autom√°tico: <b>${money(mensal)}</b><br>` +
      `‚Ä¢ Vence: <b>${diaPagar ? ("dia " + diaPagar) : "sem prazo"}</b>`
  };
}

function findCurrentMonthItemByName(all, name){
  const d = getMesData(all, currentMonthKey());
  const n = normalizeText(name);

  return d.items.find(it => {
    const itemName = normalizeText(it.desc);
    return itemName.includes(n) || n.includes(itemName);
  });
}

function tryMarkAsPaid(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("como pago") || t.includes("marcar") || t.includes("paguei"))) return null;
  if(t.includes("desmarcar")) return null;

  let nome = t
    .replace("marcar","")
    .replace("como pago","")
    .replace("paguei","")
    .replace("como paga","")
    .trim();

  if(!nome) return { ok:false, msg:"N√£o entendi qual item voc√™ quer marcar como pago." };

  const d = getMesData(all, currentMonthKey());
  const target = findCurrentMonthItemByName(all, nome);

  if(!target){
    return { ok:false, msg:`N√£o encontrei item do m√™s com o nome parecido com "<b>${escapeHtml(nome)}</b>".` };
  }

  target.paid = true;

  if(target.isInvestFixo && target.invId){
    d.investStatus[target.invId] = true;
    if(!Array.isArray(d.saved)) d.saved = [];
    const exists = d.saved.some(s => s && s.source==="investFixo" && s.invId===target.invId && s.month===currentMonthKey());
    if(!exists){
      d.saved.unshift({
        value:Number(target.amount||0),
        desc:`Autom√°tico: ${target.desc}`,
        date:todayISO(),
        source:"investFixo",
        invId:target.invId,
        month:currentMonthKey()
      });
    }
  }

  saveState(all);

  return {
    ok:true,
    msg:`Item <b>${escapeHtml(target.desc)}</b> marcado como <b>Pago</b>.`
  };
}

function tryUnmarkAsPaid(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("desmarcar") || t.includes("tirar pago") || t.includes("voltar pendente"))) return null;

  let nome = t
    .replace("desmarcar","")
    .replace("como pago","")
    .replace("tirar pago","")
    .replace("voltar pendente","")
    .replace("pago","")
    .trim();

  if(!nome) return { ok:false, msg:"N√£o entendi qual item voc√™ quer voltar para pendente." };

  const d = getMesData(all, currentMonthKey());
  const target = findCurrentMonthItemByName(all, nome);

  if(!target){
    return { ok:false, msg:`N√£o encontrei item do m√™s com nome parecido com "<b>${escapeHtml(nome)}</b>".` };
  }

  target.paid = false;

  if(target.isInvestFixo && target.invId){
    d.investStatus[target.invId] = false;
    d.saved = (d.saved || []).filter(s => !(s && s.source==="investFixo" && s.invId===target.invId && s.month===currentMonthKey()));
  }

  saveState(all);

  return {
    ok:true,
    msg:`Item <b>${escapeHtml(target.desc)}</b> voltou para <b>Pendente</b>.`
  };
}

function tryAddGastoNormal(cmd, all){
  const t = normalizeText(cmd);

  if(t.includes("gasto fixo") || t.includes("investimento fixo")) return null;
  if(!(t.includes("adicionar gasto") || t.includes("anotar gasto") || t.startsWith("gasto "))) return null;

  const valor = extractAmount(t);
  const categoria = parseCategory(t, all.categorias);
  const desc = cleanDesc(t);

  if(!desc) return { ok:false, msg:"N√£o entendi a descri√ß√£o do gasto." };
  if(!valor || valor <= 0) return { ok:false, msg:"N√£o entendi o valor do gasto." };

  const d = getMesData(all, currentMonthKey());
  d.items.push({
    id: uid(),
    desc,
    amount: valor,
    category: categoria,
    isFixo: false,
    isInvestFixo: false,
    paid: false
  });

  saveState(all);

  return {
    ok:true,
    msg:
      `Gasto adicionado:<br>` +
      `‚Ä¢ <b>${escapeHtml(desc)}</b><br>` +
      `‚Ä¢ Valor: <b>${money(valor)}</b><br>` +
      `‚Ä¢ Categoria: <b>${escapeHtml(categoria)}</b>`
  };
}

function tryRemoveGastoNormal(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("remover gasto") || t.includes("apagar gasto") || t.includes("deletar gasto") || t.includes("excluir gasto"))) return null;
  if(t.includes("gasto fixo")) return null;

  const nome = cleanDesc(t);
  if(!nome) return { ok:false, msg:"N√£o entendi qual gasto voc√™ quer remover." };

  const d = getMesData(all, currentMonthKey());
  const idx = d.items.findIndex(it => !it.isFixo && (normalizeText(it.desc).includes(normalizeText(nome)) || normalizeText(nome).includes(normalizeText(it.desc))));

  if(idx === -1){
    return { ok:false, msg:`N√£o encontrei gasto normal parecido com "<b>${escapeHtml(nome)}</b>" no m√™s atual.` };
  }

  const removed = d.items[idx];
  d.items.splice(idx,1);
  saveState(all);

  return { ok:true, msg:`Gasto <b>${escapeHtml(removed.desc)}</b> removido do m√™s atual.` };
}

function tryRemoveGastoFixo(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("remover gasto fixo") || t.includes("apagar gasto fixo") || t.includes("deletar gasto fixo") || t.includes("excluir gasto fixo"))) return null;

  const nome = cleanDesc(t);
  if(!nome) return { ok:false, msg:"N√£o entendi qual gasto fixo voc√™ quer remover." };

  const idx = all.fixos.findIndex(it => normalizeText(it.desc).includes(normalizeText(nome)) || normalizeText(nome).includes(normalizeText(it.desc)));
  if(idx === -1){
    return { ok:false, msg:`N√£o encontrei gasto fixo parecido com "<b>${escapeHtml(nome)}</b>".` };
  }

  const removed = all.fixos[idx];
  all.fixos.splice(idx,1);

  Object.keys(all.state.meses || {}).forEach(m=>{
    const d = all.state.meses[m];
    if(d && Array.isArray(d.items)){
      d.items = d.items.filter(it=> !(it.isFixo && !it.isInvestFixo && (it.id === removed.id || normalizeText(it.desc) === normalizeText(removed.desc))));
    }
  });

  saveState(all);
  return { ok:true, msg:`Gasto fixo <b>${escapeHtml(removed.desc)}</b> removido do sistema.` };
}

function tryRemoveInvestFixo(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("remover investimento fixo") || t.includes("apagar investimento fixo") || t.includes("deletar investimento fixo") || t.includes("excluir investimento fixo"))) return null;

  const nome = cleanDesc(t);
  if(!nome) return { ok:false, msg:"N√£o entendi qual investimento fixo voc√™ quer remover." };

  const idx = all.investFixos.findIndex(it => normalizeText(it.nome).includes(normalizeText(nome)) || normalizeText(nome).includes(normalizeText(it.nome)));
  if(idx === -1){
    return { ok:false, msg:`N√£o encontrei investimento fixo parecido com "<b>${escapeHtml(nome)}</b>".` };
  }

  const removed = all.investFixos[idx];
  all.investFixos.splice(idx,1);

  Object.keys(all.state.meses || {}).forEach(m=>{
    const d = all.state.meses[m];
    if(d){
      if(d.investStatus && removed.id) delete d.investStatus[removed.id];
      if(Array.isArray(d.saved)){
        d.saved = d.saved.filter(s => !(s && s.source==="investFixo" && s.invId===removed.id));
      }
      if(Array.isArray(d.items)){
        d.items = d.items.filter(it => !(it.isInvestFixo && (it.invId === removed.id || it.id === removed.id)));
      }
    }
  });

  saveState(all);
  return { ok:true, msg:`Investimento fixo <b>${escapeHtml(removed.nome)}</b> removido do sistema.` };
}

function tryShowSummary(cmd, all){
  const t = normalizeText(cmd);
  if(!(t.includes("mostrar resumo do mes") || t.includes("resumo do mes") || t.includes("mostrar meu resumo"))) return null;
  return { ok:true, msg: monthSummaryHtml(all) };
}

function tryOpenNotifications(cmd){
  const t = normalizeText(cmd);
  if(!(t.includes("abrir notificacoes") || t.includes("ativar notificacoes") || t.includes("notificacoes"))) return null;
  requestNotificationPermission();
  return { ok:true, msg:`Abrindo permiss√£o de <b>notifica√ß√µes</b>.` };
}

function executeVoiceCommand(){
  if(!USER_ID){
    setResult(`<span class="err">Fa√ßa login primeiro.</span>`);
    return;
  }

  const cmd = lastTranscript.trim();
  if(!cmd){
    setResult(`<span class="warn">Nenhum comando para executar.</span>`);
    return;
  }

  const all = loadState();
  let res = null;

  res = tryShowSummary(cmd, all);
  if(res === null) res = tryOpenNotifications(cmd);
  if(res === null) res = tryAddCategoria(cmd, all);
  if(res === null) res = tryAddGastoFixo(cmd, all);
  if(res === null) res = tryAddInvestimentoFixo(cmd, all);
  if(res === null) res = tryUnmarkAsPaid(cmd, all);
  if(res === null) res = tryMarkAsPaid(cmd, all);
  if(res === null) res = tryRemoveGastoFixo(cmd, all);
  if(res === null) res = tryRemoveInvestFixo(cmd, all);
  if(res === null) res = tryRemoveGastoNormal(cmd, all);
  if(res === null) res = tryAddGastoNormal(cmd, all);

  if(res === null){
    setResult(`<span class="err">N√£o consegui entender esse comando.</span><br><br>Tente falar de forma parecida com os exemplos da tela.`);
    dbg("Comando n√£o reconhecido: " + cmd);
    return;
  }

  if(res.ok){
    setResult(`<span class="ok">Comando executado.</span><br><br>${res.msg}`);
    dbg("OK: " + cmd);
  }else{
    setResult(`<span class="warn">N√£o foi poss√≠vel concluir.</span><br><br>${res.msg}`);
    dbg("Falha: " + cmd);
  }
}

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou.");
    return false;
  }

  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
  }catch(e){}

  auth = firebase.auth();

  auth.onAuthStateChanged((u)=>{
    USER = u || null;
    if(!USER){
      USER_ID = null;
      location.replace("./login.html");
      return;
    }

    USER_ID = USER.uid;

    const savedTheme = localStorage.getItem("theme");
    if(savedTheme === "light"){
      document.body.classList.add("light");
    }

    dbg("Usu√°rio autenticado: " + (USER.email || USER.uid));
  });

  return true;
}

document.addEventListener("DOMContentLoaded", async ()=>{
  const ok = await initFirebase();
  if(!ok) return;
  ensureSpeech();
});
</script>
</body>
</html>
