<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Comando de Voz IA ‚Ä¢ Controle de Gastos PRO</title>

  <style>
    :root{
      --bg:#07101f;
      --grad1: rgba(86,156,255,.22);
      --grad2: rgba(57,217,138,.16);
      --grad3: rgba(255,93,93,.12);
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.72);
      --accent:#569cff;
      --good:#39d98a;
      --warn:#ffd166;
      --danger:#ff5d5d;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --glass: blur(14px);
    }

    .light{
      --panel: rgba(0,0,0,.04);
      --panel2: rgba(0,0,0,.06);
      --stroke: rgba(0,0,0,.08);
      --text:#0d1222;
      --muted: rgba(13,18,34,.68);
      --shadow: 0 18px 60px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1000px 700px at 20% 10%, var(--grad1), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, var(--grad2), transparent 60%),
        radial-gradient(800px 600px at 70% 90%, var(--grad3), transparent 60%),
        var(--bg);
    }

    .wrap{
      max-width:1050px;
      margin:auto;
      padding:16px;
      padding-bottom:120px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    h1{margin:0;font-size:24px}
    h2{margin:0;font-size:18px}
    .small{font-size:12px;color:var(--muted)}

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:850;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:color-mix(in srgb, var(--accent), transparent 55%);
    }
    .btn.good{
      background:var(--good);
      color:#062114;
      border-color:color-mix(in srgb, var(--good), transparent 55%);
    }
    .btn.warn{
      background:var(--warn);
      color:#2a1a00;
      border-color:color-mix(in srgb, var(--warn), transparent 55%);
    }
    .btn.danger{
      background:var(--danger);
      color:#2b0707;
      border-color:color-mix(in srgb, var(--danger), transparent 55%);
    }
    .btn:active{transform:translateY(1px)}

    .card{
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter:var(--glass);
      margin-bottom:14px;
    }

    .grid2{
      display:grid;
      grid-template-columns:1.2fr .95fr;
      gap:14px;
    }
    .grid22{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row > *{flex:1}

    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--warn);
      box-shadow:0 0 0 4px rgba(255,209,102,.12);
    }
    .dot.ok{
      background:var(--good);
      box-shadow:0 0 0 4px rgba(57,217,138,.12);
    }
    .dot.err{
      background:var(--danger);
      box-shadow:0 0 0 4px rgba(255,93,93,.12);
    }

    .bigMicWrap{
      display:flex;
      justify-content:center;
      margin:16px 0 18px;
    }

    .bigMic{
      width:150px;
      height:150px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:58px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      box-shadow:0 24px 60px rgba(0,0,0,.35);
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(135deg, rgba(86,156,255,.98), rgba(57,217,138,.55));
      color:#04152c;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .bigMic:active{transform:scale(.98)}
    .bigMic.listening{
      animation:pulse 1.2s infinite;
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(255,255,255,.28), transparent 60%),
        linear-gradient(135deg, rgba(255,93,93,.98), rgba(255,209,102,.65));
      color:#1d1200;
    }

    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(255,93,93,.38), 0 24px 60px rgba(0,0,0,.35);}
      70%{ box-shadow:0 0 0 18px rgba(255,93,93,0), 0 24px 60px rgba(0,0,0,.35);}
      100%{ box-shadow:0 0 0 0 rgba(255,93,93,0), 0 24px 60px rgba(0,0,0,.35);}
    }

    .center{text-align:center}
    .box{
      min-height:88px;
      white-space:pre-wrap;
      line-height:1.45;
      font-size:15px;
      padding:14px;
      border-radius:18px;
      border:1px dashed var(--stroke);
      background:rgba(255,255,255,.04);
    }
    .result{
      min-height:160px;
      white-space:pre-wrap;
      line-height:1.5;
      font-size:15px;
      padding:14px;
      border-radius:18px;
      border:1px dashed var(--stroke);
      background:rgba(255,255,255,.04);
    }

    .item{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      line-height:1.45;
    }

    .list{
      display:grid;
      gap:10px;
    }

    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;
      white-space:pre-wrap;
      line-height:1.45;
    }

    .ok{color:var(--good);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .err{color:var(--danger);font-weight:900}

    .chipRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }

    .jsonBox{
      min-height:180px;
      max-height:360px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.45;
      font-size:12px;
      padding:14px;
      border-radius:18px;
      border:1px dashed var(--stroke);
      background:rgba(255,255,255,.04);
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }

    .hidden{display:none !important}

    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
    }
    @media (max-width:700px){
      .grid22{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Comando de Voz IA</h1>
        <div class="small">Ele tenta regra local primeiro. Se n√£o bater, envia o texto para sua IA e executa automaticamente.</div>
      </div>
      <div class="row" style="max-width:340px">
        <button class="btn" onclick="goBack()">‚Üê Voltar</button>
        <button class="btn" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
      </div>
    </div>

    <div class="card">
      <div class="heroTop">
        <div>
          <h2>Fale normalmente</h2>
          <div class="small" style="margin-top:6px">
            Exemplos:
            <br>‚Ä¢ anota que paguei 50 no mercado hoje
            <br>‚Ä¢ coloca internet 99 fixo vencendo dia 11
            <br>‚Ä¢ quero guardar 300 pro tablet
            <br>‚Ä¢ marca internet como pago
            <br>‚Ä¢ tira internet do pago
            <br>‚Ä¢ remove o gasto mercado
            <br>‚Ä¢ gera pdf de mar√ßo de 2026
            <br>‚Ä¢ muda o tema para roxo
          </div>
        </div>
        <div class="badge">
          <span class="dot" id="micDot"></span>
          <span id="micStatus">Parado</span>
        </div>
      </div>

      <div class="bigMicWrap">
        <button class="bigMic" id="bigMic" onclick="toggleRecording()" title="Gravar comando">üéôÔ∏è</button>
      </div>

      <div class="center small" id="hintText">Toque no microfone para come√ßar a ouvir.</div>

      <div style="margin-top:14px">
        <div class="small" style="margin-bottom:6px">Texto reconhecido</div>
        <div class="box" id="transcriptBox">Nenhum comando ainda.</div>
      </div>

      <div class="chipRow">
        <div class="chip" onclick="fillExample('anota que paguei 50 no mercado hoje')">Gasto natural</div>
        <div class="chip" onclick="fillExample('coloca internet 99 fixo vencendo dia 11')">Fixo</div>
        <div class="chip" onclick="fillExample('quero guardar 300 pro tablet')">Guardado</div>
        <div class="chip" onclick="fillExample('muda o tema para roxo')">Tema</div>
        <div class="chip" onclick="fillExample('gera pdf de mar√ßo de 2026')">PDF</div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn" onclick="clearTranscript()">Limpar</button>
        <button class="btn warn" onclick="toggleRecording()">Ouvir novamente</button>
        <button class="btn good" onclick="executeVoiceCommand()">Executar comando</button>
      </div>
    </div>

    <div class="grid2">
      <div>
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">√öltimo resultado</div>
          <div id="resultBox" class="result">Nenhuma a√ß√£o executada ainda.</div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Diagn√≥stico</div>
          <div id="debugBox" class="mono">Aguardando...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Modo IA</div>
          <div class="small">
            Quando a regra local n√£o entende, o sistema manda o texto para sua IA em:
            <br><b>/api/chat</b>
            <br><br>
            A IA precisa responder JSON puro ou um bloco JSON com:
            <br>‚Ä¢ <b>action</b>
            <br>‚Ä¢ par√¢metros da a√ß√£o
          </div>
          <div class="hr" style="height:1px;background:var(--stroke);margin:12px 0"></div>
          <div class="grid22">
            <button class="btn" onclick="testAI()">Testar IA</button>
            <button class="btn" onclick="toggleRawBox()">Mostrar JSON</button>
          </div>
        </div>

        <div class="card hidden" id="rawCard">
          <div style="font-weight:900;margin-bottom:10px">Resposta bruta da IA</div>
          <div id="rawJsonBox" class="jsonBox">Nenhum retorno ainda.</div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">A√ß√µes que a IA pode devolver</div>
          <div class="list small">
            <div class="item"><b>add_expense</b><br>{ "action":"add_expense","desc":"mercado","amount":50,"category":"Alimenta√ß√£o","paid":true }</div>
            <div class="item"><b>add_fixed_expense</b><br>{ "action":"add_fixed_expense","desc":"internet","amount":99,"category":"Casa","dueDay":11 }</div>
            <div class="item"><b>add_fixed_investment</b><br>{ "action":"add_fixed_investment","name":"reserva","goalAmount":3000,"months":12,"dueDay":10 }</div>
            <div class="item"><b>mark_paid</b> / <b>mark_pending</b><br>{ "action":"mark_paid","target":"internet" }</div>
            <div class="item"><b>remove_expense</b> / <b>remove_fixed_expense</b> / <b>remove_fixed_investment</b></div>
            <div class="item"><b>add_saved</b><br>{ "action":"add_saved","amount":300,"desc":"tablet" }</div>
            <div class="item"><b>change_theme</b><br>{ "action":"change_theme","preset":"purple","accent":"#aa6eff" }</div>
            <div class="item"><b>generate_month_pdf</b><br>{ "action":"generate_month_pdf","month":"2026-03" }</div>
            <div class="item"><b>generate_year_summary_pdf</b><br>{ "action":"generate_year_summary_pdf","year":"2026" }</div>
            <div class="item"><b>show_summary</b><br>{ "action":"show_summary" }</div>
            <div class="item"><b>request_notifications</b><br>{ "action":"request_notifications" }</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
  window.API_BASE_URL = window.API_BASE_URL || "https://gastospro-ai.limaribeiroabraoolimaribeiro.workers.dev";
  window.APP_KEY = window.APP_KEY || "GastosPro@2026!";
</script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Investimentos","Outros"];
const THEME_KEYS = { preset: "theme_preset_v1", accent: "theme_accent_v1" };

const THEME_PRESETS = {
  default:{ dark:{bg:"#07101f",g1:"rgba(86,156,255,.22)",g2:"rgba(57,217,138,.16)",g3:"rgba(255,93,93,.12)"}, light:{bg:"#f4f6ff",g1:"rgba(86,156,255,.14)",g2:"rgba(57,217,138,.10)",g3:"rgba(255,93,93,.08)"} },
  purple:{ dark:{bg:"#0d0a1f",g1:"rgba(170,110,255,.25)",g2:"rgba(86,156,255,.12)",g3:"rgba(57,217,138,.10)"}, light:{bg:"#fbf8ff",g1:"rgba(170,110,255,.16)",g2:"rgba(86,156,255,.10)",g3:"rgba(57,217,138,.08)"} },
  green:{ dark:{bg:"#061a14",g1:"rgba(57,217,138,.28)",g2:"rgba(86,156,255,.10)",g3:"rgba(255,209,102,.10)"}, light:{bg:"#f7fffb",g1:"rgba(57,217,138,.16)",g2:"rgba(86,156,255,.08)",g3:"rgba(255,209,102,.10)"} },
  sunset:{ dark:{bg:"#1a0b0b",g1:"rgba(255,93,93,.22)",g2:"rgba(255,209,102,.18)",g3:"rgba(86,156,255,.10)"}, light:{bg:"#fff7f2",g1:"rgba(255,93,93,.14)",g2:"rgba(255,209,102,.14)",g3:"rgba(86,156,255,.08)"} },
  mono:{ dark:{bg:"#05070c",g1:"rgba(255,255,255,.10)",g2:"rgba(255,255,255,.06)",g3:"rgba(255,255,255,.04)"}, light:{bg:"#ffffff",g1:"rgba(0,0,0,.06)",g2:"rgba(0,0,0,.04)",g3:"rgba(0,0,0,.03)"} }
};

const COLOR_MAP = {
  azul:"#569cff", blue:"#569cff",
  verde:"#39d98a", green:"#39d98a",
  vermelho:"#ff5d5d", red:"#ff5d5d",
  amarelo:"#ffd166", yellow:"#ffd166",
  roxo:"#aa6eff", purple:"#aa6eff",
  rosa:"#ff69b4", pink:"#ff69b4",
  laranja:"#ff8c42", orange:"#ff8c42",
  branco:"#f5f5f5", preto:"#222222",
  ciano:"#00c2ff"
};

const MONTHS_PT = {
  janeiro:"01", fevereiro:"02", marco:"03", "mar√ßo":"03", abril:"04", maio:"05", junho:"06",
  julho:"07", agosto:"08", setembro:"09", outubro:"10", novembro:"11", dezembro:"12"
};

let auth = null;
let USER = null;
let USER_ID = null;
let recognition = null;
let listening = false;
let lastTranscript = "";
let lastRaw = "";

function dbg(msg){
  document.getElementById("debugBox").textContent = String(msg);
}

function setResult(html){
  document.getElementById("resultBox").innerHTML = html;
}

function setRawBox(text){
  lastRaw = String(text || "");
  document.getElementById("rawJsonBox").textContent = lastRaw || "Nenhum retorno ainda.";
}

function toggleRawBox(){
  document.getElementById("rawCard").classList.toggle("hidden");
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeText(s){
  return String(s || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();
}

function titleCase(s){
  return String(s || "")
    .split(" ")
    .filter(Boolean)
    .map(p => p.charAt(0).toUpperCase() + p.slice(1))
    .join(" ");
}

function money(n){
  return Number(n || 0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function todayISO(){
  return new Date().toISOString().slice(0,10);
}

function currentMonthKey(){
  return new Date().toISOString().slice(0,7);
}

function kMes(){ return "gastos_pro_state_" + USER_ID; }
function kCat(){ return "categorias_" + USER_ID; }
function kFix(){ return "fixos_" + USER_ID; }
function kInv(){ return "inv_fixos_" + USER_ID; }

function loadState(){
  let state = { meses:{} };
  let categorias = [...DEFAULT_CATEGORIAS];
  let fixos = [];
  let investFixos = [];

  try{
    const raw = localStorage.getItem(kMes());
    if(raw) state = JSON.parse(raw) || { meses:{} };
  }catch(e){}

  try{
    const raw = localStorage.getItem(kCat());
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed) && parsed.length) categorias = parsed;
    }
  }catch(e){}

  try{
    const raw = localStorage.getItem(kFix());
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) fixos = parsed;
    }
  }catch(e){}

  try{
    const raw = localStorage.getItem(kInv());
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) investFixos = parsed;
    }
  }catch(e){}

  if(!categorias.some(c=>normalizeText(c)==="investimentos")){
    categorias.splice(categorias.length-1,0,"Investimentos");
  }

  if(!state.meses || typeof state.meses !== "object") state.meses = {};

  fixos = (fixos || []).map(f => ({
    ...f,
    id: f.id || uid(),
    diaPagar: Number(f.diaPagar || 0),
    isFixo: true
  }));

  investFixos = (investFixos || []).map(inv => ({
    ...inv,
    id: inv.id || uid(),
    diaPagar: Number(inv.diaPagar || 0),
    metaFinal: Number(inv.metaFinal || 0),
    prazoMeses: Number(inv.prazoMeses || 0),
    mensal: Number(inv.mensal || 0)
  }));

  return { state, categorias, fixos, investFixos };
}

function saveState(all){
  localStorage.setItem(kMes(), JSON.stringify(all.state));
  localStorage.setItem(kCat(), JSON.stringify(all.categorias));
  localStorage.setItem(kFix(), JSON.stringify(all.fixos));
  localStorage.setItem(kInv(), JSON.stringify(all.investFixos));
}

function getMesData(all, monthKey){
  const m = monthKey || currentMonthKey();
  if(!all.state.meses[m]){
    all.state.meses[m] = {
      salary:0,
      meta:0,
      items:[],
      saved:[],
      hiddenFixos:[],
      investStatus:{}
    };
  }
  const d = all.state.meses[m];
  if(!Array.isArray(d.items)) d.items = [];
  if(!Array.isArray(d.saved)) d.saved = [];
  if(!Array.isArray(d.hiddenFixos)) d.hiddenFixos = [];
  if(!d.investStatus || typeof d.investStatus !== "object") d.investStatus = {};
  d.items = d.items.map(it => ({
    ...it,
    id: it.id || uid(),
    paid: !!it.paid,
    isFixo: !!it.isFixo,
    isInvestFixo: !!it.isInvestFixo,
    diaPagar: Number(it.diaPagar || 0)
  }));
  return d;
}

function fixKey(desc, amount, category){
  return `${String(desc||"").toLowerCase()}|${Number(amount||0)}|${String(category||"").toLowerCase()}`;
}

function ensureMonthItems(all, monthKey){
  const d = getMesData(all, monthKey);
  const hidden = new Set((d.hiddenFixos || []).map(String));
  const present = new Set(d.items.map(it => fixKey(it.desc, it.amount, it.category)));

  (all.fixos || []).forEach(f=>{
    const fk = fixKey(f.desc, f.amount, f.category);
    if(hidden.has(fk) || present.has(fk)) return;
    d.items.unshift({
      id: f.id,
      desc: f.desc,
      amount: Number(f.amount || 0),
      category: f.category || "Outros",
      isFixo:true,
      isInvestFixo:false,
      diaPagar:Number(f.diaPagar || 0),
      paid:false
    });
    present.add(fk);
  });

  (all.investFixos || []).forEach(inv=>{
    const desc = `Juntar: ${inv.nome}`;
    const amount = Number(inv.mensal || 0);
    const fk = fixKey(desc, amount, "Investimentos");
    if(hidden.has(fk) || present.has(fk)) return;
    if(typeof d.investStatus[inv.id] !== "boolean") d.investStatus[inv.id] = false;
    d.items.unshift({
      id: inv.id,
      invId: inv.id,
      desc,
      amount,
      category:"Investimentos",
      isFixo:true,
      isInvestFixo:true,
      diaPagar:Number(inv.diaPagar || 0),
      paid: !!d.investStatus[inv.id]
    });
    present.add(fk);
  });

  return d;
}

function setMicStatus(text, type){
  document.getElementById("micStatus").textContent = text;
  const dot = document.getElementById("micDot");
  dot.classList.remove("ok","err");
  if(type === "ok") dot.classList.add("ok");
  if(type === "err") dot.classList.add("err");
}

function setTranscript(text){
  lastTranscript = String(text || "").trim();
  document.getElementById("transcriptBox").textContent = lastTranscript || "Nenhum comando ainda.";
}

function fillExample(text){
  setTranscript(text);
  setResult(`Exemplo carregado:<br><b>${escapeHtml(text)}</b>`);
}

function clearTranscript(){
  setTranscript("");
  setResult("Nenhuma a√ß√£o executada ainda.");
}

function applyThemeToPage(){
  const preset = localStorage.getItem(THEME_KEYS.preset) || "default";
  const accent = localStorage.getItem(THEME_KEYS.accent) || "#569cff";
  const p = THEME_PRESETS[preset] || THEME_PRESETS.default;
  const light = document.body.classList.contains("light");
  const colors = light ? p.light : p.dark;

  document.documentElement.style.setProperty("--accent", accent);
  document.documentElement.style.setProperty("--bg", colors.bg);
  document.documentElement.style.setProperty("--grad1", colors.g1);
  document.documentElement.style.setProperty("--grad2", colors.g2);
  document.documentElement.style.setProperty("--grad3", colors.g3);
}

function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
  applyThemeToPage();
}

function goBack(){
  location.href = "./index.html";
}

function ensureSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    setMicStatus("Sem suporte", "err");
    dbg("SpeechRecognition n√£o suportado neste navegador.");
    return false;
  }

  recognition = new SR();
  recognition.lang = "pt-BR";
  recognition.interimResults = true;
  recognition.continuous = false;

  recognition.onstart = () => {
    listening = true;
    document.getElementById("bigMic").classList.add("listening");
    document.getElementById("hintText").textContent = "Ouvindo... fale seu comando.";
    setMicStatus("Ouvindo...", "ok");
  };

  recognition.onresult = (event) => {
    let finalText = "";
    let partialText = "";
    for(let i = event.resultIndex; i < event.results.length; i++){
      const txt = event.results[i][0].transcript || "";
      if(event.results[i].isFinal) finalText += txt + " ";
      else partialText += txt + " ";
    }
    const merged = (finalText || partialText).trim();
    if(merged) setTranscript(merged);
  };

  recognition.onerror = (event) => {
    listening = false;
    document.getElementById("bigMic").classList.remove("listening");
    document.getElementById("hintText").textContent = "Erro ao ouvir. Tente novamente.";
    setMicStatus("Erro", "err");
    dbg("Erro SpeechRecognition: " + (event.error || "desconhecido"));
  };

  recognition.onend = () => {
    listening = false;
    document.getElementById("bigMic").classList.remove("listening");
    document.getElementById("hintText").textContent = "Se o texto ficou certo, toque em Executar comando.";
    if(lastTranscript) setMicStatus("Pronto", "ok");
    else setMicStatus("Parado", "");
  };

  return true;
}

function toggleRecording(){
  if(!recognition && !ensureSpeech()) return;
  try{
    if(listening) recognition.stop();
    else recognition.start();
  }catch(e){
    dbg("Falha ao iniciar/parar grava√ß√£o: " + e.message);
  }
}

function parseCategory(text, categorias){
  const normalized = normalizeText(text);
  for(const c of categorias){
    const nc = normalizeText(c);
    if(normalized.includes("categoria " + nc)) return c;
  }
  if(normalized.includes("casa")) return "Casa";
  if(normalized.includes("alimentacao")) return "Alimenta√ß√£o";
  if(normalized.includes("transporte")) return "Transporte";
  if(normalized.includes("lazer")) return "Lazer";
  if(normalized.includes("pets")) return "Pets";
  if(normalized.includes("investimentos")) return "Investimentos";
  return "Outros";
}

function extractAmount(text){
  const t = normalizeText(text).replace(/,/g, ".");
  const matches = t.match(/\d+(\.\d+)?/g);
  if(!matches || !matches.length) return 0;
  return Number(matches[0] || 0);
}

function extractAllNumbers(text){
  const t = normalizeText(text).replace(/,/g, ".");
  const matches = t.match(/\d+(\.\d+)?/g);
  return (matches || []).map(Number).filter(n => !Number.isNaN(n));
}

function extractDueDay(text){
  const t = normalizeText(text);
  const m =
    t.match(/vence dia (\d{1,2})/) ||
    t.match(/vencimento dia (\d{1,2})/) ||
    t.match(/dia (\d{1,2}) e o prazo/) ||
    t.match(/dia (\d{1,2}) prazo/) ||
    t.match(/prazo dia (\d{1,2})/) ||
    t.match(/pagar dia (\d{1,2})/) ||
    t.match(/ate dia (\d{1,2})/) ||
    t.match(/at√© dia (\d{1,2})/);
  return m ? Number(m[1]) : 0;
}

function extractMonths(text){
  const t = normalizeText(text);
  const m = t.match(/em (\d{1,3}) meses?/) || t.match(/(\d{1,3}) meses?/);
  return m ? Number(m[1]) : 0;
}

function cleanDesc(raw){
  let t = normalizeText(raw);

  t = t
    .replace(/^adicionar\s+/, "")
    .replace(/^criar\s+/, "")
    .replace(/^anotar\s+/, "")
    .replace(/^colocar\s+/, "")
    .replace(/^novo\s+/, "")
    .replace(/^nova\s+/, "")
    .replace(/^uma\s+/, "")
    .replace(/^um\s+/, "")
    .replace(/^remover\s+/, "")
    .replace(/^apagar\s+/, "")
    .replace(/^deletar\s+/, "")
    .replace(/^excluir\s+/, "")
    .replace(/^marcar\s+/, "")
    .replace(/^desmarcar\s+/, "")
    .replace(/^gastei\s+/, "")
    .replace(/^guardei\s+/, "")
    .replace(/^quero guardar\s+/, "")
    .replace(/^quero juntar\s+/, "")
    .replace(/^quero\s+/, "");

  t = t
    .replace(/\bgasto fixo\b/g, "")
    .replace(/\bgasto\b/g, "")
    .replace(/\binvestimento fixo\b/g, "")
    .replace(/\binvestimento\b/g, "")
    .replace(/\bcategoria\b/g, "")
    .replace(/\bfixo\b/g, "")
    .replace(/\bguardado\b/g, "")
    .replace(/\bguardar\b/g, "")
    .replace(/\bcomo pago\b/g, "")
    .replace(/\bpago\b/g, "")
    .replace(/\bpendente\b/g, "")
    .replace(/\bvencer\b/g, "")
    .replace(/\bvencendo\b/g, "")
    .replace(/\bvence\b/g, "")
    .replace(/\bdia \d{1,2}\b/g, "")
    .replace(/\bcategoria [a-zA-Z√Ä-√ø√ß√á]+\b/g, "")
    .replace(/\bem \d{1,3} meses?\b/g, "")
    .replace(/\bhoje\b/g, "")
    .replace(/\bno\b/g, " ")
    .replace(/\bna\b/g, " ")
    .replace(/\bpro\b/g, " ")
    .replace(/\bpra\b/g, " ")
    .replace(/\d+(\.\d+)?/g, "")
    .replace(/\s+/g, " ")
    .trim();

  return titleCase(t);
}

function findCurrentMonthItemByName(all, name, monthKey){
  const d = ensureMonthItems(all, monthKey || currentMonthKey());
  const n = normalizeText(name);
  return d.items.find(it => {
    const itemName = normalizeText(it.desc);
    return itemName.includes(n) || n.includes(itemName);
  });
}

function monthSummaryHtml(all, monthKey){
  const d = ensureMonthItems(all, monthKey || currentMonthKey());
  const salary = Number(d.salary || 0);
  const spent = (d.items || []).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved || []).reduce((a,b)=>a+Number(b.value||0),0);
  const left = salary - spent;

  const byCat = {};
  (d.items || []).forEach(it=>{
    const c = it.category || "Outros";
    byCat[c] = (byCat[c] || 0) + Number(it.amount || 0);
  });
  const topCats = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,3);

  return (
    `<span class="ok">Resumo do m√™s.</span><br><br>` +
    `‚Ä¢ Sal√°rio: <b>${money(salary)}</b><br>` +
    `‚Ä¢ Gastos: <b>${money(spent)}</b><br>` +
    `‚Ä¢ Guardado: <b>${money(saved)}</b><br>` +
    `‚Ä¢ Sobra: <b>${money(left)}</b><br><br>` +
    `${topCats.length ? `Top categorias:<br>${topCats.map(([c,v])=>`‚Ä¢ ${escapeHtml(c)}: <b>${money(v)}</b>`).join("<br>")}` : `Sem categorias registradas no m√™s.`}`
  );
}

function parseMonthYearFromText(cmd){
  const t = normalizeText(cmd);
  const yearMatch = t.match(/\b(20\d{2})\b/);
  const year = yearMatch ? yearMatch[1] : String(new Date().getFullYear());

  for(const [name, num] of Object.entries(MONTHS_PT)){
    if(t.includes(name)) return { year, month:num, monthName:name };
  }

  const current = currentMonthKey();
  return { year: current.slice(0,4), month: current.slice(5,7), monthName: "" };
}

function requestNotificationPermission(){
  if(!("Notification" in window)){
    setResult(`<span class="err">Seu navegador n√£o suporta notifica√ß√µes.</span>`);
    return;
  }
  Notification.requestPermission().then((perm)=>{
    if(perm === "granted") setResult(`<span class="ok">Notifica√ß√µes ativadas com sucesso.</span>`);
    else setResult(`<span class="warn">Notifica√ß√µes n√£o foram permitidas.</span>`);
  }).catch(()=>{
    setResult(`<span class="err">N√£o foi poss√≠vel ativar notifica√ß√µes.</span>`);
  });
}

function setThemePresetByName(name){
  const n = normalizeText(name);
  if(n.includes("roxo") || n.includes("purple")) return "purple";
  if(n.includes("verde") || n.includes("green")) return "green";
  if(n.includes("sunset") || n.includes("por do sol") || n.includes("laranja")) return "sunset";
  if(n.includes("minimal") || n.includes("mono") || n.includes("preto e branco")) return "mono";
  if(n.includes("padrao") || n.includes("normal") || n.includes("azul")) return "default";
  return "";
}

function setAccentByName(name){
  const n = normalizeText(name).replace(/\s+/g,"");
  return COLOR_MAP[n] || "";
}

function monthsOfYear(all, year){
  return Object.keys(all.state.meses || {}).filter(m => m.startsWith(String(year) + "-")).sort();
}

function aggregateYear(all, year){
  const months = monthsOfYear(all, year);
  const byCat = {};
  const byMonth = [];

  months.forEach(m=>{
    const d = ensureMonthItems(all, m);
    const spent = (d.items || []).reduce((a,b)=>a+Number(b.amount||0),0);
    const saved = (d.saved || []).reduce((a,b)=>a+Number(b.value||0),0);
    const salary = Number(d.salary || 0);
    byMonth.push({ m, salary, spent, saved });
    (d.items || []).forEach(it=>{
      const c = it.category || "Outros";
      byCat[c] = (byCat[c] || 0) + Number(it.amount || 0);
    });
  });

  const catsSorted = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const topCat = catsSorted[0] ? { cat: catsSorted[0][0], value: catsSorted[0][1] } : { cat:"‚Äî", value:0 };
  return { months, byCat, byMonth, topCat };
}

async function renderPdfAndSaveFromElement(wrap, filename){
  const canvas = await html2canvas(wrap, { scale: 2, backgroundColor:"#ffffff" });
  const imgData = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const imgW = pageW;
  const imgH = (canvas.height * imgW) / canvas.width;

  let y = 0;
  let remaining = imgH;
  pdf.addImage(imgData, "PNG", 0, y, imgW, imgH);
  remaining -= pageH;

  while(remaining > 0){
    pdf.addPage();
    y = -(imgH - remaining);
    pdf.addImage(imgData, "PNG", 0, y, imgW, imgH);
    remaining -= pageH;
  }

  pdf.save(filename);
}

async function generateYearSummaryPDF(all, year){
  const agg = aggregateYear(all, year);

  const wrap = document.createElement("div");
  wrap.style.position = "fixed";
  wrap.style.left = "-9999px";
  wrap.style.top = "0";
  wrap.style.width = "900px";
  wrap.style.padding = "16px";
  wrap.style.background = "#fff";
  wrap.style.color = "#111";
  wrap.style.fontFamily = "system-ui, sans-serif";

  wrap.innerHTML = `
    <div style="font-size:22px;font-weight:900">Resumo do Ano ‚Ä¢ Controle de Gastos PRO</div>
    <div style="font-size:13px;color:#444">Ano: <b>${escapeHtml(year)}</b> ‚Ä¢ Gerado em: ${escapeHtml(todayISO())}</div>
    <div style="margin-top:10px;font-size:14px;font-weight:900">Mais gastou no ano: ${escapeHtml(agg.topCat.cat)} ‚Ä¢ ${money(agg.topCat.value)}</div>
    <hr style="border:none;height:1px;background:#ddd;margin:14px 0"/>
    <div style="border:1px solid #ddd;border-radius:12px;padding:12px">
      <div style="font-weight:900;margin-bottom:8px">Tabela do ano</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid #ddd;padding:8px">M√™s</th>
            <th style="text-align:right;border-bottom:1px solid #ddd;padding:8px">Sal√°rio</th>
            <th style="text-align:right;border-bottom:1px solid #ddd;padding:8px">Gastos</th>
            <th style="text-align:right;border-bottom:1px solid #ddd;padding:8px">Guardado</th>
            <th style="text-align:right;border-bottom:1px solid #ddd;padding:8px">Sobra</th>
          </tr>
        </thead>
        <tbody>
          ${agg.byMonth.map(x=>{
            const sobra = Number(x.salary||0) - Number(x.spent||0);
            const label = new Date(x.m+"-01T00:00:00").toLocaleDateString("pt-BR",{month:"short",year:"numeric"});
            return `<tr>
              <td style="padding:7px;border-bottom:1px solid #eee">${escapeHtml(label)}</td>
              <td style="padding:7px;border-bottom:1px solid #eee;text-align:right">${money(x.salary)}</td>
              <td style="padding:7px;border-bottom:1px solid #eee;text-align:right">${money(x.spent)}</td>
              <td style="padding:7px;border-bottom:1px solid #eee;text-align:right">${money(x.saved)}</td>
              <td style="padding:7px;border-bottom:1px solid #eee;text-align:right">${money(sobra)}</td>
            </tr>`;
          }).join("") || `<tr><td colspan="5" style="padding:10px">Sem dados no ano.</td></tr>`}
        </tbody>
      </table>
    </div>
  `;

  document.body.appendChild(wrap);
  await new Promise(r=>setTimeout(r,200));
  await renderPdfAndSaveFromElement(wrap, `resumo_ano_${year}.pdf`);
  wrap.remove();
}

async function generateMonthPDF(all, monthKey){
  const d = ensureMonthItems(all, monthKey);
  const spent = (d.items || []).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved || []).reduce((a,b)=>a+Number(b.value||0),0);
  const salary = Number(d.salary || 0);
  const left = salary - spent;

  const wrap = document.createElement("div");
  wrap.style.position = "fixed";
  wrap.style.left = "-9999px";
  wrap.style.top = "0";
  wrap.style.width = "900px";
  wrap.style.padding = "16px";
  wrap.style.background = "#fff";
  wrap.style.color = "#111";
  wrap.style.fontFamily = "system-ui, sans-serif";

  const monthLabel = new Date(monthKey + "-01T00:00:00").toLocaleDateString("pt-BR",{month:"long",year:"numeric"});

  wrap.innerHTML = `
    <div style="font-size:22px;font-weight:900">PDF do M√™s ‚Ä¢ Controle de Gastos PRO</div>
    <div style="font-size:13px;color:#444">M√™s: <b>${escapeHtml(monthLabel)}</b> ‚Ä¢ Gerado em: ${escapeHtml(todayISO())}</div>
    <hr style="border:none;height:1px;background:#ddd;margin:14px 0"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div style="border:1px solid #ddd;border-radius:12px;padding:12px">
        <div style="font-weight:900;margin-bottom:8px">Resumo</div>
        <div>Sal√°rio: <b>${money(salary)}</b></div>
        <div>Gastos: <b>${money(spent)}</b></div>
        <div>Guardado: <b>${money(saved)}</b></div>
        <div>Sobra: <b>${money(left)}</b></div>
      </div>
      <div style="border:1px solid #ddd;border-radius:12px;padding:12px">
        <div style="font-weight:900;margin-bottom:8px">Totais</div>
        <div>Itens anotados: <b>${(d.items || []).length}</b></div>
        <div>Entradas guardadas: <b>${(d.saved || []).length}</b></div>
      </div>
    </div>

    <div style="margin-top:14px;border:1px solid #ddd;border-radius:12px;padding:12px">
      <div style="font-weight:900;margin-bottom:8px">Itens do m√™s</div>
      ${(d.items || []).length ? (d.items || []).map(it=>`
        <div style="display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #eee">
          <div>
            <div style="font-weight:800">${escapeHtml(it.desc || "")}</div>
            <div style="font-size:12px;color:#444">
              ${escapeHtml(it.category || "Outros")} ‚Ä¢ ${it.paid ? "Pago" : "Pendente"}
              ${it.isFixo ? " ‚Ä¢ Fixo" : ""}
              ${it.isInvestFixo ? " ‚Ä¢ Juntar" : ""}
              ${it.diaPagar ? (" ‚Ä¢ Vence dia " + escapeHtml(it.diaPagar)) : ""}
            </div>
          </div>
          <div style="font-weight:900">${money(it.amount || 0)}</div>
        </div>
      `).join("") : `<div style="padding:8px 0">Sem itens no m√™s.</div>`}
    </div>

    <div style="margin-top:14px;border:1px solid #ddd;border-radius:12px;padding:12px">
      <div style="font-weight:900;margin-bottom:8px">Guardado</div>
      ${(d.saved || []).length ? (d.saved || []).map(s=>`
        <div style="display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #eee">
          <div>
            <div style="font-weight:800">${escapeHtml(s.desc || "Sem descri√ß√£o")}</div>
            <div style="font-size:12px;color:#444">${escapeHtml(s.date || "")}</div>
          </div>
          <div style="font-weight:900">${money(s.value || 0)}</div>
        </div>
      `).join("") : `<div style="padding:8px 0">Sem valores guardados no m√™s.</div>`}
    </div>
  `;

  document.body.appendChild(wrap);
  await new Promise(r=>setTimeout(r,200));
  await renderPdfAndSaveFromElement(wrap, `pdf_mes_${monthKey}.pdf`);
  wrap.remove();
}

/* =========================
   REGRAS LOCAIS
========================= */

function tryLocalRule(cmd, all){
  const t = normalizeText(cmd);

  if(t.includes("mostrar resumo do mes") || t.includes("resumo do mes")){
    return { ok:true, html: monthSummaryHtml(all, currentMonthKey()) };
  }

  if(t.includes("abrir notificacoes") || t.includes("ativar notificacoes") || t === "notificacoes"){
    requestNotificationPermission();
    return { ok:true, html:`Abrindo permiss√£o de <b>notifica√ß√µes</b>.` };
  }

  if(t.includes("anotar guardado") || t.includes("guardar ") || t.includes("guardei ") || t.includes("quero guardar ")){
    const valor = extractAmount(t);
    let desc = cleanDesc(t);
    if(!valor || valor <= 0) return { ok:false, html:"N√£o entendi o valor do guardado." };
    if(!desc) desc = "Guardado";
    const d = ensureMonthItems(all, currentMonthKey());
    d.saved.unshift({ value:valor, desc, date:todayISO(), source:"manual" });
    saveState(all);
    return { ok:true, html:`Valor guardado anotado:<br>‚Ä¢ Valor: <b>${money(valor)}</b><br>‚Ä¢ Descri√ß√£o: <b>${escapeHtml(desc)}</b>` };
  }

  if(t.includes("mudar tema") || t.includes("trocar tema") || t.includes("mudar cor") || t.includes("trocar cor")){
    let changed = [];
    const preset = setThemePresetByName(t);
    if(preset){
      localStorage.setItem(THEME_KEYS.preset, preset);
      changed.push(`Tema alterado para <b>${escapeHtml(preset)}</b>`);
    }
    for(const [name, hex] of Object.entries(COLOR_MAP)){
      if(t.includes(name)){
        localStorage.setItem(THEME_KEYS.accent, hex);
        changed.push(`Cor principal alterada para <b>${escapeHtml(name)}</b>`);
        break;
      }
    }
    if(!changed.length) return { ok:false, html:"N√£o entendi qual cor/tema voc√™ quer usar." };
    applyThemeToPage();
    return { ok:true, html: changed.join("<br>") };
  }

  if(t.includes("marcar") && t.includes("como pago") && !t.includes("desmarcar")){
    let nome = t.replace("marcar","").replace("como pago","").trim();
    const target = findCurrentMonthItemByName(all, nome, currentMonthKey());
    if(!target) return { ok:false, html:`N√£o encontrei item parecido com "<b>${escapeHtml(nome)}</b>".` };
    target.paid = true;
    const d = ensureMonthItems(all, currentMonthKey());
    if(target.isInvestFixo && target.invId){
      d.investStatus[target.invId] = true;
      const exists = d.saved.some(s => s && s.source==="investFixo" && s.invId===target.invId && s.month===currentMonthKey());
      if(!exists){
        d.saved.unshift({
          value:Number(target.amount || 0),
          desc:`Autom√°tico: ${target.desc}`,
          date:todayISO(),
          source:"investFixo",
          invId:target.invId,
          month:currentMonthKey()
        });
      }
    }
    saveState(all);
    return { ok:true, html:`Item <b>${escapeHtml(target.desc)}</b> marcado como <b>Pago</b>.` };
  }

  if((t.includes("desmarcar") && t.includes("pago")) || t.includes("voltar pendente") || t.includes("tirar pago")){
    let nome = t.replace("desmarcar","").replace("como pago","").replace("tirar pago","").replace("voltar pendente","").replace("pago","").trim();
    const target = findCurrentMonthItemByName(all, nome, currentMonthKey());
    if(!target) return { ok:false, html:`N√£o encontrei item parecido com "<b>${escapeHtml(nome)}</b>".` };
    target.paid = false;
    const d = ensureMonthItems(all, currentMonthKey());
    if(target.isInvestFixo && target.invId){
      d.investStatus[target.invId] = false;
      d.saved = d.saved.filter(s => !(s && s.source==="investFixo" && s.invId===target.invId && s.month===currentMonthKey()));
    }
    saveState(all);
    return { ok:true, html:`Item <b>${escapeHtml(target.desc)}</b> voltou para <b>Pendente</b>.` };
  }

  if(t.startsWith("gastei ") || t.startsWith("paguei ")){
    const valor = extractAmount(t);
    if(!valor || valor <= 0) return { ok:false, html:"N√£o entendi o valor gasto." };
    let desc = cleanDesc(t);
    if(!desc) desc = "Gasto";
    const categoria = parseCategory(t, all.categorias);
    const d = ensureMonthItems(all, currentMonthKey());
    d.items.push({
      id: uid(),
      desc,
      amount: valor,
      category: categoria,
      isFixo: false,
      isInvestFixo: false,
      paid: true
    });
    saveState(all);
    return { ok:true, html:`Gasto anotado:<br>‚Ä¢ <b>${escapeHtml(desc)}</b><br>‚Ä¢ Valor: <b>${money(valor)}</b><br>‚Ä¢ Categoria: <b>${escapeHtml(categoria)}</b><br>‚Ä¢ Status: <b>Pago</b>` };
  }

  if(t.includes("adicionar gasto") || t.includes("anotar gasto") || t.startsWith("gasto ")){
    if(t.includes("gasto fixo")) return null;
    const valor = extractAmount(t);
    const categoria = parseCategory(t, all.categorias);
    const desc = cleanDesc(t);
    if(!desc) return { ok:false, html:"N√£o entendi a descri√ß√£o do gasto." };
    if(!valor || valor <= 0) return { ok:false, html:"N√£o entendi o valor do gasto." };
    const d = ensureMonthItems(all, currentMonthKey());
    d.items.push({
      id: uid(),
      desc,
      amount: valor,
      category: categoria,
      isFixo: false,
      isInvestFixo: false,
      paid: false
    });
    saveState(all);
    return { ok:true, html:`Gasto adicionado:<br>‚Ä¢ <b>${escapeHtml(desc)}</b><br>‚Ä¢ Valor: <b>${money(valor)}</b><br>‚Ä¢ Categoria: <b>${escapeHtml(categoria)}</b>` };
  }

  if(t.includes("gasto fixo") || (t.includes("fixo") && extractAmount(t))){
    const valor = extractAmount(t);
    const categoria = parseCategory(t, all.categorias);
    const dueDay = extractDueDay(t);
    const desc = cleanDesc(t);
    if(!desc) return { ok:false, html:"N√£o entendi a descri√ß√£o do gasto fixo." };
    if(!valor || valor <= 0) return { ok:false, html:"N√£o entendi o valor do gasto fixo." };
    all.fixos.push({
      id: uid(),
      desc,
      amount: valor,
      category: categoria,
      diaPagar: dueDay || 0,
      isFixo: true
    });
    saveState(all);
    return { ok:true, html:`Gasto fixo adicionado:<br>‚Ä¢ <b>${escapeHtml(desc)}</b><br>‚Ä¢ Valor: <b>${money(valor)}</b><br>‚Ä¢ Categoria: <b>${escapeHtml(categoria)}</b><br>‚Ä¢ Vence: <b>${dueDay ? ("dia " + dueDay) : "sem prazo"}</b>` };
  }

  if(t.includes("investimento fixo")){
    const nums = extractAllNumbers(t);
    const goalAmount = nums[0] || 0;
    const months = extractMonths(t) || nums[1] || 0;
    const dueDay = extractDueDay(t);
    const name = cleanDesc(t);
    if(!name) return { ok:false, html:"N√£o entendi o nome do investimento fixo." };
    if(!goalAmount || goalAmount <= 0) return { ok:false, html:"N√£o entendi a meta final." };
    if(!months || months <= 0) return { ok:false, html:"N√£o entendi o prazo em meses." };
    const mensal = Math.round((goalAmount / months) * 100) / 100;
    const id = uid();
    all.investFixos.push({ id, nome:name, metaFinal:goalAmount, prazoMeses:months, mensal, diaPagar:dueDay || 0 });
    const d = ensureMonthItems(all, currentMonthKey());
    d.investStatus[id] = false;
    saveState(all);
    return { ok:true, html:`Investimento fixo adicionado:<br>‚Ä¢ <b>${escapeHtml(name)}</b><br>‚Ä¢ Meta final: <b>${money(goalAmount)}</b><br>‚Ä¢ Prazo: <b>${months} meses</b><br>‚Ä¢ Mensal: <b>${money(mensal)}</b>` };
  }

  if(t.includes("adicionar categoria") || t.includes("criar categoria")){
    let nome = t.replace("adicionar categoria","").replace("criar categoria","").trim();
    if(!nome) return { ok:false, html:"N√£o entendi o nome da categoria." };
    nome = titleCase(nome);
    if(all.categorias.some(c => normalizeText(c) === normalizeText(nome))){
      return { ok:false, html:`A categoria "${escapeHtml(nome)}" j√° existe.` };
    }
    all.categorias.push(nome);
    saveState(all);
    return { ok:true, html:`Categoria <b>${escapeHtml(nome)}</b> adicionada com sucesso.` };
  }

  if(t.includes("remover gasto fixo") || t.includes("apagar gasto fixo") || t.includes("deletar gasto fixo") || t.includes("excluir gasto fixo")){
    const nome = cleanDesc(t);
    const idx = all.fixos.findIndex(it => normalizeText(it.desc).includes(normalizeText(nome)) || normalizeText(nome).includes(normalizeText(it.desc)));
    if(idx === -1) return { ok:false, html:`N√£o encontrei gasto fixo parecido com "<b>${escapeHtml(nome)}</b>".` };
    const removed = all.fixos[idx];
    all.fixos.splice(idx,1);
    Object.keys(all.state.meses || {}).forEach(m=>{
      const d = all.state.meses[m];
      if(d && Array.isArray(d.items)){
        d.items = d.items.filter(it => !(it.isFixo && !it.isInvestFixo && (it.id === removed.id || normalizeText(it.desc) === normalizeText(removed.desc))));
      }
    });
    saveState(all);
    return { ok:true, html:`Gasto fixo <b>${escapeHtml(removed.desc)}</b> removido do sistema.` };
  }

  if(t.includes("remover investimento fixo") || t.includes("apagar investimento fixo") || t.includes("deletar investimento fixo") || t.includes("excluir investimento fixo")){
    const nome = cleanDesc(t);
    const idx = all.investFixos.findIndex(it => normalizeText(it.nome).includes(normalizeText(nome)) || normalizeText(nome).includes(normalizeText(it.nome)));
    if(idx === -1) return { ok:false, html:`N√£o encontrei investimento fixo parecido com "<b>${escapeHtml(nome)}</b>".` };
    const removed = all.investFixos[idx];
    all.investFixos.splice(idx,1);
    Object.keys(all.state.meses || {}).forEach(m=>{
      const d = all.state.meses[m];
      if(d){
        if(d.investStatus && removed.id) delete d.investStatus[removed.id];
        if(Array.isArray(d.saved)) d.saved = d.saved.filter(s => !(s && s.source==="investFixo" && s.invId===removed.id));
        if(Array.isArray(d.items)) d.items = d.items.filter(it => !(it.isInvestFixo && (it.invId === removed.id || it.id === removed.id)));
      }
    });
    saveState(all);
    return { ok:true, html:`Investimento fixo <b>${escapeHtml(removed.nome)}</b> removido do sistema.` };
  }

  if(t.includes("remover gasto") || t.includes("apagar gasto") || t.includes("deletar gasto") || t.includes("excluir gasto")){
    if(t.includes("gasto fixo")) return null;
    const nome = cleanDesc(t);
    const d = ensureMonthItems(all, currentMonthKey());
    const idx = d.items.findIndex(it => !it.isFixo && (normalizeText(it.desc).includes(normalizeText(nome)) || normalizeText(nome).includes(normalizeText(it.desc))));
    if(idx === -1) return { ok:false, html:`N√£o encontrei gasto parecido com "<b>${escapeHtml(nome)}</b>".` };
    const removed = d.items[idx];
    d.items.splice(idx,1);
    saveState(all);
    return { ok:true, html:`Gasto <b>${escapeHtml(removed.desc)}</b> removido do m√™s atual.` };
  }

  return null;
}

/* =========================
   IA
========================= */

function buildVoiceAIPrompt(userText, all){
  const month = currentMonthKey();
  const d = ensureMonthItems(all, month);

  const context = {
    currentMonth: month,
    categories: all.categorias,
    fixedExpenses: all.fixos.map(f=>({
      desc:f.desc, amount:Number(f.amount||0), category:f.category || "Outros", dueDay:Number(f.diaPagar||0)
    })),
    fixedInvestments: all.investFixos.map(inv=>({
      name:inv.nome, goalAmount:Number(inv.metaFinal||0), months:Number(inv.prazoMeses||0), monthlyAmount:Number(inv.mensal||0), dueDay:Number(inv.diaPagar||0)
    })),
    currentMonthItems: d.items.map(it=>({
      desc:it.desc, amount:Number(it.amount||0), category:it.category || "Outros",
      paid:!!it.paid, isFixed:!!it.isFixo, isFixedInvestment:!!it.isInvestFixo, dueDay:Number(it.diaPagar||0)
    }))
  };

  return `
Voc√™ √© um interpretador de inten√ß√£o para um app de finan√ßas pessoais.
Sua tarefa √© converter o pedido do usu√°rio em UM JSON execut√°vel.
Responda SOMENTE JSON puro, sem explica√ß√£o, sem markdown.

A√ß√µes permitidas:
- add_expense
- add_fixed_expense
- add_fixed_investment
- mark_paid
- mark_pending
- remove_expense
- remove_fixed_expense
- remove_fixed_investment
- add_saved
- change_theme
- generate_month_pdf
- generate_year_summary_pdf
- show_summary
- request_notifications
- unknown

Regras:
1) Sempre devolva um √∫nico objeto JSON.
2) Se faltar algo essencial, preencha com o melhor palpite.
3) Se n√£o entender, use {"action":"unknown","raw":"...","reason":"..."}.
4) Para "change_theme", voc√™ pode usar:
   {"action":"change_theme","preset":"purple","accent":"#aa6eff"}
5) Para "generate_month_pdf", use month no formato YYYY-MM.
6) Para "generate_year_summary_pdf", use year no formato YYYY.
7) Para "mark_paid" e "mark_pending", use "target".
8) Para remover, use "target".
9) Para add_saved, use "amount" e "desc".
10) Para add_fixed_investment, use:
   {"action":"add_fixed_investment","name":"...","goalAmount":3000,"months":12,"dueDay":10}
11) Para add_fixed_expense, use:
   {"action":"add_fixed_expense","desc":"...","amount":99,"category":"Casa","dueDay":11}
12) Para add_expense, use:
   {"action":"add_expense","desc":"...","amount":50,"category":"Alimenta√ß√£o","paid":true}

Contexto do app:
${JSON.stringify(context, null, 2)}

Pedido do usu√°rio:
${userText}
`.trim();
}

function extractJsonFromText(text){
  const raw = String(text || "").trim();
  try{
    return JSON.parse(raw);
  }catch(e){}

  const match = raw.match(/\{[\s\S]*\}/);
  if(match){
    try{
      return JSON.parse(match[0]);
    }catch(e){}
  }
  throw new Error("A IA n√£o retornou JSON v√°lido.");
}

async function askAIToInterpret(userText, all){
  const base = (window.API_BASE_URL || "").replace(/\/$/, "");
  if(!base) throw new Error("API_BASE_URL n√£o configurada.");

  const prompt = buildVoiceAIPrompt(userText, all);

  const resp = await fetch(base + "/api/chat", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-app-key": window.APP_KEY || ""
    },
    body: JSON.stringify({ prompt }),
    cache: "no-store"
  });

  if(!resp.ok){
    const txt = await resp.text().catch(()=> "");
    throw new Error(`Falha na IA (${resp.status}): ${txt || "sem detalhe"}`);
  }

  const data = await resp.json();
  const aiText = data.response || data.text || data.message || "";
  setRawBox(aiText);
  return extractJsonFromText(aiText);
}

async function testAI(){
  try{
    const all = loadState();
    setResult("Testando IA...");
    const out = await askAIToInterpret("anota que paguei 35 no mercado hoje", all);
    setResult(`<span class="ok">IA respondeu JSON.</span><br><br><pre style="white-space:pre-wrap">${escapeHtml(JSON.stringify(out, null, 2))}</pre>`);
  }catch(e){
    setResult(`<span class="err">Falha no teste da IA.</span><br><br>${escapeHtml(e.message || String(e))}`);
  }
}

/* =========================
   EXECU√á√ÉO DAS A√á√ïES
========================= */

async function executeParsedAction(parsed, all){
  const action = String(parsed.action || "").trim();
  const month = parsed.month || currentMonthKey();
  const d = ensureMonthItems(all, month);

  if(action === "unknown" || !action){
    return { ok:false, html:`A IA n√£o conseguiu identificar a a√ß√£o.<br><br>${escapeHtml(parsed.reason || "Sem motivo informado.")}` };
  }

  if(action === "show_summary"){
    return { ok:true, html: monthSummaryHtml(all, month) };
  }

  if(action === "request_notifications"){
    requestNotificationPermission();
    return { ok:true, html:`Abrindo permiss√£o de <b>notifica√ß√µes</b>.` };
  }

  if(action === "add_saved"){
    const amount = Number(parsed.amount || 0);
    const desc = titleCase(parsed.desc || "Guardado");
    if(!amount || amount <= 0) return { ok:false, html:"A√ß√£o add_saved veio sem valor v√°lido." };
    d.saved.unshift({ value:amount, desc, date:todayISO(), source:"manual" });
    saveState(all);
    return { ok:true, html:`Valor guardado anotado:<br>‚Ä¢ Valor: <b>${money(amount)}</b><br>‚Ä¢ Descri√ß√£o: <b>${escapeHtml(desc)}</b>` };
  }

  if(action === "add_expense"){
    const desc = titleCase(parsed.desc || "Gasto");
    const amount = Number(parsed.amount || 0);
    const category = parsed.category ? titleCase(parsed.category) : "Outros";
    const paid = !!parsed.paid;
    if(!amount || amount <= 0) return { ok:false, html:"A√ß√£o add_expense veio sem valor v√°lido." };
    d.items.push({
      id: uid(),
      desc,
      amount,
      category,
      isFixo:false,
      isInvestFixo:false,
      paid
    });
    saveState(all);
    return { ok:true, html:`Gasto adicionado pela IA:<br>‚Ä¢ <b>${escapeHtml(desc)}</b><br>‚Ä¢ Valor: <b>${money(amount)}</b><br>‚Ä¢ Categoria: <b>${escapeHtml(category)}</b><br>‚Ä¢ Status: <b>${paid ? "Pago" : "Pendente"}</b>` };
  }

  if(action === "add_fixed_expense"){
    const desc = titleCase(parsed.desc || "Fixo");
    const amount = Number(parsed.amount || 0);
    const category = parsed.category ? titleCase(parsed.category) : "Outros";
    const dueDay = Number(parsed.dueDay || 0);
    if(!amount || amount <= 0) return { ok:false, html:"A√ß√£o add_fixed_expense veio sem valor v√°lido." };

    all.fixos.push({
      id: uid(),
      desc,
      amount,
      category,
      diaPagar: dueDay || 0,
      isFixo:true
    });
    saveState(all);
    return { ok:true, html:`Gasto fixo adicionado pela IA:<br>‚Ä¢ <b>${escapeHtml(desc)}</b><br>‚Ä¢ Valor: <b>${money(amount)}</b><br>‚Ä¢ Categoria: <b>${escapeHtml(category)}</b><br>‚Ä¢ Vence: <b>${dueDay ? ("dia " + dueDay) : "sem prazo"}</b>` };
  }

  if(action === "add_fixed_investment"){
    const name = titleCase(parsed.name || parsed.desc || "Investimento");
    const goalAmount = Number(parsed.goalAmount || parsed.metaFinal || 0);
    const months = Number(parsed.months || parsed.prazoMeses || 0);
    const dueDay = Number(parsed.dueDay || 0);
    if(!goalAmount || goalAmount <= 0) return { ok:false, html:"A√ß√£o add_fixed_investment veio sem meta v√°lida." };
    if(!months || months <= 0) return { ok:false, html:"A√ß√£o add_fixed_investment veio sem prazo v√°lido." };

    const mensal = Math.round((goalAmount / months) * 100) / 100;
    const id = uid();
    all.investFixos.push({
      id,
      nome:name,
      metaFinal:goalAmount,
      prazoMeses:months,
      mensal,
      diaPagar:dueDay || 0
    });
    const dm = ensureMonthItems(all, currentMonthKey());
    dm.investStatus[id] = false;
    saveState(all);
    return { ok:true, html:`Investimento fixo adicionado pela IA:<br>‚Ä¢ <b>${escapeHtml(name)}</b><br>‚Ä¢ Meta: <b>${money(goalAmount)}</b><br>‚Ä¢ Prazo: <b>${months} meses</b><br>‚Ä¢ Mensal: <b>${money(mensal)}</b>` };
  }

  if(action === "mark_paid"){
    const target = parsed.target || parsed.desc || "";
    const item = findCurrentMonthItemByName(all, target, currentMonthKey());
    if(!item) return { ok:false, html:`N√£o encontrei item para marcar como pago: <b>${escapeHtml(target)}</b>` };
    item.paid = true;
    const dc = ensureMonthItems(all, currentMonthKey());
    if(item.isInvestFixo && item.invId){
      dc.investStatus[item.invId] = true;
      const exists = dc.saved.some(s => s && s.source==="investFixo" && s.invId===item.invId && s.month===currentMonthKey());
      if(!exists){
        dc.saved.unshift({
          value:Number(item.amount || 0),
          desc:`Autom√°tico: ${item.desc}`,
          date:todayISO(),
          source:"investFixo",
          invId:item.invId,
          month:currentMonthKey()
        });
      }
    }
    saveState(all);
    return { ok:true, html:`Item <b>${escapeHtml(item.desc)}</b> marcado como <b>Pago</b>.` };
  }

  if(action === "mark_pending"){
    const target = parsed.target || parsed.desc || "";
    const item = findCurrentMonthItemByName(all, target, currentMonthKey());
    if(!item) return { ok:false, html:`N√£o encontrei item para voltar a pendente: <b>${escapeHtml(target)}</b>` };
    item.paid = false;
    const dc = ensureMonthItems(all, currentMonthKey());
    if(item.isInvestFixo && item.invId){
      dc.investStatus[item.invId] = false;
      dc.saved = dc.saved.filter(s => !(s && s.source==="investFixo" && s.invId===item.invId && s.month===currentMonthKey()));
    }
    saveState(all);
    return { ok:true, html:`Item <b>${escapeHtml(item.desc)}</b> voltou para <b>Pendente</b>.` };
  }

  if(action === "remove_expense"){
    const target = parsed.target || parsed.desc || "";
    const idx = d.items.findIndex(it => !it.isFixo && (normalizeText(it.desc).includes(normalizeText(target)) || normalizeText(target).includes(normalizeText(it.desc))));
    if(idx === -1) return { ok:false, html:`N√£o encontrei gasto para remover: <b>${escapeHtml(target)}</b>` };
    const removed = d.items[idx];
    d.items.splice(idx,1);
    saveState(all);
    return { ok:true, html:`Gasto <b>${escapeHtml(removed.desc)}</b> removido do m√™s atual.` };
  }

  if(action === "remove_fixed_expense"){
    const target = parsed.target || parsed.desc || "";
    const idx = all.fixos.findIndex(it => normalizeText(it.desc).includes(normalizeText(target)) || normalizeText(target).includes(normalizeText(it.desc)));
    if(idx === -1) return { ok:false, html:`N√£o encontrei gasto fixo para remover: <b>${escapeHtml(target)}</b>` };
    const removed = all.fixos[idx];
    all.fixos.splice(idx,1);
    Object.keys(all.state.meses || {}).forEach(m=>{
      const dm = all.state.meses[m];
      if(dm && Array.isArray(dm.items)){
        dm.items = dm.items.filter(it => !(it.isFixo && !it.isInvestFixo && (it.id === removed.id || normalizeText(it.desc) === normalizeText(removed.desc))));
      }
    });
    saveState(all);
    return { ok:true, html:`Gasto fixo <b>${escapeHtml(removed.desc)}</b> removido do sistema.` };
  }

  if(action === "remove_fixed_investment"){
    const target = parsed.target || parsed.name || parsed.desc || "";
    const idx = all.investFixos.findIndex(it => normalizeText(it.nome).includes(normalizeText(target)) || normalizeText(target).includes(normalizeText(it.nome)));
    if(idx === -1) return { ok:false, html:`N√£o encontrei investimento fixo para remover: <b>${escapeHtml(target)}</b>` };
    const removed = all.investFixos[idx];
    all.investFixos.splice(idx,1);
    Object.keys(all.state.meses || {}).forEach(m=>{
      const dm = all.state.meses[m];
      if(dm){
        if(dm.investStatus && removed.id) delete dm.investStatus[removed.id];
        if(Array.isArray(dm.saved)) dm.saved = dm.saved.filter(s => !(s && s.source==="investFixo" && s.invId===removed.id));
        if(Array.isArray(dm.items)) dm.items = dm.items.filter(it => !(it.isInvestFixo && (it.invId === removed.id || it.id === removed.id)));
      }
    });
    saveState(all);
    return { ok:true, html:`Investimento fixo <b>${escapeHtml(removed.nome)}</b> removido do sistema.` };
  }

  if(action === "change_theme"){
    if(parsed.preset) localStorage.setItem(THEME_KEYS.preset, String(parsed.preset));
    if(parsed.accent) localStorage.setItem(THEME_KEYS.accent, String(parsed.accent));
    if(parsed.colorName){
      const c = setAccentByName(parsed.colorName);
      if(c) localStorage.setItem(THEME_KEYS.accent, c);
    }
    applyThemeToPage();
    return { ok:true, html:`Tema alterado pela IA com sucesso.` };
  }

  if(action === "generate_month_pdf"){
    const monthKey = String(parsed.month || currentMonthKey());
    await generateMonthPDF(all, monthKey);
    const label = new Date(monthKey + "-01T00:00:00").toLocaleDateString("pt-BR",{month:"long",year:"numeric"});
    return { ok:true, html:`PDF do m√™s <b>${escapeHtml(label)}</b> gerado com sucesso.` };
  }

  if(action === "generate_year_summary_pdf"){
    const year = String(parsed.year || new Date().getFullYear());
    await generateYearSummaryPDF(all, year);
    return { ok:true, html:`PDF <b>resumo do ano ${escapeHtml(year)}</b> gerado com sucesso.` };
  }

  return { ok:false, html:`A√ß√£o n√£o suportada: <b>${escapeHtml(action)}</b>` };
}

/* =========================
   FLUXO PRINCIPAL
========================= */

async function executeVoiceCommand(){
  if(!USER_ID){
    setResult(`<span class="err">Fa√ßa login primeiro.</span>`);
    return;
  }

  const cmd = lastTranscript.trim();
  if(!cmd){
    setResult(`<span class="warn">Nenhum comando para executar.</span>`);
    return;
  }

  const all = loadState();

  try{
    setResult("Analisando comando...");
    setRawBox("");

    const local = tryLocalRule(cmd, all);
    if(local){
      if(local.ok){
        setResult(`<span class="ok">Executado por regra local.</span><br><br>${local.html}`);
        dbg("Local OK: " + cmd);
      }else{
        setResult(`<span class="warn">Regra local falhou.</span><br><br>${local.html}`);
        dbg("Local falhou: " + cmd);
      }
      return;
    }

    setResult("Enviando texto para sua IA...");
    const parsed = await askAIToInterpret(cmd, all);
    const execResult = await executeParsedAction(parsed, all);

    if(execResult.ok){
      setResult(`<span class="ok">Executado pela IA.</span><br><br>${execResult.html}`);
      dbg("IA OK: " + cmd + "\nAction: " + JSON.stringify(parsed));
    }else{
      setResult(`<span class="warn">A IA respondeu, mas n√£o consegui concluir.</span><br><br>${execResult.html}`);
      dbg("IA falhou: " + cmd + "\nAction: " + JSON.stringify(parsed));
    }
  }catch(e){
    setResult(`<span class="err">Erro ao executar comando.</span><br><br>${escapeHtml(e.message || String(e))}`);
    dbg("Erro comando: " + (e.message || e));
  }
}

/* =========================
   FIREBASE
========================= */

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou.");
    return false;
  }

  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
  }catch(e){}

  auth = firebase.auth();

  auth.onAuthStateChanged((u)=>{
    USER = u || null;
    if(!USER){
      USER_ID = null;
      location.replace("./login.html");
      return;
    }

    USER_ID = USER.uid;

    const savedTheme = localStorage.getItem("theme");
    if(savedTheme === "light") document.body.classList.add("light");

    applyThemeToPage();
    dbg("Usu√°rio autenticado: " + (USER.email || USER.uid));
  });

  return true;
}

document.addEventListener("DOMContentLoaded", async ()=>{
  const ok = await initFirebase();
  if(!ok) return;
  ensureSpeech();
  applyThemeToPage();
});
</script>
</body>
</html>
