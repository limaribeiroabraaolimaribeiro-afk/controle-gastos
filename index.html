<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<script>
  window.API_BASE_URL = "https://gastospro-ai.limaribeiroabraoolimaribeiro.workers.dev";
  window.APP_KEY = "GastosPro@2026!";
</script>

<style>
:root{
  --bg:#07101f;
  --bg2:#0a1730;
  --panel:rgba(255,255,255,.07);
  --panel2:rgba(255,255,255,.10);
  --stroke:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.72);
  --accent:#5f9cff;
  --good:#39d98a;
  --warn:#ffd166;
  --danger:#ff5d5d;
  --shadow:0 18px 60px rgba(0,0,0,.42);
  --radius:22px;
  --radius2:26px;
}
.light{
  --bg:#f3f7ff;
  --bg2:#e9f0ff;
  --panel:rgba(255,255,255,.86);
  --panel2:rgba(255,255,255,.96);
  --stroke:rgba(0,0,0,.08);
  --text:#121826;
  --muted:rgba(18,24,38,.68);
  --shadow:0 18px 40px rgba(0,0,0,.10);
}

*{box-sizing:border-box}
html,body{margin:0}
body{
  min-height:100vh;
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
  background:
    radial-gradient(900px 700px at 15% 8%, rgba(86,156,255,.18), transparent 58%),
    radial-gradient(700px 600px at 80% 30%, rgba(57,217,138,.11), transparent 60%),
    radial-gradient(700px 560px at 70% 92%, rgba(255,209,102,.07), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
}
.wrap{max-width:980px;margin:auto;padding:16px;padding-bottom:120px}
.card{
  background:linear-gradient(180deg,var(--panel2),var(--panel));
  border:1px solid var(--stroke);
  border-radius:var(--radius2);
  box-shadow:var(--shadow);
  backdrop-filter:blur(16px);
  padding:14px;
}
h1,h2,h3,p{margin:0}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:700px){
  .grid2,.grid4{grid-template-columns:1fr}
}
input,select,textarea{
  width:100%;
  border:1px solid var(--stroke);
  background:rgba(6,16,34,.18);
  color:var(--text);
  border-radius:18px;
  padding:14px 16px;
  font-size:16px;
  outline:none;
}
.light input,.light select,.light textarea{background:rgba(255,255,255,.92)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.btn{
  appearance:none;border:1px solid var(--stroke);cursor:pointer;
  background:rgba(255,255,255,.10);color:var(--text);
  border-radius:20px;padding:15px 16px;font-weight:800;
  box-shadow:0 10px 24px rgba(0,0,0,.16);
}
.btn.primary{
  background:var(--accent);color:#fff;
  border-color:color-mix(in srgb,var(--accent), transparent 50%);
}
.btn.good{
  background:var(--good);color:#062114;
  border-color:color-mix(in srgb,var(--good), transparent 50%);
}
.btn.warn{
  background:var(--warn);color:#2b1d00;
  border-color:color-mix(in srgb,var(--warn), transparent 50%);
}
.btn.icon{
  width:44px;height:44px;padding:0;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.08);
  font-size:12px;color:var(--muted);
}
.badge.good{color:var(--good);background:rgba(57,217,138,.10);border-color:rgba(57,217,138,.25)}
.badge.warn{color:var(--warn);background:rgba(255,209,102,.10);border-color:rgba(255,209,102,.25)}
.topbar{
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:16px;
}
.topbar .right{display:flex;gap:12px;align-items:center}
.pill{
  display:flex;align-items:center;justify-content:center;gap:10px;
  min-width:184px;padding:16px 18px;border-radius:22px;
  background:rgba(255,255,255,.11);border:1px solid rgba(255,255,255,.16);
  box-shadow:0 12px 28px rgba(0,0,0,.18);
  font-weight:900;font-size:18px;
}
@media (max-width:700px){
  .topbar{flex-direction:column}
  .topbar .right{width:100%;justify-content:space-between}
  .pill{min-width:0;flex:1}
}
.screen{display:none}
.screen.active{display:block}
.backRow{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.sectionTitle{font-size:18px;font-weight:900;margin-bottom:10px}
.kpi{
  background:linear-gradient(180deg, rgba(57,217,138,.06), rgba(255,255,255,.04));
  border:1px solid var(--stroke);border-radius:22px;padding:14px;
}
.kpi .t{font-size:13px;color:var(--muted)}
.kpi .v{font-size:22px;font-weight:900;margin-top:6px}
.hr{height:1px;background:var(--stroke);margin:14px 0}
.note{
  background:rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  border-radius:18px;padding:12px;
}
.itemCard{
  display:flex;justify-content:space-between;gap:12px;align-items:center;
  background:rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  border-radius:22px;padding:14px;margin-bottom:10px;
}
.itemTitle{font-size:18px;font-weight:900}
.itemMeta{font-size:13px;color:var(--muted);margin-top:4px}
.listActions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.fabWrap{
  position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:12px;z-index:999;
}
.fab{
  width:78px;height:78px;border-radius:50%;
  border:1px solid rgba(255,255,255,.20);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 18px 40px rgba(0,0,0,.28);
  cursor:pointer;user-select:none;
}
.fab.ai{
  background:radial-gradient(90px 80px at 30% 18%, rgba(255,255,255,.25), transparent 60%),
             linear-gradient(135deg,#8ec0ff,#5f9cff);
  color:#062040;font-weight:1000;font-size:16px;
}
.fab.voice{
  background:radial-gradient(90px 80px at 30% 18%, rgba(255,255,255,.25), transparent 60%),
             linear-gradient(135deg,#f1c27a,#d88967);
  color:#2a1400;font-size:28px;font-weight:1000;
}
.fab.add{
  background:radial-gradient(90px 80px at 30% 18%, rgba(255,255,255,.25), transparent 60%),
             linear-gradient(135deg,#73f0b0,#39d98a);
  color:#062114;font-size:42px;font-weight:1000;
}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;
  align-items:center;justify-content:center;padding:16px;z-index:2000;
}
.modal{
  width:min(520px,100%);
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
  border:1px solid var(--stroke);border-radius:24px;box-shadow:var(--shadow);overflow:hidden;
}
.modalHeader,.modalFooter{padding:14px;border-bottom:1px solid var(--stroke)}
.modalFooter{border-bottom:0;border-top:1px solid var(--stroke);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
.modalBody{padding:14px}
.closeX{
  width:44px;height:44px;border-radius:16px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-weight:900;
}
#loading{
  min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
}
#debugBox{
  position:fixed;left:12px;right:12px;bottom:12px;background:rgba(0,0,0,.82);
  color:#fff;padding:10px;border-radius:14px;z-index:9999;font-size:12px;display:none;white-space:pre-wrap;
}
</style>
</head>
<body>

<div id="loading">
  <div class="card" style="max-width:520px;width:100%">
    <h2 style="font-size:20px;font-weight:900">Carregando‚Ä¶</h2>
    <div class="small" style="margin-top:8px">Validando login e preparando seus dados.</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1 style="font-size:28px;font-weight:1000;line-height:1.04">Controle de<br>Gastos PRO</h1>
        <div class="small" style="font-size:17px;max-width:270px;margin-top:8px">
          Aqui fica s√≥ o essencial. Para editar categorias, fixos, PDF e simuladores, use o Menu.
        </div>
      </div>
      <div class="right">
        <button class="pill" onclick="openMenu()">‚ò∞ <span>Menu</span></button>
        <button class="pill" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
      </div>
    </div>

    <div class="screen active" id="screen-home">
      <div id="homeContainer">

        <div class="card" style="padding:18px">
          <div class="sectionTitle" style="font-size:24px">Resumo do m√™s</div>

          <div class="grid2">
            <div>
              <label>M√™s</label>
              <select id="monthSelect"></select>
            </div>
            <div>
              <label>Sal√°rio</label>
              <input id="salary" type="number" placeholder="2107">
            </div>
            <div>
              <label>Meta</label>
              <input id="meta" type="number" placeholder="500">
            </div>
            <div>
              <label>Guardado (adicionar)</label>
              <input id="savedValue" type="number" placeholder="Ex: 1000">
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Descri√ß√£o do guardado (opcional)</label>
              <input id="savedDesc" placeholder="Ex: Reserva, CDB, Tesouro...">
            </div>
            <div style="display:flex;align-items:flex-end">
              <button class="btn primary" style="width:100%;font-size:18px" onclick="addSaved()">Adicionar</button>
            </div>
          </div>

          <div id="savedList" style="margin-top:12px"></div>

          <div class="row" style="margin-top:14px">
            <button class="btn primary" style="font-size:18px" onclick="saveSettings()">Salvar</button>
            <button class="btn" style="font-size:18px" onclick="openHistory()">üìÖ Hist√≥rico</button>
          </div>
        </div>

        <div class="grid4" style="margin-top:14px">
          <div class="kpi">
            <div class="t">Sal√°rio</div>
            <div class="v" id="kpiSalary">R$ 0,00</div>
          </div>
          <div class="kpi">
            <div class="t">Gasto</div>
            <div class="v" id="kpiSpent">R$ 0,00</div>
          </div>
          <div class="kpi">
            <div class="t">Sobra</div>
            <div class="v" id="kpiLeft">R$ 0,00</div>
          </div>
          <div class="kpi">
            <div class="t">Guardado</div>
            <div class="v" id="kpiSaved">R$ 0,00</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 style="font-size:16px;margin-bottom:10px">Gastos por categoria</h3>
          <canvas id="chart" style="width:100%;height:220px"></canvas>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 style="font-size:16px;margin-bottom:10px">Evolu√ß√£o</h3>
          <canvas id="chartEvolucao" style="width:100%;height:220px"></canvas>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 style="font-size:16px;margin-bottom:10px">Lista do m√™s</h3>
          <div class="small" style="font-size:14px;margin-bottom:10px">
            Toque em <b>Pendente/Pago</b> para marcar se voc√™ j√° pagou.
            <br>‚úÖ Gastos fixos e investimentos fixos podem ter <b>dia de vencimento</b>.
            <br>‚úÖ Quando faltar 3, 2, 1 dias ou vencer hoje, o app pode te avisar por <b>notifica√ß√£o</b>.
          </div>
          <div id="list"></div>
        </div>

      </div>
    </div>

    <div class="screen" id="screen-menu">
      <div class="backRow">
        <button class="btn" onclick="goHome()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Menu</div>
      </div>

      <div class="card">
        <div class="row" style="flex-direction:column;align-items:stretch">
          <button class="btn" onclick="openScreen('screen-config')">‚öôÔ∏è Configura√ß√µes</button>
          <button class="btn" onclick="openScreen('screen-simulators')">üß† Simuladores</button>
          <button class="btn" onclick="openScreen('screen-categories')">üìÇ Minhas Categorias</button>
          <button class="btn" onclick="openScreen('screen-fixos')">üìå Gastos Fixos</button>
          <button class="btn" onclick="openScreen('screen-investfixos')">üìà Investimentos Fixos</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Conta</h3>
        <div class="row">
          <div>
            <div style="font-weight:900;font-size:18px" id="userName">‚Äî</div>
            <div class="small" style="font-size:15px" id="userEmail">‚Äî</div>
          </div>
          <button class="btn" onclick="logout()">Sair</button>
        </div>
      </div>
    </div>

    <div class="screen" id="screen-config">
      <div class="backRow">
        <button class="btn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Configura√ß√µes</div>
      </div>

      <div class="card">
        <div class="row" style="flex-direction:column;align-items:stretch">
          <button class="btn" onclick="openScreen('screen-themes')">üé® Temas</button>
          <button class="btn" onclick="openPdfScreen()">üñ®Ô∏è Imprimir em PDF</button>
          <button class="btn" onclick="openHistory()">üìÖ Hist√≥rico</button>
        </div>

        <div class="hr"></div>

        <div class="note">
          <div style="font-weight:900">üîî Notifica√ß√µes</div>
          <div class="small" style="margin-top:6px">Ative aqui. Quando voc√™ cadastrar um prazo em gasto fixo ou investimento fixo, o app j√° tenta usar essa permiss√£o automaticamente.</div>
          <div style="margin-top:10px">
            <button class="btn good" onclick="requestNotificationPermission()">Ativar notifica√ß√µes</button>
          </div>
        </div>

        <div class="note" style="margin-top:12px">
          <div style="font-weight:900">üéôÔ∏è Sistema de voz</div>
          <div class="small" style="margin-top:6px">Quando bloqueado, o bot√£o de voz some da tela principal.</div>
          <div class="row" style="margin-top:10px">
            <div>
              <div class="small">Status</div>
              <div style="font-weight:900" id="voiceEnableStatus">‚Äî</div>
            </div>
            <button class="btn" id="btnToggleVoiceEnabled" onclick="toggleVoiceEnabled()">‚Äî</button>
          </div>
        </div>
      </div>
    </div>

    <div class="screen" id="screen-themes">
      <div class="backRow">
        <button class="btn" onclick="openScreen('screen-config')">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Temas</div>
      </div>

      <div class="card">
        <label>Preset</label>
        <select id="themePreset" onchange="saveThemePreset()">
          <option value="default">Padr√£o</option>
          <option value="purple">Roxo</option>
          <option value="green">Verde</option>
          <option value="sunset">P√¥r do sol</option>
          <option value="mono">Minimal</option>
        </select>

        <div class="hr"></div>

        <label>Cor dos bot√µes</label>
        <input id="accentPicker" type="color" value="#5f9cff" onchange="saveAccentColor()">

        <div style="margin-top:12px">
          <button class="btn" onclick="resetThemes()">‚Ü©Ô∏è Voltar ao padr√£o</button>
        </div>
      </div>
    </div>

    <div class="screen" id="screen-categories">
      <div class="backRow">
        <button class="btn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Minhas Categorias</div>
      </div>

      <div class="card">
        <h3 style="font-size:18px;margin-bottom:10px">Adicionar categoria</h3>
        <div class="row">
          <input id="novaCategoria" placeholder="Nome da categoria">
          <button class="btn primary" style="flex:0 0 auto" onclick="addCategoria()">Adicionar</button>
        </div>
        <div class="hr"></div>
        <div class="small">‚ö†Ô∏è O X remove a categoria. Gastos dessa categoria v√£o para ‚ÄúOutros‚Äù.</div>
        <div class="hr"></div>
        <div id="listaCategorias"></div>
      </div>
    </div>

    <div class="screen" id="screen-fixos">
      <div class="backRow">
        <button class="btn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Gastos Fixos</div>
      </div>

      <div class="card">
        <h3 style="font-size:18px;margin-bottom:10px">Adicionar gasto fixo</h3>

        <label>Descri√ß√£o</label>
        <input id="descFixo" placeholder="Casa">

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Valor</label>
            <input id="valorFixo" type="number" placeholder="750">
          </div>
          <div>
            <label>Categoria</label>
            <select id="categoriaFixo"></select>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>At√© que dia deve pagar</label>
            <input id="diaFixo" type="number" min="1" max="31" placeholder="7">
          </div>
          <div class="note">
            <div style="font-weight:900;font-size:18px">Notifica√ß√£o</div>
            <div class="small" style="margin-top:6px;font-size:14px">O app pode avisar quando faltarem 3, 2, 1 dias e no dia do vencimento.</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <button class="btn primary" style="width:100%;font-size:18px" onclick="addFixo()">Adicionar</button>
        </div>

        <div class="hr"></div>
        <div class="small">‚ö†Ô∏è O X aqui remove do sistema. Na lista do m√™s (Home), o X remove s√≥ daquele m√™s.</div>
        <div class="hr"></div>
        <div id="listaFixos"></div>
      </div>
    </div>

    <div class="screen" id="screen-investfixos">
      <div class="backRow">
        <button class="btn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Investimentos Fixos</div>
      </div>

      <div class="card">
        <h3 style="font-size:18px">Como funciona</h3>
        <div class="small" style="margin-top:6px;font-size:16px">
          Voc√™ informa <b>Nome</b>, <b>Meta final (R$)</b>, <b>Prazo (meses)</b> e <b>at√© que dia pagar</b>. O app calcula automaticamente o valor mensal.
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="font-size:18px;margin-bottom:10px">Adicionar investimento fixo</h3>

        <label>Nome</label>
        <input id="invNome" placeholder="Ex: Internet">

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Meta final (R$)</label>
            <input id="invMetaFinal" type="number" placeholder="Ex: 10000">
          </div>
          <div>
            <label>Prazo (meses)</label>
            <input id="invPrazoMeses" type="number" placeholder="12">
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>At√© que dia deve pagar</label>
            <input id="invDiaPagar" type="number" min="1" max="31" placeholder="10">
          </div>
          <div class="note">
            <div style="font-weight:900;font-size:18px">Lembrete</div>
            <div class="small" style="margin-top:6px;font-size:14px">O app avisa quando faltar 3, 2, 1 dias e no dia do prazo.</div>
          </div>
        </div>

        <div class="note" style="margin-top:12px">
          <div style="font-weight:900;font-size:18px">Mensal autom√°tico</div>
          <div class="small" id="invResumo" style="margin-top:6px;font-size:14px">Digite o Nome.</div>
        </div>

        <div style="margin-top:14px">
          <button class="btn primary" style="width:100%;font-size:18px" onclick="addInvestFixo()">Adicionar</button>
        </div>

        <div class="hr"></div>
        <div id="listaInvestFixos"></div>
      </div>
    </div>

    <div class="screen" id="screen-simulators">
      <div class="backRow">
        <button class="btn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Simuladores</div>
      </div>

      <div class="card">
        <label>Escolha</label>
        <select id="tipoSimulacao">
          <option value="investimento">Investimento</option>
          <option value="emprestimo">Empr√©stimo / Compra</option>
        </select>

        <div class="hr"></div>

        <div id="areaInvestimento">
          <h3 style="font-size:18px;margin-bottom:10px">üìà Investimento</h3>

          <label>Tipo de investimento</label>
          <select id="investTipo">
            <option value="poupanca">Poupan√ßa (estimativa)</option>
            <option value="cdb">CDB/LCI/LCA (% do CDI)</option>
            <option value="tesouro">Tesouro Selic (estimativa)</option>
            <option value="fixo">Taxa fixa mensal (%)</option>
          </select>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label id="investExtraLabel">Par√¢metro</label>
              <input id="investExtraValue" type="number" placeholder="Ex: 100">
            </div>
            <div class="note">
              <div class="small" id="investHint">Escolha o tipo para ver o par√¢metro.</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Valor inicial</label>
              <input id="valorInvestimento" type="number" placeholder="Ex: 1000">
            </div>
            <div>
              <label>Meses</label>
              <input id="mesesInvestimento" type="number" placeholder="Ex: 12">
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Aporte mensal</label>
              <input id="aporteMensalInvest" type="number" placeholder="Ex: 300">
            </div>
            <div>
              <label>Vai colocar esse valor todo m√™s?</label>
              <select id="aporteRecorrenteInvest">
                <option value="nao">N√£o</option>
                <option value="sim">Sim</option>
              </select>
            </div>
          </div>

          <div style="margin-top:14px">
            <button class="btn primary" style="width:100%" onclick="simularInvestimento()">Calcular</button>
          </div>
          <div id="resultadoInvestimento" style="margin-top:12px;font-weight:900"></div>
        </div>

        <div id="areaEmprestimo" style="display:none">
          <h3 style="font-size:18px;margin-bottom:10px">üí≥ Empr√©stimo / Compra</h3>

          <label>Modelo</label>
          <select id="loanTipo">
            <option value="price">PRICE (parcela fixa)</option>
            <option value="sac">SAC (parcela decrescente)</option>
          </select>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Valor</label>
              <input id="loanValor" type="number" placeholder="Ex: 10000">
            </div>
            <div>
              <label>Parcelas</label>
              <input id="loanParcelas" type="number" placeholder="Ex: 24">
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Juros mensal (%)</label>
              <input id="loanJuros" type="number" placeholder="Ex: 2.5">
            </div>
            <div class="note">
              <div class="small">O sistema considera sal√°rio, gastos e meta.</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <button class="btn primary" style="width:100%" onclick="simularEmprestimo()">Calcular</button>
          </div>
          <div id="resultadoEmprestimo" style="margin-top:12px;font-weight:900"></div>
          <div id="tabelaEmprestimo" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div class="screen" id="screen-history">
      <div class="backRow">
        <button class="btn" onclick="goHome()">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Hist√≥rico</div>
      </div>

      <div class="card">
        <h3 style="font-size:18px;margin-bottom:10px">Seus meses salvos</h3>
        <div class="small">Toque em um m√™s para abrir na tela principal. Use o ‚úï para deletar o m√™s do hist√≥rico.</div>
        <div class="hr"></div>
        <div id="historyList"></div>
      </div>
    </div>

    <div class="screen" id="screen-pdf">
      <div class="backRow">
        <button class="btn" onclick="openScreen('screen-config')">‚Üê Voltar</button>
        <div style="font-size:18px;font-weight:900">Imprimir em PDF</div>
      </div>

      <div class="card">
        <label>Ano</label>
        <select id="pdfYear"></select>

        <div style="margin-top:12px">
          <label>M√™s do relat√≥rio</label>
          <select id="pdfMonth"></select>
        </div>

        <div class="row" style="margin-top:14px">
          <button class="btn" onclick="gerarPDFResumoAno()">üìò Resumo do ano</button>
          <button class="btn primary" onclick="gerarPDFCompleto()">üìÑ PDF do m√™s</button>
        </div>

        <div class="small" id="pdfStatus" style="margin-top:10px"></div>
      </div>
    </div>

  </div>

  <div class="fabWrap">
    <div class="fab ai" onclick="openIA()">IAPRO</div>
    <div class="fab voice" id="fabVoice" onclick="openVoicePage()">üéôÔ∏è</div>
    <div class="fab add" onclick="openAddExpense()">+</div>
  </div>
</div>

<div id="debugBox"></div>

<div class="overlay" id="overlay-addExpense">
  <div class="modal">
    <div class="modalHeader row" style="justify-content:space-between">
      <div style="font-weight:900;font-size:18px">‚ûï Adicionar gasto</div>
      <div class="closeX" onclick="closeModal('overlay-addExpense')">‚úï</div>
    </div>
    <div class="modalBody">
      <label>Descri√ß√£o</label>
      <input id="mDesc" placeholder="Ex: Mercado">
      <div class="grid2" style="margin-top:12px">
        <div>
          <label>Valor</label>
          <input id="mValor" type="number" placeholder="Ex: 120.50">
        </div>
        <div>
          <label>Categoria</label>
          <select id="mCategoria"></select>
        </div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" onclick="closeModal('overlay-addExpense')">Cancelar</button>
      <button class="btn good" onclick="confirmAddExpense()">Adicionar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

let auth = null;
let USER = null;
let USER_ID = null;
let categorias = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Investimentos","Outros"];
let fixos = [];
let investFixos = [];
let state = { meses:{} };
let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;
let graficoEvolucao = null;

const NOTIF_KEYS = { sentPrefix: "notif_sent_v1" };
const THEME_KEYS = { preset: "theme_preset_v1", accent: "theme_accent_v1" };

const THEME_PRESETS = {
  default:{ dark:{bg:"#07101f"}, light:{bg:"#f3f7ff"} },
  purple:{ dark:{bg:"#0e0b21"}, light:{bg:"#faf7ff"} },
  green:{ dark:{bg:"#081711"}, light:{bg:"#f6fff9"} },
  sunset:{ dark:{bg:"#1a0c0a"}, light:{bg:"#fff8f2"} },
  mono:{ dark:{bg:"#05070c"}, light:{bg:"#fff"} }
};

function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});

function money(n){ return Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
function normalizeText(s){ return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim(); }
function titleCase(s){ return String(s||"").split(" ").filter(Boolean).map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(" "); }
function monthLabel(m){ return new Date(m + "-01T00:00:00").toLocaleDateString("pt-BR",{month:"short",year:"numeric"}); }
function onlyMonthLabel(m){ return new Date(m + "-01T00:00:00").toLocaleDateString("pt-BR",{month:"short"}); }

function showLoading(){ document.getElementById("app").style.display="none"; document.getElementById("loading").style.display="flex"; }
function showApp(){ document.getElementById("loading").style.display="none"; document.getElementById("app").style.display="block"; }
function openModal(id){ const el=document.getElementById(id); if(el) el.style.display="flex"; }
function closeModal(id){ const el=document.getElementById(id); if(el) el.style.display="none"; }

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
}
function goHome(){ showScreen("screen-home"); }
function openMenu(){ showScreen("screen-menu"); }
function openScreen(id){ showScreen(id); }
function openHistory(){ buildHistoryUI(); showScreen("screen-history"); }
function openPdfScreen(){ buildPdfSelectors(); showScreen("screen-pdf"); }

function openIA(){ if(!USER_ID) return alert("Fa√ßa login primeiro"); location.href="./ia.html"; }
function openVoicePage(){ if(!USER_ID) return alert("Fa√ßa login primeiro"); location.href="./voz.html"; }

function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
  applyThemeSettings();
}
function applyThemeSettings(){
  const preset = localStorage.getItem(THEME_KEYS.preset) || "default";
  const accent = localStorage.getItem(THEME_KEYS.accent) || "#5f9cff";
  const p = THEME_PRESETS[preset] || THEME_PRESETS.default;
  const mode = document.body.classList.contains("light") ? "light" : "dark";
  document.documentElement.style.setProperty("--accent", accent);
  document.documentElement.style.setProperty("--bg", p[mode].bg);
  document.documentElement.style.setProperty("--bg2", p[mode].bg);
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta) meta.setAttribute("content", accent);
  const tp = document.getElementById("themePreset");
  const ac = document.getElementById("accentPicker");
  if(tp) tp.value = preset;
  if(ac) ac.value = accent;
}
function saveThemePreset(){ localStorage.setItem(THEME_KEYS.preset, document.getElementById("themePreset").value); applyThemeSettings(); }
function saveAccentColor(){ localStorage.setItem(THEME_KEYS.accent, document.getElementById("accentPicker").value); applyThemeSettings(); }
function resetThemes(){ localStorage.removeItem(THEME_KEYS.preset); localStorage.removeItem(THEME_KEYS.accent); applyThemeSettings(); }

function kMes(){ return "gastos_pro_state_" + USER_ID; }
function kCat(){ return "categorias_" + USER_ID; }
function kFix(){ return "fixos_" + USER_ID; }
function kInv(){ return "inv_fixos_" + USER_ID; }
function kVoiceEnabled(){ return `voice_enabled_v1_${USER_ID || "guest"}`; }

function loadAll(){
  try{ const raw = localStorage.getItem(kMes()); if(raw) state = JSON.parse(raw) || { meses:{} }; }catch(e){}
  try{ const raw = localStorage.getItem(kCat()); if(raw) categorias = JSON.parse(raw) || categorias; }catch(e){}
  try{ const raw = localStorage.getItem(kFix()); if(raw) fixos = JSON.parse(raw) || []; }catch(e){}
  try{ const raw = localStorage.getItem(kInv()); if(raw) investFixos = JSON.parse(raw) || []; }catch(e){}
  if(!state.meses) state.meses = {};
}
function saveAll(){
  localStorage.setItem(kMes(), JSON.stringify(state));
  localStorage.setItem(kCat(), JSON.stringify(categorias));
  localStorage.setItem(kFix(), JSON.stringify(fixos));
  localStorage.setItem(kInv(), JSON.stringify(investFixos));
}
function getDataMes(m){
  const key = m || mesAtual;
  if(!state.meses[key]) state.meses[key] = { salary:0, meta:0, items:[], saved:[], investStatus:{}, hiddenFixos:[] };
  const d = state.meses[key];
  if(!Array.isArray(d.items)) d.items = [];
  if(!Array.isArray(d.saved)) d.saved = [];
  if(!Array.isArray(d.hiddenFixos)) d.hiddenFixos = [];
  if(!d.investStatus) d.investStatus = {};
  return d;
}

function buildMonthSelect(){
  const sel = document.getElementById("monthSelect");
  const set = new Set(Object.keys(state.meses || {}));
  const now = new Date();
  for(let i=0;i<36;i++){
    const dt = new Date(now.getFullYear(), now.getMonth()-i, 1);
    set.add(dt.toISOString().slice(0,7));
  }
  const months = Array.from(set).sort().reverse();
  sel.innerHTML = months.map(m=>`<option value="${m}">${monthLabel(m)}</option>`).join("");
  if(!months.includes(mesAtual)) mesAtual = months[0] || new Date().toISOString().slice(0,7);
  sel.value = mesAtual;
  sel.onchange = ()=>{ mesAtual = sel.value; render(); };
}
function buildPdfSelectors(){
  const yearSel = document.getElementById("pdfYear");
  const monthSel = document.getElementById("pdfMonth");
  const months = Object.keys(state.meses || {}).sort().reverse();
  const years = Array.from(new Set(months.map(m=>m.slice(0,4)).concat([String(new Date().getFullYear())]))).sort().reverse();
  yearSel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
  monthSel.innerHTML = months.map(m=>`<option value="${m}">${monthLabel(m)}</option>`).join("");
  yearSel.value = mesAtual.slice(0,4);
  if(months.length) monthSel.value = mesAtual;
}

function renderCategorias(){
  const div = document.getElementById("listaCategorias");
  const selF = document.getElementById("categoriaFixo");
  const selM = document.getElementById("mCategoria");

  div.innerHTML = categorias.map((c,idx)=>`
    <div class="itemCard">
      <div style="font-weight:900">‚Ä¢ ${escapeHtml(c)}</div>
      <button class="btn icon" ${normalizeText(c)==="investimentos" ? "disabled" : ""} onclick="removeCategoria(${idx})">‚úï</button>
    </div>
  `).join("");

  const opts = categorias.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  if(selF) selF.innerHTML = opts;
  if(selM) selM.innerHTML = opts;
}
function addCategoria(){
  const input = document.getElementById("novaCategoria");
  const nome = titleCase((input.value||"").trim());
  if(!nome) return alert("Digite o nome da categoria.");
  if(categorias.some(c=>normalizeText(c)===normalizeText(nome))) return alert("Essa categoria j√° existe.");
  categorias.push(nome);
  input.value = "";
  saveAll();
  renderCategorias();
}
function removeCategoria(idx){
  const cat = categorias[idx];
  if(!cat || normalizeText(cat)==="investimentos") return;
  if(!confirm(`Remover a categoria "${cat}"?`)) return;
  categorias.splice(idx,1);
  fixos = fixos.map(f=>normalizeText(f.category||"")===normalizeText(cat) ? {...f, category:"Outros"} : f);
  Object.keys(state.meses||{}).forEach(m=>{
    const d = getDataMes(m);
    d.items = d.items.map(it=>normalizeText(it.category||"")===normalizeText(cat) ? {...it, category:"Outros"} : it);
  });
  saveAll();
  renderCategorias();
  renderFixos();
  render();
}

function renderFixos(){
  const div = document.getElementById("listaFixos");
  div.innerHTML = fixos.length ? fixos.map((f,idx)=>`
    <div class="itemCard">
      <div>
        <div class="itemTitle">${escapeHtml(f.desc)}</div>
        <div class="itemMeta">${money(f.amount)} <span class="badge">${escapeHtml(f.category)}</span></div>
        <div class="itemMeta">Vence: <b>${f.diaPagar ? "dia " + escapeHtml(f.diaPagar) : "sem prazo"}</b></div>
      </div>
      <button class="btn icon" onclick="removeFixo(${idx})">‚úï</button>
    </div>
  `).join("") : `<div class="small">Nenhum gasto fixo cadastrado.</div>`;
}
function addFixo(){
  const desc = (document.getElementById("descFixo").value||"").trim();
  const amount = Number(document.getElementById("valorFixo").value||0);
  const category = document.getElementById("categoriaFixo").value || "Outros";
  const diaPagar = Number(document.getElementById("diaFixo").value||0);
  if(!desc) return alert("Digite a descri√ß√£o.");
  if(!amount || amount<=0) return alert("Digite um valor v√°lido.");
  if(diaPagar && (diaPagar<1 || diaPagar>31)) return alert("Dia inv√°lido.");
  fixos.push({ id:uid(), desc, amount, category, diaPagar });
  document.getElementById("descFixo").value="";
  document.getElementById("valorFixo").value="";
  document.getElementById("diaFixo").value="";
  saveAll();
  renderFixos();
  render();
  if(diaPagar) autoEnableNotificationsIfNeeded();
}
function removeFixo(idx){
  const item = fixos[idx];
  if(!item) return;
  Object.keys(state.meses||{}).forEach(m=>{
    const d = getDataMes(m);
    d.items = d.items.filter(it=>!(it.isFixo && !it.isInvestFixo && (it.id===item.id || (it.desc===item.desc && Number(it.amount||0)===Number(item.amount||0) && it.category===item.category))));
  });
  fixos.splice(idx,1);
  saveAll();
  renderFixos();
  render();
}

function calcMensal(meta,prazo){
  meta=Number(meta||0); prazo=Number(prazo||0);
  if(!meta || !prazo || prazo<=0) return 0;
  return Math.round((meta/prazo)*100)/100;
}
function updateInvResumo(){
  const nome = (document.getElementById("invNome").value||"").trim();
  const meta = Number(document.getElementById("invMetaFinal").value||0);
  const prazo = Number(document.getElementById("invPrazoMeses").value||0);
  const dia = Number(document.getElementById("invDiaPagar").value||0);
  const el = document.getElementById("invResumo");
  if(!nome){ el.textContent = "Digite o Nome."; return; }
  if(!meta){ el.textContent = "Digite a Meta final."; return; }
  if(!prazo){ el.textContent = "Digite o Prazo."; return; }
  const mensal = calcMensal(meta,prazo);
  el.textContent = `Meta ${money(meta)} ‚Ä¢ Prazo ${prazo} meses ‚Ä¢ Mensal ${money(mensal)}${dia ? ` ‚Ä¢ Dia ${dia}` : ""}`;
}
function renderInvestFixos(){
  const div = document.getElementById("listaInvestFixos");
  div.innerHTML = investFixos.length ? investFixos.map((inv,idx)=>`
    <div class="itemCard">
      <div>
        <div class="itemTitle">${escapeHtml(inv.nome)}</div>
        <div class="itemMeta">Meta: ${money(inv.metaFinal)} ‚Ä¢ Prazo: ${escapeHtml(inv.prazoMeses)} meses</div>
        <div class="itemMeta">Mensal: <b>${money(inv.mensal)}</b> ‚Ä¢ Prazo: <b>${inv.diaPagar ? "dia " + escapeHtml(inv.diaPagar) : "‚Äî"}</b></div>
      </div>
      <button class="btn icon" onclick="removeInvestFixo(${idx})">‚úï</button>
    </div>
  `).join("") : `<div class="small">Nenhum investimento fixo cadastrado.</div>`;
}
function addInvestFixo(){
  const nome = (document.getElementById("invNome").value||"").trim();
  const metaFinal = Number(document.getElementById("invMetaFinal").value||0);
  const prazoMeses = Number(document.getElementById("invPrazoMeses").value||0);
  const diaPagar = Number(document.getElementById("invDiaPagar").value||0);
  if(!nome) return alert("Digite o nome.");
  if(!metaFinal || metaFinal<=0) return alert("Digite a meta final.");
  if(!prazoMeses || prazoMeses<=0) return alert("Digite o prazo.");
  if(!diaPagar || diaPagar<1 || diaPagar>31) return alert("Digite o dia.");
  const mensal = calcMensal(metaFinal,prazoMeses);
  investFixos.push({ id:uid(), nome, metaFinal, prazoMeses, mensal, diaPagar });
  document.getElementById("invNome").value="";
  document.getElementById("invMetaFinal").value="";
  document.getElementById("invPrazoMeses").value="";
  document.getElementById("invDiaPagar").value="";
  updateInvResumo();
  saveAll();
  renderInvestFixos();
  render();
  autoEnableNotificationsIfNeeded();
}
function removeInvestFixo(idx){
  const inv = investFixos[idx];
  if(!inv) return;
  Object.keys(state.meses||{}).forEach(m=>{
    const d = getDataMes(m);
    d.items = d.items.filter(it=>!(it.isInvestFixo && (it.invId===inv.id || it.id===inv.id)));
    d.saved = d.saved.filter(s=>!(s && s.source==="investFixo" && s.invId===inv.id));
    if(d.investStatus) delete d.investStatus[inv.id];
  });
  investFixos.splice(idx,1);
  saveAll();
  renderInvestFixos();
  render();
}

function ensureFixedItems(d){
  if(!Array.isArray(d.items)) d.items = [];
  if(!Array.isArray(d.hiddenFixos)) d.hiddenFixos = [];
  if(!d.investStatus) d.investStatus = {};
  if(!Array.isArray(d.saved)) d.saved = [];

  const hidden = new Set(d.hiddenFixos.map(String));
  const exists = new Set(d.items.map(it => `${it.desc}|${Number(it.amount||0)}|${it.category}`));

  fixos.forEach(f=>{
    const key = `${f.desc}|${Number(f.amount||0)}|${f.category}`;
    if(hidden.has(key) || exists.has(key)) return;
    d.items.unshift({
      id:f.id, desc:f.desc, amount:Number(f.amount||0), category:f.category||"Outros",
      isFixo:true, isInvestFixo:false, diaPagar:Number(f.diaPagar||0), paid:false
    });
    exists.add(key);
  });

  investFixos.forEach(inv=>{
    const desc = `Juntar: ${inv.nome}`;
    const amount = Number(inv.mensal||0);
    const key = `${desc}|${amount}|Investimentos`;
    if(hidden.has(key) || exists.has(key)) return;
    if(typeof d.investStatus[inv.id] !== "boolean") d.investStatus[inv.id] = false;
    d.items.unshift({
      id:inv.id, invId:inv.id, desc, amount, category:"Investimentos",
      isFixo:true, isInvestFixo:true, diaPagar:Number(inv.diaPagar||0), paid:!!d.investStatus[inv.id]
    });
    exists.add(key);
  });
}

function addSaved(){
  const value = Number(document.getElementById("savedValue").value||0);
  const desc = (document.getElementById("savedDesc").value||"").trim();
  if(!value || value<=0) return alert("Digite um valor para guardar.");
  const d = getDataMes(mesAtual);
  d.saved.unshift({ value, desc, date:todayISO(), source:"manual" });
  document.getElementById("savedValue").value="";
  document.getElementById("savedDesc").value="";
  saveAll();
  render();
}
function removeSaved(idx){
  const d = getDataMes(mesAtual);
  if(!d.saved[idx]) return;
  d.saved.splice(idx,1);
  saveAll();
  render();
}
function saveSettings(){
  const d = getDataMes(mesAtual);
  d.salary = Number(document.getElementById("salary").value||0);
  d.meta = Number(document.getElementById("meta").value||0);
  saveAll();
  render();
}
function openAddExpense(){
  document.getElementById("mDesc").value="";
  document.getElementById("mValor").value="";
  document.getElementById("mCategoria").value = categorias.includes("Outros") ? "Outros" : categorias[0];
  openModal("overlay-addExpense");
}
function confirmAddExpense(){
  const desc = (document.getElementById("mDesc").value||"").trim();
  const amount = Number(document.getElementById("mValor").value||0);
  const category = document.getElementById("mCategoria").value || "Outros";
  if(!desc) return alert("Preencha a descri√ß√£o.");
  if(!amount || amount<=0) return alert("Preencha o valor.");
  const d = getDataMes(mesAtual);
  d.items.push({ id:uid(), desc, amount, category, isFixo:false, isInvestFixo:false, diaPagar:0, paid:false });
  saveAll();
  closeModal("overlay-addExpense");
  render();
}
function togglePaid(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;
  it.paid = !it.paid;
  if(it.isInvestFixo && it.invId){
    d.investStatus[it.invId] = !!it.paid;
    if(it.paid){
      const exists = d.saved.some(s=>s && s.source==="investFixo" && s.invId===it.invId && s.month===mesAtual);
      if(!exists){
        d.saved.unshift({
          value:Number(it.amount||0),
          desc:`Autom√°tico: ${it.desc}`,
          date:todayISO(),
          source:"investFixo",
          invId:it.invId,
          month:mesAtual
        });
      }
    }else{
      d.saved = d.saved.filter(s=>!(s && s.source==="investFixo" && s.invId===it.invId && s.month===mesAtual));
    }
  }
  saveAll();
  render();
}
function deleteItem(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;
  if(it.isFixo){
    const key = `${it.desc}|${Number(it.amount||0)}|${it.category}`;
    if(!d.hiddenFixos.includes(key)) d.hiddenFixos.push(key);
  }
  if(it.isInvestFixo && it.invId){
    d.saved = d.saved.filter(s=>!(s && s.source==="investFixo" && s.invId===it.invId && s.month===mesAtual));
    d.investStatus[it.invId] = false;
  }
  d.items.splice(idx,1);
  saveAll();
  render();
}

function renderSavedList(){
  const d = getDataMes(mesAtual);
  const div = document.getElementById("savedList");
  div.innerHTML = (d.saved||[]).map((s,idx)=>`
    <div class="itemCard">
      <div>
        <div class="itemTitle">üè¶ ${money(s.value)}</div>
        <div class="itemMeta">Data: ${escapeHtml(s.date || "")}${s.desc ? " ‚Ä¢ " + escapeHtml(s.desc) : ""}</div>
      </div>
      <button class="btn icon" onclick="removeSaved(${idx})">‚úï</button>
    </div>
  `).join("");
}

function renderKPIs(){
  const d = getDataMes(mesAtual);
  const spent = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
  const salary = Number(d.salary||0);
  const left = salary - spent;

  document.getElementById("salary").value = salary || "";
  document.getElementById("meta").value = d.meta || "";

  document.getElementById("kpiSalary").textContent = money(salary);
  document.getElementById("kpiSpent").textContent = money(spent);
  document.getElementById("kpiLeft").textContent = money(left);
  document.getElementById("kpiSaved").textContent = money(saved);
}
function renderList(){
  const d = getDataMes(mesAtual);
  const div = document.getElementById("list");
  if(!(d.items||[]).length){
    div.innerHTML = `<div class="small">Nenhum gasto neste m√™s. Toque em ‚Äú+‚Äù para adicionar.</div>`;
    return;
  }
  div.innerHTML = d.items.map((it,idx)=>`
    <div class="itemCard">
      <div>
        <div class="itemTitle">
          ${escapeHtml(it.desc)}
          ${it.isFixo ? `<span class="badge">Fixo</span>` : ``}
          ${it.isInvestFixo ? `<span class="badge">Juntar</span>` : ``}
        </div>
        <div class="itemMeta">
          ${money(it.amount)} ‚Ä¢ ${escapeHtml(it.category || "Outros")}
          ${it.diaPagar ? ` ‚Ä¢ Vence dia ${escapeHtml(it.diaPagar)}` : ``}
        </div>
        <div class="listActions" style="margin-top:8px">
          <button class="btn ${it.paid ? "good" : "warn"}" onclick="togglePaid(${idx})">${it.paid ? "‚úÖ Pago" : "‚è≥ Pendente"}</button>
        </div>
      </div>
      <button class="btn icon" onclick="deleteItem(${idx})">‚úï</button>
    </div>
  `).join("");
}

function drawChart(){
  const d = getDataMes(mesAtual);
  const byCat = {};
  (d.items||[]).forEach(it=>{
    const c = it.category || "Outros";
    byCat[c] = (byCat[c]||0) + Number(it.amount||0);
  });
  const labels = Object.keys(byCat);
  const values = Object.values(byCat);
  if(grafico) grafico.destroy();
  grafico = new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{ labels, datasets:[{ data: values }] },
    options:{ plugins:{ legend:{ labels:{ color:getComputedStyle(document.body).getPropertyValue("--text") } } } }
  });
}
function drawEvolution(){
  const months = Object.keys(state.meses||{}).sort();
  const values = months.map(m=>{
    const d = getDataMes(m);
    return (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  });
  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao = new Chart(document.getElementById("chartEvolucao"),{
    type:"line",
    data:{ labels: months.map(onlyMonthLabel), datasets:[{ data: values }] },
    options:{ plugins:{ legend:{ display:false } } }
  });
}

function buildHistoryUI(){
  const div = document.getElementById("historyList");
  const months = Object.keys(state.meses||{}).sort().reverse();
  div.innerHTML = months.length ? months.map(m=>{
    const d = getDataMes(m);
    const total = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
    const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
    const sobra = Number(d.salary||0) - total;
    return `
      <div class="itemCard" onclick="openMonthFromHistory('${m}')" style="cursor:pointer">
        <div>
          <div class="itemTitle" style="text-transform:capitalize">${escapeHtml(monthLabel(m))}</div>
          <div class="itemMeta">Sal√°rio: ${money(d.salary||0)} ‚Ä¢ Gasto: ${money(total)} ‚Ä¢ Guardado: ${money(saved)} ‚Ä¢ Sobra: ${money(sobra)}</div>
        </div>
        <button class="btn icon" onclick="event.stopPropagation(); deleteMonth('${m}')">‚úï</button>
      </div>
    `;
  }).join("") : `<div class="small">Nenhum m√™s salvo ainda.</div>`;
}
function openMonthFromHistory(m){
  mesAtual = m;
  goHome();
  render();
}
function deleteMonth(m){
  if(!confirm("Deletar este m√™s do hist√≥rico?")) return;
  delete state.meses[m];
  saveAll();
  buildMonthSelect();
  buildHistoryUI();
  render();
}

function updateInvestUI(){
  const tipo = document.getElementById("investTipo").value;
  const lab = document.getElementById("investExtraLabel");
  const hint= document.getElementById("investHint");
  const val = document.getElementById("investExtraValue");

  if(tipo==="poupanca"){
    lab.textContent = "Taxa mensal (%)";
    hint.textContent = "Ex.: 0,5% ao m√™s.";
    if(!val.value) val.value = "0.5";
  }else if(tipo==="cdb"){
    lab.textContent = "% do CDI";
    hint.textContent = "Ex.: 100% CDI.";
    if(!val.value) val.value = "100";
  }else if(tipo==="tesouro"){
    lab.textContent = "Taxa mensal (%)";
    hint.textContent = "Ex.: 0,9% ao m√™s.";
    if(!val.value) val.value = "0.9";
  }else{
    lab.textContent = "Taxa fixa mensal (%)";
    hint.textContent = "Ex.: 1,2% ao m√™s.";
    if(!val.value) val.value = "1.2";
  }
}
function simularInvestimento(){
  const tipo = document.getElementById("investTipo").value;
  const valor = Number(document.getElementById("valorInvestimento").value||0);
  const meses = Number(document.getElementById("mesesInvestimento").value||0);
  const extra = Number(document.getElementById("investExtraValue").value||0);
  const aporte = Number(document.getElementById("aporteMensalInvest").value||0);
  const recorrente = document.getElementById("aporteRecorrenteInvest").value === "sim";
  if(!valor || valor<=0) return alert("Informe o valor inicial.");
  if(!meses || meses<=0) return alert("Informe os meses.");

  let taxa = 0;
  if(tipo==="poupanca") taxa = (extra||0.5)/100;
  else if(tipo==="cdb") taxa = 0.009*((extra||100)/100);
  else if(tipo==="tesouro") taxa = (extra||0.9)/100;
  else taxa = (extra||1.2)/100;

  let total = valor;
  for(let i=1;i<=meses;i++){
    total = total * (1 + taxa);
    if(recorrente && aporte > 0) total += aporte;
  }
  const investido = valor + (recorrente ? aporte*meses : 0);
  const lucro = total - investido;
  document.getElementById("resultadoInvestimento").innerHTML =
    `Valor final: <span style="color:var(--good)">${money(total)}</span><br>` +
    `Valor investido: <b>${money(investido)}</b><br>` +
    `Lucro estimado: <span style="color:var(--good)">${money(lucro)}</span>`;
}
function simularEmprestimo(){
  const modelo = document.getElementById("loanTipo").value;
  const valor = Number(document.getElementById("loanValor").value||0);
  const n = Number(document.getElementById("loanParcelas").value||0);
  const juros = Number(document.getElementById("loanJuros").value||0)/100;
  if(!valor || valor<=0) return alert("Informe o valor.");
  if(!n || n<=0) return alert("Informe as parcelas.");
  const d = getDataMes(mesAtual);
  const gastos = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const salario = Number(d.salary||0);

  let primeira=0,totalPago=0,rows="";
  if(modelo==="price"){
    const p = juros===0 ? valor/n : (valor * (juros / (1 - Math.pow(1+juros, -n))));
    primeira = p; totalPago = p*n;
    for(let i=1;i<=Math.min(n,12);i++) rows += `<div>Parcela ${i}: <b>${money(p)}</b></div>`;
  }else{
    const amort = valor/n; let saldo = valor;
    for(let i=1;i<=n;i++){
      const parcela = amort + saldo*juros;
      if(i===1) primeira = parcela;
      totalPago += parcela; saldo -= amort;
      if(i<=12) rows += `<div>Parcela ${i}: <b>${money(parcela)}</b></div>`;
    }
  }
  const sobra = salario - gastos - primeira;
  document.getElementById("resultadoEmprestimo").innerHTML =
    `Primeira parcela: <b>${money(primeira)}</b><br>Total pago: <b>${money(totalPago)}</b><br>Sobra ap√≥s pagar 1¬™: <b>${money(sobra)}</b>`;
  document.getElementById("tabelaEmprestimo").innerHTML = rows;
}

function requestNotificationPermission(){
  if(!("Notification" in window)) return alert("Seu navegador n√£o suporta notifica√ß√µes.");
  Notification.requestPermission().then(perm=>{
    if(perm==="granted"){
      alert("Notifica√ß√µes ativadas com sucesso.");
      checkDueNotifications();
    }else{
      alert("Notifica√ß√µes n√£o foram permitidas.");
    }
  });
}
function autoEnableNotificationsIfNeeded(){
  if(!("Notification" in window)) return;
  if(Notification.permission === "default"){
    Notification.requestPermission().then(perm=>{
      if(perm==="granted") checkDueNotifications();
    }).catch(()=>{});
  }else if(Notification.permission === "granted"){
    checkDueNotifications();
  }
}
function daysUntilDue(day, baseDate = new Date()){
  const y = baseDate.getFullYear();
  const m = baseDate.getMonth();
  const maxDay = new Date(y, m+1, 0).getDate();
  const dueDay = Math.min(Math.max(Number(day||1),1), maxDay);
  const today = new Date(y, m, baseDate.getDate());
  const due = new Date(y, m, dueDay);
  return Math.floor((due.getTime() - today.getTime()) / 86400000);
}
function showBrowserNotification(title, body){
  if(!("Notification" in window)) return;
  if(Notification.permission !== "granted") return;
  try{
    new Notification(title, { body, icon:"icon-192.png", badge:"icon-192.png" });
  }catch(e){}
}
function checkDueNotifications(){
  if(!("Notification" in window) || Notification.permission !== "granted") return;
  const d = getDataMes(new Date().toISOString().slice(0,7));
  ensureFixedItems(d);
  d.items.forEach(it=>{
    if(!it.isFixo || !it.diaPagar || it.paid) return;
    const diff = daysUntilDue(it.diaPagar);
    if(diff < 0 || diff > 3) return;
    const key = `${NOTIF_KEYS.sentPrefix}_${USER_ID}_${it.id}_${new Date().toISOString().slice(0,7)}_${diff}`;
    if(localStorage.getItem(key)==="1") return;
    const msg = diff===0
      ? `O prazo para pagar ${it.desc} √© hoje.`
      : `O prazo para pagar ${it.desc} est√° chegando. Faltam ${diff} dias.`;
    showBrowserNotification("Controle de Gastos PRO", msg);
    localStorage.setItem(key,"1");
  });
}

function isVoiceEnabled(){ return localStorage.getItem(kVoiceEnabled()) !== "0"; }
function applyVoiceVisibility(){
  const fab = document.getElementById("fabVoice");
  const enabled = isVoiceEnabled();
  if(fab) fab.style.display = enabled ? "flex" : "none";
  const st = document.getElementById("voiceEnableStatus");
  const bt = document.getElementById("btnToggleVoiceEnabled");
  if(st) st.textContent = enabled ? "Ativado" : "Bloqueado";
  if(bt){
    bt.textContent = enabled ? "Bloquear" : "Ativar";
    bt.className = "btn " + (enabled ? "danger" : "good");
  }
}
function toggleVoiceEnabled(){
  localStorage.setItem(kVoiceEnabled(), isVoiceEnabled() ? "0" : "1");
  applyVoiceVisibility();
}

function buildCategorySummary(items){
  const byCat = {};
  (items||[]).forEach(it=>{
    const c = it.category || "Outros";
    byCat[c] = (byCat[c] || 0) + Number(it.amount||0);
  });
  return byCat;
}
function getTopCategory(items){
  const byCat = buildCategorySummary(items);
  const arr = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  return arr[0] || ["‚Äî",0];
}
function getMonthNumbers(d){
  const salary = Number(d.salary||0);
  const spent = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
  const left = salary - spent;
  return { salary, spent, saved, left };
}
function getYearSummary(year){
  const months = Object.keys(state.meses||{}).filter(m=>m.startsWith(String(year)+"-")).sort();
  const rows = [];
  const byCat = {};
  months.forEach(m=>{
    const d = getDataMes(m);
    ensureFixedItems(d);
    const nums = getMonthNumbers(d);
    rows.push({ month:m, ...nums, items:d.items, savedList:d.saved });
    d.items.forEach(it=>{
      const c = it.category || "Outros";
      byCat[c] = (byCat[c] || 0) + Number(it.amount||0);
    });
  });
  const totals = rows.reduce((acc,r)=>{
    acc.salary += r.salary;
    acc.spent += r.spent;
    acc.saved += r.saved;
    acc.left += r.left;
    return acc;
  }, {salary:0, spent:0, saved:0, left:0});
  const topCat = Object.entries(byCat).sort((a,b)=>b[1]-a[1])[0] || ["‚Äî",0];
  return { months, rows, byCat, totals, topCat };
}

async function createChartImage(labels, values, type="bar", options={}){
  const canvas = document.createElement("canvas");
  canvas.width = options.width || 1200;
  canvas.height = options.height || 520;
  const ctx = canvas.getContext("2d");
  new Chart(ctx,{
    type,
    data:{
      labels,
      datasets:[{
        data: values,
        borderWidth:2,
        tension:0.35,
        fill:false
      }]
    },
    options:{
      animation:false,
      responsive:false,
      maintainAspectRatio:false,
      plugins:{
        legend:{ display:type==="doughnut" || type==="pie" },
        title:{ display:false }
      },
      scales:(type==="line" || type==="bar") ? {
        y:{ beginAtZero:true, ticks:{ callback:(v)=>money(v) } }
      } : {}
    }
  });
  await new Promise(r=>setTimeout(r,120));
  return canvas.toDataURL("image/png");
}
async function renderPdfAndSave(wrap, filename){
  const canvas = await html2canvas(wrap, { scale:2, backgroundColor:"#ffffff", useCORS:true });
  const img = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const imgW = pageW;
  const imgH = (canvas.height * imgW) / canvas.width;
  let heightLeft = imgH;
  let position = 0;

  pdf.addImage(img,"PNG",0,position,imgW,imgH);
  heightLeft -= pageH;

  while(heightLeft > 0){
    position = heightLeft - imgH;
    pdf.addPage();
    pdf.addImage(img,"PNG",0,position,imgW,imgH);
    heightLeft -= pageH;
  }
  pdf.save(filename);
}
function pdfCardStyle(title, body){
  return `
    <div style="border:1px solid #e5e7eb;border-radius:18px;padding:14px;background:#fff;">
      <div style="font-weight:800;font-size:17px;margin-bottom:10px;color:#111827;">${title}</div>
      ${body}
    </div>
  `;
}
function createPdfBase(title, subtitle, rightInfo){
  const wrap = document.createElement("div");
  wrap.style.position = "fixed";
  wrap.style.left = "-99999px";
  wrap.style.top = "0";
  wrap.style.width = "1120px";
  wrap.style.padding = "20px";
  wrap.style.background = "#ffffff";
  wrap.style.color = "#111827";
  wrap.style.fontFamily = "Arial, sans-serif";
  wrap.style.lineHeight = "1.35";
  wrap.innerHTML = `
    <div style="border:1px solid #e5e7eb;border-radius:22px;padding:18px;background:#fff;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:18px;">
        <div>
          <div style="font-size:30px;font-weight:900;color:#111827;">${title}</div>
          <div style="margin-top:6px;font-size:13px;color:#6b7280;">${subtitle}</div>
          <div style="margin-top:3px;font-size:13px;color:#6b7280;">Usu√°rio: ${escapeHtml((USER && (USER.displayName || USER.email)) || "Usu√°rio")}</div>
        </div>
        <div style="text-align:right;font-size:13px;color:#6b7280;">
          ${rightInfo}
        </div>
      </div>
      <div id="pdfContentArea" style="margin-top:16px;"></div>
      <div style="margin-top:16px;font-size:11px;color:#9ca3af;">Observa√ß√£o: Este relat√≥rio √© um resumo do seu controle. N√£o √© recomenda√ß√£o financeira.</div>
    </div>
  `;
  document.body.appendChild(wrap);
  return wrap;
}

async function gerarPDFResumoAno(){
  const status = document.getElementById("pdfStatus");
  try{
    status.textContent = "Gerando resumo do ano‚Ä¶";
    const year = document.getElementById("pdfYear").value;
    const info = getYearSummary(year);

    if(!info.months.length){
      status.textContent = "N√£o h√° dados salvos nesse ano.";
      return;
    }

    const chartCat = Object.keys(info.byCat).length
      ? await createChartImage(Object.keys(info.byCat), Object.values(info.byCat), "doughnut", {width:900,height:460})
      : "";
    const chartLine = info.rows.length
      ? await createChartImage(info.rows.map(r=>onlyMonthLabel(r.month)), info.rows.map(r=>r.spent), "line", {width:1100,height:420})
      : "";
    const chartSaved = info.rows.length
      ? await createChartImage(info.rows.map(r=>onlyMonthLabel(r.month)), info.rows.map(r=>r.saved), "bar", {width:1100,height:420})
      : "";

    const firstMonth = info.months[0];
    const sampleMonth = getDataMes(firstMonth);
    const topRows = Object.entries(info.byCat).sort((a,b)=>b[1]-a[1]);

    const wrap = createPdfBase(
      "Relat√≥rio ‚Ä¢ Controle de Gastos PRO",
      `Ano: ${escapeHtml(year)} ‚Ä¢ Gerado em: ${escapeHtml(todayISO())}`,
      `Mais gastou no ano<br><b style="color:#111827;font-size:16px;">${escapeHtml(info.topCat[0])} ‚Ä¢ ${money(info.topCat[1])}</b>`
    );

    const area = wrap.querySelector("#pdfContentArea");
    area.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
        ${pdfCardStyle("Sal√°rio total", `<div style="font-size:28px;font-weight:900;">${money(info.totals.salary)}</div>`)}
        ${pdfCardStyle("Gastos totais", `<div style="font-size:28px;font-weight:900;">${money(info.totals.spent)}</div>`)}
        ${pdfCardStyle("Guardado total", `<div style="font-size:28px;font-weight:900;">${money(info.totals.saved)}</div>`)}
        ${pdfCardStyle("Sobra acumulada", `<div style="font-size:28px;font-weight:900;">${money(info.totals.left)}</div>`)}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        ${pdfCardStyle("Gr√°fico ‚Ä¢ Categorias do ano", chartCat ? `<img src="${chartCat}" style="width:100%;display:block;">` : `<div style="color:#6b7280;">Sem dados</div>`)}
        ${pdfCardStyle("Top categorias", `
          <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">As categorias com maior gasto no ano.</div>
          ${topRows.length ? topRows.slice(0,8).map((x,i)=>`
            <div style="display:flex;justify-content:space-between;gap:10px;padding:9px 0;border-bottom:1px solid #f0f0f0;">
              <div><b>${i+1}.</b> ${escapeHtml(x[0])}</div>
              <div style="font-weight:800;">${money(x[1])}</div>
            </div>
          `).join("") : `<div style="color:#6b7280;">Sem dados</div>`}
        `)}
      </div>

      <div style="margin-top:12px;">
        ${pdfCardStyle("Gr√°fico ‚Ä¢ Evolu√ß√£o mensal dos gastos", chartLine ? `<img src="${chartLine}" style="width:100%;display:block;">` : `<div style="color:#6b7280;">Sem dados</div>`)}
      </div>

      <div style="margin-top:12px;">
        ${pdfCardStyle("Gr√°fico ‚Ä¢ Evolu√ß√£o mensal do guardado", chartSaved ? `<img src="${chartSaved}" style="width:100%;display:block;">` : `<div style="color:#6b7280;">Sem dados</div>`)}
      </div>

      <div style="margin-top:12px;">
        ${pdfCardStyle("Tabela do ano", `
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr>
                <th style="text-align:left;padding:10px;border-bottom:1px solid #d1d5db;">M√™s</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #d1d5db;">Sal√°rio</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #d1d5db;">Gastos</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #d1d5db;">Guardado</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #d1d5db;">Sobra</th>
              </tr>
            </thead>
            <tbody>
              ${info.rows.map(r=>`
                <tr>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${escapeHtml(monthLabel(r.month))}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;">${money(r.salary)}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;">${money(r.spent)}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;">${money(r.saved)}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;">${money(r.left)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `)}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        ${pdfCardStyle("Investimentos fixos cadastrados", investFixos.length ? investFixos.map(inv=>`
          <div style="padding:9px 0;border-bottom:1px solid #f1f5f9;">
            <div style="font-weight:800;">${escapeHtml(inv.nome)}</div>
            <div style="font-size:12px;color:#6b7280;">Meta: ${money(inv.metaFinal)} ‚Ä¢ Prazo: ${escapeHtml(inv.prazoMeses)} meses ‚Ä¢ Mensal: ${money(inv.mensal)}</div>
          </div>
        `).join("") : `<div style="font-size:13px;color:#6b7280;">Nenhum investimento fixo cadastrado.</div>`)}
        ${pdfCardStyle(`Anota√ß√µes do m√™s (${escapeHtml(firstMonth)})`, (sampleMonth.items||[]).length ? sampleMonth.items.map(it=>`
          <div style="display:flex;justify-content:space-between;gap:10px;padding:9px 0;border-bottom:1px solid #f1f5f9;">
            <div>
              <div style="font-weight:800;">${escapeHtml(it.desc)}</div>
              <div style="font-size:12px;color:#6b7280;">${escapeHtml(it.category)} ‚Ä¢ ${it.paid ? "Pago" : "Pendente"}${it.isFixo ? " ‚Ä¢ Fixo" : ""}</div>
            </div>
            <div style="font-weight:800;">${money(it.amount)}</div>
          </div>
        `).join("") : `<div style="font-size:13px;color:#6b7280;">Sem anota√ß√µes.</div>`)}
      </div>
    `;

    await new Promise(r=>setTimeout(r,250));
    await renderPdfAndSave(wrap, `resumo_ano_${year}.pdf`);
    wrap.remove();
    status.textContent = "Resumo do ano gerado ‚úÖ";
  }catch(e){
    status.textContent = "Erro ao gerar resumo do ano: " + (e.message || e);
  }
}

async function gerarPDFCompleto(){
  const status = document.getElementById("pdfStatus");
  try{
    status.textContent = "Gerando PDF do m√™s‚Ä¶";
    const month = document.getElementById("pdfMonth").value;
    const d = getDataMes(month);
    ensureFixedItems(d);

    const nums = getMonthNumbers(d);
    const byCat = buildCategorySummary(d.items);
    const topCat = getTopCategory(d.items);
    const itemsSorted = [...d.items].sort((a,b)=>Number(b.amount||0)-Number(a.amount||0));

    const chartCat = Object.keys(byCat).length
      ? await createChartImage(Object.keys(byCat), Object.values(byCat), "doughnut", {width:900,height:460})
      : "";

    const lastSix = Object.keys(state.meses||{}).sort().slice(-6);
    const chartEvoMonth = lastSix.length
      ? await createChartImage(
          lastSix.map(onlyMonthLabel),
          lastSix.map(m=>(getDataMes(m).items||[]).reduce((a,b)=>a+Number(b.amount||0),0)),
          "line",
          {width:1100,height:420}
        )
      : "";

    const chartCurrentMonthBars = d.items.length
      ? await createChartImage(
          itemsSorted.slice(0,8).map(x=>x.desc.length > 18 ? x.desc.slice(0,18)+"..." : x.desc),
          itemsSorted.slice(0,8).map(x=>Number(x.amount||0)),
          "bar",
          {width:1100,height:420}
        )
      : "";

    const wrap = createPdfBase(
      "Relat√≥rio ‚Ä¢ Controle de Gastos PRO",
      `M√™s: ${escapeHtml(month)} ‚Ä¢ Gerado em: ${escapeHtml(todayISO())}`,
      `Mais gastou no m√™s<br><b style="color:#111827;font-size:16px;">${escapeHtml(topCat[0])} ‚Ä¢ ${money(topCat[1])}</b>`
    );

    const area = wrap.querySelector("#pdfContentArea");
    area.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
        ${pdfCardStyle("Sal√°rio", `<div style="font-size:28px;font-weight:900;">${money(nums.salary)}</div>`)}
        ${pdfCardStyle("Gastos", `<div style="font-size:28px;font-weight:900;">${money(nums.spent)}</div>`)}
        ${pdfCardStyle("Guardado", `<div style="font-size:28px;font-weight:900;">${money(nums.saved)}</div>`)}
        ${pdfCardStyle("Sobra", `<div style="font-size:28px;font-weight:900;">${money(nums.left)}</div>`)}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        ${pdfCardStyle("Gr√°fico ‚Ä¢ Categorias do m√™s", chartCat ? `<img src="${chartCat}" style="width:100%;display:block;">` : `<div style="color:#6b7280;">Sem dados</div>`)}
        ${pdfCardStyle("Top categorias do m√™s", `
          <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">Categorias que mais pesaram no m√™s.</div>
          ${Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,8).map((x,i)=>`
            <div style="display:flex;justify-content:space-between;gap:10px;padding:9px 0;border-bottom:1px solid #f0f0f0;">
              <div><b>${i+1}.</b> ${escapeHtml(x[0])}</div>
              <div style="font-weight:800;">${money(x[1])}</div>
            </div>
          `).join("") || `<div style="color:#6b7280;">Sem dados</div>`}
        `)}
      </div>

      <div style="margin-top:12px;">
        ${pdfCardStyle("Gr√°fico ‚Ä¢ Evolu√ß√£o dos gastos", chartEvoMonth ? `<img src="${chartEvoMonth}" style="width:100%;display:block;">` : `<div style="color:#6b7280;">Sem dados</div>`)}
      </div>

      <div style="margin-top:12px;">
        ${pdfCardStyle("Gr√°fico ‚Ä¢ Maiores gastos do m√™s", chartCurrentMonthBars ? `<img src="${chartCurrentMonthBars}" style="width:100%;display:block;">` : `<div style="color:#6b7280;">Sem dados</div>`)}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        ${pdfCardStyle("Investimentos fixos cadastrados", investFixos.length ? investFixos.map(inv=>`
          <div style="padding:9px 0;border-bottom:1px solid #f1f5f9;">
            <div style="font-weight:800;">${escapeHtml(inv.nome)}</div>
            <div style="font-size:12px;color:#6b7280;">Meta: ${money(inv.metaFinal)} ‚Ä¢ Prazo: ${escapeHtml(inv.prazoMeses)} meses ‚Ä¢ Mensal: ${money(inv.mensal)}</div>
          </div>
        `).join("") : `<div style="font-size:13px;color:#6b7280;">Nenhum investimento fixo cadastrado.</div>`)}
        ${pdfCardStyle(`Anota√ß√µes do m√™s (${escapeHtml(month)})`, d.items.length ? d.items.map(it=>`
          <div style="display:flex;justify-content:space-between;gap:10px;padding:9px 0;border-bottom:1px solid #f1f5f9;">
            <div>
              <div style="font-weight:800;">${escapeHtml(it.desc)}</div>
              <div style="font-size:12px;color:#6b7280;">${escapeHtml(it.category)} ‚Ä¢ ${it.paid ? "Pago" : "Pendente"}${it.isFixo ? " ‚Ä¢ Fixo" : ""}</div>
            </div>
            <div style="font-weight:800;">${money(it.amount)}</div>
          </div>
        `).join("") : `<div style="font-size:13px;color:#6b7280;">Sem anota√ß√µes.</div>`)}
      </div>

      <div style="margin-top:12px;">
        ${pdfCardStyle("Tabela detalhada do m√™s", `
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr>
                <th style="text-align:left;padding:10px;border-bottom:1px solid #d1d5db;">Descri√ß√£o</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid #d1d5db;">Categoria</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid #d1d5db;">Status</th>
                <th style="text-align:right;padding:10px;border-bottom:1px solid #d1d5db;">Valor</th>
              </tr>
            </thead>
            <tbody>
              ${d.items.length ? d.items.map(it=>`
                <tr>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${escapeHtml(it.desc)}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${escapeHtml(it.category || "Outros")}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${it.paid ? "Pago" : "Pendente"}${it.isFixo ? " ‚Ä¢ Fixo" : ""}</td>
                  <td style="padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;">${money(it.amount)}</td>
                </tr>
              `).join("") : `<tr><td colspan="4" style="padding:10px;color:#6b7280;">Sem dados no m√™s.</td></tr>`}
            </tbody>
          </table>
        `)}
      </div>
    `;

    await new Promise(r=>setTimeout(r,250));
    await renderPdfAndSave(wrap, `relatorio_mes_${month}.pdf`);
    wrap.remove();
    status.textContent = "PDF do m√™s gerado ‚úÖ";
  }catch(e){
    status.textContent = "Erro ao gerar PDF do m√™s: " + (e.message || e);
  }
}

async function initFirebase(){
  try{
    if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
  }catch(e){}
  auth = firebase.auth();

  auth.onAuthStateChanged((u)=>{
    USER = u || null;
    if(!USER){
      location.replace("./login.html");
      return;
    }
    USER_ID = USER.uid;
    document.getElementById("userName").textContent = USER.displayName || "Usu√°rio";
    document.getElementById("userEmail").textContent = USER.email || "";
    if(localStorage.getItem("theme")==="light") document.body.classList.add("light");
    loadAll();
    applyThemeSettings();
    if(localStorage.getItem(kVoiceEnabled()) == null) localStorage.setItem(kVoiceEnabled(),"1");
    applyVoiceVisibility();
    buildMonthSelect();
    buildPdfSelectors();
    renderCategorias();
    renderFixos();
    renderInvestFixos();
    updateInvResumo();
    updateInvestUI();
    document.getElementById("tipoSimulacao").addEventListener("change", ()=>{
      const v = document.getElementById("tipoSimulacao").value;
      document.getElementById("areaInvestimento").style.display = v==="investimento" ? "block" : "none";
      document.getElementById("areaEmprestimo").style.display = v==="emprestimo" ? "block" : "none";
    });
    document.getElementById("investTipo").addEventListener("change", updateInvestUI);
    ["invNome","invMetaFinal","invPrazoMeses","invDiaPagar"].forEach(id=>{
      document.getElementById(id).addEventListener("input", updateInvResumo);
    });

    showApp();
    render();
    checkDueNotifications();
  });
}

function render(){
  const d = getDataMes(mesAtual);
  ensureFixedItems(d);
  renderSavedList();
  renderKPIs();
  renderList();
  renderCategorias();
  renderFixos();
  renderInvestFixos();
  drawChart();
  drawEvolution();
  buildPdfSelectors();
}
async function logout(){
  try{ await auth.signOut(); }catch(e){}
  location.replace("./login.html");
}

document.addEventListener("DOMContentLoaded", ()=>{
  applyThemeSettings();
  showLoading();
  initFirebase();
});
</script>
</body>
</html>
