<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<style>
:root{
  --bg:#0b1020;
  --card:#ffffff0f;
  --text:#eaf0ff;
  --accent:#569cff;
}
.light{
  --bg:#f4f6ff;
  --card:#ffffff;
  --text:#111;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
}
h1{font-size:20px;margin:0 0 10px}
input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:5px;
}
button{
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  touch-action: manipulation;
}
.kpis{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}
.kpi{
  background:var(--card);
  padding:10px;
  border-radius:10px;
}
.success{color:#4CAF50}
.warn{color:#ffd166}
.danger{color:#ff6b6b}
#chart,#chartEvolucao{width:100%;height:220px}
.fab{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#4CAF50;
  color:white;
  border-radius:50%;
  width:55px;
  height:55px;
  font-size:28px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.toggle{float:right;cursor:pointer}
.small{opacity:.8;font-size:12px}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  margin-left:6px;
  font-size:12px;
}
.light .badge{background:rgba(0,0,0,.08);}
.row{
  display:flex;
  gap:8px;
  align-items:center;
}
.row > * {flex:1}
.row .mini {flex:0 0 auto; width:auto; padding:8px 10px; border-radius:10px;}

#debugBox{
  position:fixed;
  left:12px;
  right:12px;
  bottom:12px;
  background:rgba(0,0,0,.75);
  color:#fff;
  padding:10px;
  border-radius:12px;
  font-size:12px;
  z-index:9999;
  display:none;
  white-space:pre-wrap;
}
hr{border:none;height:1px;background:rgba(255,255,255,.2)}
.light hr{background:rgba(0,0,0,.15)}
</style>
</head>

<body>

<div id="loginScreen" style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center">
  <h2>Controle de Gastos PRO</h2>

  <input id="email" type="email" placeholder="Seu e-mail">
  <input id="senha" type="password" placeholder="Sua senha">

  <!-- Mantive seus onclick -->
  <button id="btnLoginEmail" onclick="loginEmail()">Entrar com Email</button>
  <button id="btnCriarConta" onclick="registrarEmail()">Criar conta</button>

  <hr style="margin:10px 0;width:80%">

  <button id="btnLoginGoogle" onclick="loginGoogle()">Entrar com Google</button>
</div>

<div id="app" style="display:none">
  <div class="wrap">

    <h1>
      Controle de Gastos PRO
      <span class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
      <span class="toggle" onclick="abrirConfig()">‚öôÔ∏è</span>
    </h1>

    <div id="configBox" class="card" style="display:none">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <b id="userName"></b>
      <br><br>
      <button onclick="logout()">Sair da conta</button>
    </div>

    <div class="card">
      <h3>üìÇ Minhas Categorias</h3>
      <div class="row">
        <input id="novaCategoria" placeholder="Nome da categoria">
        <button class="mini" onclick="addCategoria()">Adicionar</button>
      </div>
      <div id="listaCategorias" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>üìå Gastos Fixos (Prioridades)</h3>
      <input id="descFixo" placeholder="Descri√ß√£o (ex: Aluguel)">
      <input id="valorFixo" type="number" placeholder="Valor (ex: 750)">
      <select id="categoriaFixo"></select>
      <button onclick="addFixo()">Adicionar gasto fixo</button>
      <div id="listaFixos" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <label>Sal√°rio</label>
      <input id="salary" type="number">

      <label>M√™s</label>
      <input id="month" type="month">

      <label>Meta</label>
      <input id="meta" type="number">

      <button onclick="saveSettings()">Salvar</button>
    </div>

    <!-- üß† SIMULADOR COMPLETO (MELHORADO, SEM REMOVER NADA) -->
    <div class="card">
      <h3>üß† Simulador Financeiro (PRO)</h3>

      <label>Tipo</label>
      <select id="tipoSimulacao">
        <option value="emprestimo">Empr√©stimo / Financiamento</option>
        <option value="investimento">Investimento</option>
      </select>

      <!-- ===== EMPR√âSTIMO ===== -->
      <div id="areaEmprestimo">
        <label>Modalidade de c√°lculo</label>
        <select id="tipoEmprestimo">
          <option value="price">PRICE (parcela fixa)</option>
          <option value="sac">SAC (parcela decrescente)</option>
          <option value="americano">Americano (paga s√≥ juros + principal no final)</option>
          <option value="bullet">Bullet (paga tudo no final)</option>
        </select>

        <label>Valor total do bem / valor desejado</label>
        <input id="valorSimulacao" type="number" placeholder="Ex: 20000">

        <label>Entrada (opcional)</label>
        <input id="entradaEmp" type="number" placeholder="Ex: 5000">

        <label>Parcelas (meses)</label>
        <input id="parcelasSimulacao" type="number" placeholder="Ex: 24">

        <label>Juros mensal (%)</label>
        <input id="jurosSimulacao" type="number" placeholder="Ex: 2.5">

        <div class="row" style="margin-top:8px">
          <label style="margin:0">
            <input id="chkTaxasEmp" type="checkbox" style="width:auto;margin:0 8px 0 0;transform:scale(1.1);vertical-align:middle">
            Incluir taxas (IOF + Tarifa/Seguro)
          </label>
        </div>

        <div id="areaTaxasEmp" style="display:none;margin-top:6px">
          <label>IOF (%) (opcional)</label>
          <input id="iofPerc" type="number" placeholder="Ex: 0.38">

          <label>Tarifa/Seguro (R$) (opcional)</label>
          <input id="tarifaFixa" type="number" placeholder="Ex: 300">
        </div>

        <div class="row" style="margin-top:8px">
          <label style="margin:0">
            <input id="chkCarencia" type="checkbox" style="width:auto;margin:0 8px 0 0;transform:scale(1.1);vertical-align:middle">
            Car√™ncia (paga s√≥ juros por alguns meses)
          </label>
        </div>

        <div id="areaCarencia" style="display:none;margin-top:6px">
          <label>Meses de car√™ncia</label>
          <input id="mesesCarencia" type="number" placeholder="Ex: 3">
        </div>

        <div class="row" style="margin-top:8px">
          <label style="margin:0">
            <input id="chkAmortExtra" type="checkbox" style="width:auto;margin:0 8px 0 0;transform:scale(1.1);vertical-align:middle">
            Amortiza√ß√£o extra mensal
          </label>
        </div>

        <div id="areaAmortExtra" style="display:none;margin-top:6px">
          <label>Amortiza√ß√£o extra (R$ por m√™s)</label>
          <input id="amortExtraMensal" type="number" placeholder="Ex: 100">
        </div>
      </div>

      <!-- ===== INVESTIMENTO ===== -->
      <div id="areaInvestimento" style="display:none">
        <label>Tipo de investimento</label>
        <select id="tipoInvest">
          <option value="cdb_cdi">CDB / Fundo DI (CDI %) ‚Äî com IR</option>
          <option value="lci_lca">LCI/LCA (CDI %) ‚Äî isento de IR</option>
          <option value="pre">Pr√©-fixado ‚Äî com IR</option>
          <option value="ipca">IPCA + ‚Äî com IR</option>
        </select>

        <label>Valor inicial</label>
        <input id="valorInvestimento" type="number" placeholder="Ex: 1000">

        <div class="row" style="margin-top:8px">
          <label style="margin:0">
            <input id="chkAportes" type="checkbox" style="width:auto;margin:0 8px 0 0;transform:scale(1.1);vertical-align:middle">
            Aportes mensais
          </label>
        </div>

        <div id="areaAportes" style="display:none;margin-top:6px">
          <label>Aporte mensal (R$)</label>
          <input id="aporteMensal" type="number" placeholder="Ex: 200">
        </div>

        <label>Meses</label>
        <input id="mesesInvestimento" type="number" placeholder="Ex: 24">

        <!-- CDI -->
        <div id="areaCDI" style="margin-top:6px">
          <label>% do CDI</label>
          <input id="percentualInvest" type="number" placeholder="Ex: 110">
          <label>CDI mensal (decimal) (opcional)</label>
          <input id="cdiMensal" type="number" placeholder="Ex: 0.012 (1.2% ao m√™s)">
          <div class="small">Se deixar vazio, o app usa 0.012 (1.2% ao m√™s) como refer√™ncia.</div>
        </div>

        <!-- Pr√© -->
        <div id="areaPRE" style="display:none;margin-top:6px">
          <label>Taxa (%)</label>
          <input id="taxaPre" type="number" placeholder="Ex: 12">
          <label>Periodicidade</label>
          <select id="periodoPre">
            <option value="aa">ao ano (a.a.)</option>
            <option value="am">ao m√™s (a.m.)</option>
          </select>
        </div>

        <!-- IPCA+ -->
        <div id="areaIPCA" style="display:none;margin-top:6px">
          <label>IPCA estimado (%)</label>
          <input id="ipcaPerc" type="number" placeholder="Ex: 4.5">
          <label>Periodicidade do IPCA</label>
          <select id="periodoIpca">
            <option value="aa">ao ano (a.a.)</option>
            <option value="am">ao m√™s (a.m.)</option>
          </select>

          <label>Pr√™mio (IPCA + taxa) (%)</label>
          <input id="premioIpca" type="number" placeholder="Ex: 6">
          <label>Periodicidade do pr√™mio</label>
          <select id="periodoPremio">
            <option value="aa">ao ano (a.a.)</option>
            <option value="am">ao m√™s (a.m.)</option>
          </select>
        </div>

        <div class="row" style="margin-top:8px">
          <label style="margin:0">
            <input id="chkCustosInv" type="checkbox" style="width:auto;margin:0 8px 0 0;transform:scale(1.1);vertical-align:middle">
            Incluir custos (taxa adm/cust√≥dia)
          </label>
        </div>

        <div id="areaCustosInv" style="display:none;margin-top:6px">
          <label>Taxa (%) ao ano</label>
          <input id="taxaAdmAA" type="number" placeholder="Ex: 1">
        </div>
      </div>

      <button onclick="simularCompleto()">Calcular</button>
      <div id="resultadoSimulacao" style="margin-top:10px;font-weight:bold"></div>
      <div id="detalhesSimulacao" class="small" style="margin-top:8px"></div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card">
      <canvas id="chart"></canvas>
    </div>

    <div class="card">
      <h3>Evolu√ß√£o</h3>
      <canvas id="chartEvolucao"></canvas>
    </div>

    <div class="card">
      <table id="list"></table>
    </div>

  </div>

  <div class="fab" onclick="abrirAdd()">+</div>
</div>

<div id="debugBox"></div>

<script>
/* === Debug visual (sem depender de alert) === */
function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
/* ===========================
   ‚úÖ Vari√°veis globais do app
=========================== */
const API = "https://api-rf1w.onrender.com";

let auth = null;
let provider = null;

window.USER_ID = null;

let state = { meses:{} };

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Outros"];

let regras = [
  {palavra:"aluguel", categoria:"Casa"},
  {palavra:"luz", categoria:"Casa"},
  {palavra:"agua", categoria:"Casa"},
  {palavra:"√°gua", categoria:"Casa"},
  {palavra:"mercado", categoria:"Alimenta√ß√£o"},
  {palavra:"padaria", categoria:"Alimenta√ß√£o"},
  {palavra:"gasolina", categoria:"Transporte"},
  {palavra:"uber", categoria:"Transporte"},
  {palavra:"ra√ß√£o", categoria:"Pets"},
  {palavra:"pet", categoria:"Pets"}
];

let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];

let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;
let graficoEvolucao = null;

/* ===========================
   ‚úÖ Firebase init (ANTI DUPLICA√á√ÉO)
=========================== */
function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou. Verifique internet/blocked scripts.");
    return false;
  }
  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp({
        apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
        authDomain:"controle-gastos-pro.firebaseapp.com",
        projectId:"controle-gastos-pro"
      });
    }
  }catch(e){
    // se j√° existir, ignora
  }
  auth = firebase.auth();
  provider = new firebase.auth.GoogleAuthProvider();
  return true;
}

/* ===========================
   ‚úÖ Fun√ß√µes storage
=========================== */
function salvarCategorias(){
  localStorage.setItem("categorias_" + window.USER_ID, JSON.stringify(categorias));
}
function carregarCategorias(){
  const raw = localStorage.getItem("categorias_" + window.USER_ID);
  categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
  if(!Array.isArray(categorias) || categorias.length === 0) categorias = [...DEFAULT_CATEGORIAS];
}
function salvarFixos(){
  localStorage.setItem("fixos_" + window.USER_ID, JSON.stringify(fixos));
}
function carregarFixos(){
  const raw = localStorage.getItem("fixos_" + window.USER_ID);
  fixos = raw ? JSON.parse(raw) : [];
  if(!Array.isArray(fixos)) fixos = [];
  fixos = fixos.map(f=>({ ...f, isFixo:true }));
}

/* ===========================
   ‚úÖ Helpers UI (globais p/ onclick)
=========================== */
window.toggleTheme = ()=> document.body.classList.toggle("light");

window.abrirConfig = ()=>{
  const box = document.getElementById("configBox");
  box.style.display = box.style.display==="none" ? "block" : "none";
};

window.getMes = ()=>{
  const monthInput = document.getElementById("month");
  return monthInput.value || new Date().toISOString().slice(0,7);
};

function keyItem(i){
  return `${(i.desc||"").toLowerCase()}|${Number(i.amount||0)}|${(i.category||"Outros").toLowerCase()}|${i.isFixo?1:0}`;
}

function garantirFixosNoMes(d){
  const set = new Set((d.items||[]).map(keyItem));
  for(const f of fixos){
    const obj = { ...f, isFixo:true };
    const k = keyItem(obj);
    if(!set.has(k)){
      d.items.unshift(obj);
      set.add(k);
    }
  }
}

window.getDataMes = ()=>{
  if(!state.meses[mesAtual]){
    state.meses[mesAtual] = {
      salary: 0,
      items: fixos.map(f=>({ ...f, isFixo:true })),
      meta: 0
    };
  } else {
    garantirFixosNoMes(state.meses[mesAtual]);
  }
  return state.meses[mesAtual];
};

function detectarCategoria(desc){
  const txt = (desc||"").toLowerCase();
  for(const r of regras){
    if(txt.includes(r.palavra)) return r.categoria;
  }
  return "Outros";
}

/* ===========================
   ‚úÖ CATEGORIAS (globais p/ onclick)
=========================== */
window.addCategoria = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  const input = document.getElementById("novaCategoria");
  const nome = (input.value || "").trim();
  if(!nome) return;

  const exists = categorias.some(c => c.toLowerCase() === nome.toLowerCase());
  if(exists){ alert("Essa categoria j√° existe."); return; }

  categorias.push(nome);
  input.value = "";
  salvarCategorias();
  renderCategorias();
};

function renderCategorias(){
  const div = document.getElementById("listaCategorias");
  const select = document.getElementById("categoriaFixo");

  div.innerHTML = categorias.map(c=>`<div>‚Ä¢ ${c}</div>`).join("");
  select.innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");
}

/* ===========================
   ‚úÖ FIXOS (globais p/ onclick)
=========================== */
window.addFixo = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  const desc = (document.getElementById("descFixo").value || "").trim();
  const valor = Number(document.getElementById("valorFixo").value);
  const categoria = document.getElementById("categoriaFixo").value || "Outros";

  if(!desc || !valor || valor <= 0){
    alert("Preencha descri√ß√£o e valor (maior que 0).");
    return;
  }

  fixos.push({ desc, amount: valor, category: categoria, isFixo:true });

  document.getElementById("descFixo").value = "";
  document.getElementById("valorFixo").value = "";

  salvarFixos();
  renderFixos();

  const d = window.getDataMes();
  garantirFixosNoMes(d);
  window.render();
};

function renderFixos(){
  const div = document.getElementById("listaFixos");
  if(fixos.length === 0){
    div.innerHTML = "<div>Nenhum gasto fixo cadastrado.</div>";
    return;
  }
  div.innerHTML = fixos.map(f=>`
    <div>‚Ä¢ ${f.desc} ‚Äî R$ ${Number(f.amount).toFixed(2)} <span class="badge">${f.category}</span></div>
  `).join("");
}

/* ===========================
   ‚úÖ CRUD GASTOS / SETTINGS
=========================== */
window.abrirAdd = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  mesAtual = window.getMes();
  const d = window.getDataMes();

  const desc = prompt("Descri√ß√£o");
  const valor = parseFloat(prompt("Valor"));
  if(!desc || isNaN(valor)) return;

  const categoria = detectarCategoria(desc);

  d.items.push({ desc, amount: valor, category: categoria, isFixo:false });

  fetch(API + "/addGasto", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      userId: window.USER_ID,
      mes: mesAtual,
      desc,
      amount: valor,
      category: categoria
    })
  }).catch(()=>{});

  window.render();
};

window.del = (i)=>{
  mesAtual = window.getMes();
  const d = window.getDataMes();
  d.items.splice(i,1);
  window.render();
};

window.saveSettings = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  mesAtual = window.getMes();
  const d = window.getDataMes();

  d.salary = Number(document.getElementById("salary").value);
  d.meta = Number(document.getElementById("meta").value);

  fetch(API + "/salvarMes", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      userId: window.USER_ID,
      mes: mesAtual,
      salary: d.salary,
      meta: d.meta
    })
  }).catch(()=>{});

  window.render();
};

/* ===========================
   ‚úÖ GR√ÅFICOS + RENDER
=========================== */
function drawChart(items){
  const mapa = {};
  items.forEach(i=>{
    const cat = i.category || "Outros";
    mapa[cat] = (mapa[cat] || 0) + Number(i.amount||0);
  });

  const labels = Object.keys(mapa);
  const valores = Object.values(mapa);

  if(grafico) grafico.destroy();
  grafico = new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{ labels, datasets:[{ data: valores }] }
  });
}

function drawEvolucao(){
  const meses = Object.keys(state.meses).sort();
  const valores = meses.map(m=>{
    const it = state.meses[m].items || [];
    return it.reduce((a,b)=>a+Number(b.amount||0),0);
  });

  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao = new Chart(document.getElementById("chartEvolucao"),{
    type:"line",
    data:{ labels: meses, datasets:[{ data: valores }] }
  });
}

window.render = ()=>{
  if(!window.USER_ID) return;

  mesAtual = window.getMes();
  const d = window.getDataMes();

  paint();

  fetch(API + "/mes/" + window.
