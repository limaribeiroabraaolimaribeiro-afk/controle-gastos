<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<style>
:root{ --bg:#0b1020; --card:#ffffff0f; --text:#eaf0ff; --accent:#569cff; }
.light{ --bg:#f4f6ff; --card:#ffffff; --text:#111; }
body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui; }
.wrap{max-width:980px;margin:auto;padding:16px}
.card{ background:var(--card); border-radius:12px; padding:14px; margin-bottom:12px; }
h1{font-size:20px;margin:0 0 10px}
input,select,button,textarea{ width:100%; padding:10px; border-radius:10px; border:none; margin-top:5px; box-sizing:border-box; }
textarea{ min-height:90px; resize:vertical; }
button{ background:var(--accent); color:#fff; cursor:pointer; touch-action:manipulation; }
.kpis{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.kpi{ background:var(--card); padding:10px; border-radius:10px; }
.success{color:#4CAF50}
#chart,#chartEvolucao{width:100%;height:220px}
.fab{ position:fixed; bottom:20px; right:20px; background:#4CAF50; color:white; border-radius:50%; width:55px; height:55px; font-size:28px; display:flex; align-items:center; justify-content:center; }
.toggle{float:right;cursor:pointer; margin-left:10px;}
.small{opacity:.85;font-size:12px}
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); margin-left:6px; font-size:12px; }
.light .badge{background:rgba(0,0,0,.08);}
.row{ display:flex; gap:8px; align-items:center; }
.row > * {flex:1}
.row .mini {flex:0 0 auto; width:auto; padding:8px 10px; border-radius:10px;}
hr{border:0;border-top:1px solid rgba(255,255,255,.08);margin:10px 0}
.light hr{border-top:1px solid rgba(0,0,0,.08)}

#debugBox{
  position:fixed; left:12px; right:12px; bottom:12px;
  background:rgba(0,0,0,.75); color:#fff; padding:10px; border-radius:12px;
  font-size:12px; z-index:9999; display:none; white-space:pre-wrap;
}

#loading{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  text-align:center;
  padding:24px;
  opacity:.9;
}

.linkbtn{
  background:transparent;
  border:1px solid rgba(255,255,255,.18);
}
.light .linkbtn{
  border:1px solid rgba(0,0,0,.18);
  color:var(--text);
}
</style>
</head>

<body>

<div id="loading">
  <div>
    <div style="font-size:18px;font-weight:700">Carregando...</div>
    <div style="opacity:.8;margin-top:6px">Validando login</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="wrap">
    <h1>
      Controle de Gastos PRO
      <span class="toggle" onclick="abrirConfig()">‚öôÔ∏è</span>
      <span class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
    </h1>

    <div id="configBox" class="card" style="display:none">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <b id="userName"></b><br><br>

      <!-- ‚úÖ Login Google direto -->
      <button class="linkbtn" onclick="googleLogin()">Entrar / Trocar conta (Google)</button>
      <button onclick="logout()">Sair da conta</button>
      <div class="small" style="margin-top:8px;opacity:.8">
        Dica: se o popup n√£o abrir no celular, o login ser√° por redirecionamento autom√°tico.
      </div>
    </div>

    <!-- ‚úÖ HIST√ìRICO DE MESES -->
    <div class="card">
      <h3>üóìÔ∏è Hist√≥rico de meses</h3>
      <div class="small">Toque em um m√™s para abrir.</div>
      <div id="listaMeses" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>üìÇ Minhas Categorias</h3>
      <div class="row">
        <input id="novaCategoria" placeholder="Nome da categoria">
        <button class="mini" onclick="addCategoria()">Adicionar</button>
      </div>
      <div id="listaCategorias" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>üìå Gastos Fixos (Prioridades)</h3>
      <input id="descFixo" placeholder="Descri√ß√£o (ex: Aluguel)">
      <input id="valorFixo" type="number" placeholder="Valor (ex: 750)">
      <select id="categoriaFixo"></select>
      <button onclick="addFixo()">Adicionar gasto fixo</button>
      <div id="listaFixos" class="small" style="margin-top:8px"></div>
      <div class="small" style="margin-top:6px;opacity:.75">
        Dica: o bot√£o ‚ùå remove o gasto fixo para n√£o entrar nos pr√≥ximos meses.
      </div>
    </div>

    <div class="card">
      <label>Sal√°rio</label>
      <input id="salary" type="number">
      <label>M√™s</label>
      <input id="month" type="month">
      <label>Meta</label>
      <input id="meta" type="number">

      <!-- ‚úÖ ANOTA√á√ïES DO M√äS (vai para hist√≥rico) -->
      <label>Anota√ß√µes do m√™s</label>
      <textarea id="notes" placeholder="Ex: meta de cortar delivery, juntar para reserva, etc..."></textarea>

      <button onclick="saveSettings()">Salvar</button>
      <div class="small" style="margin-top:6px;opacity:.8">
        Ao salvar, sal√°rio/meta/anota√ß√µes ficam guardados no hist√≥rico do m√™s.
      </div>
    </div>

    <!-- ‚úÖ SIMULADOR DE INVESTIMENTOS (COM MAIS OP√á√ïES) -->
    <div class="card">
      <h3>üß† Simulador de Investimentos (Mais op√ß√µes)</h3>

      <label>Tipo de investimento</label>
      <select id="invTipo" onchange="atualizarCamposInvestimento()">
        <option value="poupanca">Poupan√ßa</option>
        <option value="tesouro_selic">Tesouro Selic</option>
        <option value="cdb">CDB (CDI %)</option>
        <option value="lci_lca">LCI/LCA (CDI % ‚Äî isento IR)</option>
        <option value="fundo_di">Fundo DI (CDI % - taxa adm)</option>
        <option value="prefixado">Prefixado (% ao ano)</option>
        <option value="ipca_plus">Tesouro IPCA+ (IPCA + taxa real)</option>
        <option value="renda_variavel">Renda Vari√°vel (m√©dia % ao ano)</option>
      </select>

      <label>Valor inicial (R$)</label>
      <input id="invInicial" type="number" placeholder="Ex: 1000">

      <label>Aporte mensal (R$) (opcional)</label>
      <input id="invAporte" type="number" placeholder="Ex: 200">

      <label>Tempo</label>
      <div class="row">
        <input id="invMeses" type="number" placeholder="Meses (ex: 24)">
        <input id="invDias" type="number" placeholder="Dias (opcional)">
      </div>

      <div id="boxCDI" style="margin-top:10px">
        <label>CDI (% ao ano)</label>
        <input id="invCDI" type="number" placeholder="Ex: 10.65">
        <label>Percentual do CDI (%)</label>
        <input id="invPercCDI" type="number" placeholder="Ex: 110">
      </div>

      <div id="boxPrefixado" style="display:none;margin-top:10px">
        <label>Taxa prefixada (% ao ano)</label>
        <input id="invPrefixado" type="number" placeholder="Ex: 12">
      </div>

      <div id="boxIPCA" style="display:none;margin-top:10px">
        <label>IPCA (% ao ano)</label>
        <input id="invIPCA" type="number" placeholder="Ex: 4.5">
        <label>Taxa real (% ao ano)</label>
        <input id="invReal" type="number" placeholder="Ex: 5.5">
      </div>

      <div id="boxFundo" style="display:none;margin-top:10px">
        <label>Taxa de administra√ß√£o (% ao ano)</label>
        <input id="invAdm" type="number" placeholder="Ex: 1.0">
      </div>

      <div id="boxRV" style="display:none;margin-top:10px">
        <label>Retorno m√©dio (% ao ano)</label>
        <input id="invRV" type="number" placeholder="Ex: 15">
      </div>

      <div style="margin-top:10px">
        <label>
          <input id="invAplicarIOF" type="checkbox" style="width:auto;transform:scale(1.1);margin-right:8px">
          Aplicar IOF (se resgatar antes de 30 dias) ‚Äî estimativa
        </label>
      </div>

      <button onclick="simularInvestimentos()">Calcular</button>

      <div id="resultadoInv" style="margin-top:10px;font-weight:bold"></div>
      <div id="detalhesInv" class="small" style="margin-top:8px"></div>
    </div>

    <!-- ‚úÖ CARD IA (Ollama) -->
    <div class="card" id="iaCard">
      <h3>ü§ñ IA (Ollama)</h3>

      <label>Pergunta</label>
      <input id="iaPrompt" placeholder="Ex: com meus gastos, onde devo investir este m√™s?">

      <button onclick="iaPerguntar()">Perguntar</button>

      <div id="iaResposta" class="small" style="margin-top:10px; white-space:pre-wrap;"></div>

      <div class="small" style="margin-top:8px; opacity:.8">
        Status: <span id="iaStatus">Aguardando...</span>
      </div>
      <div class="small" style="margin-top:6px;opacity:.75">
        A IA usa automaticamente seu sal√°rio, gastos, categorias e anota√ß√µes do m√™s para responder.
      </div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card"><canvas id="chart"></canvas></div>
    <div class="card"><h3>Evolu√ß√£o</h3><canvas id="chartEvolucao"></canvas></div>
    <div class="card"><table id="list"></table></div>
  </div>

  <div class="fab" onclick="abrirAdd()">+</div>
</div>

<div id="debugBox"></div>

<script>
function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<!-- ‚úÖ carrega URL do tunnel (config.js) -->
<script src="./config.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

const API = "https://api-rf1w.onrender.com";
let auth = null;

window.USER_ID = null;
let state = { meses:{} };

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Outros"];
let regras = [
  {palavra:"aluguel", categoria:"Casa"},
  {palavra:"luz", categoria:"Casa"},
  {palavra:"agua", categoria:"Casa"},
  {palavra:"√°gua", categoria:"Casa"},
  {palavra:"mercado", categoria:"Alimenta√ß√£o"},
  {palavra:"padaria", categoria:"Alimenta√ß√£o"},
  {palavra:"gasolina", categoria:"Transporte"},
  {palavra:"uber", categoria:"Transporte"},
  {palavra:"ra√ß√£o", categoria:"Pets"},
  {palavra:"pet", categoria:"Pets"}
];

let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];
let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;
let graficoEvolucao = null;

function showApp(){
  document.getElementById("loading").style.display = "none";
  document.getElementById("app").style.display = "block";
}
function showLoading(){
  document.getElementById("app").style.display = "none";
  document.getElementById("loading").style.display = "flex";
}

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou (sem internet ou bloqueio).");
    return false;
  }

  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
  }catch(e){}

  auth = firebase.auth();

  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }catch(e){
    dbg("Persist√™ncia:\n" + (e.code||"") + " - " + (e.message||e));
  }

  return true;
}

window.logout = function(){
  if(!auth) return;
  auth.signOut()
    .then(()=> location.replace("./login.html"))
    .catch(e=>alert((e.code||"")+" - "+e.message));
};

// ‚úÖ Login Google (funciona melhor no celular com redirect)
window.googleLogin = async function(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // em mobile, redirect √© mais confi√°vel
    await auth.signInWithRedirect(provider);
  }catch(e){
    alert((e.code||"")+" - "+e.message);
  }
};

function salvarCategorias(){ localStorage.setItem("categorias_" + window.USER_ID, JSON.stringify(categorias)); }
function carregarCategorias(){
  const raw = localStorage.getItem("categorias_" + window.USER_ID);
  categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
  if(!Array.isArray(categorias) || !categorias.length) categorias = [...DEFAULT_CATEGORIAS];
}
function salvarFixos(){ localStorage.setItem("fixos_" + window.USER_ID, JSON.stringify(fixos)); }
function carregarFixos(){
  const raw = localStorage.getItem("fixos_" + window.USER_ID);
  fixos = raw ? JSON.parse(raw) : [];
  if(!Array.isArray(fixos)) fixos = [];
  fixos = fixos.map(f=>({ ...f, isFixo:true }));
}

window.toggleTheme = ()=> document.body.classList.toggle("light");
window.abrirConfig = ()=>{
  const box = document.getElementById("configBox");
  box.style.display = box.style.display==="none" ? "block" : "none";
};

window.getMes = ()=>{
  const el = document.getElementById("month");
  const v = el && el.value ? el.value : new Date().toISOString().slice(0,7);
  return v;
};

function keyItem(i){ return `${(i.desc||"").toLowerCase()}|${Number(i.amount||0)}|${(i.category||"Outros").toLowerCase()}|${i.isFixo?1:0}`; }

function garantirFixosNoMes(d){
  const set = new Set((d.items||[]).map(keyItem));
  for(const f of fixos){
    const obj = { ...f, isFixo:true };
    const k = keyItem(obj);
    if(!set.has(k)){ d.items.unshift(obj); set.add(k); }
  }
}

window.getDataMes = ()=>{
  if(!state.meses[mesAtual]){
    state.meses[mesAtual] = {
      salary: 0,
      items: fixos.map(f=>({ ...f, isFixo:true })),
      meta: 0,
      notes: ""
    };
  }else{
    garantirFixosNoMes(state.meses[mesAtual]);
    if(typeof state.meses[mesAtual].notes !== "string") state.meses[mesAtual].notes = "";
  }
  return state.meses[mesAtual];
};

function detectarCategoria(desc){
  const txt=(desc||"").toLowerCase();
  for(const r of regras){ if(txt.includes(r.palavra)) return r.categoria; }
  return "Outros";
}

window.addCategoria = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const input=document.getElementById("novaCategoria");
  const nome=(input.value||"").trim();
  if(!nome) return;
  if(categorias.some(c=>c.toLowerCase()===nome.toLowerCase())){ alert("Essa categoria j√° existe."); return; }
  categorias.push(nome); input.value="";
  salvarCategorias(); renderCategorias();
};

function renderCategorias(){
  document.getElementById("listaCategorias").innerHTML = categorias.map(c=>`<div>‚Ä¢ ${c}</div>`).join("");
  document.getElementById("categoriaFixo").innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");
}

window.addFixo = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const desc=(document.getElementById("descFixo").value||"").trim();
  const valor=Number(document.getElementById("valorFixo").value);
  const categoria=document.getElementById("categoriaFixo").value||"Outros";
  if(!desc || !valor || valor<=0){ alert("Preencha descri√ß√£o e valor (maior que 0)."); return; }

  fixos.push({ desc, amount:valor, category:categoria, isFixo:true });
  document.getElementById("descFixo").value="";
  document.getElementById("valorFixo").value="";

  salvarFixos(); renderFixos();
  garantirFixosNoMes(window.getDataMes());
  salvarTudoLocal();
  window.render();
};

// ‚úÖ remover gasto fixo (bot√£o ‚ùå)
window.removerFixo = function(idx){
  if(idx<0 || idx>=fixos.length) return;
  if(!confirm("Remover este gasto fixo? (ele n√£o vai entrar nos pr√≥ximos meses)")) return;

  const alvo = fixos[idx];
  fixos.splice(idx, 1);
  salvarFixos();
  renderFixos();

  // remove tamb√©m do m√™s atual (se estiver na lista)
  const d = window.getDataMes();
  d.items = (d.items||[]).filter(it => !(it.isFixo && keyItem(it) === keyItem(alvo)));
  salvarTudoLocal();
  window.render();
};

function renderFixos(){
  const div=document.getElementById("listaFixos");
  if(!fixos.length){
    div.innerHTML = "<div>Nenhum gasto fixo cadastrado.</div>";
    return;
  }
  div.innerHTML = fixos.map((f,idx)=>`
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div style="flex:1">
        ‚Ä¢ ${f.desc} ‚Äî R$ ${Number(f.amount).toFixed(2)}
        <span class="badge">${f.category}</span>
      </div>
      <button class="mini" style="background:#d9534f" onclick="removerFixo(${idx})">‚ùå</button>
    </div>
  `).join("");
}

window.abrirAdd = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  mesAtual = window.getMes();
  const d = window.getDataMes();
  const desc = prompt("Descri√ß√£o");
  const valor = parseFloat(prompt("Valor"));
  if(!desc || isNaN(valor)) return;
  const categoria = detectarCategoria(desc);
  d.items.push({ desc, amount:valor, category:categoria, isFixo:false });

  fetch(API+"/addGasto",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId:window.USER_ID,mes:mesAtual,desc,amount:valor,category:categoria})
  }).catch(()=>{});

  salvarTudoLocal();
  window.render();
};

// ‚úÖ bot√£o X agora remove fixo de verdade quando clicar em cima do fixo
window.del = (i)=>{
  mesAtual=window.getMes();
  const d=window.getDataMes();
  const item = d.items[i];
  if(!item) return;

  // se for fixo: remove tamb√©m da lista de fixos
  if(item.isFixo){
    const k = keyItem(item);
    fixos = fixos.filter(f => keyItem(f) !== k);
    salvarFixos();
    renderFixos();
  }

  d.items.splice(i,1);
  salvarTudoLocal();
  window.render();
};

// ‚úÖ salvar sal√°rio/meta/notas no hist√≥rico do m√™s
window.saveSettings = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  mesAtual=window.getMes();
  const d=window.getDataMes();
  d.salary=Number(document.getElementById("salary").value);
  d.meta=Number(document.getElementById("meta").value);
  d.notes=String(document.getElementById("notes").value || "");

  // mant√©m no hist√≥rico local
  salvarTudoLocal();
  renderListaMeses();

  // mant√©m API (se existir endpoint; se n√£o existir, n√£o quebra)
  fetch(API+"/salvarMes",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId:window.USER_ID,mes:mesAtual,salary:d.salary,meta:d.meta,notes:d.notes})
  }).catch(()=>{});

  window.render();
};

function salvarTudoLocal(){
  localStorage.setItem("gastos_pro", JSON.stringify(state));
}

function drawChart(items){
  const mapa={}; items.forEach(i=>{ const cat=i.category||"Outros"; mapa[cat]=(mapa[cat]||0)+Number(i.amount||0); });
  const labels=Object.keys(mapa), valores=Object.values(mapa);
  if(grafico) grafico.destroy();
  grafico=new Chart(document.getElementById("chart"),{type:"doughnut",data:{labels,datasets:[{data:valores}]}} );
}

function drawEvolucao(){
  const meses=Object.keys(state.meses).sort();
  const valores=meses.map(m=>(state.meses[m].items||[]).reduce((a,b)=>a+Number(b.amount||0),0));
  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao=new Chart(document.getElementById("chartEvolucao"),{type:"line",data:{labels:meses,datasets:[{data:valores}]}} );
}

function paint(){
  const d=window.getDataMes();

  document.getElementById("salary").value=Number(d.salary||0);
  document.getElementById("month").value=mesAtual;
  document.getElementById("meta").value=d.meta||"";
  document.getElementById("notes").value = d.notes || "";

  const total=(d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const sobra=Number(d.salary||0)-total;

  document.getElementById("kpis").innerHTML=`
    <div class="kpi">Sal√°rio<br><b>R$ ${Number(d.salary||0).toFixed(2)}</b></div>
    <div class="kpi">Gasto<br><b>R$ ${total.toFixed(2)}</b></div>
    <div class="kpi">Sobra<br><b>R$ ${sobra.toFixed(2)}</b></div>
    <div class="success">Voc√™ economizou R$ ${sobra.toFixed(2)}</div>
  `;

  document.getElementById("list").innerHTML=(d.items||[]).map((i,idx)=>`
    <tr>
      <td>
        ${i.desc}
        ${i.isFixo?` <span class="badge">Fixo</span>`:""}
        <span class="badge">${i.category||"Outros"}</span>
      </td>
      <td>R$ ${Number(i.amount||0).toFixed(2)}</td>
      <td><button onclick="del(${idx})">X</button></td>
    </tr>
  `).join("");

  drawChart(d.items||[]);
  drawEvolucao();
}

// ‚úÖ lista meses (hist√≥rico)
function renderListaMeses(){
  const el = document.getElementById("listaMeses");
  const meses = Object.keys(state.meses||{}).sort().reverse();
  if(!meses.length){
    el.innerHTML = "<div>Nenhum m√™s salvo ainda.</div>";
    return;
  }
  el.innerHTML = meses.map(m=>{
    const d = state.meses[m] || {};
    const total = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
    const sal = Number(d.salary||0);
    const sobra = sal - total;
    const tag = (m===mesAtual) ? `<span class="badge">Atual</span>` : "";
    return `
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0">
        <div style="flex:1">
          <b>${m}</b> ${tag}<br>
          <span class="small">Sal√°rio R$ ${sal.toFixed(2)} ‚Ä¢ Gasto R$ ${total.toFixed(2)} ‚Ä¢ Sobra R$ ${sobra.toFixed(2)}</span>
        </div>
        <button class="mini" onclick="abrirMes('${m}')">Abrir</button>
      </div>
      <hr>
    `;
  }).join("");
}

window.abrirMes = function(m){
  const monthEl = document.getElementById("month");
  if(monthEl) monthEl.value = m;
  mesAtual = m;
  window.render();
};

window.render = ()=>{
  if(!window.USER_ID) return;
  mesAtual = window.getMes();
  const d = window.getDataMes();
  paint();
  renderListaMeses();

  fetch(API+"/mes/"+window.USER_ID+"/"+mesAtual)
    .then(r=>r.json())
    .then(data=>{
      const apiItems = Array.isArray(data)
        ? data.filter(x=>x && x.desc).map(x=>({desc:x.desc,amount:Number(x.amount||0),category:x.category||detectarCategoria(x.desc),isFixo:false}))
        : [];

      if(Array.isArray(data) && data.length){
        d.salary = Number(data[0].salary||d.salary||0);
        d.meta   = Number(data[0].meta||d.meta||0);
        if(typeof data[0].notes === "string") d.notes = data[0].notes;
      }

      const merged=[], seen=new Set();

      // fixos primeiro
      for(const f of fixos){
        const obj={...f,isFixo:true};
        const k=keyItem(obj);
        if(!seen.has(k)){merged.push(obj); seen.add(k);}
      }

      // depois itens da API
      for(const it of apiItems){
        const k=keyItem(it);
        if(!seen.has(k)){merged.push(it); seen.add(k);}
      }

      d.items = merged;

      salvarTudoLocal();
      paint();
      renderListaMeses();
    })
    .catch(()=>{
      salvarTudoLocal();
      paint();
      renderListaMeses();
    });
};

/* ==========================================================
   ‚úÖ SIMULADOR DE INVESTIMENTOS (MAIS OP√á√ïES)
========================================================== */
function clampNum(v, def=0){
  v = Number(v);
  return Number.isFinite(v) ? v : def;
}
function formatBRL(n){
  return "R$ " + Number(n||0).toFixed(2).replace(".", ",");
}
function anualParaMensalEfetivo(taxaAnual){
  const r = taxaAnual/100;
  return Math.pow(1+r, 1/12) - 1;
}
function aliquotaIR(dias){
  if(dias <= 180) return 0.225;
  if(dias <= 360) return 0.20;
  if(dias <= 720) return 0.175;
  return 0.15;
}
function iofAprox(dias){
  if(dias >= 30) return 0;
  if(dias <= 0) return 0.96;
  return (30 - dias) / 30 * 0.96;
}
function simularComAporte(inicial, aporteMensal, meses, taxaMensal){
  let saldo = inicial;
  for(let m=1; m<=meses; m++){
    saldo = saldo * (1 + taxaMensal) + aporteMensal;
  }
  const investido = inicial + aporteMensal * meses;
  const lucroBruto = saldo - investido;
  return { final: saldo, investido, lucroBruto };
}
function atualizarCamposInvestimento(){
  const tipo = document.getElementById("invTipo").value;
  const boxCDI = document.getElementById("boxCDI");
  const boxPrefixado = document.getElementById("boxPrefixado");
  const boxIPCA = document.getElementById("boxIPCA");
  const boxFundo = document.getElementById("boxFundo");
  const boxRV = document.getElementById("boxRV");

  boxCDI.style.display = "none";
  boxPrefixado.style.display = "none";
  boxIPCA.style.display = "none";
  boxFundo.style.display = "none";
  boxRV.style.display = "none";

  if(tipo === "poupanca" || tipo === "tesouro_selic" || tipo === "cdb" || tipo === "lci_lca" || tipo === "fundo_di"){
    boxCDI.style.display = "block";
  }
  if(tipo === "prefixado"){ boxPrefixado.style.display = "block"; }
  if(tipo === "ipca_plus"){ boxIPCA.style.display = "block"; }
  if(tipo === "fundo_di"){ boxFundo.style.display = "block"; }
  if(tipo === "renda_variavel"){ boxRV.style.display = "block"; }
}
window.simularInvestimentos = function(){
  const tipo = document.getElementById("invTipo").value;

  const inicial = Math.max(0, clampNum(document.getElementById("invInicial").value, 0));
  const aporte  = Math.max(0, clampNum(document.getElementById("invAporte").value, 0));
  let meses     = Math.max(0, Math.floor(clampNum(document.getElementById("invMeses").value, 0)));
  let diasExtra = Math.max(0, Math.floor(clampNum(document.getElementById("invDias").value, 0)));

  if(meses === 0 && diasExtra > 0){
    meses = Math.floor(diasExtra / 30);
    diasExtra = diasExtra % 30;
  }

  const diasTotais = meses*30 + diasExtra;
  const aplicarIOF = !!document.getElementById("invAplicarIOF").checked;

  const out = document.getElementById("resultadoInv");
  const det = document.getElementById("detalhesInv");

  if(inicial <= 0 && aporte <= 0){
    out.textContent = "Informe um valor inicial ou um aporte mensal.";
    det.textContent = "";
    return;
  }
  if(meses <= 0 && diasExtra <= 0){
    out.textContent = "Informe o tempo (meses ou dias).";
    det.textContent = "";
    return;
  }

  // taxa mensal
  let taxaMensal = 0;
  let textoTaxa = "";

  if(tipo === "poupanca"){
    // aproxima√ß√£o simples: 70% CDI ao ano (depende da Selic)
    const cdi = clampNum(document.getElementById("invCDI").value, 10.5);
    const anual = cdi * 0.70;
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `Poupan√ßa (aprox. 70% do CDI): ~${anual.toFixed(2)}% a.a.`;
  }

  if(tipo === "tesouro_selic"){
    const cdi = clampNum(document.getElementById("invCDI").value, 10.5);
    taxaMensal = anualParaMensalEfetivo(cdi);
    textoTaxa = `Tesouro Selic (aprox CDI): ${cdi.toFixed(2)}% a.a.`;
  }

  if(tipo === "cdb" || tipo === "lci_lca" || tipo === "fundo_di"){
    const cdi = clampNum(document.getElementById("invCDI").value, 10.5);
    const perc = clampNum(document.getElementById("invPercCDI").value, 100);
    let anual = cdi * (perc/100);

    if(tipo === "fundo_di"){
      const adm = clampNum(document.getElementById("invAdm").value, 1.0);
      anual = Math.max(0, anual - adm);
      textoTaxa = `Fundo DI: CDI ${cdi.toFixed(2)}% * ${perc.toFixed(0)}% - adm ${adm.toFixed(2)}% ‚âà ${anual.toFixed(2)}% a.a.`;
    }else if(tipo === "lci_lca"){
      textoTaxa = `LCI/LCA: CDI ${cdi.toFixed(2)}% * ${perc.toFixed(0)}% ‚âà ${anual.toFixed(2)}% a.a. (isento IR)`;
    }else{
      textoTaxa = `CDB: CDI ${cdi.toFixed(2)}% * ${perc.toFixed(0)}% ‚âà ${anual.toFixed(2)}% a.a.`;
    }

    taxaMensal = anualParaMensalEfetivo(anual);
  }

  if(tipo === "prefixado"){
    const anual = clampNum(document.getElementById("invPrefixado").value, 12);
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `Prefixado: ${anual.toFixed(2)}% a.a.`;
  }

  if(tipo === "ipca_plus"){
    const ipca = clampNum(document.getElementById("invIPCA").value, 4.5);
    const real = clampNum(document.getElementById("invReal").value, 5.5);
    const anual = ( (1+ipca/100) * (1+real/100) - 1 ) * 100;
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `IPCA+ (aprox): IPCA ${ipca.toFixed(2)}% + real ${real.toFixed(2)}% ‚âà ${anual.toFixed(2)}% a.a.`;
  }

  if(tipo === "renda_variavel"){
    const anual = clampNum(document.getElementById("invRV").value, 15);
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `Renda vari√°vel (m√©dia): ${anual.toFixed(2)}% a.a.`;
  }

  // simula (meses inteiros)
  const res = simularComAporte(inicial, aporte, meses, taxaMensal);

  // ajuste por dias extras (juros proporcional aproximado)
  let final = res.final;
  if(diasExtra > 0){
    final = final * (1 + taxaMensal * (diasExtra/30));
  }

  const investido = inicial + aporte * meses;
  let lucroBruto = final - investido;

  // impostos (aprox)
  let imposto = 0;
  let iof = 0;

  const temIR = (tipo === "cdb" || tipo === "tesouro_selic" || tipo === "fundo_di" || tipo === "prefixado" || tipo === "ipca_plus");
  const isentoIR = (tipo === "lci_lca" || tipo === "poupanca" || tipo === "renda_variavel"); // RV tem impostos pr√≥prios, aqui simplificando

  if(temIR){
    const aliq = aliquotaIR(diasTotais);
    imposto = Math.max(0, lucroBruto) * aliq;
  }else if(!isentoIR && tipo === "renda_variavel"){
    imposto = 0; // simplificado
  }

  if(aplicarIOF){
    const fator = iofAprox(diasTotais);
    iof = Math.max(0, lucroBruto) * fator;
  }

  const lucroLiquido = lucroBruto - imposto - iof;

  out.textContent = `Final: ${formatBRL(final)} ‚Ä¢ Lucro l√≠quido: ${formatBRL(lucroLiquido)}`;
  det.textContent =
    `${textoTaxa}\n` +
    `Investido: ${formatBRL(investido)}\n` +
    `Lucro bruto: ${formatBRL(lucroBruto)}\n` +
    `IR (estimado): ${formatBRL(imposto)}\n` +
    `IOF (estimado): ${formatBRL(iof)}\n` +
    `Per√≠odo: ~${diasTotais} dias`;
};

/* ==========================================================
   ‚úÖ IA (Ollama) COM CONTEXTO DO SEU M√äS
========================================================== */
function getIaBase(){
  return (window.API_BASE_URL || "").replace(/\/$/, "");
}

function resumoDoMesParaIA(){
  const d = window.getDataMes();
  const items = d.items || [];
  const total = items.reduce((a,b)=>a+Number(b.amount||0),0);
  const sobra = Number(d.salary||0) - total;

  // total por categoria
  const porCat = {};
  for(const it of items){
    const c = it.category || "Outros";
    porCat[c] = (porCat[c] || 0) + Number(it.amount||0);
  }

  const topCats = Object.entries(porCat)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,6)
    .map(([c,v])=>`${c}: R$ ${v.toFixed(2)}`)
    .join(", ");

  const fixosTotal = items.filter(x=>x.isFixo).reduce((a,b)=>a+Number(b.amount||0),0);

  return `
M√äS: ${mesAtual}
SAL√ÅRIO: R$ ${Number(d.salary||0).toFixed(2)}
META: R$ ${Number(d.meta||0).toFixed(2)}
GASTO TOTAL: R$ ${total.toFixed(2)}
GASTO FIXO TOTAL: R$ ${fixosTotal.toFixed(2)}
SOBRA: R$ ${sobra.toFixed(2)}
TOP CATEGORIAS: ${topCats || "sem dados"}
ANOTA√á√ïES: ${(d.notes||"").trim() || "(vazio)"}
  `.trim();
}

async function iaHealth(){
  try{
    const base = getIaBase();
    if(!base) throw new Error("API_BASE_URL n√£o definido no config.js");
    const r = await fetch(base + "/");
    const j = await r.json();
    const el = document.getElementById("iaStatus");
    if(el) el.textContent = (j && j.message) ? j.message : "Online ‚úÖ";
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    const el = document.getElementById("iaStatus");
    if(el) el.textContent = "Offline: " + msg;
  }
}

window.iaPerguntar = async function(){
  const promptEl = document.getElementById("iaPrompt");
  const outEl = document.getElementById("iaResposta");
  const statusEl = document.getElementById("iaStatus");

  const pergunta = (promptEl.value || "").trim();
  if(!pergunta){
    outEl.textContent = "Digite uma pergunta.";
    return;
  }

  try{
    outEl.textContent = "Pensando...";
    if(statusEl) statusEl.textContent = "Consultando IA...";

    const base = getIaBase();
    if(!base) throw new Error("API_BASE_URL n√£o definido no config.js");

    const url = base + "/api/chat";

    const contexto = resumoDoMesParaIA();

    const promptFinal =
`Voc√™ √© um consultor financeiro pessoal. Use os dados abaixo para responder de forma pr√°tica.
- Se eu perguntar sobre investimento, sugira 1 a 3 op√ß√µes coerentes com minha SOBRA e perfil conservador por padr√£o.
- Se a SOBRA estiver negativa, explique como ajustar gastos antes de investir.
- Responda em portugu√™s, direto, com passos.

DADOS DO USU√ÅRIO:
${contexto}

PERGUNTA:
${pergunta}
`;

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama3.2:3b",
        prompt: promptFinal
      })
    });

    const data = await resp.json();
    outEl.textContent = data.response || JSON.stringify(data, null, 2);
    if(statusEl) statusEl.textContent = "Online ‚úÖ";
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    outEl.textContent = "Erro: " + msg;
    if(statusEl) statusEl.textContent = "Erro ‚ùå";
  }
};

/* ==========================================================
   ‚úÖ INIT
========================================================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  showLoading();

  const ok = await initFirebase();
  if(!ok) return;

  // m√™s padr√£o
  const monthEl = document.getElementById("month");
  if(monthEl && !monthEl.value){
    monthEl.value = new Date().toISOString().slice(0,7);
  }

  // investimento: mostra campos corretos
  atualizarCamposInvestimento();

  document.getElementById("month").addEventListener("change", ()=>{
    mesAtual = window.getMes();
    window.render();
  });

  // tenta pegar resultado do redirect do Google (se teve login)
  try{
    await auth.getRedirectResult();
  }catch(e){}

  const unsub = auth.onAuthStateChanged(async (user)=>{
    unsub && unsub();

    if(!user){
      // se n√£o tiver logado, manda pro login.html (como voc√™ j√° fazia)
      location.replace("./login.html");
      return;
    }

    window.USER_ID = user.uid;
    document.getElementById("userName").innerText = user.displayName || user.email;

    carregarCategorias();
    carregarFixos();
    renderCategorias();
    renderFixos();

    try{
      const raw = localStorage.getItem("gastos_pro");
      if(raw) state = JSON.parse(raw) || { meses:{} };
    }catch(e){ state = { meses:{} }; }

    mesAtual = window.getMes();
    showApp();
    window.render();
    iaHealth();
  });
});
</script>

</body>
</html>
