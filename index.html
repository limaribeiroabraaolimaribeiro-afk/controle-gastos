<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<style>
:root{
  --bg:#0b1020;
  --card:#ffffff0f;
  --text:#eaf0ff;
  --accent:#569cff;
}
.light{
  --bg:#f4f6ff;
  --card:#ffffff;
  --text:#111;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
}
h1{font-size:20px;margin:0 0 10px}
input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:5px;
}
button{
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  touch-action: manipulation;
}
.kpis{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}
.kpi{
  background:var(--card);
  padding:10px;
  border-radius:10px;
}
.success{color:#4CAF50}
.warn{color:#ffd166}
.danger{color:#ff6b6b}
#chart,#chartEvolucao{width:100%;height:220px}
.fab{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#4CAF50;
  color:white;
  border-radius:50%;
  width:55px;
  height:55px;
  font-size:28px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.toggle{float:right;cursor:pointer}
.small{opacity:.8;font-size:12px}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  margin-left:6px;
  font-size:12px;
}
.light .badge{background:rgba(0,0,0,.08);}
.row{
  display:flex;
  gap:8px;
  align-items:center;
}
.row > * {flex:1}
.row .mini {flex:0 0 auto; width:auto; padding:8px 10px; border-radius:10px;}

#debugBox{
  position:fixed;
  left:12px;
  right:12px;
  bottom:12px;
  background:rgba(0,0,0,.75);
  color:#fff;
  padding:10px;
  border-radius:12px;
  font-size:12px;
  z-index:999999;
  display:none;
  white-space:pre-wrap;
}
hr{border:none;height:1px;background:rgba(255,255,255,.2)}
.light hr{background:rgba(0,0,0,.15)}
</style>

<!-- ‚úÖ STUBS: impede "is not defined" SEM mexer nos onclick -->
<script>
function dbg(msg){
  var box = document.getElementById("debugBox");
  if(!box) return;
  box.style.display = "block";
  box.textContent = String(msg);
}

window.addEventListener("error", function(e){
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", function(e){
  var r = e.reason;
  dbg("Promise rejeitada:\n" + (r && (r.code || r.message) ? (r.code + " - " + r.message) : String(r)));
});

function loginEmail(){
  if(typeof window._loginEmail === "function") return window._loginEmail();
  dbg("App ainda carregando... (loginEmail)");
}
function registrarEmail(){
  if(typeof window._registrarEmail === "function") return window._registrarEmail();
  dbg("App ainda carregando... (registrarEmail)");
}
function loginGoogle(){
  if(typeof window._loginGoogle === "function") return window._loginGoogle();
  dbg("App ainda carregando... (loginGoogle)");
}
function logout(){
  if(typeof window._logout === "function") return window._logout();
}
</script>
</head>

<body>

<!-- ‚úÖ ANTI-CACHE PWA/GitHub Pages (resolve travar em vers√£o velha) -->
<script>
(async function(){
  try{
    if("serviceWorker" in navigator){
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs) await r.unregister();
    }
    if("caches" in window){
      const keys = await caches.keys();
      for(const k of keys) await caches.delete(k);
    }
  }catch(e){}
})();
</script>

<div id="loginScreen" style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center">
  <h2>Controle de Gastos PRO</h2>

  <input id="email" type="email" placeholder="Seu e-mail">
  <input id="senha" type="password" placeholder="Sua senha">

  <button id="btnLoginEmail" onclick="loginEmail()">Entrar com Email</button>
  <button id="btnCriarConta" onclick="registrarEmail()">Criar conta</button>

  <hr style="margin:10px 0;width:80%">

  <button id="btnLoginGoogle" onclick="loginGoogle()">Entrar com Google</button>
</div>

<div id="app" style="display:none">
  <div class="wrap">

    <h1>
      Controle de Gastos PRO
      <span class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
      <span class="toggle" onclick="abrirConfig()">‚öôÔ∏è</span>
    </h1>

    <div id="configBox" class="card" style="display:none">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <b id="userName"></b>
      <br><br>
      <button onclick="logout()">Sair da conta</button>
    </div>

    <div class="card">
      <h3>üìÇ Minhas Categorias</h3>
      <div class="row">
        <input id="novaCategoria" placeholder="Nome da categoria">
        <button class="mini" onclick="addCategoria()">Adicionar</button>
      </div>
      <div id="listaCategorias" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>üìå Gastos Fixos (Prioridades)</h3>
      <input id="descFixo" placeholder="Descri√ß√£o (ex: Aluguel)">
      <input id="valorFixo" type="number" placeholder="Valor (ex: 750)">
      <select id="categoriaFixo"></select>
      <button onclick="addFixo()">Adicionar gasto fixo</button>
      <div id="listaFixos" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <label>Sal√°rio</label>
      <input id="salary" type="number">

      <label>M√™s</label>
      <input id="month" type="month">

      <label>Meta</label>
      <input id="meta" type="number">

      <button onclick="saveSettings()">Salvar</button>
    </div>

    <div class="card">
      <h3>üß† Simulador Financeiro</h3>

      <label>Tipo</label>
      <select id="tipoSimulacao">
        <option value="compra">Compra / Empr√©stimo</option>
        <option value="investimento">Investimento</option>
      </select>

      <div id="areaCompra">
        <label>Valor total</label>
        <input id="valorSimulacao" type="number">

        <label>Parcelas</label>
        <input id="parcelasSimulacao" type="number">

        <label>Juros mensal (%)</label>
        <input id="jurosSimulacao" type="number">
      </div>

      <div id="areaInvestimento" style="display:none">
        <label>Valor a investir</label>
        <input id="valorInvestimento" type="number">

        <label>Meses</label>
        <input id="mesesInvestimento" type="number">

        <label>% do CDI</label>
        <input id="percentualInvest" type="number">
      </div>

      <button onclick="simularCompleto()">Calcular</button>
      <div id="resultadoSimulacao" style="margin-top:10px;font-weight:bold"></div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card">
      <canvas id="chart"></canvas>
    </div>

    <div class="card">
      <h3>Evolu√ß√£o</h3>
      <canvas id="chartEvolucao"></canvas>
    </div>

    <div class="card">
      <table id="list"></table>
    </div>

  </div>

  <div class="fab" onclick="abrirAdd()">+</div>
</div>

<div id="debugBox"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
/* ===========================
   ‚úÖ Vari√°veis globais do app
=========================== */
const API = "https://api-rf1w.onrender.com";

let auth = null;
let provider = null;

window.USER_ID = null;

let state = { meses:{} };

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Outros"];

let regras = [
  {palavra:"aluguel", categoria:"Casa"},
  {palavra:"luz", categoria:"Casa"},
  {palavra:"agua", categoria:"Casa"},
  {palavra:"√°gua", categoria:"Casa"},
  {palavra:"mercado", categoria:"Alimenta√ß√£o"},
  {palavra:"padaria", categoria:"Alimenta√ß√£o"},
  {palavra:"gasolina", categoria:"Transporte"},
  {palavra:"uber", categoria:"Transporte"},
  {palavra:"ra√ß√£o", categoria:"Pets"},
  {palavra:"pet", categoria:"Pets"}
];

let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];

let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;
let graficoEvolucao = null;

/* ===========================
   ‚úÖ Firebase init (ANTI DUPLICA√á√ÉO)
=========================== */
function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou. Verifique internet/blocked scripts.");
    return false;
  }
  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp({
        apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
        authDomain:"controle-gastos-pro.firebaseapp.com",
        projectId:"controle-gastos-pro"
      });
    }
  }catch(e){
    // j√° inicializado
  }
  auth = firebase.auth();
  provider = new firebase.auth.GoogleAuthProvider();
  return true;
}

/* ===========================
   ‚úÖ Fun√ß√µes storage
=========================== */
function salvarCategorias(){
  localStorage.setItem("categorias_" + window.USER_ID, JSON.stringify(categorias));
}
function carregarCategorias(){
  const raw = localStorage.getItem("categorias_" + window.USER_ID);
  categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
  if(!Array.isArray(categorias) || categorias.length === 0) categorias = [...DEFAULT_CATEGORIAS];
}
function salvarFixos(){
  localStorage.setItem("fixos_" + window.USER_ID, JSON.stringify(fixos));
}
function carregarFixos(){
  const raw = localStorage.getItem("fixos_" + window.USER_ID);
  fixos = raw ? JSON.parse(raw) : [];
  if(!Array.isArray(fixos)) fixos = [];
  fixos = fixos.map(f=>({ ...f, isFixo:true }));
}

/* ===========================
   ‚úÖ Helpers UI (globais p/ onclick)
=========================== */
window.toggleTheme = ()=> document.body.classList.toggle("light");

window.abrirConfig = ()=>{
  const box = document.getElementById("configBox");
  box.style.display = box.style.display==="none" ? "block" : "none";
};

window.getMes = ()=>{
  const monthInput = document.getElementById("month");
  return monthInput.value || new Date().toISOString().slice(0,7);
};

function keyItem(i){
  return `${(i.desc||"").toLowerCase()}|${Number(i.amount||0)}|${(i.category||"Outros").toLowerCase()}|${i.isFixo?1:0}`;
}

function garantirFixosNoMes(d){
  const set = new Set((d.items||[]).map(keyItem));
  for(const f of fixos){
    const obj = { ...f, isFixo:true };
    const k = keyItem(obj);
    if(!set.has(k)){
      d.items.unshift(obj);
      set.add(k);
    }
  }
}

window.getDataMes = ()=>{
  if(!state.meses[mesAtual]){
    state.meses[mesAtual] = {
      salary: 0,
      items: fixos.map(f=>({ ...f, isFixo:true })),
      meta: 0
    };
  } else {
    garantirFixosNoMes(state.meses[mesAtual]);
  }
  return state.meses[mesAtual];
};

function detectarCategoria(desc){
  const txt = (desc||"").toLowerCase();
  for(const r of regras){
    if(txt.includes(r.palavra)) return r.categoria;
  }
  return "Outros";
}

/* ===========================
   ‚úÖ CATEGORIAS (globais p/ onclick)
=========================== */
window.addCategoria = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  const input = document.getElementById("novaCategoria");
  const nome = (input.value || "").trim();
  if(!nome) return;

  const exists = categorias.some(c => c.toLowerCase() === nome.toLowerCase());
  if(exists){ alert("Essa categoria j√° existe."); return; }

  categorias.push(nome);
  input.value = "";
  salvarCategorias();
  renderCategorias();
};

function renderCategorias(){
  const div = document.getElementById("listaCategorias");
  const select = document.getElementById("categoriaFixo");

  div.innerHTML = categorias.map(c=>`<div>‚Ä¢ ${c}</div>`).join("");
  select.innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");
}

/* ===========================
   ‚úÖ FIXOS (globais p/ onclick)
=========================== */
window.addFixo = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  const desc = (document.getElementById("descFixo").value || "").trim();
  const valor = Number(document.getElementById("valorFixo").value);
  const categoria = document.getElementById("categoriaFixo").value || "Outros";

  if(!desc || !valor || valor <= 0){
    alert("Preencha descri√ß√£o e valor (maior que 0).");
    return;
  }

  fixos.push({ desc, amount: valor, category: categoria, isFixo:true });

  document.getElementById("descFixo").value = "";
  document.getElementById("valorFixo").value = "";

  salvarFixos();
  renderFixos();

  const d = window.getDataMes();
  garantirFixosNoMes(d);
  window.render();
};

function renderFixos(){
  const div = document.getElementById("listaFixos");
  if(fixos.length === 0){
    div.innerHTML = "<div>Nenhum gasto fixo cadastrado.</div>";
    return;
  }
  div.innerHTML = fixos.map(f=>`
    <div>‚Ä¢ ${f.desc} ‚Äî R$ ${Number(f.amount).toFixed(2)} <span class="badge">${f.category}</span></div>
  `).join("");
}

/* ===========================
   ‚úÖ CRUD GASTOS / SETTINGS
=========================== */
window.abrirAdd = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  mesAtual = window.getMes();
  const d = window.getDataMes();

  const desc = prompt("Descri√ß√£o");
  const valor = parseFloat(prompt("Valor"));
  if(!desc || isNaN(valor)) return;

  const categoria = detectarCategoria(desc);

  d.items.push({ desc, amount: valor, category: categoria, isFixo:false });

  fetch(API + "/addGasto", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      userId: window.USER_ID,
      mes: mesAtual,
      desc,
      amount: valor,
      category: categoria
    })
  }).catch(()=>{});

  window.render();
};

window.del = (i)=>{
  mesAtual = window.getMes();
  const d = window.getDataMes();
  d.items.splice(i,1);
  window.render();
};

window.saveSettings = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

  mesAtual = window.getMes();
  const d = window.getDataMes();

  d.salary = Number(document.getElementById("salary").value);
  d.meta = Number(document.getElementById("meta").value);

  fetch(API + "/salvarMes", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      userId: window.USER_ID,
      mes: mesAtual,
      salary: d.salary,
      meta: d.meta
    })
  }).catch(()=>{});

  window.render();
};

/* ===========================
   ‚úÖ GR√ÅFICOS + RENDER
=========================== */
function drawChart(items){
  const mapa = {};
  items.forEach(i=>{
    const cat = i.category || "Outros";
    mapa[cat] = (mapa[cat] || 0) + Number(i.amount||0);
  });

  const labels = Object.keys(mapa);
  const valores = Object.values(mapa);

  if(grafico) grafico.destroy();
  grafico = new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{ labels, datasets:[{ data: valores }] }
  });
}

function drawEvolucao(){
  const meses = Object.keys(state.meses).sort();
  const valores = meses.map(m=>{
    const it = state.meses[m].items || [];
    return it.reduce((a,b)=>a+Number(b.amount||0),0);
  });

  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao = new Chart(document.getElementById("chartEvolucao"),{
    type:"line",
    data:{ labels: meses, datasets:[{ data: valores }] }
  });
}

window.render = ()=>{
  if(!window.USER_ID) return;

  mesAtual = window.getMes();
  const d = window.getDataMes();

  paint();

  fetch(API + "/mes/" + window.USER_ID + "/" + mesAtual)
    .then(r=>r.json())
    .then(data=>{
      const apiItems = Array.isArray(data)
        ? data.filter(x=>x && x.desc).map(x=>({
            desc: x.desc,
            amount: Number(x.amount||0),
            category: x.category || detectarCategoria(x.desc),
            isFixo: false
          }))
        : [];

      if(Array.isArray(data) && data.length){
        d.salary = Number(data[0].salary || d.salary || 0);
        d.meta = Number(data[0].meta || d.meta || 0);
      }

      const merged = [];
      const seen = new Set();

      for(const f of fixos){
        const obj = { ...f, isFixo:true };
        const k = keyItem(obj);
        if(!seen.has(k)){ merged.push(obj); seen.add(k); }
      }
      for(const it of apiItems){
        const k = keyItem(it);
        if(!seen.has(k)){ merged.push(it); seen.add(k); }
      }

      d.items = merged;
      localStorage.setItem("gastos_pro", JSON.stringify(state));
      paint();
    })
    .catch(()=> paint());
};

function paint(){
  const d = window.getDataMes();

  document.getElementById("salary").value = Number(d.salary||0);
  document.getElementById("month").value = mesAtual;
  document.getElementById("meta").value = d.meta || "";

  const total = d.items.reduce((a,b)=>a+Number(b.amount||0),0);
  const sobra = Number(d.salary||0) - total;

  document.getElementById("kpis").innerHTML = `
    <div class="kpi">Sal√°rio<br><b>R$ ${Number(d.salary||0).toFixed(2)}</b></div>
    <div class="kpi">Gasto<br><b>R$ ${total.toFixed(2)}</b></div>
    <div class="kpi">Sobra<br><b>R$ ${sobra.toFixed(2)}</b></div>
    <div class="success">Voc√™ economizou R$ ${sobra.toFixed(2)}</div>
  `;

  document.getElementById("list").innerHTML = d.items.map((i,idx)=>`
    <tr>
      <td>
        ${i.desc}
        ${i.isFixo ? `<span class="badge">Fixo</span>` : ``}
        <span class="badge">${i.category || "Outros"}</span>
      </td>
      <td>R$ ${Number(i.amount||0).toFixed(2)}</td>
      <td><button onclick="del(${idx})">X</button></td>
    </tr>
  `).join("");

  drawChart(d.items);
  drawEvolucao();
}

/* ===========================
   ‚úÖ SIMULADOR (igual voc√™ tinha)
=========================== */
window.simularCompleto = ()=>{
  const tipo = document.getElementById("tipoSimulacao").value;

  const d = window.getDataMes();
  const gastos = d.items.reduce((a,b)=>a+Number(b.amount||0),0);
  const salario = Number(d.salary||0);

  const resultadoSimEl = document.getElementById("resultadoSimulacao");

  if(tipo==="compra"){
    const valor = Number(document.getElementById("valorSimulacao").value);
    const parcelas = Number(document.getElementById("parcelasSimulacao").value);
    const juros = Number(document.getElementById("jurosSimulacao").value)/100;

    const i = juros;
    const n = parcelas;

    const parcela = valor * ( i / (1 - Math.pow(1+i, -n)) );
    const total = parcela * n;
    const jurosTotal = total - valor;

    const sobra = salario - gastos - parcela;
    const resultado = sobra>salario*0.3 ? "üü¢ Vale a pena" : sobra>0 ? "üü° Cuidado" : "üî¥ N√£o recomendado";

    resultadoSimEl.innerHTML = `
      Parcela real: R$ ${parcela.toFixed(2)}<br>
      Total pago: R$ ${total.toFixed(2)}<br>
      Juros pagos: R$ ${jurosTotal.toFixed(2)}<br>
      Sobra ap√≥s pagar: R$ ${sobra.toFixed(2)}<br><br>
      ${resultado}
    `;
  }else{
    const valor = Number(document.getElementById("valorInvestimento").value);
    const meses = Number(document.getElementById("mesesInvestimento").value);
    const perc = Number(document.getElementById("percentualInvest").value)/100;

    const taxaCDI = 0.012; // exemplo
    const total = valor*(1+(taxaCDI*perc))**meses;
    const lucro = total-valor;

    resultadoSimEl.innerHTML = `
      Valor final: R$ ${total.toFixed(2)}<br>
      Lucro: R$ ${lucro.toFixed(2)}
    `;
  }
};

/* ===========================
   ‚úÖ LOGIN (IMPLEMENTA√á√ïES reais)
   - stubs chamam essas fun√ß√µes
=========================== */
window._loginGoogle = ()=>{
  if(!auth){ alert("Firebase n√£o carregou."); return; }
  auth.signInWithRedirect(provider).catch(e=>alert((e.code||"") + " - " + e.message));
};

window._logout = ()=>{
  if(!auth) return;
  auth.signOut().catch(e=>alert((e.code||"") + " - " + e.message));
};

window._loginEmail = ()=>{
  if(!auth){ alert("Firebase n√£o carregou."); return; }

  const email = document.getElementById(
