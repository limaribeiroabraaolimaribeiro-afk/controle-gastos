<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<!-- ‚úÖ NOVA IA (Cloudflare Workers AI) -->
<script>
  // ‚úÖ Cloudflare Workers AI (online)
  window.API_BASE_URL = "https://gastospro-ai.limaribeiroabraoolimaribeiro.workers.dev";
  window.APP_KEY = "GastosPro@2026!";
</script>

<style>
:root{
  --bg:#07101f;

  /* Fundo (configur√°vel) */
  --grad1: rgba(86,156,255,.22);
  --grad2: rgba(57,217,138,.16);
  --grad3: rgba(255,93,93,.12);

  --panel: rgba(255,255,255,.06);
  --panel2: rgba(255,255,255,.08);
  --stroke: rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.72);

  /* Cor principal (configur√°vel) */
  --accent:#569cff;

  --good:#39d98a;
  --warn:#ffd166;
  --danger:#ff5d5d;
  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --radius: 18px;
  --radius2: 22px;
  --pad: 14px;
  --glass: blur(14px);
}
.light{
  --bg:#f4f6ff;

  --grad1: rgba(86,156,255,.20);
  --grad2: rgba(57,217,138,.14);
  --grad3: rgba(255,93,93,.10);

  --panel: rgba(0,0,0,.04);
  --panel2: rgba(0,0,0,.06);
  --stroke: rgba(0,0,0,.08);
  --text:#0d1222;
  --muted: rgba(13,18,34,.68);
  --shadow: 0 18px 60px rgba(0,0,0,.12);
}

*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(1000px 700px at 20% 10%, var(--grad1), transparent 55%),
    radial-gradient(900px 700px at 80% 30%, var(--grad2), transparent 60%),
    radial-gradient(800px 600px at 70% 90%, var(--grad3), transparent 60%),
    var(--bg);
  color:var(--text);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
  min-height:100vh;
}

a{color:inherit}
.wrap{max-width:980px;margin:auto;padding:16px;padding-bottom:120px}
h1{margin:0;font-size:20px;letter-spacing:.2px}
h2{margin:0;font-size:16px}
h3{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:600}
.small{font-size:12px;color:var(--muted)}
.card{
  background: linear-gradient(180deg, var(--panel2), var(--panel));
  border: 1px solid var(--stroke);
  border-radius: var(--radius2);
  padding: 14px;
  box-shadow: var(--shadow);
  backdrop-filter: var(--glass);
}
.row{display:flex;gap:10px;align-items:center}
.row > *{flex:1}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.grid1{display:grid;grid-template-columns:1fr;gap:12px}
.btn{
  appearance:none;border:0;cursor:pointer;
  background: rgba(255,255,255,.10);
  color:var(--text);
  padding:12px 12px;border-radius:14px;
  border:1px solid var(--stroke);
  font-weight:650;
  box-shadow: 0 10px 26px rgba(0,0,0,.18);
}
.btn.primary{
  background: var(--accent);
  border-color: color-mix(in srgb, var(--accent), transparent 55%);
  color:#fff;
}
.btn.good{
  background: var(--good);
  border-color: color-mix(in srgb, var(--good), transparent 55%);
  color:#062114;
}
.btn.warn{
  background: var(--warn);
  border-color: color-mix(in srgb, var(--warn), transparent 55%);
  color:#281a00
}
.btn.ghost{background: transparent}
.btn.mini{padding:9px 10px;border-radius:12px;font-size:13px}
.btn.icon{width:44px;height:44px;display:flex;align-items:center;justify-content:center;padding:0;border-radius:16px}
.btn:active{transform: translateY(1px)}
input,select,textarea{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--stroke);
  outline:none;
  background: rgba(0,0,0,.15);
  color:var(--text);
  font-size:14px;
}
.light input,.light select,.light textarea{background: rgba(255,255,255,.75)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
.badge{
  display:inline-flex;gap:6px;align-items:center;
  padding:4px 10px;border-radius:999px;
  background: rgba(255,255,255,.10);
  border:1px solid var(--stroke);
  font-size:12px;color:var(--muted);
}
.badge.good{color:var(--good); border-color: rgba(57,217,138,.35); background: rgba(57,217,138,.10)}
.badge.warn{color:var(--warn); border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10)}
.kpi{
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  border-radius: 18px;
  padding:12px;
}
.kpi .v{font-size:18px;font-weight:800;margin-top:6px}

.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
.topbar .right{display:flex;gap:10px;align-items:center}
.pill{
  display:flex;gap:10px;align-items:center;justify-content:center;
  padding:10px 12px;border-radius:18px;
  border:1px solid var(--stroke);
  min-width:92px;
  font-weight:800;
}
.pill.menuBtn{
  background: rgba(255,255,255,.14);
  border-color: rgba(255,255,255,.20);
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
}
.pill.themeBtn{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
}
.pill .icon{opacity:.95}

.list{width:100%;border-collapse:separate;border-spacing:0 10px}
.list tr{background: rgba(255,255,255,.06);border:1px solid var(--stroke)}
.list td{padding:12px}
.list tr td:first-child{border-top-left-radius:16px;border-bottom-left-radius:16px}
.list tr td:last-child{border-top-right-radius:16px;border-bottom-right-radius:16px}

.fabWrap{
  position:fixed; right:18px; bottom:18px;
  display:flex; flex-direction:column; gap:10px; z-index:999;
}
.fab{
  width:58px;height:58px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  cursor:pointer; user-select:none;
}
.fab.add{
  background: radial-gradient(90px 70px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
              linear-gradient(135deg, rgba(57,217,138,.98), rgba(57,217,138,.55));
  color:#062114; font-size:30px; font-weight:900;
}
.fab.ai{
  background: radial-gradient(90px 70px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
              linear-gradient(135deg, color-mix(in srgb, var(--accent), #fff 15%), color-mix(in srgb, var(--accent), #000 20%));
  color:#04152c; font-weight:1000; letter-spacing:.8px;
  font-size:12px; line-height:1.05; text-align:center;
}
.light .fab.ai{color:#04152c}
.fab.ai span{display:block;font-weight:950;font-size:13px}
.fab.ai em{font-style:normal;font-weight:900;font-size:11px;opacity:.9}

.overlay{
  position:fixed;inset:0;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:2000;
}
.modal{
  width: min(520px, 100%);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
  border: 1px solid var(--stroke);
  border-radius: 22px;
  box-shadow: var(--shadow);
  backdrop-filter: var(--glass);
  overflow:hidden;
}
.modalHeader{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 14px;
  border-bottom:1px solid var(--stroke);
}
.modalHeader .title{display:flex;gap:10px;align-items:center;font-weight:900}
.modalBody{padding:14px}
.modalFooter{
  padding:14px;border-top:1px solid var(--stroke);
  display:flex;gap:10px;justify-content:flex-end;
}
.closeX{
  width:42px;height:42px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  cursor:pointer;
  font-weight:900;
}
.screen{display:none}
.screen.active{display:block}
.backRow{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.backBtn{display:flex;align-items:center;gap:8px;border-radius:16px;padding:10px 12px;font-weight:850}
.hr{height:1px;background:var(--stroke);margin:12px 0}
.note{
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  padding:10px 12px;border-radius:16px;
}
.successText{color: var(--good);font-weight:800}
.warnText{color: var(--warn);font-weight:800}
.dangerText{color: var(--danger);font-weight:900}

#loading{
  display:flex;align-items:center;justify-content:center;
  height:100vh;padding:24px;text-align:center;
}
#debugBox{
  position:fixed; left:12px; right:12px; bottom:12px;
  background:rgba(0,0,0,.78); color:#fff; padding:10px; border-radius:12px;
  font-size:12px; z-index:9999; display:none; white-space:pre-wrap;
}

/* Chat */
.chatBox{
  height: 42vh;
  min-height: 260px;
  max-height: 420px;
  overflow:auto;
  padding:12px;
  border-radius:18px;
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.16);
}
.light .chatBox{background: rgba(255,255,255,.60)}
.bubble{
  max-width: 86%;
  padding:10px 12px;
  border-radius: 18px;
  margin: 8px 0;
  border:1px solid var(--stroke);
}
.bubble.me{margin-left:auto;background: color-mix(in srgb, var(--accent), transparent 80%)}
.bubble.bot{margin-right:auto;background: rgba(255,255,255,.08)}
.chatComposer{display:flex;gap:10px;margin-top:12px}
.chatComposer input{flex:1}

.mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

/* ‚úÖ Editor do painel (Config > Edi√ß√£o) */
.layoutItem{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 12px;border-radius:16px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
}
.layoutLeft{display:flex;align-items:center;gap:10px;min-width:0}
.layoutTitle{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.layoutActions{display:flex;gap:8px;flex:0 0 auto}
.chk{
  width:18px;height:18px;accent-color: var(--accent);
}
.handle{
  width:34px;height:34px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
  font-weight:900;
  user-select:none;
}
</style>
</head>

<body>

<div id="loading">
  <div class="card" style="max-width:520px;width:100%">
    <h2 style="font-weight:900;margin-bottom:6px">Carregando‚Ä¶</h2>
    <div class="small">Validando login e preparando seus dados.</div>
    <div class="hr"></div>
    <div class="small">Se demorar, verifique sua internet.</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="wrap">

    <!-- TOP BAR -->
    <div class="topbar">
      <div>
        <h1>Controle de Gastos PRO</h1>
        <div class="small" id="subHeader">Aqui fica s√≥ o essencial. Para editar categorias, fixos e simuladores, use o Menu.</div>
      </div>
      <div class="right">
        <button class="pill menuBtn" onclick="openMenu()" title="Menu">
          <span class="icon">‚ò∞</span> Menu
        </button>
        <button class="pill themeBtn" onclick="toggleTheme()" title="Tema">
          <span class="icon">üåô/‚òÄÔ∏è</span>
        </button>
      </div>
    </div>

    <!-- SCREEN: HOME -->
    <div class="screen active" id="screen-home">
      <!-- ‚úÖ Tudo do home agora √© montado dentro desse container, e a ordem/visibilidade vem da Config > Edi√ß√£o -->
      <div id="homeContainer">

        <!-- SECTION: Resumo -->
        <div data-home="resumo">
          <div class="card">
            <h2 style="font-weight:900;margin-bottom:10px">Resumo do m√™s</h2>

            <div class="grid2">
              <div>
                <label>M√™s</label>
                <select id="monthSelect"></select>
              </div>
              <div>
                <label>Sal√°rio</label>
                <input id="salary" type="number" placeholder="Ex: 4000">
              </div>
              <div>
                <label>Meta</label>
                <input id="meta" type="number" placeholder="Ex: 500">
              </div>
              <div>
                <label>Guardado (adicionar)</label>
                <input id="savedValue" type="number" placeholder="Ex: 1000">
              </div>
            </div>

            <div class="grid2" style="margin-top:10px">
              <div style="grid-column:1/2">
                <label>Descri√ß√£o do guardado (opcional)</label>
                <input id="savedDesc" placeholder="Ex: Reserva, CDB, Tesouro...">
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn primary" style="width:100%" onclick="addSaved()">Adicionar</button>
              </div>
            </div>

            <div id="savedList" style="margin-top:12px"></div>

            <div class="row" style="margin-top:14px">
              <button class="btn primary" onclick="saveSettings()" style="flex:1">Salvar</button>
              <button class="btn" onclick="openHistory()" style="flex:1">üìÖ Hist√≥rico</button>
            </div>

            <div class="small" style="margin-top:10px">
              Dica: toque em <b>IA PRO</b> para analisar seu m√™s e sugerir investimentos.
            </div>
          </div>
        </div>

        <!-- SECTION: KPIs -->
        <div data-home="kpis" style="margin-top:12px">
          <div class="grid2">
            <div class="kpi">
              <div class="small">Sal√°rio</div>
              <div class="v" id="kpiSalary">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="small">Gasto</div>
              <div class="v" id="kpiSpent">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="small">Sobra</div>
              <div class="v" id="kpiLeft">R$ 0,00</div>
            </div>
            <div class="kpi">
              <div class="small">Guardado</div>
              <div class="v" id="kpiSaved">R$ 0,00</div>
            </div>
          </div>
        </div>

        <!-- SECTION: Chart categorias -->
        <div data-home="chartCat" style="margin-top:12px">
          <div class="card">
            <h3>Gastos por categoria</h3>
            <canvas id="chart" style="width:100%;height:220px"></canvas>
          </div>
        </div>

        <!-- SECTION: Evolu√ß√£o -->
        <div data-home="chartEvo" style="margin-top:12px">
          <div class="card">
            <h3>Evolu√ß√£o</h3>
            <canvas id="chartEvolucao" style="width:100%;height:220px"></canvas>
          </div>
        </div>

        <!-- SECTION: Lista -->
        <div data-home="lista" style="margin-top:12px">
          <div class="card">
            <h3>Lista do m√™s</h3>
            <div class="small" style="margin-bottom:10px">
              Toque em <b>Pendente/Pago</b> para marcar se voc√™ j√° pagou.
              <br>‚úÖ Itens de investimento fixo (Juntar) tamb√©m aparecem aqui.
              <br>‚úÖ Ao marcar ‚ÄúPago‚Äù em ‚ÄúJuntar‚Äù, o valor entra automaticamente no <b>Guardado</b>.
            </div>
            <table class="list" id="list"></table>
          </div>
        </div>

      </div>
    </div>

    <!-- SCREEN: MENU -->
    <div class="screen" id="screen-menu">
      <div class="backRow">
        <button class="btn backBtn" onclick="goHome()">‚Üê Voltar</button>
        <div style="font-weight:900">Menu</div>
      </div>

      <div class="grid1">
        <button class="btn" onclick="openScreen('screen-config')">‚öôÔ∏è Configura√ß√µes</button>
        <button class="btn" onclick="openScreen('screen-simulators')">üß† Simuladores</button>
        <button class="btn" onclick="openScreen('screen-categories')">üìÇ Minhas Categorias</button>
        <button class="btn" onclick="openScreen('screen-fixos')">üìå Gastos Fixos</button>
        <button class="btn" onclick="openScreen('screen-investfixos')">üìà Investimentos Fixos</button>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h3>Conta</h3>
        <div class="row">
          <div>
            <div style="font-weight:900" id="userName">‚Äî</div>
            <div class="small" id="userEmail">‚Äî</div>
          </div>
          <button class="btn" onclick="logout()">Sair</button>
        </div>
      </div>
    </div>

    <!-- SCREEN: CONFIG -->
    <div class="screen" id="screen-config">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Configura√ß√µes</div>
      </div>

      <div class="grid1">
        <button class="btn" onclick="openScreen('screen-themes')">üé® Temas</button>
        <!-- ‚úÖ NOVO: Edi√ß√£o do painel -->
        <button class="btn" onclick="openHomeEditor()">üß© Edi√ß√£o do painel</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Hist√≥rico</h3>
        <div class="small">Acesse seu hist√≥rico completo de meses.</div>
        <div class="hr"></div>
        <button class="btn primary" onclick="openHistory()">üìÖ Abrir hist√≥rico</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Prefer√™ncias</h3>
        <button class="btn" onclick="toggleTheme()">üåô/‚òÄÔ∏è Alternar tema</button>
      </div>
    </div>

    <!-- ‚úÖ SCREEN: HOME EDITOR -->
    <div class="screen" id="screen-home-editor">
      <div class="backRow">
        <button class="btn backBtn" onclick="openScreen('screen-config')">‚Üê Voltar</button>
        <div style="font-weight:900">Edi√ß√£o do painel</div>
      </div>

      <div class="card">
        <h3>Organize sua tela principal</h3>
        <div class="small">
          Marque o que aparece e use as setas para mudar a ordem (pra cima/baixo).
          Assim, cada pessoa monta o painel do jeito que quiser.
        </div>

        <div class="hr"></div>

        <div id="layoutList"></div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" onclick="resetHomeLayout()">‚Ü©Ô∏è Padr√£o</button>
          <button class="btn primary" onclick="applyHomeLayoutFromEditor()">Salvar e aplicar</button>
        </div>
      </div>
    </div>

    <!-- SCREEN: THEMES -->
    <div class="screen" id="screen-themes">
      <div class="backRow">
        <button class="btn backBtn" onclick="openScreen('screen-config')">‚Üê Voltar</button>
        <div style="font-weight:900">Temas</div>
      </div>

      <div class="card">
        <h3>Cor do app (painel/fundo)</h3>
        <div class="small">Escolha um estilo de fundo. Isso muda o painel principal.</div>

        <div class="hr"></div>

        <label>Preset</label>
        <select id="themePreset" onchange="saveThemePreset()">
          <option value="default">Padr√£o (Azul/Verde)</option>
          <option value="purple">Roxo</option>
          <option value="green">Verde</option>
          <option value="sunset">P√¥r do sol</option>
          <option value="mono">Escuro minimal</option>
        </select>

        <div class="hr"></div>

        <h3>Cor dos bot√µes</h3>
        <div class="small">Muda os bot√µes principais e detalhes do app.</div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Escolher cor</label>
            <input id="accentPicker" type="color" value="#569cff" onchange="saveAccentColor()">
          </div>
          <div class="note">
            <div style="font-weight:900">Pr√©via</div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary mini" type="button">Prim√°rio</button>
              <button class="btn mini" type="button">Normal</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <button class="btn" onclick="resetThemes()">‚Ü©Ô∏è Voltar ao padr√£o</button>
      </div>
    </div>

    <!-- SCREEN: CATEGORIES -->
    <div class="screen" id="screen-categories">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Minhas Categorias</div>
      </div>

      <div class="card">
        <h3>Adicionar categoria</h3>
        <div class="row">
          <input id="novaCategoria" placeholder="Nome da categoria">
          <button class="btn primary mini" style="flex:0 0 auto" onclick="addCategoria()">Adicionar</button>
        </div>
        <div class="hr"></div>
        <div id="listaCategorias" class="small"></div>
      </div>
    </div>

    <!-- SCREEN: FIXOS -->
    <div class="screen" id="screen-fixos">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Gastos Fixos</div>
      </div>

      <div class="card">
        <h3>Adicionar gasto fixo</h3>
        <label>Descri√ß√£o</label>
        <input id="descFixo" placeholder="Ex: Aluguel">
        <div class="row" style="margin-top:10px">
          <div>
            <label>Valor</label>
            <input id="valorFixo" type="number" placeholder="Ex: 750">
          </div>
          <div>
            <label>Categoria</label>
            <select id="categoriaFixo"></select>
          </div>
        </div>
        <button class="btn primary" style="margin-top:10px" onclick="addFixo()">Adicionar</button>

        <div class="hr"></div>
        <div class="small">‚ö†Ô∏è O X aqui remove do sistema. Na lista do m√™s (Home), o X remove s√≥ daquele m√™s.</div>
        <div class="hr"></div>
        <div id="listaFixos" class="small"></div>
      </div>
    </div>

    <!-- SCREEN: INVEST FIXOS -->
    <div class="screen" id="screen-investfixos">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Investimentos Fixos</div>
      </div>

      <div class="card">
        <h3>Como funciona</h3>
        <div class="small">
          Voc√™ informa <b>Nome</b>, <b>Meta final (R$)</b> e <b>Prazo (meses)</b>.
          O app calcula automaticamente o <b>valor mensal</b> (meta √∑ meses).
          Esse valor aparece em <b>todos os meses</b> como um item fixo ‚ÄúJuntar‚Äù.
          ‚úÖ E aparece na tela principal junto com as anota√ß√µes como <b>Pendente/Pago</b>.
          ‚úÖ Ao marcar como <b>Pago</b>, o app automaticamente soma no <b>Guardado</b>.
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Adicionar investimento fixo</h3>

        <label>Nome (ex.: Reserva, Carro, Casa)</label>
        <input id="invNome" placeholder="Ex: Reserva">

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Meta final (R$)</label>
            <input id="invMetaFinal" type="number" placeholder="Ex: 10000">
          </div>
          <div>
            <label>Prazo (meses)</label>
            <input id="invPrazoMeses" type="number" placeholder="Ex: 12" value="12">
          </div>
        </div>

        <div class="note" style="margin-top:10px">
          <div style="font-weight:900">Mensal autom√°tico</div>
          <div class="small" id="invResumo">Preencha Meta e Prazo para ver o valor por m√™s.</div>
        </div>

        <button class="btn primary" style="margin-top:10px" onclick="addInvestFixo()">Adicionar</button>

        <div class="hr"></div>
        <div id="listaInvestFixos" class="small"></div>
      </div>
    </div>

    <!-- SCREEN: SIMULATORS -->
    <div class="screen" id="screen-simulators">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Simuladores</div>
      </div>

      <div class="card">
        <h3>Escolha</h3>
        <select id="tipoSimulacao">
          <option value="investimento">Investimento</option>
          <option value="emprestimo">Empr√©stimo / Compra</option>
        </select>

        <div class="hr"></div>

        <div id="areaInvestimento">
          <h2 style="font-weight:900;margin-bottom:10px">üìà Investimento</h2>

          <label>Tipo de investimento</label>
          <select id="investTipo">
            <option value="poupanca">Poupan√ßa (estimativa)</option>
            <option value="cdb">CDB/LCI/LCA (% do CDI)</option>
            <option value="tesouro">Tesouro Selic (estimativa)</option>
            <option value="fixo">Taxa fixa mensal (%)</option>
          </select>

          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Valor inicial</label>
              <input id="valorInvestimento" type="number" placeholder="Ex: 1000">
            </div>
            <div>
              <label>Meses</label>
              <input id="mesesInvestimento" type="number" placeholder="Ex: 12">
            </div>
          </div>

          <div class="grid2" style="margin-top:10px" id="investExtra">
            <div>
              <label id="investExtraLabel">Par√¢metro</label>
              <input id="investExtraValue" type="number" placeholder="Ex: 100">
            </div>
            <div class="note">
              <div class="small">Dica</div>
              <div class="small" id="investHint">Escolha o tipo para ver o par√¢metro.</div>
            </div>
          </div>

          <button class="btn primary" style="margin-top:10px" onclick="simularInvestimento()">Calcular</button>
          <div id="resultadoInvestimento" style="margin-top:12px;font-weight:900"></div>
        </div>

        <div id="areaEmprestimo" style="display:none">
          <h2 style="font-weight:900;margin-bottom:10px">üí≥ Empr√©stimo / Compra</h2>

          <label>Modelo</label>
          <select id="loanTipo">
            <option value="price">PRICE (parcela fixa)</option>
            <option value="sac">SAC (parcela decrescente)</option>
          </select>

          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Valor</label>
              <input id="loanValor" type="number" placeholder="Ex: 10000">
            </div>
            <div>
              <label>Parcelas</label>
              <input id="loanParcelas" type="number" placeholder="Ex: 24">
            </div>
          </div>

          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Juros mensal (%)</label>
              <input id="loanJuros" type="number" placeholder="Ex: 2.5">
            </div>
            <div class="note">
              <div class="small">Seu m√™s</div>
              <div class="small">A IA considera sal√°rio, gastos e meta ao sugerir.</div>
            </div>
          </div>

          <button class="btn primary" style="margin-top:10px" onclick="simularEmprestimo()">Calcular</button>
          <div id="resultadoEmprestimo" style="margin-top:12px;font-weight:900"></div>
          <div id="tabelaEmprestimo" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- SCREEN: HISTORY -->
    <div class="screen" id="screen-history">
      <div class="backRow">
        <button class="btn backBtn" onclick="goBackFromHistory()">‚Üê Voltar</button>
        <div style="font-weight:900">Hist√≥rico</div>
      </div>

      <div class="card">
        <h3>Seus meses salvos</h3>
        <div class="small">Toque em um m√™s para abrir na tela principal. Use o <b>‚úï</b> para deletar o m√™s do hist√≥rico.</div>
        <div class="hr"></div>
        <div id="historyList"></div>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="screen" id="screen-login">
      <div class="card" style="max-width:520px;margin:auto">
        <h2 style="font-weight:950;margin-bottom:6px">Entrar</h2>
        <div class="small">Use sua conta Google para sincronizar seu controle.</div>
        <div class="hr"></div>
        <button class="btn primary" onclick="loginGoogle()">Entrar com Google</button>
        <div class="small" style="margin-top:10px" id="loginMsg"></div>
      </div>
    </div>

  </div>

  <!-- FABs -->
  <div class="fabWrap">
    <div class="fab ai" onclick="openIa()" title="IA PRO">
      <span>IA</span><em>PRO</em>
    </div>
    <div class="fab add" onclick="openAddExpense()" title="Adicionar gasto">+</div>
  </div>

</div>

<div id="debugBox"></div>

<!-- MODALS -->
<div class="overlay" id="overlay-addExpense">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">‚ûï Adicionar gasto</div>
      <div class="closeX" onclick="closeModal('overlay-addExpense')">‚úï</div>
    </div>
    <div class="modalBody">
      <label>Descri√ß√£o</label>
      <input id="mDesc" placeholder="Ex: Mercado">
      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Valor</label>
          <input id="mValor" type="number" placeholder="Ex: 120.50">
        </div>
        <div>
          <label>Categoria</label>
          <select id="mCategoria"></select>
        </div>
      </div>
      <div class="small" style="margin-top:10px">
        Dica: a categoria pode ser sugerida automaticamente pela descri√ß√£o.
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" onclick="closeModal('overlay-addExpense')">Cancelar</button>
      <button class="btn good" onclick="confirmAddExpense()">Adicionar</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay-ia">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">ü§ñ IA PRO ‚Ä¢ Consultor</div>
      <div class="closeX" onclick="closeModal('overlay-ia')">‚úï</div>
    </div>
    <div class="modalBody">
      <div class="chatBox" id="chatBox"></div>
      <div class="small" style="margin-top:10px">
        Status: <span id="iaStatus">Aguardando‚Ä¶</span>
      </div>
      <div class="chatComposer">
        <input id="iaPrompt" placeholder="Digite sua pergunta...">
        <button class="btn primary" style="flex:0 0 auto" onclick="iaSend()">Enviar</button>
      </div>
      <div class="small" style="margin-top:8px" id="iaHint"></div>
    </div>
  </div>
</div>

<script>
function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script src="./config.js"></script>

<script>
/* =========================
   CONFIG
========================= */
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};
const API = "https://api-rf1w.onrender.com";

let auth = null;
let USER = null;
let USER_ID = null;

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Investimentos","Outros"];
let regras = [
  {palavra:"aluguel", categoria:"Casa"},
  {palavra:"luz", categoria:"Casa"},
  {palavra:"agua", categoria:"Casa"},
  {palavra:"√°gua", categoria:"Casa"},
  {palavra:"mercado", categoria:"Alimenta√ß√£o"},
  {palavra:"padaria", categoria:"Alimenta√ß√£o"},
  {palavra:"gasolina", categoria:"Transporte"},
  {palavra:"uber", categoria:"Transporte"},
  {palavra:"ra√ß√£o", categoria:"Pets"},
  {palavra:"pet", categoria:"Pets"},
  {palavra:"cdb", categoria:"Investimentos"},
  {palavra:"tesouro", categoria:"Investimentos"},
  {palavra:"invest", categoria:"Investimentos"}
];

let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];
let investFixos = [];

let state = { meses:{} };
let mesAtual = new Date().toISOString().slice(0,7);

let grafico = null;
let graficoEvolucao = null;
let lastNonHistoryScreen = "screen-home";

/* =========================
   THEME
========================= */
const THEME_KEYS = {
  preset: "theme_preset_v1",
  accent: "theme_accent_v1"
};
const THEME_PRESETS = {
  default: { bgDark:"#07101f", g1:"rgba(86,156,255,.22)", g2:"rgba(57,217,138,.16)", g3:"rgba(255,93,93,.12)" },
  purple:  { bgDark:"#0d0a1f", g1:"rgba(170,110,255,.25)", g2:"rgba(86,156,255,.12)", g3:"rgba(57,217,138,.10)" },
  green:   { bgDark:"#061a14", g1:"rgba(57,217,138,.28)", g2:"rgba(86,156,255,.10)", g3:"rgba(255,209,102,.10)" },
  sunset:  { bgDark:"#1a0b0b", g1:"rgba(255,93,93,.22)", g2:"rgba(255,209,102,.18)", g3:"rgba(86,156,255,.10)" },
  mono:    { bgDark:"#05070c", g1:"rgba(255,255,255,.10)", g2:"rgba(255,255,255,.06)", g3:"rgba(255,255,255,.04)" }
};

function applyThemeSettings(){
  const preset = localStorage.getItem(THEME_KEYS.preset) || "default";
  const accent = localStorage.getItem(THEME_KEYS.accent) || "#569cff";
  const p = THEME_PRESETS[preset] || THEME_PRESETS.default;

  document.documentElement.style.setProperty("--accent", accent);
  document.documentElement.style.setProperty("--bg", p.bgDark);
  document.documentElement.style.setProperty("--grad1", p.g1);
  document.documentElement.style.setProperty("--grad2", p.g2);
  document.documentElement.style.setProperty("--grad3", p.g3);

  const sel = document.getElementById("themePreset");
  if(sel) sel.value = preset;

  const pick = document.getElementById("accentPicker");
  if(pick) pick.value = accent;

  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta) meta.setAttribute("content", accent);
}
function saveThemePreset(){
  const sel = document.getElementById("themePreset");
  const preset = sel ? sel.value : "default";
  localStorage.setItem(THEME_KEYS.preset, preset);
  applyThemeSettings();
}
function saveAccentColor(){
  const pick = document.getElementById("accentPicker");
  const accent = pick ? pick.value : "#569cff";
  localStorage.setItem(THEME_KEYS.accent, accent);
  applyThemeSettings();
}
function resetThemes(){
  localStorage.removeItem(THEME_KEYS.preset);
  localStorage.removeItem(THEME_KEYS.accent);
  applyThemeSettings();
}

/* =========================
   HOME LAYOUT (‚úÖ NOVO)
   - usu√°rio escolhe o que aparece e a ordem do painel principal
========================= */
const HOME_SECTIONS = [
  { id:"resumo",  title:"Resumo do m√™s" },
  { id:"kpis",    title:"Cards (Sal√°rio/Gasto/Sobra/Guardado)" },
  { id:"chartCat",title:"Gr√°fico por categoria" },
  { id:"chartEvo",title:"Gr√°fico evolu√ß√£o" },
  { id:"lista",   title:"Lista do m√™s" }
];

function kHomeLayout(){ return `home_layout_${USER_ID || "guest"}`; }

function defaultHomeLayout(){
  return HOME_SECTIONS.map(s=>({ id:s.id, show:true }));
}

function loadHomeLayout(){
  try{
    const raw = localStorage.getItem(kHomeLayout());
    if(!raw) return defaultHomeLayout();
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed)) return defaultHomeLayout();

    // garante que se entrar se√ß√£o nova, ela aparece no final
    const ids = new Set(parsed.map(x=>x && x.id).filter(Boolean));
    const fixed = parsed
      .filter(x=>x && typeof x.id==="string")
      .map(x=>({ id:x.id, show: x.show!==false }));

    HOME_SECTIONS.forEach(s=>{
      if(!ids.has(s.id)) fixed.push({ id:s.id, show:true });
    });

    // remove itens que n√£o existem mais
    return fixed.filter(x=>HOME_SECTIONS.some(s=>s.id===x.id));
  }catch(e){
    return defaultHomeLayout();
  }
}

function saveHomeLayout(layout){
  localStorage.setItem(kHomeLayout(), JSON.stringify(layout));
}

/* aplica no DOM da home */
function applyHomeLayoutToDOM(){
  const container = document.getElementById("homeContainer");
  if(!container) return;

  const layout = loadHomeLayout();

  // mapeia se√ß√µes existentes
  const map = {};
  container.querySelectorAll("[data-home]").forEach(el=>{
    map[el.getAttribute("data-home")] = el;
  });

  // reordena
  layout.forEach(item=>{
    const el = map[item.id];
    if(!el) return;
    container.appendChild(el);
    el.style.display = item.show ? "" : "none";
  });

  // garante display para se√ß√µes n√£o listadas (n√£o deveria)
  Object.keys(map).forEach(id=>{
    if(!layout.some(x=>x.id===id)){
      map[id].style.display = "";
      container.appendChild(map[id]);
    }
  });
}

/* tela editor */
function openHomeEditor(){
  renderHomeEditorUI();
  openScreen("screen-home-editor");
}
function renderHomeEditorUI(){
  const div = document.getElementById("layoutList");
  if(!div) return;

  const layout = loadHomeLayout();
  const titleById = Object.fromEntries(HOME_SECTIONS.map(s=>[s.id,s.title]));

  div.innerHTML = layout.map((it,idx)=>{
    const t = titleById[it.id] || it.id;
    const checked = it.show ? "checked" : "";
    const upDisabled = idx===0 ? "disabled" : "";
    const downDisabled = idx===layout.length-1 ? "disabled" : "";

    return `
      <div class="layoutItem" data-layout-row="${idx}">
        <div class="layoutLeft">
          <div class="handle">‚â°</div>
          <input class="chk" type="checkbox" ${checked} onchange="toggleHomeSectionShow(${idx}, this.checked)">
          <div class="layoutTitle">${escapeHtml(t)}</div>
        </div>
        <div class="layoutActions">
          <button class="btn icon mini" ${upDisabled} onclick="moveHomeSection(${idx}, -1)" title="Subir">‚Üë</button>
          <button class="btn icon mini" ${downDisabled} onclick="moveHomeSection(${idx}, 1)" title="Descer">‚Üì</button>
        </div>
      </div>
    `;
  }).join("");
}

function moveHomeSection(index, dir){
  const layout = loadHomeLayout();
  const newIndex = index + dir;
  if(newIndex < 0 || newIndex >= layout.length) return;
  const tmp = layout[index];
  layout[index] = layout[newIndex];
  layout[newIndex] = tmp;
  saveHomeLayout(layout);
  renderHomeEditorUI();
}

function toggleHomeSectionShow(index, show){
  const layout = loadHomeLayout();
  if(!layout[index]) return;
  layout[index].show = !!show;
  saveHomeLayout(layout);
}

function resetHomeLayout(){
  saveHomeLayout(defaultHomeLayout());
  renderHomeEditorUI();
}

function applyHomeLayoutFromEditor(){
  // j√° foi salvando; s√≥ aplica
  applyHomeLayoutToDOM();
  goHome();
}

/* =========================
   HELPERS
========================= */
const money = (n)=> Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function todayISO(){ return new Date().toISOString().slice(0,10); }

function showLoading(){ document.getElementById("app").style.display="none"; document.getElementById("loading").style.display="flex"; }
function showApp(){ document.getElementById("loading").style.display="none"; document.getElementById("app").style.display="block"; }
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
}
function openScreen(id){ lastNonHistoryScreen = id; showScreen(id); }
function goHome(){ lastNonHistoryScreen = "screen-home"; showScreen("screen-home"); applyHomeLayoutToDOM(); }
function openMenu(){ lastNonHistoryScreen = "screen-menu"; showScreen("screen-menu"); }
function openHistory(){ buildHistoryUI(); showScreen("screen-history"); }
function goBackFromHistory(){ showScreen(lastNonHistoryScreen || "screen-home"); }
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
  applyThemeSettings();
}
function openModal(id){ const o=document.getElementById(id); if(o) o.style.display="flex"; }
function closeModal(id){ const o=document.getElementById(id); if(o) o.style.display="none"; }

/* =========================
   STORAGE KEYS
========================= */
function kMes(){ return "gastos_pro_state_" + USER_ID; }
function kCat(){ return "categorias_" + USER_ID; }
function kFix(){ return "fixos_" + USER_ID; }
function kInv(){ return "inv_fixos_" + USER_ID; }

/* =========================
   DATA
========================= */
function loadAll(){
  try{ const raw = localStorage.getItem(kMes()); if(raw) state = JSON.parse(raw) || {meses:{}}; }catch(e){ state={meses:{}}; }

  try{
    const raw = localStorage.getItem(kCat());
    categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
    if(!Array.isArray(categorias) || !categorias.length) categorias=[...DEFAULT_CATEGORIAS];
    if(!categorias.some(c=>String(c).toLowerCase()==="investimentos")) categorias.splice(categorias.length-1,0,"Investimentos");
  }catch(e){ categorias=[...DEFAULT_CATEGORIAS]; }

  try{
    const raw = localStorage.getItem(kFix());
    fixos = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(fixos)) fixos=[];
    fixos = fixos.map(f=>({ ...f, isFixo:true }));
  }catch(e){ fixos=[]; }

  try{
    const raw = localStorage.getItem(kInv());
    investFixos = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(investFixos)) investFixos=[];
  }catch(e){ investFixos=[]; }

  if(!state || typeof state!=="object") state={meses:{}};
  if(!state.meses || typeof state.meses!=="object") state.meses={};
}
function saveAll(){
  localStorage.setItem(kMes(), JSON.stringify(state));
  localStorage.setItem(kCat(), JSON.stringify(categorias));
  localStorage.setItem(kFix(), JSON.stringify(fixos));
  localStorage.setItem(kInv(), JSON.stringify(investFixos));
}

function detectarCategoria(desc){
  const txt=(desc||"").toLowerCase();
  for(const r of regras){ if(txt.includes(r.palavra)) return r.categoria; }
  return "Outros";
}

/* Invest fixo */
function ensureMonthInvestStatus(d){
  if(!d.investStatus || typeof d.investStatus!=="object") d.investStatus = {};
  return d.investStatus;
}

/* Guardado auto do investimento fixo */
function ensureSavedArray(d){
  if(!Array.isArray(d.saved)) d.saved = [];
  return d.saved;
}
function hasAutoSavedForInv(d, invId, month){
  const saved = ensureSavedArray(d);
  return saved.some(s => s && s.source==="investFixo" && s.invId===invId && s.month===month);
}
function addAutoSavedForInv(d, invId, month, value, desc){
  const saved = ensureSavedArray(d);
  if(hasAutoSavedForInv(d, invId, month)) return;
  saved.unshift({
    value: Number(value||0),
    desc: desc || "Investimento fixo",
    date: todayISO(),
    source: "investFixo",
    invId,
    month
  });
}
function removeAutoSavedForInv(d, invId, month){
  const saved = ensureSavedArray(d);
  d.saved = saved.filter(s => !(s && s.source==="investFixo" && s.invId===invId && s.month===month));
}

function ensureItemDefaults(it){
  if(!it) return it;
  if(typeof it.paid !== "boolean") it.paid = false;
  return it;
}

function fixKey(desc, amount, category){
  return `${String(desc||"").toLowerCase()}|${Number(amount||0)}|${String(category||"").toLowerCase()}`;
}

function getDataMes(m){
  const mm = m || mesAtual;
  if(!state.meses[mm]) state.meses[mm] = { salary:0, meta:0, items:[], saved:[], hiddenFixos:[], investStatus:{} };
  const d = state.meses[mm];

  if(!Array.isArray(d.items)) d.items=[];
  if(!Array.isArray(d.hiddenFixos)) d.hiddenFixos=[];
  ensureSavedArray(d);
  ensureMonthInvestStatus(d);

  d.items = d.items.map(ensureItemDefaults);

  const hidden = new Set(d.hiddenFixos.map(String));
  const present = new Set(d.items.map(it=>fixKey(it.desc,it.amount,it.category)));

  // fixos normais
  for(const f of fixos){
    const fk = fixKey(f.desc, f.amount, f.category);
    if(hidden.has(fk)) continue;
    if(present.has(fk)) continue;
    d.items.unshift(ensureItemDefaults({ ...f, isFixo:true, isInvestFixo:false }));
    present.add(fk);
  }

  // investimentos fixos como "Juntar" na tela principal
  for(const inv of investFixos){
    const desc = `Juntar: ${inv.nome}`;
    const amount = Number(inv.mensal||0);
    const fk = fixKey(desc, amount, "Investimentos");
    if(hidden.has(fk)) continue;
    if(present.has(fk)) continue;

    const paid = !!d.investStatus[inv.id];

    d.items.unshift(ensureItemDefaults({
      desc,
      amount,
      category:"Investimentos",
      isFixo:true,
      isInvestFixo:true,
      invId: inv.id,
      paid
    }));
    present.add(fk);
  }

  return d;
}

/* =========================
   UI BUILDERS
========================= */
function buildMonthSelect(){
  const sel = document.getElementById("monthSelect");
  if(!sel) return;

  const monthsSet = new Set(Object.keys(state.meses||{}));
  const now = new Date();
  for(let i=0;i<=120;i++){
    const dt = new Date(now.getFullYear(), now.getMonth()-i, 1);
    monthsSet.add(dt.toISOString().slice(0,7));
  }
  for(let i=1;i<=120;i++){
    const dt = new Date(now.getFullYear(), now.getMonth()+i, 1);
    monthsSet.add(dt.toISOString().slice(0,7));
  }
  const months = Array.from(monthsSet).sort().reverse();

  sel.innerHTML = months.map(m=>{
    const [y,mo]=m.split("-");
    const dt = new Date(Number(y), Number(mo)-1, 1);
    const label = dt.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});
    return `<option value="${m}">${label}</option>`;
  }).join("");

  if(!months.includes(mesAtual)) mesAtual = new Date().toISOString().slice(0,7);
  sel.value = mesAtual;

  sel.onchange = ()=>{ mesAtual = sel.value; render(); };
}

function renderCategorias(){
  const list = document.getElementById("listaCategorias");
  const selF = document.getElementById("categoriaFixo");
  const selM = document.getElementById("mCategoria");
  if(list){
    list.innerHTML = categorias.map(c=>`<div class="note">‚Ä¢ ${escapeHtml(c)}</div>`).join("") || "<div class='small'>Nenhuma categoria.</div>";
  }
  const opts = categorias.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  if(selF) selF.innerHTML = opts;
  if(selM) selM.innerHTML = opts;
}

function renderFixos(){
  const div = document.getElementById("listaFixos");
  if(!div) return;
  if(!fixos.length){ div.innerHTML = "<div class='small'>Nenhum gasto fixo cadastrado.</div>"; return; }

  div.innerHTML = fixos.map((f,idx)=>`
    <div class="note" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <div style="font-weight:900">${escapeHtml(f.desc)}</div>
        <div class="small">${money(f.amount)} <span class="badge">${escapeHtml(f.category)}</span></div>
      </div>
      <button class="btn icon mini" title="Remover do cadastro (todos os meses)" onclick="removeFixo(${idx})">‚úï</button>
    </div>
  `).join("");
}

function calcMensalAuto(metaFinal, prazoMeses){
  const meta = Number(metaFinal||0);
  const meses = Number(prazoMeses||0);
  if(!meta || meta<=0) return 0;
  if(!meses || meses<=0) return 0;
  return Math.round((meta/meses)*100)/100;
}
function updateInvResumo(){
  const nome = (document.getElementById("invNome").value||"").trim();
  const metaFinal = Number(document.getElementById("invMetaFinal").value||0);
  const prazoMeses = Number(document.getElementById("invPrazoMeses").value||0) || 12;
  const out = document.getElementById("invResumo");
  if(!out) return;
  if(!nome){ out.textContent="Digite o Nome."; return; }
  if(!metaFinal || metaFinal<=0){ out.textContent="Digite a Meta final (R$)."; return; }
  if(!prazoMeses || prazoMeses<=0){ out.textContent="Digite o Prazo (meses)."; return; }
  const mensal = calcMensalAuto(metaFinal, prazoMeses);
  out.textContent = `Para juntar ${money(metaFinal)} em ${prazoMeses} meses, o valor mensal fica: ${money(mensal)} (meta √∑ meses).`;
}
function renderInvestFixos(){
  const div = document.getElementById("listaInvestFixos");
  if(!div) return;
  if(!investFixos.length){ div.innerHTML="<div class='small'>Nenhum investimento fixo cadastrado.</div>"; return; }

  div.innerHTML = investFixos.map((inv,idx)=>{
    const meta = Number(inv.metaFinal||0);
    const meses = Number(inv.prazoMeses||12) || 12;
    const mensal = Number(inv.mensal||0);
    return `
      <div class="note" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:950">üìå ${escapeHtml(inv.nome)}</div>
          <div class="small" style="margin-top:6px">Meta: <b>${money(meta)}</b> ‚Ä¢ Prazo: <b>${meses} meses</b></div>
          <div class="small">Mensal autom√°tico: <b class="successText">${money(mensal)}</b></div>
          <div class="small">‚úÖ Na tela principal, marque <b>Pendente/Pago</b> e ao pagar entra no <b>Guardado</b>.</div>
        </div>
        <button class="btn icon mini" title="Remover do cadastro (todos os meses)" onclick="removeInvestFixo(${idx})">‚úï</button>
      </div>
    `;
  }).join("");
}

/* =========================
   HIST√ìRICO (com X)
========================= */
function deleteMonth(m){
  if(!USER_ID) return;
  if(!state.meses || !state.meses[m]) return;

  const dt = new Date(m+"-01T00:00:00");
  const label = dt.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});
  if(!confirm(`Deletar o m√™s de ${label} do hist√≥rico?`)) return;

  delete state.meses[m];
  saveAll();

  if(mesAtual === m) mesAtual = new Date().toISOString().slice(0,7);

  buildMonthSelect();
  buildHistoryUI();
  render();
}

function buildHistoryUI(){
  const div = document.getElementById("historyList");
  if(!div) return;
  const meses = Object.keys(state.meses||{}).sort().reverse();
  if(!meses.length){ div.innerHTML = `<div class="small">Nenhum m√™s salvo ainda. Use ‚ÄúSalvar‚Äù na tela inicial.</div>`; return; }

  div.innerHTML = meses.map(m=>{
    const d = getDataMes(m);
    const total = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
    const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
    const left = Number(d.salary||0) - total;
    const dt = new Date(m+"-01T00:00:00");
    const label = dt.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});

    return `
      <div class="note" style="cursor:pointer" onclick="openMonthFromHistory('${m}')">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div style="display:flex;align-items:center;gap:10px;min-width:0">
            <div style="font-weight:950;text-transform:capitalize;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(label)}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;flex:0 0 auto">
            <span class="badge">${money(left)} sobra</span>
            <button class="btn icon mini" title="Deletar m√™s do hist√≥rico" onclick="event.stopPropagation(); deleteMonth('${m}')">‚úï</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px">
          Sal√°rio: <b>${money(d.salary||0)}</b> ‚Ä¢ Gasto: <b>${money(total)}</b> ‚Ä¢ Guardado: <b>${money(saved)}</b>
        </div>
      </div>
    `;
  }).join("");
}
function openMonthFromHistory(m){
  mesAtual = m;
  const sel = document.getElementById("monthSelect");
  if(sel) sel.value = mesAtual;
  goHome(); render();
}

/* =========================
   MAIN ACTIONS
========================= */
function addCategoria(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const input = document.getElementById("novaCategoria");
  const nome = (input.value||"").trim();
  if(!nome) return;
  if(categorias.some(c=>c.toLowerCase()===nome.toLowerCase())) return alert("Essa categoria j√° existe.");
  categorias.push(nome);
  input.value="";
  saveAll();
  renderCategorias();
}

function addFixo(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const desc = (document.getElementById("descFixo").value||"").trim();
  const valor = Number(document.getElementById("valorFixo").value);
  const categoria = document.getElementById("categoriaFixo").value || "Outros";
  if(!desc || !valor || valor<=0) return alert("Preencha descri√ß√£o e valor (maior que 0).");

  fixos.push({ desc, amount: valor, category: categoria, isFixo:true });

  document.getElementById("descFixo").value="";
  document.getElementById("valorFixo").value="";

  saveAll();
  renderFixos();
  render();
}
function removeFixo(idx){
  if(idx<0 || idx>=fixos.length) return;
  fixos.splice(idx,1);
  saveAll();
  renderFixos();
  render();
}

function addInvestFixo(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const nome = (document.getElementById("invNome").value||"").trim();
  const metaFinal = Number(document.getElementById("invMetaFinal").value||0);
  const prazoMeses = Number(document.getElementById("invPrazoMeses").value||0) || 12;
  if(!nome) return alert("Digite o Nome.");
  if(!metaFinal || metaFinal<=0) return alert("Digite a Meta final (R$).");
  if(!prazoMeses || prazoMeses<=0) return alert("Digite o Prazo (meses).");
  const mensal = calcMensalAuto(metaFinal, prazoMeses);

  const id = uid();
  investFixos.push({ id, nome, metaFinal, prazoMeses, mensal });

  const d = getDataMes(mesAtual);
  ensureMonthInvestStatus(d);
  if(typeof d.investStatus[id] !== "boolean") d.investStatus[id] = false;

  document.getElementById("invNome").value="";
  document.getElementById("invMetaFinal").value="";
  document.getElementById("invPrazoMeses").value="12";
  updateInvResumo();

  saveAll();
  renderInvestFixos();
  render();
}
function removeInvestFixo(idx){
  if(idx<0 || idx>=investFixos.length) return;
  const inv = investFixos[idx];

  Object.keys(state.meses||{}).forEach(m=>{
    const d = state.meses[m];
    if(d && d.investStatus && inv && inv.id) delete d.investStatus[inv.id];
    if(d && inv && inv.id) removeAutoSavedForInv(d, inv.id, m);
  });

  investFixos.splice(idx,1);
  saveAll();
  renderInvestFixos();
  render();
}

function addSaved(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const v = Number(document.getElementById("savedValue").value);
  const desc = (document.getElementById("savedDesc").value||"").trim();
  if(!v || v<=0) return alert("Digite um valor para adicionar ao guardado.");
  const d = getDataMes(mesAtual);
  ensureSavedArray(d);
  d.saved.unshift({ value:v, desc, date:todayISO(), source:"manual" });
  document.getElementById("savedValue").value="";
  document.getElementById("savedDesc").value="";
  saveAll();
  renderSaved();
  renderKPIs();
}
function removeSaved(idx){
  const d = getDataMes(mesAtual);
  ensureSavedArray(d);
  if(!d.saved || idx<0 || idx>=d.saved.length) return;
  d.saved.splice(idx,1);
  saveAll();
  renderSaved();
  renderKPIs();
}

function saveSettings(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const d = getDataMes(mesAtual);
  d.salary = Number(document.getElementById("salary").value||0);
  d.meta   = Number(document.getElementById("meta").value||0);
  saveAll();

  fetch(API+"/salvarMes",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ userId: USER_ID, mes: mesAtual, salary: d.salary, meta: d.meta })
  }).catch(()=>{});

  render();
}

/* Pendente/Pago (inclui investimento fixo) + ao pagar: anota no guardado */
function togglePaid(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;

  it.paid = !it.paid;

  if(it.isInvestFixo && it.invId){
    ensureMonthInvestStatus(d);
    d.investStatus[it.invId] = !!it.paid;

    if(it.paid){
      addAutoSavedForInv(
        d,
        it.invId,
        mesAtual,
        Number(it.amount||0),
        `Autom√°tico: ${it.desc}`
      );
    }else{
      removeAutoSavedForInv(d, it.invId, mesAtual);
    }
  }

  saveAll();
  renderSaved();
  renderList();
  renderKPIs();
}

function hideFixoOnlyThisMonth(it){
  const d = getDataMes(mesAtual);
  const fk = fixKey(it.desc, it.amount, it.category);
  if(!d.hiddenFixos.includes(fk)) d.hiddenFixos.push(fk);
  d.items = (d.items||[]).filter((x)=>fixKey(x.desc,x.amount,x.category)!==fk);

  if(it.isInvestFixo && it.invId){
    removeAutoSavedForInv(d, it.invId, mesAtual);
    ensureMonthInvestStatus(d);
    d.investStatus[it.invId] = false;
  }

  saveAll();
}
function delItemMonthOnly(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;
  d.items.splice(idx,1);
  saveAll();

  if(!it.isFixo){
    fetch(API+"/delGasto",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: USER_ID, mes: mesAtual, desc: it.desc, amount: it.amount })
    }).catch(()=>{});
  }
}
function delItemSmart(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;

  if(it.isFixo){
    hideFixoOnlyThisMonth(it);
    render();
    return;
  }

  delItemMonthOnly(idx);
  render();
}

/* =========================
   SAVED/UI RENDER
========================= */
function renderSaved(){
  const d = getDataMes(mesAtual);
  const div = document.getElementById("savedList");
  if(!div) return;

  ensureSavedArray(d);

  if(!d.saved.length){ div.innerHTML=""; return; }

  div.innerHTML = d.saved.map((s,idx)=>`
    <div class="note" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <div style="font-weight:950">üè¶ ${money(s.value)}</div>
        <div class="small">
          Data: ${escapeHtml(s.date || "")}
          ${s.desc?(" ‚Ä¢ "+escapeHtml(s.desc)):""}
          ${s.source==="investFixo" ? ` ‚Ä¢ <span class="badge">Auto</span>` : ``}
        </div>
      </div>
      <button class="btn icon mini" title="Remover" onclick="removeSaved(${idx})">‚úï</button>
    </div>
  `).join("");
}

/* =========================
   ADD EXPENSE MODAL
========================= */
function openAddExpense(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  document.getElementById("mDesc").value="";
  document.getElementById("mValor").value="";
  if(document.getElementById("mCategoria")) document.getElementById("mCategoria").value = "Outros";
  openModal("overlay-addExpense");
}
function confirmAddExpense(){
  const desc = (document.getElementById("mDesc").value||"").trim();
  const amount = Number(document.getElementById("mValor").value||0);
  let cat = document.getElementById("mCategoria").value || "Outros";
  if(!desc) return alert("Preencha a descri√ß√£o.");
  if(!amount || amount<=0) return alert("Preencha o valor (maior que 0).");

  const sug = detectarCategoria(desc);
  if(cat==="Outros" && sug!=="Outros") cat=sug;

  const d = getDataMes(mesAtual);
  d.items.push(ensureItemDefaults({ desc, amount, category: cat, isFixo:false, isInvestFixo:false }));
  saveAll();

  fetch(API+"/addGasto",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ userId: USER_ID, mes: mesAtual, desc, amount, category: cat })
  }).catch(()=>{});

  closeModal("overlay-addExpense");
  render();
}

/* =========================
   RENDER
========================= */
function drawChart(items){
  const mapa={};
  items.forEach(i=>{
    const cat = i.category||"Outros";
    mapa[cat]=(mapa[cat]||0)+Number(i.amount||0);
  });
  const labels = Object.keys(mapa);
  const valores= Object.values(mapa);

  if(grafico) grafico.destroy();
  grafico=new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{ labels, datasets:[{ data: valores }] },
    options:{ plugins:{ legend:{ labels:{ color: getComputedStyle(document.body).getPropertyValue("--text") } } } }
  });
}
function drawEvolucao(){
  const meses = Object.keys(state.meses||{}).sort().reverse();
  if(!meses.length) return;
  const valores = meses.map(m=>{
    const d = getDataMes(m);
    return (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  });
  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao=new Chart(document.getElementById("chartEvolucao"),{
    type:"line",
    data:{ labels: meses, datasets:[{ data: valores }] },
    options:{ plugins:{ legend:{ display:false } } }
  });
}

function renderList(){
  const d = getDataMes(mesAtual);
  const table = document.getElementById("list");
  if(!table) return;

  if(!d.items.length){
    table.innerHTML = `<tr><td class="small">Nenhum gasto neste m√™s. Toque em ‚Äú+‚Äù para adicionar.</td></tr>`;
    return;
  }

  table.innerHTML = d.items.map((i,idx)=>{
    const paid = !!i.paid;
    const statusBadge = paid ? `<span class="badge good">Pago</span>` : `<span class="badge warn">Pendente</span>`;
    const fixBadge = i.isInvestFixo ? `<span class="badge">Juntar</span>` : (i.isFixo ? `<span class="badge">Fixo</span>` : ``);
    const btnPaidClass = paid ? "good" : "warn";
    const btnPaidText = paid ? "‚úÖ Pago" : "‚è≥ Pendente";

    return `
      <tr>
        <td>
          <div style="font-weight:900">
            ${escapeHtml(i.desc||"")}
            ${fixBadge}
            <span class="badge">${escapeHtml(i.category||"Outros")}</span>
            ${statusBadge}
          </div>
          <div class="small">${money(i.amount||0)}</div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn ${btnPaidClass} mini" onclick="togglePaid(${idx})">${btnPaidText}</button>
          </div>
        </td>
        <td style="width:64px;text-align:right">
          <button class="btn icon mini" onclick="delItemSmart(${idx})" title="Remover">‚úï</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderKPIs(){
  const d = getDataMes(mesAtual);
  const spent = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
  const salary = Number(d.salary||0);
  const left = salary - spent;

  document.getElementById("kpiSalary").textContent = money(salary);
  document.getElementById("kpiSpent").textContent  = money(spent);
  document.getElementById("kpiLeft").textContent   = money(left);
  document.getElementById("kpiSaved").textContent  = money(saved);

  document.getElementById("salary").value = salary ? salary : "";
  document.getElementById("meta").value = d.meta ? d.meta : "";
}

function render(){
  if(!USER_ID) return;

  buildMonthSelect();
  const d = getDataMes(mesAtual);

  // garante coer√™ncia do guardado auto para investimentos fixos
  ensureMonthInvestStatus(d);
  d.items.forEach(it=>{
    if(it && it.isInvestFixo && it.invId){
      it.paid = !!d.investStatus[it.invId];
      if(it.paid){
        addAutoSavedForInv(d, it.invId, mesAtual, Number(it.amount||0), `Autom√°tico: ${it.desc}`);
      }else{
        removeAutoSavedForInv(d, it.invId, mesAtual);
      }
    }
  });
  saveAll();

  // aplica layout do painel antes de renderizar gr√°ficos (pra garantir canvas vis√≠vel)
  applyHomeLayoutToDOM();

  renderKPIs();
  renderSaved();
  renderList();
  drawChart(d.items||[]);
  drawEvolucao();

  fetch(API+"/mes/"+USER_ID+"/"+mesAtual)
    .then(r=>r.json())
    .then(data=>{
      if(!Array.isArray(data)) return;

      if(data.length){
        const first = data[0] || {};
        if(first.salary!=null) d.salary = Number(first.salary||d.salary||0);
        if(first.meta!=null) d.meta = Number(first.meta||d.meta||0);
      }

      const apiItems = data
        .filter(x=>x && x.desc)
        .map(x=>ensureItemDefaults({
          desc: x.desc,
          amount: Number(x.amount||0),
          category: x.category || detectarCategoria(x.desc),
          isFixo:false,
          isInvestFixo:false
        }));

      const hidden = new Set((d.hiddenFixos||[]).map(String));
      const merged = [];
      const seen = new Set();

      const fresh = getDataMes(mesAtual);

      for(const it of (fresh.items||[]).filter(x=>x.isFixo)){
        const fk = fixKey(it.desc,it.amount,it.category);
        if(hidden.has(fk)) continue;
        const k = fk + "|fix";
        if(!seen.has(k)){ merged.push(it); seen.add(k); }
      }

      for(const it of (d.items||[]).filter(x=>!x.isFixo)){
        const k = fixKey(it.desc,it.amount,it.category) + "|loc";
        if(!seen.has(k)){ merged.push(it); seen.add(k); }
      }

      for(const it of apiItems){
        const k = fixKey(it.desc,it.amount,it.category) + "|api";
        if(!seen.has(k)){ merged.push(it); seen.add(k); }
      }

      d.items = merged.map(ensureItemDefaults);

      ensureMonthInvestStatus(d);
      d.items.forEach(it=>{
        if(it && it.isInvestFixo && it.invId){
          it.paid = !!d.investStatus[it.invId];
          if(it.paid){
            addAutoSavedForInv(d, it.invId, mesAtual, Number(it.amount||0), `Autom√°tico: ${it.desc}`);
          }else{
            removeAutoSavedForInv(d, it.invId, mesAtual);
          }
        }
      });

      saveAll();

      applyHomeLayoutToDOM();
      renderKPIs();
      renderSaved();
      renderList();
      drawChart(d.items||[]);
      drawEvolucao();
    })
    .catch(()=>{});
}

/* =========================
   SIMULATORS
========================= */
function updateInvestUI(){
  const tipoEl = document.getElementById("investTipo");
  if(!tipoEl) return;

  const tipo = tipoEl.value;
  const lab = document.getElementById("investExtraLabel");
  const hint= document.getElementById("investHint");
  const val = document.getElementById("investExtraValue");

  if(tipo==="poupanca"){
    lab.textContent = "Taxa mensal (%) (estimativa)";
    hint.textContent = "Ex.: 0,5% ao m√™s (padr√£o 0,5).";
    if(!val.value) val.value = "0.5";
  }else if(tipo==="cdb"){
    lab.textContent = "% do CDI";
    hint.textContent = "Ex.: 100% CDI (padr√£o 100).";
    if(!val.value) val.value = "100";
  }else if(tipo==="tesouro"){
    lab.textContent = "Taxa mensal (%) (estimativa)";
    hint.textContent = "Estimativa mensal. Ex.: 0,9% (padr√£o 0,9).";
    if(!val.value) val.value = "0.9";
  }else{
    lab.textContent = "Taxa fixa mensal (%)";
    hint.textContent = "Ex.: 1,2% ao m√™s (padr√£o 1,2).";
    if(!val.value) val.value = "1.2";
  }
}
function simularInvestimento(){
  const tipo = document.getElementById("investTipo").value;
  const valor = Number(document.getElementById("valorInvestimento").value||0);
  const meses = Number(document.getElementById("mesesInvestimento").value||0);
  const extra = Number(document.getElementById("investExtraValue").value||0);

  if(!valor || valor<=0) return alert("Informe o valor inicial.");
  if(!meses || meses<=0) return alert("Informe os meses.");

  let taxaMensal = 0;
  if(tipo==="poupanca") taxaMensal = (extra||0.5)/100;
  else if(tipo==="cdb"){ const cdiMensal=0.009; taxaMensal = cdiMensal*((extra||100)/100); }
  else if(tipo==="tesouro") taxaMensal = (extra||0.9)/100;
  else taxaMensal = (extra||1.2)/100;

  const total = valor * Math.pow(1+taxaMensal, meses);
  const lucro = total - valor;

  document.getElementById("resultadoInvestimento").innerHTML =
    `Valor final: <span class="successText">${money(total)}</span><br>`+
    `Lucro estimado: <span class="successText">${money(lucro)}</span><br>`+
    `<div class="small">*Estimativa simples. N√£o √© recomenda√ß√£o financeira.</div>`;
}
function simularEmprestimo(){
  const modelo = document.getElementById("loanTipo").value;
  const valor = Number(document.getElementById("loanValor").value||0);
  const n = Number(document.getElementById("loanParcelas").value||0);
  const juros = Number(document.getElementById("loanJuros").value||0)/100;

  if(!valor || valor<=0) return alert("Informe o valor.");
  if(!n || n<=0) return alert("Informe as parcelas.");
  if(juros<0) return alert("Juros inv√°lido.");

  const d = getDataMes(mesAtual);
  const gastos = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const salario = Number(d.salary||0);

  let primeira=0, totalPago=0, rows="";

  if(modelo==="price"){
    const p = juros===0 ? (valor/n) : (valor * (juros / (1 - Math.pow(1+juros, -n))));
    primeira = p; totalPago = p*n;
    for(let i=1;i<=Math.min(n,12);i++) rows += `<div>Parcela ${i}: <b>${money(p)}</b></div>`;
    if(n>12) rows += `<div class="small">‚Ä¶ (mostrando 12 de ${n})</div>`;
  }else{
    const amort = valor/n; let saldo = valor;
    for(let i=1;i<=n;i++){
      const j = saldo*juros;
      const parcela = amort + j;
      if(i===1) primeira = parcela;
      totalPago += parcela; saldo -= amort;
      if(i<=12) rows += `<div>Parcela ${i}: <b>${money(parcela)}</b></div>`;
    }
    if(n>12) rows += `<div class="small">‚Ä¶ (mostrando 12 de ${n})</div>`;
  }

  const sobraApos = salario - gastos - primeira;
  let selo = sobraApos > salario*0.30 ? "üü¢ Folga" : sobraApos > 0 ? "üü° Apertado" : "üî¥ N√£o cabe";
  let cor = sobraApos > salario*0.30 ? "successText" : sobraApos > 0 ? "warnText" : "dangerText";

  document.getElementById("resultadoEmprestimo").innerHTML =
    `Primeira parcela: <span class="${cor}">${money(primeira)}</span><br>`+
    `Total pago: <b>${money(totalPago)}</b><br>`+
    `Sobra ap√≥s pagar 1¬™: <span class="${cor}">${money(sobraApos)}</span><br>`+
    `<div style="margin-top:6px;font-weight:900">${selo}</div>`;

  document.getElementById("tabelaEmprestimo").innerHTML =
    `<div class="small">Pr√©via das parcelas:</div><div class="mono" style="margin-top:6px">${rows}</div>`;
}

/* =========================
   IA (‚úÖ ATUALIZADA: Cloudflare Workers AI)
========================= */

/* ‚úÖ NOVA FUN√á√ÉO (substitui chamada local/Ollama) */
async function callIA(prompt) {
  const base = (window.API_BASE_URL || "").replace(/\/$/, "");
  const resp = await fetch(base + "/api/chat", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-app-key": window.APP_KEY
    },
    body: JSON.stringify({ prompt }),
    cache: "no-store"
  });

  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    throw new Error(data?.error || ("Erro HTTP " + resp.status));
  }
  return data.response || "Sem resposta";
}

function getIaBase(){
  const v = (window.API_BASE_URL || "").trim();
  return v.replace(/\/$/, "");
}
function chatAdd(role, text){
  const box = document.getElementById("chatBox");
  const b = document.createElement("div");
  b.className = "bubble " + (role==="me" ? "me" : "bot");
  b.textContent = text;
  box.appendChild(b);
  box.scrollTop = box.scrollHeight;
}
async function iaHealth(){
  const el = document.getElementById("iaStatus");
  try{
    const base = getIaBase();
    if(!base) throw new Error("API_BASE_URL vazio");
    const r = await fetch(base + "/", {
      cache:"no-store",
      headers: { "x-app-key": window.APP_KEY }
    });
    await r.json().catch(()=>({}));
    el.textContent = "Online ‚úÖ";
  }catch(e){
    el.textContent = "Offline: " + (e.message || e);
  }
}
function buildIaContext(){
  const d = getDataMes(mesAtual);
  const spent = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
  const salary = Number(d.salary||0);
  const left = salary - spent;

  const topCats = {};
  (d.items||[]).forEach(it=>{
    const c = it.category||"Outros";
    topCats[c]=(topCats[c]||0)+Number(it.amount||0);
  });
  const catsSorted = Object.entries(topCats).sort((a,b)=>b[1]-a[1]).slice(0,5);

  return [
    `M√™s: ${mesAtual}`,
    `Sal√°rio: ${salary}`,
    `Gasto total: ${spent}`,
    `Sobra: ${left}`,
    `Guardado no m√™s: ${saved}`,
    `Top categorias: ${catsSorted.map(([c,v])=>`${c}=${v}`).join(", ")}`
  ].join("\n");
}
async function iaSend(){
  const input = document.getElementById("iaPrompt");
  const q = (input.value||"").trim();
  if(!q) return;

  input.value="";
  chatAdd("me", q);

  const statusEl = document.getElementById("iaStatus");
  statusEl.textContent = "Consultando‚Ä¶";

  try{
    const ctx = buildIaContext();
    const prompt =
`Voc√™ √© a IA PRO, consultor financeiro simples.
Responda em PT-BR, direto e pr√°tico.
Use os dados do m√™s para sugerir a√ß√µes e investimentos coerentes, sem prometer ganhos.
Se faltar dado, pe√ßa o m√≠nimo necess√°rio.

DADOS DO USU√ÅRIO:
${ctx}

PERGUNTA:
${q}`;

    const ans = await callIA(prompt); // ‚úÖ AQUI usa a nova IA
    chatAdd("bot", ans);
    statusEl.textContent = "Online ‚úÖ";
  }catch(e){
    chatAdd("bot", "Erro ao conectar na IA: " + (e.message||e));
    statusEl.textContent = "Offline: " + (e.message||e);
  }
}
function openIa(){
  openModal("overlay-ia");
  const box = document.getElementById("chatBox");
  if(!box.dataset.inited){
    chatAdd("bot", "Oi! Eu sou a IA PRO. Me pergunte algo sobre seus gastos, sal√°rio e melhor investimento. üôÇ");
    box.dataset.inited = "1";
  }
  iaHealth();
  const base = getIaBase();
  document.getElementById("iaHint").textContent = base ? ("Conectando em: " + base) : "API_BASE_URL vazio.";
}

/* =========================
   AUTH
========================= */
async function initFirebase(){
  if(!window.firebase){ dbg("Firebase n√£o carregou (sem internet ou bloqueio)."); return false; }

  try{ if(!firebase.apps || !firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG); }catch(e){}
  auth = firebase.auth();
  try{ await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}

  auth.onAuthStateChanged((u)=>{
    USER = u || null;
    if(!USER){ USER_ID=null; setTimeout(()=>location.replace("./login.html"),50); return; }

    USER_ID = USER.uid;
    document.getElementById("userName").textContent = USER.displayName || "Usu√°rio";
    document.getElementById("userEmail").textContent = USER.email || "";

    const t = localStorage.getItem("theme");
    if(t==="light") document.body.classList.add("light");

    applyThemeSettings();

    loadAll();
    buildMonthSelect();
    renderCategorias();
    renderFixos();
    renderInvestFixos();
    updateInvestUI();
    updateInvResumo();

    const tipoSel = document.getElementById("tipoSimulacao");
    if(tipoSel && !tipoSel.dataset.bound){
      tipoSel.addEventListener("change", ()=>{
        const v = tipoSel.value;
        document.getElementById("areaInvestimento").style.display = (v==="investimento") ? "block" : "none";
        document.getElementById("areaEmprestimo").style.display = (v==="emprestimo") ? "block" : "none";
      });
      tipoSel.dataset.bound = "1";
    }

    const investSel = document.getElementById("investTipo");
    if(investSel && !investSel.dataset.bound){
      investSel.addEventListener("change", updateInvestUI);
      investSel.dataset.bound = "1";
    }

    ["invNome","invMetaFinal","invPrazoMeses"].forEach(id=>{
      const el=document.getElementById(id);
      if(el && !el.dataset.bound){
        el.addEventListener("input", updateInvResumo);
        el.dataset.bound="1";
      }
    });

    showApp();
    goHome();
    render();
  });

  return true;
}

async function loginGoogle(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account" });
    try{ await auth.signInWithPopup(provider); }
    catch(e){ await auth.signInWithRedirect(provider); }
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    const el = document.getElementById("loginMsg");
    if(el) el.textContent = "Erro: " + msg;
  }
}
async function logout(){
  try{ if(auth) await auth.signOut(); }catch(e){}
  location.replace("./login.html");
}

/* =========================
   ESCAPE
========================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   BOOT
========================= */
document.addEventListener("DOMContentLoaded", async ()=>{
  applyThemeSettings();
  showLoading();
  const ok = await initFirebase();
  if(!ok) return;

  applyThemeSettings();
  // se abrir editor sem login, ainda mostra algo
  renderHomeEditorUI();
});
</script>
</body>
</html>
