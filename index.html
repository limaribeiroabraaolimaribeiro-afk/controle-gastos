<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Controle de Gastos PRO</title>

  <!-- Chart + PDF -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card:#ffffff0f;
      --card2:#ffffff12;
      --text:#eaf0ff;
      --muted:#b9c4dd;
      --line:#ffffff18;
      --accent:#569cff;
      --good:#2bd3a3;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 20px 45px rgba(0,0,0,.25);
      --r:16px;
    }
    body.light{
      --bg:#f4f6ff;
      --card:#ffffff;
      --card2:#f6f7ff;
      --text:#101427;
      --muted:#4c5671;
      --line:#e7ebff;
      --shadow: 0 15px 35px rgba(10,20,60,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:radial-gradient(1200px 800px at 20% 0%, rgba(86,156,255,.20), transparent 60%),
                 radial-gradient(1000px 700px at 90% 10%, rgba(43,211,163,.12), transparent 55%),
                 var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{ max-width:980px; margin:auto; padding:16px; }
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .brand p{ margin:4px 0 0; color:var(--muted); max-width:520px; }
    .pillbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
      user-select:none;
    }
    body.light .btn{ background:linear-gradient(180deg, #fff, #f3f6ff); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent), white 10%);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent), white 15%), var(--accent));
      color:#071026;
      font-weight:700;
    }
    .btn.ghost{
      background:transparent;
      box-shadow:none;
    }
    .btn.small{ padding:8px 12px; font-size:14px; }
    .btn.icon{ width:44px; justify-content:center; padding:10px; }
    .badge{
      font-size:12px; padding:3px 8px; border-radius:999px;
      background:color-mix(in oklab, var(--accent), transparent 75%);
      border:1px solid color-mix(in oklab, var(--accent), transparent 60%);
      color:var(--text);
    }
    .grid{ display:grid; gap:12px; }
    @media(min-width:860px){ .grid.cols2{ grid-template-columns: 1.2fr .8fr; } }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{ margin:0 0 10px; font-size:18px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .field{ flex:1; min-width:160px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, textarea{
      width:100%;
      background:var(--card2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:11px 12px;
      outline:none;
    }
    textarea{ min-height:44px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: color-mix(in oklab, var(--accent), transparent 40%);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent), transparent 84%);
    }
    .tabs{
      display:none;
      margin:10px 0 0;
      padding:10px;
      border-radius:18px;
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .tabs.show{ display:block; }
    .tabs .trow{ display:flex; flex-wrap:wrap; gap:10px; }
    .tab{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
    }
    .tab.active{
      border-color: color-mix(in oklab, var(--accent), transparent 30%);
      background: color-mix(in oklab, var(--accent), transparent 80%);
    }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius:16px;
      padding:12px;
    }
    body.light .item{ background:linear-gradient(180deg, #fff, #f4f7ff); }
    .meta{ display:flex; align-items:center; gap:10px; min-width:0; }
    .emoji{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
      background: color-mix(in oklab, var(--accent), transparent 85%);
      border:1px solid color-mix(in oklab, var(--accent), transparent 70%);
      flex:0 0 auto;
    }
    .meta .txt{ min-width:0; }
    .meta .title{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .sub{ font-size:12px; color:var(--muted); }
    .actions{ display:flex; gap:8px; align-items:center; }
    .chip{
      border:1px solid var(--line);
      background:transparent;
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      color:var(--text);
    }
    .chip.good{ border-color: color-mix(in oklab, var(--good), transparent 35%); background: color-mix(in oklab, var(--good), transparent 88%); }
    .chip.warn{ border-color: color-mix(in oklab, var(--warn), transparent 35%); background: color-mix(in oklab, var(--warn), transparent 88%); }
    .chip.bad{ border-color: color-mix(in oklab, var(--bad), transparent 35%); background: color-mix(in oklab, var(--bad), transparent 88%); }
    .xbtn{
      width:42px; height:42px; border-radius:14px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-size:18px;
    }
    .hint{ margin-top:10px; color:var(--muted); font-size:13px; }
    .split{ height:1px; background:var(--line); margin:12px 0; }
    .right{ text-align:right; }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kpi .k{
      flex:1; min-width:170px;
      border-radius:16px; border:1px solid var(--line);
      padding:10px 12px;
      background:var(--card2);
    }
    .k .lab{ color:var(--muted); font-size:12px; }
    .k .val{ font-size:18px; font-weight:900; margin-top:4px; }
    .mini{ font-size:12px; color:var(--muted); }
    .footerSpace{ height:22px; }

    /* FABs */
    .fabWrap{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:10; }
    .fab{
      width:60px; height:60px; border-radius:999px; border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
      box-shadow: 0 20px 45px rgba(0,0,0,.28);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      display:grid; place-items:center;
    }
    .fab.primary{
      background:linear-gradient(180deg, color-mix(in oklab, var(--good), white 10%), var(--good));
      color:#06141b;
      border-color: color-mix(in oklab, var(--good), white 10%);
    }
    .fab.small{ width:56px; height:56px; font-size:12px; font-weight:900; }
    .fab .sub{ font-weight:900; font-size:12px; opacity:.9; }

    /* reorder */
    .orderRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:14px; background:var(--card2); }
    .orderRow .name{ font-weight:800; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Controle de Gastos PRO</h1>
        <p>Aqui fica s√≥ o essencial. Para editar categorias, fixos, investimentos e relat√≥rios, use o <b>Menu</b>.</p>
      </div>
      <div class="pillbar">
        <button class="btn" id="btnMenu" title="Abrir menu">‚ò∞ <b>Menu</b></button>
        <button class="btn" id="btnTheme" title="Modo claro/escuro">üåô/‚òÄÔ∏è</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="trow">
        <button class="tab active" data-tab="home">Resumo</button>
        <button class="tab" data-tab="categorias">Minhas Categorias</button>
        <button class="tab" data-tab="fixos">Gastos Fixos</button>
        <button class="tab" data-tab="investFixos">Investimentos Fixos</button>
        <button class="tab" data-tab="config">Configura√ß√µes</button>
        <button class="tab" data-tab="pdf">Imprimir (PDF)</button>
      </div>
      <div class="hint">Dica: no celular, se o bot√£o ‚ÄúMenu‚Äù estava muito escuro, agora ele ficou com contraste maior.</div>
    </div>

    <div id="screen"></div>
    <div class="footerSpace"></div>
  </div>

  <div class="fabWrap">
    <button class="fab small" id="fabIA" title="IA PRO (placeholder)">IA<br><span class="sub">PRO</span></button>
    <button class="fab primary" id="fabAdd" title="Adicionar lan√ßamento">+</button>
  </div>

<script>
/* =========================
   STORAGE + STATE
========================= */
const LS_KEY = "gastosPRO_v2";
const defaultData = {
  version: 2,
  theme: { mode: "dark", accent: "#569cff" },
  ui: {
    // como o usu√°rio quer organizar
    sectionOrder: ["Resumo do m√™s", "Anota√ß√µes do m√™s", "Gr√°fico", "Atalhos"],
    sectionVisible: {
      "Resumo do m√™s": true,
      "Anota√ß√µes do m√™s": true,
      "Gr√°fico": true,
      "Atalhos": true
    }
  },
  categories: [
    { id: id(), name: "Alimenta√ß√£o" },
    { id: id(), name: "Transporte" },
    { id: id(), name: "Moradia" },
    { id: id(), name: "Lazer" }
  ],
  fixedExpenses: [
    // {id, name, amount, categoryId, day, active:true}
  ],
  fixedInvestments: [
    // {id, name, target, months, startMonth, monthly, active:true}
  ],
  months: {
    // "2026-02": { salary:0, goal:0, saved:[], entries:[], status:{}, hiddenFixed:{}, hiddenInvest:{} }
  }
};

let data = load();
let chart = null;

applyTheme();

/* =========================
   HELPERS
========================= */
function id(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultData);
    const parsed = JSON.parse(raw);
    // merge b√°sico
    return deepMerge(structuredClone(defaultData), parsed);
  }catch(e){
    return structuredClone(defaultData);
  }
}

function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}

function deepMerge(base, extra){
  if(extra === null || extra === undefined) return base;
  if(typeof base !== "object" || typeof extra !== "object") return extra;
  if(Array.isArray(base) && Array.isArray(extra)) return extra; // arrays: usa o salvo
  for(const k of Object.keys(extra)){
    if(k in base) base[k] = deepMerge(base[k], extra[k]);
    else base[k] = extra[k];
  }
  return base;
}

function monthKeyFromDate(d=new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function ensureMonth(key){
  if(!data.months[key]){
    data.months[key] = {
      salary: 0,
      goal: 0,
      saved: [], // {id, amount, desc, date}
      entries: [], // {id, type:"gasto"|"receita", amount, categoryId, desc, date}
      status: {}, // itemId -> "pago"|"pendente"  (para fixos/investFixos e lan√ßamentos)
      hiddenFixed: {}, // fixedId -> true (some s√≥ naquele m√™s)
      hiddenInvest: {} // investId -> true (some s√≥ naquele m√™s)
    };
  }
  return data.months[key];
}

function brMoney(v){
  const n = Number(v||0);
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function brMonthLabel(key){
  // key: YYYY-MM
  const [y,m] = key.split("-").map(Number);
  const d = new Date(y, m-1, 1);
  return d.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});
}

function sortMonthKeys(keys){
  // CORRIGE o gr√°fico "ao contr√°rio": ordem cronol√≥gica (do mais antigo pro mais novo)
  return [...keys].sort((a,b)=> a.localeCompare(b));
}

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

function applyTheme(){
  document.body.classList.toggle("light", data.theme.mode === "light");
  document.documentElement.style.setProperty("--accent", data.theme.accent || "#569cff");
}

/* =========================
   NAV / TABS
========================= */
const tabsEl = document.getElementById("tabs");
document.getElementById("btnMenu").addEventListener("click", ()=>{
  tabsEl.classList.toggle("show");
});
document.getElementById("btnTheme").addEventListener("click", ()=>{
  data.theme.mode = (data.theme.mode === "light") ? "dark" : "light";
  save();
  applyTheme();
  render(activeTab);
});

let activeTab = "home";
tabsEl.addEventListener("click",(e)=>{
  const b = e.target.closest(".tab");
  if(!b) return;
  activeTab = b.dataset.tab;
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===activeTab));
  render(activeTab);
});

/* =========================
   FAB
========================= */
document.getElementById("fabIA").addEventListener("click", ()=>{
  alert("IA PRO: aqui voc√™ pode ligar um analisador futuramente. üôÇ");
});
document.getElementById("fabAdd").addEventListener("click", ()=>{
  // atalho: adicionar lan√ßamento no m√™s atual
  if(activeTab !== "home") activeTab = "home";
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===activeTab));
  render(activeTab, { openAdd: true });
});

/* =========================
   RENDER
========================= */
const screen = document.getElementById("screen");

function render(tab, opts={}){
  if(tab==="home") return renderHome(opts);
  if(tab==="categorias") return renderCategorias();
  if(tab==="fixos") return renderFixos();
  if(tab==="investFixos") return renderInvestFixos();
  if(tab==="config") return renderConfig();
  if(tab==="pdf") return renderPDF();
}

function renderHome(opts={}){
  const nowKey = monthKeyFromDate();
  const allKeys = Object.keys(data.months);
  const defaultKey = allKeys.includes(nowKey) ? nowKey : (allKeys[allKeys.length-1] || nowKey);
  const monthKey = (opts.monthKey || defaultKey);

  const m = ensureMonth(monthKey);

  const sections = data.ui.sectionOrder.filter(s=> data.ui.sectionVisible[s] !== false);

  screen.innerHTML = `
    <div class="grid cols2">
      <div class="card" data-section="Resumo do m√™s">
        <h2>Resumo do m√™s</h2>
        <div class="row">
          <div class="field">
            <label>M√™s</label>
            <select id="selMonth"></select>
          </div>
          <div class="field">
            <label>Sal√°rio</label>
            <input id="inSalary" type="number" inputmode="decimal" placeholder="Ex: 4000" value="${Number(m.salary||0)}"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Meta</label>
            <input id="inGoal" type="number" inputmode="decimal" placeholder="Ex: 500" value="${Number(m.goal||0)}"/>
          </div>
          <div class="field">
            <label>Guardado (adicionar)</label>
            <input id="inSavedAmount" type="number" inputmode="decimal" placeholder="Ex: 1000"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Descri√ß√£o do guardado (opcional)</label>
            <input id="inSavedDesc" type="text" placeholder="Ex: Reserva, CDB, Tesouro..."/>
          </div>
          <div style="min-width:170px">
            <label>&nbsp;</label>
            <button class="btn primary" id="btnAddSaved" style="width:100%">Adicionar</button>
          </div>
        </div>

        <div class="split"></div>

        <div class="kpi">
          <div class="k">
            <div class="lab">Total gastos (m√™s)</div>
            <div class="val" id="kpiGastos">‚Äî</div>
          </div>
          <div class="k">
            <div class="lab">Total invest fixo (m√™s)</div>
            <div class="val" id="kpiInvest">‚Äî</div>
          </div>
          <div class="k">
            <div class="lab">Guardado (m√™s)</div>
            <div class="val" id="kpiSaved">‚Äî</div>
          </div>
        </div>

        <div class="hint">As anota√ß√µes abaixo misturam: gastos fixos + investimentos fixos + seus lan√ßamentos, com bot√£o <b>Pendente/Pago</b>.</div>
      </div>

      <div class="card" data-section="Atalhos">
        <h2>Atalhos</h2>
        <div class="row">
          <button class="btn small" id="goFixos">‚öôÔ∏è Gastos Fixos</button>
          <button class="btn small" id="goInv">üìà Invest. Fixos</button>
          <button class="btn small" id="goCats">üóÇ Categorias</button>
          <button class="btn small" id="goPDF">üßæ PDF</button>
        </div>
        <div class="split"></div>
        <div class="mini">
          Dica: o ‚ÄúX‚Äù em fixos/invest fixos some <b>s√≥ deste m√™s</b>.
        </div>
      </div>
    </div>

    <div class="card" data-section="Anota√ß√µes do m√™s" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Anota√ß√µes do m√™s</h2>
        <button class="btn" id="btnAddEntry">‚ûï Lan√ßamento</button>
      </div>

      <div id="addEntryBox" style="display:none; margin-top:12px">
        <div class="row">
          <div class="field">
            <label>Tipo</label>
            <select id="inType">
              <option value="gasto">Gasto</option>
              <option value="receita">Receita</option>
            </select>
          </div>
          <div class="field">
            <label>Categoria</label>
            <select id="inCat"></select>
          </div>
          <div class="field">
            <label>Valor</label>
            <input id="inAmount" type="number" inputmode="decimal" placeholder="Ex: 80"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Descri√ß√£o (opcional)</label>
            <input id="inDesc" type="text" placeholder="Ex: Mercado, Uber, etc."/>
          </div>
          <div style="min-width:170px">
            <label>&nbsp;</label>
            <button class="btn primary" id="btnSaveEntry" style="width:100%">Salvar lan√ßamento</button>
          </div>
        </div>
      </div>

      <div class="split"></div>

      <div class="list" id="notesList"></div>

      <div class="hint">Status: <b>Pendente</b> (a pagar/confirmar) ou <b>Pago</b> (j√° foi).</div>
    </div>

    <div class="card" data-section="Gr√°fico" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Gr√°fico (todos os meses)</h2>
        <span class="badge">ordem cronol√≥gica correta ‚úÖ</span>
      </div>
      <div style="margin-top:10px">
        <canvas id="chartAll" height="120"></canvas>
      </div>
      <div class="hint">Se antes ‚Äúmarcava ao contr√°rio‚Äù, agora o eixo do tempo est√° do mais antigo ‚Üí mais novo.</div>
    </div>
  `;

  // preencher select meses (inclui atual e todos existentes)
  const selMonth = document.getElementById("selMonth");
  const monthKeys = sortMonthKeys(Array.from(new Set([monthKeyFromDate(), ...Object.keys(data.months)])));
  selMonth.innerHTML = monthKeys.map(k => `<option value="${k}" ${k===monthKey ? "selected":""}>${cap(brMonthLabel(k))}</option>`).join("");

  // categoria select (para lan√ßamento)
  const inCat = document.getElementById("inCat");
  inCat.innerHTML = data.categories.map(c=> `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");

  // listeners resumo
  selMonth.addEventListener("change", ()=>{
    render("home", { monthKey: selMonth.value });
  });

  document.getElementById("inSalary").addEventListener("input",(e)=>{
    m.salary = Number(e.target.value||0);
    save(); updateKpisAndChart(monthKey);
  });
  document.getElementById("inGoal").addEventListener("input",(e)=>{
    m.goal = Number(e.target.value||0);
    save(); updateKpisAndChart(monthKey);
  });

  document.getElementById("btnAddSaved").addEventListener("click", ()=>{
    const amt = Number(document.getElementById("inSavedAmount").value||0);
    if(!amt) return alert("Digite um valor para Guardado.");
    const desc = document.getElementById("inSavedDesc").value.trim();
    m.saved.unshift({ id:id(), amount:amt, desc, date: todayISO() });
    document.getElementById("inSavedAmount").value = "";
    document.getElementById("inSavedDesc").value = "";
    save();
    render("home",{ monthKey });
  });

  // atalhos
  document.getElementById("goFixos").onclick = ()=> switchTab("fixos");
  document.getElementById("goInv").onclick = ()=> switchTab("investFixos");
  document.getElementById("goCats").onclick = ()=> switchTab("categorias");
  document.getElementById("goPDF").onclick = ()=> switchTab("pdf");

  // add entry
  const addEntryBox = document.getElementById("addEntryBox");
  document.getElementById("btnAddEntry").onclick = ()=> addEntryBox.style.display = (addEntryBox.style.display==="none"?"block":"none");
  document.getElementById("btnAddEntry").click && opts.openAdd && (addEntryBox.style.display="block");
  document.getElementById("btnAddEntry").id; // noop

  document.getElementById("btnAddEntry").addEventListener("click", ()=>{});
  document.getElementById("btnAddEntry").onclick = ()=> addEntryBox.style.display = (addEntryBox.style.display==="none"?"block":"none");
  if(opts.openAdd) addEntryBox.style.display = "block";

  document.getElementById("btnSaveEntry").addEventListener("click", ()=>{
    const type = document.getElementById("inType").value;
    const categoryId = document.getElementById("inCat").value;
    const amount = Number(document.getElementById("inAmount").value||0);
    const desc = document.getElementById("inDesc").value.trim();
    if(!amount) return alert("Digite um valor.");
    const entryId = id();
    m.entries.unshift({ id: entryId, type, categoryId, amount, desc, date: todayISO() });
    // por padr√£o: gasto pendente, receita pago
    m.status[entryId] = (type==="gasto") ? "pendente" : "pago";
    document.getElementById("inAmount").value = "";
    document.getElementById("inDesc").value = "";
    save();
    render("home",{ monthKey });
  });

  // cria lista de anota√ß√µes: FIXOS + INVEST FIXOS + ENTRADAS
  renderNotesList(monthKey);

  // KPIs e gr√°fico
  updateKpisAndChart(monthKey);
}

function renderNotesList(monthKey){
  const m = ensureMonth(monthKey);
  const list = document.getElementById("notesList");

  const catById = Object.fromEntries(data.categories.map(c=>[c.id,c]));
  const items = [];

  // fixos (aparecem em todo m√™s, mas X some s√≥ naquele m√™s)
  for(const f of data.fixedExpenses.filter(x=>x.active!==false)){
    if(m.hiddenFixed[f.id]) continue;
    items.push({
      kind:"fixo",
      id:f.id,
      title:f.name,
      sub:`Gasto fixo ‚Ä¢ ${f.day ? "dia " + f.day : "mensal"} ‚Ä¢ ${catById[f.categoryId]?.name || "Sem categoria"}`,
      amount: Number(f.amount||0),
      sign: -1,
      emoji:"üè¶"
    });
  }

  // investimentos fixos (aparecem em todo m√™s dentro do prazo; tamb√©m com pendente/pago)
  for(const inv of data.fixedInvestments.filter(x=>x.active!==false)){
    if(m.hiddenInvest[inv.id]) continue;
    // se tem prazo, s√≥ mostra dentro do range (startMonth .. startMonth+months-1)
    if(inv.startMonth && inv.months){
      const show = isMonthInRange(monthKey, inv.startMonth, inv.months);
      if(!show) continue;
    }
    items.push({
      kind:"invest",
      id:inv.id,
      title:inv.name,
      sub:`Invest. fixo ‚Ä¢ meta ${brMoney(inv.target||0)} ‚Ä¢ ${inv.months||0}x`,
      amount: Number(inv.monthly||0),
      sign: -1,
      emoji:"üìà"
    });
  }

  // lan√ßamentos
  for(const e of m.entries){
    const cat = catById[e.categoryId]?.name || "Sem categoria";
    items.push({
      kind:"entry",
      id:e.id,
      title: e.type === "gasto" ? `${brMoney(e.amount)}` : `+ ${brMoney(e.amount)}`,
      sub:`${e.type==="gasto"?"Gasto":"Receita"} ‚Ä¢ ${e.date} ‚Ä¢ ${cat}${e.desc ? " ‚Ä¢ " + e.desc : ""}`,
      amount: Number(e.amount||0),
      sign: e.type==="gasto" ? -1 : +1,
      emoji: e.type==="gasto" ? "üßæ" : "üí∞"
    });
  }

  // guardado (opcional) como item visual
  for(const s of m.saved){
    items.push({
      kind:"saved",
      id:s.id,
      title: brMoney(s.amount),
      sub:`Guardado ‚Ä¢ ${s.date}${s.desc ? " ‚Ä¢ " + s.desc : ""}`,
      amount:Number(s.amount||0),
      sign: 0,
      emoji:"üèõÔ∏è"
    });
  }

  if(items.length===0){
    list.innerHTML = `<div class="mini">Nada lan√ßado neste m√™s ainda.</div>`;
    return;
  }

  list.innerHTML = items.map(it=>{
    const st = m.status[it.id] || (it.kind==="saved" ? "pago" : "pendente");
    const chipClass = st==="pago" ? "good" : "warn";
    const chipText = st==="pago" ? "Pago" : "Pendente";
    const canHideThisMonth = (it.kind==="fixo" || it.kind==="invest");
    const canDelete = (it.kind==="entry" || it.kind==="saved"); // remove do m√™s
    const rightLabel = (it.sign<0) ? brMoney(it.amount) : (it.sign>0 ? brMoney(it.amount) : "");
    return `
      <div class="item">
        <div class="meta">
          <div class="emoji">${it.emoji}</div>
          <div class="txt">
            <div class="title">${escapeHtml(it.kind==="entry" ? it.title : it.title)}${rightLabel && it.kind!=="entry" ? ` <span class="badge">${escapeHtml(rightLabel)}</span>` : ""}</div>
            <div class="sub">${escapeHtml(it.sub)}</div>
          </div>
        </div>
        <div class="actions">
          <button class="chip ${chipClass}" data-action="toggle" data-id="${it.id}">${chipText}</button>
          ${canHideThisMonth ? `<button class="xbtn" data-action="hideMonth" data-kind="${it.kind}" data-id="${it.id}" title="Sumir s√≥ neste m√™s">√ó</button>` : ""}
          ${canDelete ? `<button class="xbtn" data-action="delete" data-kind="${it.kind}" data-id="${it.id}" title="Excluir deste m√™s">√ó</button>` : ""}
        </div>
      </div>
    `;
  }).join("");

  list.onclick = (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const action = btn.dataset.action;
    const itemId = btn.dataset.id;

    if(action==="toggle"){
      m.status[itemId] = (m.status[itemId]==="pago") ? "pendente" : "pago";
      save();
      render("home",{ monthKey });
    }

    if(action==="hideMonth"){
      const kind = btn.dataset.kind;
      if(kind==="fixo") m.hiddenFixed[itemId] = true;
      if(kind==="invest") m.hiddenInvest[itemId] = true;
      save();
      render("home",{ monthKey });
    }

    if(action==="delete"){
      const kind = btn.dataset.kind;
      if(kind==="entry"){
        m.entries = m.entries.filter(x=>x.id!==itemId);
        delete m.status[itemId];
      }
      if(kind==="saved"){
        m.saved = m.saved.filter(x=>x.id!==itemId);
        delete m.status[itemId];
      }
      save();
      render("home",{ monthKey });
    }
  };
}

function updateKpisAndChart(currentMonthKey){
  const m = ensureMonth(currentMonthKey);

  // totais do m√™s
  let fixedTotal = 0;
  for(const f of data.fixedExpenses.filter(x=>x.active!==false)){
    if(m.hiddenFixed[f.id]) continue;
    fixedTotal += Number(f.amount||0);
  }
  let invTotal = 0;
  for(const inv of data.fixedInvestments.filter(x=>x.active!==false)){
    if(m.hiddenInvest[inv.id]) continue;
    if(inv.startMonth && inv.months){
      if(!isMonthInRange(currentMonthKey, inv.startMonth, inv.months)) continue;
    }
    invTotal += Number(inv.monthly||0);
  }
  let entriesGastos = 0;
  let entriesReceitas = 0;
  for(const e of m.entries){
    if(e.type==="gasto") entriesGastos += Number(e.amount||0);
    else entriesReceitas += Number(e.amount||0);
  }
  let savedTotal = m.saved.reduce((a,x)=>a+Number(x.amount||0),0);

  const totalGastos = fixedTotal + invTotal + entriesGastos; // inv entra como sa√≠da (aplica√ß√£o mensal)

  document.getElementById("kpiGastos").textContent = brMoney(totalGastos);
  document.getElementById("kpiInvest").textContent = brMoney(invTotal);
  document.getElementById("kpiSaved").textContent = brMoney(savedTotal);

  // gr√°fico de todos os meses (ordem correta)
  const keys = sortMonthKeys(Array.from(new Set([monthKeyFromDate(), ...Object.keys(data.months)])));
  const labels = keys.map(k => cap(brMonthLabel(k)));

  const gastosSeries = keys.map(k=>{
    const mm = ensureMonth(k);
    // gastos do m√™s (fixos e investimentos respeitando hide)
    let ft=0;
    for(const f of data.fixedExpenses.filter(x=>x.active!==false)){
      if(mm.hiddenFixed[f.id]) continue;
      ft += Number(f.amount||0);
    }
    let it=0;
    for(const inv of data.fixedInvestments.filter(x=>x.active!==false)){
      if(mm.hiddenInvest[inv.id]) continue;
      if(inv.startMonth && inv.months){
        if(!isMonthInRange(k, inv.startMonth, inv.months)) continue;
      }
      it += Number(inv.monthly||0);
    }
    let eg=0, er=0;
    for(const e of mm.entries){
      if(e.type==="gasto") eg += Number(e.amount||0);
      else er += Number(e.amount||0);
    }
    return (ft+it+eg) - er; // saldo de gastos l√≠quidos
  });

  const ctx = document.getElementById("chartAll");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Gastos l√≠quidos (R$)", data: gastosSeries }
      ]
    },
    options: {
      responsive:true,
      plugins:{ legend:{ labels:{ color:getComputedStyle(document.body).getPropertyValue("--text") } } },
      scales:{
        x:{ ticks:{ color:getComputedStyle(document.body).getPropertyValue("--muted") } },
        y:{ ticks:{ color:getComputedStyle(document.body).getPropertyValue("--muted") } }
      }
    }
  });

  save();
}

/* =========================
   CATEGORIAS (com X para remover)
========================= */
function renderCategorias(){
  screen.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Minhas Categorias</h2>
        <span class="badge">com bot√£o X ‚úÖ</span>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="field">
          <label>Nova categoria</label>
          <input id="catName" placeholder="Ex: Sa√∫de, Pets, Estudos..."/>
        </div>
        <div style="min-width:180px">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnAddCat" style="width:100%">Adicionar</button>
        </div>
      </div>
      <div class="split"></div>
      <div class="list" id="catList"></div>
      <div class="hint">Ao excluir, lan√ßamentos antigos continuam, mas a categoria aparece como ‚ÄúSem categoria‚Äù.</div>
    </div>
  `;

  const list = document.getElementById("catList");
  list.innerHTML = data.categories.map(c=>`
    <div class="item">
      <div class="meta">
        <div class="emoji">üóÇ</div>
        <div class="txt">
          <div class="title">${escapeHtml(c.name)}</div>
          <div class="sub">ID: ${c.id}</div>
        </div>
      </div>
      <div class="actions">
        <button class="xbtn" data-id="${c.id}" title="Remover categoria">√ó</button>
      </div>
    </div>
  `).join("");

  document.getElementById("btnAddCat").onclick = ()=>{
    const name = document.getElementById("catName").value.trim();
    if(!name) return alert("Digite o nome da categoria.");
    data.categories.push({ id:id(), name });
    document.getElementById("catName").value="";
    save();
    render("categorias");
  };

  list.onclick = (e)=>{
    const b = e.target.closest("button");
    if(!b) return;
    const cid = b.dataset.id;
    if(!confirm("Remover esta categoria?")) return;
    data.categories = data.categories.filter(x=>x.id!==cid);
    save();
    render("categorias");
  };
}

/* =========================
   FIXOS (X some s√≥ no m√™s)
========================= */
function renderFixos(){
  screen.innerHTML = `
    <div class="card">
      <h2>Gastos Fixos</h2>
      <div class="row">
        <div class="field">
          <label>Nome</label>
          <input id="fxName" placeholder="Ex: Internet, Aluguel..."/>
        </div>
        <div class="field">
          <label>Valor (R$)</label>
          <input id="fxVal" type="number" inputmode="decimal" placeholder="Ex: 120"/>
        </div>
        <div class="field">
          <label>Categoria</label>
          <select id="fxCat"></select>
        </div>
        <div class="field">
          <label>Dia (opcional)</label>
          <input id="fxDay" type="number" inputmode="numeric" placeholder="Ex: 10"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnAddFx">Adicionar gasto fixo</button>
        <button class="btn" id="btnBackHome">Voltar</button>
      </div>

      <div class="split"></div>
      <div class="list" id="fxList"></div>

      <div class="hint">
        Na tela principal, cada gasto fixo tem <b>Pendente/Pago</b> e um <b>X</b> que some <b>s√≥ naquele m√™s</b>.
      </div>
    </div>
  `;

  const fxCat = document.getElementById("fxCat");
  fxCat.innerHTML = data.categories.map(c=> `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");

  document.getElementById("btnBackHome").onclick = ()=> switchTab("home");

  document.getElementById("btnAddFx").onclick = ()=>{
    const name = document.getElementById("fxName").value.trim();
    const amount = Number(document.getElementById("fxVal").value||0);
    const categoryId = document.getElementById("fxCat").value;
    const day = Number(document.getElementById("fxDay").value||0);
    if(!name || !amount) return alert("Preencha nome e valor.");
    data.fixedExpenses.push({ id:id(), name, amount, categoryId, day: day||null, active:true });
    document.getElementById("fxName").value="";
    document.getElementById("fxVal").value="";
    document.getElementById("fxDay").value="";
    save();
    render("fixos");
  };

  const list = document.getElementById("fxList");
  const catById = Object.fromEntries(data.categories.map(c=>[c.id,c.name]));
  list.innerHTML = (data.fixedExpenses.length?data.fixedExpenses:[]).map(f=>`
    <div class="item">
      <div class="meta">
        <div class="emoji">üè¶</div>
        <div class="txt">
          <div class="title">${escapeHtml(f.name)} <span class="badge">${escapeHtml(brMoney(f.amount))}</span></div>
          <div class="sub">${escapeHtml(catById[f.categoryId]||"Sem categoria")} ${f.day?("‚Ä¢ dia "+f.day):"‚Ä¢ mensal"}</div>
        </div>
      </div>
      <div class="actions">
        <button class="chip bad" data-act="del" data-id="${f.id}">Remover</button>
      </div>
    </div>
  `).join("") || `<div class="mini">Nenhum gasto fixo ainda.</div>`;

  list.onclick = (e)=>{
    const b = e.target.closest("button"); if(!b) return;
    if(b.dataset.act==="del"){
      const fid = b.dataset.id;
      if(!confirm("Remover este gasto fixo?")) return;
      data.fixedExpenses = data.fixedExpenses.filter(x=>x.id!==fid);
      // tamb√©m remove status em meses
      for(const mk of Object.keys(data.months)){
        delete data.months[mk].status[fid];
        delete data.months[mk].hiddenFixed[fid];
      }
      save();
      render("fixos");
    }
  };
}

/* =========================
   INVESTIMENTOS FIXOS (autom√°tico: nome, meta, prazo -> mensal)
   e aparece com pendente/pago na tela principal
========================= */
function renderInvestFixos(){
  screen.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Investimentos Fixos</h2>
        <span class="badge">autom√°tico ‚úÖ</span>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field">
          <label>Nome do investimento</label>
          <input id="ivName" placeholder="Ex: Reserva, CDB, Tesouro..."/>
        </div>
        <div class="field">
          <label>Meta final (R$)</label>
          <input id="ivTarget" type="number" inputmode="decimal" placeholder="Ex: 10000"/>
        </div>
        <div class="field">
          <label>Prazo (meses)</label>
          <input id="ivMonths" type="number" inputmode="numeric" placeholder="Ex: 12"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>Come√ßar em</label>
          <select id="ivStart"></select>
        </div>
        <div class="field">
          <label>Mensal calculado</label>
          <input id="ivMonthly" disabled/>
        </div>
        <div style="min-width:180px">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnAddInv" style="width:100%">Adicionar</button>
        </div>
      </div>

      <div class="split"></div>
      <div class="list" id="ivList"></div>

      <div class="hint">
        Na tela ‚ÄúResumo‚Äù, o investimento fixo aparece em todos os meses dentro do prazo e entra junto nas anota√ß√µes com <b>Pendente/Pago</b>.
      </div>
    </div>
  `;

  // start month options
  const ivStart = document.getElementById("ivStart");
  const keys = sortMonthKeys(Array.from(new Set([monthKeyFromDate(), ...Object.keys(data.months)])));
  ivStart.innerHTML = keys.map(k=> `<option value="${k}">${cap(brMonthLabel(k))}</option>`).join("");

  const inName = document.getElementById("ivName");
  const inTarget = document.getElementById("ivTarget");
  const inMonths = document.getElementById("ivMonths");
  const inMonthly = document.getElementById("ivMonthly");

  function recalc(){
    const t = Number(inTarget.value||0);
    const mo = Number(inMonths.value||0);
    const mval = (t && mo) ? (t / mo) : 0;
    inMonthly.value = mval ? brMoney(mval) : "";
  }
  inTarget.addEventListener("input", recalc);
  inMonths.addEventListener("input", recalc);
  recalc();

  document.getElementById("btnAddInv").onclick = ()=>{
    const name = inName.value.trim();
    const target = Number(inTarget.value||0);
    const months = Number(inMonths.value||0);
    const startMonth = ivStart.value;
    if(!name || !target || !months) return alert("Preencha nome, meta e prazo (meses).");
    const monthly = +(target / months).toFixed(2);
    data.fixedInvestments.push({ id:id(), name, target, months, startMonth, monthly, active:true });
    inName.value=""; inTarget.value=""; inMonths.value=""; recalc();
    save();
    render("investFixos");
  };

  const list = document.getElementById("ivList");
  list.innerHTML = data.fixedInvestments.map(inv=>`
    <div class="item">
      <div class="meta">
        <div class="emoji">üìà</div>
        <div class="txt">
          <div class="title">${escapeHtml(inv.name)} <span class="badge">${escapeHtml(brMoney(inv.monthly))}/m√™s</span></div>
          <div class="sub">Meta ${escapeHtml(brMoney(inv.target))} ‚Ä¢ ${inv.months} meses ‚Ä¢ in√≠cio ${cap(brMonthLabel(inv.startMonth||monthKeyFromDate()))}</div>
        </div>
      </div>
      <div class="actions">
        <button class="chip bad" data-act="del" data-id="${inv.id}">Remover</button>
      </div>
    </div>
  `).join("") || `<div class="mini">Nenhum investimento fixo ainda.</div>`;

  list.onclick = (e)=>{
    const b = e.target.closest("button"); if(!b) return;
    if(b.dataset.act==="del"){
      const iid = b.dataset.id;
      if(!confirm("Remover este investimento fixo?")) return;
      data.fixedInvestments = data.fixedInvestments.filter(x=>x.id!==iid);
      for(const mk of Object.keys(data.months)){
        delete data.months[mk].status[iid];
        delete data.months[mk].hiddenInvest[iid];
      }
      save();
      render("investFixos");
    }
  };
}

/* =========================
   CONFIG: Temas + Organiza√ß√£o (ordem/visibilidade)
========================= */
function renderConfig(){
  const order = data.ui.sectionOrder;
  const vis = data.ui.sectionVisible;

  screen.innerHTML = `
    <div class="grid cols2">
      <div class="card">
        <h2>Temas</h2>
        <div class="row">
          <div class="field">
            <label>Modo</label>
            <select id="setMode">
              <option value="dark" ${data.theme.mode==="dark"?"selected":""}>Escuro</option>
              <option value="light" ${data.theme.mode==="light"?"selected":""}>Claro</option>
            </select>
          </div>
          <div class="field">
            <label>Cor principal</label>
            <input id="setAccent" type="color" value="${data.theme.accent || "#569cff"}"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnApplyTheme">Aplicar</button>
        </div>
        <div class="hint">Voc√™ escolhe a cor do app e ela se aplica em bot√µes e destaques.</div>
      </div>

      <div class="card">
        <h2>Organiza√ß√£o do app</h2>
        <div class="hint">Escolha o que aparece e a ordem (do seu jeito).</div>
        <div class="split"></div>
        <div id="orderList" class="list"></div>
      </div>
    </div>
  `;

  document.getElementById("btnApplyTheme").onclick = ()=>{
    data.theme.mode = document.getElementById("setMode").value;
    data.theme.accent = document.getElementById("setAccent").value;
    save();
    applyTheme();
    alert("Tema aplicado!");
    render("config");
  };

  const orderList = document.getElementById("orderList");
  orderList.innerHTML = order.map((name, idx)=>`
    <div class="orderRow">
      <div>
        <div class="name">${escapeHtml(name)}</div>
        <div class="mini">
          <label style="margin:6px 0 0; display:flex; gap:8px; align-items:center">
            <input type="checkbox" data-act="toggleVis" data-name="${escapeHtmlAttr(name)}" ${vis[name]!==false?"checked":""} style="width:auto; transform:translateY(1px)"/>
            Mostrar esta se√ß√£o
          </label>
        </div>
      </div>
      <div class="actions">
        <button class="btn small" data-act="up" data-idx="${idx}">‚¨ÜÔ∏è</button>
        <button class="btn small" data-act="down" data-idx="${idx}">‚¨áÔ∏è</button>
      </div>
    </div>
  `).join("");

  orderList.onclick = (e)=>{
    const b = e.target.closest("button"); if(!b) return;
    const act = b.dataset.act;
    const idx = Number(b.dataset.idx);

    if(act==="up" && idx>0){
      const arr = data.ui.sectionOrder;
      [arr[idx-1], arr[idx]] = [arr[idx], arr[idx-1]];
      save(); render("config");
    }
    if(act==="down" && idx < data.ui.sectionOrder.length-1){
      const arr = data.ui.sectionOrder;
      [arr[idx+1], arr[idx]] = [arr[idx], arr[idx+1]];
      save(); render("config");
    }
  };

  orderList.addEventListener("change",(e)=>{
    const el = e.target;
    if(el.dataset.act==="toggleVis"){
      const name = el.dataset.name;
      data.ui.sectionVisible[name] = el.checked;
      save();
    }
  });
}

/* =========================
   PDF (Ano ou M√™s)
========================= */
function renderPDF(){
  const keys = sortMonthKeys(Array.from(new Set([monthKeyFromDate(), ...Object.keys(data.months)])));
  const years = Array.from(new Set(keys.map(k=>k.split("-")[0]))).sort();

  screen.innerHTML = `
    <div class="card">
      <h2>Imprimir como PDF</h2>
      <div class="row">
        <div class="field">
          <label>Tipo</label>
          <select id="pdfType">
            <option value="mes">Um m√™s</option>
            <option value="ano">Um ano</option>
          </select>
        </div>
        <div class="field" id="boxMonth">
          <label>M√™s</label>
          <select id="pdfMonth"></select>
        </div>
        <div class="field" id="boxYear" style="display:none">
          <label>Ano</label>
          <select id="pdfYear"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnMakePDF">Gerar PDF</button>
        <button class="btn" id="btnBack">Voltar</button>
      </div>

      <div class="hint">O PDF lista: resumo, lan√ßamentos, fixos e investimentos fixos (respeitando o m√™s/ano).</div>
    </div>
  `;

  const pdfMonth = document.getElementById("pdfMonth");
  pdfMonth.innerHTML = keys.map(k=> `<option value="${k}">${cap(brMonthLabel(k))}</option>`).join("");

  const pdfYear = document.getElementById("pdfYear");
  pdfYear.innerHTML = years.map(y=> `<option value="${y}">${y}</option>`).join("");

  const pdfType = document.getElementById("pdfType");
  pdfType.onchange = ()=>{
    const t = pdfType.value;
    document.getElementById("boxMonth").style.display = (t==="mes") ? "block" : "none";
    document.getElementById("boxYear").style.display = (t==="ano") ? "block" : "none";
  };

  document.getElementById("btnBack").onclick = ()=> switchTab("home");

  document.getElementById("btnMakePDF").onclick = ()=>{
    const t = pdfType.value;
    if(t==="mes") makePdfMonth(pdfMonth.value);
    else makePdfYear(pdfYear.value);
  };
}

function makePdfMonth(monthKey){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  const m = ensureMonth(monthKey);
  const title = `Controle de Gastos PRO - ${cap(brMonthLabel(monthKey))}`;
  let y = 48;

  doc.setFontSize(16);
  doc.text(title, 40, y); y += 18;

  doc.setFontSize(11);
  doc.text(`Sal√°rio: ${brMoney(m.salary)}   Meta: ${brMoney(m.goal)}`, 40, y); y += 16;

  // totais
  const totals = calcMonthTotals(monthKey);
  doc.text(`Gastos (fixos+inv+lan√ß.): ${brMoney(totals.gastosTotal)}   Receitas: ${brMoney(totals.receitas)}   Guardado: ${brMoney(totals.saved)}`, 40, y);
  y += 22;

  doc.setFontSize(13);
  doc.text("Anota√ß√µes", 40, y); y += 12;
  doc.setFontSize(10);

  const lines = buildMonthLines(monthKey);
  for(const line of lines){
    const wrapped = doc.splitTextToSize(line, 515);
    for(const w of wrapped){
      if(y > 780){ doc.addPage(); y = 48; }
      doc.text(w, 40, y);
      y += 14;
    }
  }

  doc.save(`GastosPRO_${monthKey}.pdf`);
}

function makePdfYear(year){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  const keys = sortMonthKeys(Object.keys(data.months).filter(k=>k.startsWith(year+"-")));
  if(keys.length===0) return alert("N√£o h√° dados desse ano ainda.");

  let y = 48;
  doc.setFontSize(16);
  doc.text(`Controle de Gastos PRO - Ano ${year}`, 40, y); y += 20;

  doc.setFontSize(11);
  doc.text(`Meses no relat√≥rio: ${keys.length}`, 40, y); y += 18;

  let sumG=0,sumR=0,sumS=0;
  for(const k of keys){
    const t = calcMonthTotals(k);
    sumG += t.gastosTotal;
    sumR += t.receitas;
    sumS += t.saved;
  }
  doc.text(`Total gastos: ${brMoney(sumG)}   Total receitas: ${brMoney(sumR)}   Total guardado: ${brMoney(sumS)}`, 40, y);
  y += 22;

  doc.setFontSize(13);
  doc.text("Resumo por m√™s", 40, y); y += 12;
  doc.setFontSize(10);

  for(const k of keys){
    const t = calcMonthTotals(k);
    const line = `${cap(brMonthLabel(k))} ‚Ä¢ Gastos: ${brMoney(t.gastosTotal)} ‚Ä¢ Receitas: ${brMoney(t.receitas)} ‚Ä¢ Guardado: ${brMoney(t.saved)}`;
    if(y > 780){ doc.addPage(); y = 48; }
    doc.text(line, 40, y);
    y += 14;
  }

  doc.addPage();
  y = 48;
  doc.setFontSize(13);
  doc.text("Detalhado (anota√ß√µes)", 40, y); y += 14;
  doc.setFontSize(10);

  for(const k of keys){
    if(y > 760){ doc.addPage(); y = 48; }
    doc.setFontSize(12);
    doc.text(cap(brMonthLabel(k)), 40, y); y += 14;
    doc.setFontSize(10);

    const lines = buildMonthLines(k);
    for(const line of lines){
      const wrapped = doc.splitTextToSize(line, 515);
      for(const w of wrapped){
        if(y > 780){ doc.addPage(); y = 48; }
        doc.text(w, 40, y);
        y += 14;
      }
    }
    y += 10;
  }

  doc.save(`GastosPRO_${year}.pdf`);
}

function calcMonthTotals(monthKey){
  const m = ensureMonth(monthKey);
  let fixedTotal=0, invTotal=0, entriesGastos=0, receitas=0, saved=0;

  for(const f of data.fixedExpenses.filter(x=>x.active!==false)){
    if(m.hiddenFixed[f.id]) continue;
    fixedTotal += Number(f.amount||0);
  }
  for(const inv of data.fixedInvestments.filter(x=>x.active!==false)){
    if(m.hiddenInvest[inv.id]) continue;
    if(inv.startMonth && inv.months){
      if(!isMonthInRange(monthKey, inv.startMonth, inv.months)) continue;
    }
    invTotal += Number(inv.monthly||0);
  }
  for(const e of m.entries){
    if(e.type==="gasto") entriesGastos += Number(e.amount||0);
    else receitas += Number(e.amount||0);
  }
  saved = m.saved.reduce((a,x)=>a+Number(x.amount||0),0);

  return { gastosTotal: fixedTotal+invTotal+entriesGastos, receitas, saved };
}

function buildMonthLines(monthKey){
  const m = ensureMonth(monthKey);
  const catById = Object.fromEntries(data.categories.map(c=>[c.id,c.name]));
  const lines = [];

  // fixos
  for(const f of data.fixedExpenses.filter(x=>x.active!==false)){
    if(m.hiddenFixed[f.id]) continue;
    const st = m.status[f.id] || "pendente";
    lines.push(`[${st.toUpperCase()}] FIXO: ${f.name} ‚Ä¢ ${brMoney(f.amount)} ‚Ä¢ ${catById[f.categoryId]||"Sem categoria"}`);
  }
  // investimentos
  for(const inv of data.fixedInvestments.filter(x=>x.active!==false)){
    if(m.hiddenInvest[inv.id]) continue;
    if(inv.startMonth && inv.months){
      if(!isMonthInRange(monthKey, inv.startMonth, inv.months)) continue;
    }
    const st = m.status[inv.id] || "pendente";
    lines.push(`[${st.toUpperCase()}] INVEST: ${inv.name} ‚Ä¢ ${brMoney(inv.monthly)} / m√™s ‚Ä¢ meta ${brMoney(inv.target)}`);
  }
  // lan√ßamentos
  for(const e of m.entries){
    const st = m.status[e.id] || (e.type==="gasto"?"pendente":"pago");
    lines.push(`[${st.toUpperCase()}] ${e.type.toUpperCase()}: ${brMoney(e.amount)} ‚Ä¢ ${e.date} ‚Ä¢ ${catById[e.categoryId]||"Sem categoria"}${e.desc ? " ‚Ä¢ "+e.desc : ""}`);
  }
  // guardado
  for(const s of m.saved){
    lines.push(`[OK] GUARDADO: ${brMoney(s.amount)} ‚Ä¢ ${s.date}${s.desc ? " ‚Ä¢ "+s.desc : ""}`);
  }

  if(lines.length===0) lines.push("Sem itens no per√≠odo.");
  return lines;
}

/* =========================
   UTIL: range meses
========================= */
function isMonthInRange(current, start, months){
  // current YYYY-MM, start YYYY-MM, months int
  const [sy, sm] = start.split("-").map(Number);
  const [cy, cm] = current.split("-").map(Number);
  const startIndex = sy*12 + (sm-1);
  const curIndex = cy*12 + (cm-1);
  return curIndex >= startIndex && curIndex <= (startIndex + (Number(months)-1));
}

/* =========================
   SWITCH TAB
========================= */
function switchTab(tab){
  activeTab = tab;
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===activeTab));
  render(activeTab);
  tabsEl.classList.remove("show");
}

/* =========================
   MISC
========================= */
function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

function escapeHtml(str){
  return (str??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeHtmlAttr(str){ return escapeHtml(str).replaceAll('"',"&quot;"); }

/* =========================
   INIT
========================= */
render("home");
</script>
</body>
</html>
