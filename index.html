<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<script>
  window.API_BASE_URL = "https://gastospro-ai.limaribeiroabraoolimaribeiro.workers.dev";
  window.APP_KEY = "GastosPro@2026!";
</script>

<style>
:root{
  --bg:#07101f;
  --grad1: rgba(86,156,255,.22);
  --grad2: rgba(57,217,138,.16);
  --grad3: rgba(255,93,93,.12);

  --panel: rgba(255,255,255,.06);
  --panel2: rgba(255,255,255,.08);
  --stroke: rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.72);

  --accent:#569cff;

  --good:#39d98a;
  --warn:#ffd166;
  --danger:#ff5d5d;
  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --radius: 18px;
  --radius2: 22px;
  --pad: 14px;
  --glass: blur(14px);
}

.light{
  --panel: rgba(0,0,0,.04);
  --panel2: rgba(0,0,0,.06);
  --stroke: rgba(0,0,0,.08);
  --text:#0d1222;
  --muted: rgba(13,18,34,.68);
  --shadow: 0 18px 60px rgba(0,0,0,.12);
}

*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(1000px 700px at 20% 10%, var(--grad1), transparent 55%),
    radial-gradient(900px 700px at 80% 30%, var(--grad2), transparent 60%),
    radial-gradient(800px 600px at 70% 90%, var(--grad3), transparent 60%),
    var(--bg);
  color:var(--text);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
  min-height:100vh;
}

a{color:inherit}
.wrap{max-width:980px;margin:auto;padding:16px;padding-bottom:120px}
h1{margin:0;font-size:20px;letter-spacing:.2px}
h2{margin:0;font-size:16px}
h3{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:600}
.small{font-size:12px;color:var(--muted)}
.card{
  background: linear-gradient(180deg, var(--panel2), var(--panel));
  border: 1px solid var(--stroke);
  border-radius: var(--radius2);
  padding: 14px;
  box-shadow: var(--shadow);
  backdrop-filter: var(--glass);
}
.row{display:flex;gap:10px;align-items:center}
.row > *{flex:1}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.grid1{display:grid;grid-template-columns:1fr;gap:12px}
.btn{
  appearance:none;border:0;cursor:pointer;
  background: rgba(255,255,255,.10);
  color:var(--text);
  padding:12px 12px;border-radius:14px;
  border:1px solid var(--stroke);
  font-weight:650;
  box-shadow: 0 10px 26px rgba(0,0,0,.18);
}
.btn.primary{
  background: var(--accent);
  border-color: color-mix(in srgb, var(--accent), transparent 55%);
  color:#fff;
}
.btn.good{
  background: var(--good);
  border-color: color-mix(in srgb, var(--good), transparent 55%);
  color:#062114;
}
.btn.warn{
  background: var(--warn);
  border-color: color-mix(in srgb, var(--warn), transparent 55%);
  color:#281a00
}
.btn.danger{
  background: var(--danger);
  border-color: color-mix(in srgb, var(--danger), transparent 55%);
  color:#2b0707;
}
.btn.ghost{background: transparent}
.btn.mini{padding:9px 10px;border-radius:12px;font-size:13px}
.btn.icon{width:44px;height:44px;display:flex;align-items:center;justify-content:center;padding:0;border-radius:16px}
.btn:active{transform: translateY(1px)}
input,select,textarea{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--stroke);
  outline:none;
  background: rgba(0,0,0,.15);
  color:var(--text);
  font-size:14px;
}
.light input,.light select,.light textarea{background: rgba(255,255,255,.75)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
.badge{
  display:inline-flex;gap:6px;align-items:center;
  padding:4px 10px;border-radius:999px;
  background: rgba(255,255,255,.10);
  border:1px solid var(--stroke);
  font-size:12px;color:var(--muted);
}
.badge.good{color:var(--good); border-color: rgba(57,217,138,.35); background: rgba(57,217,138,.10)}
.badge.warn{color:var(--warn); border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10)}
.kpi{
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  border-radius: 18px;
  padding:12px;
}
.kpi .v{font-size:18px;font-weight:800;margin-top:6px}

.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
.topbar .right{display:flex;gap:10px;align-items:center}
.pill{
  display:flex;gap:10px;align-items:center;justify-content:center;
  padding:10px 12px;border-radius:18px;
  border:1px solid var(--stroke);
  min-width:92px;
  font-weight:800;
}
.pill.menuBtn{
  background: rgba(255,255,255,.14);
  border-color: rgba(255,255,255,.20);
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
}
.pill.themeBtn{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
}
.pill .icon{opacity:.95}

.list{width:100%;border-collapse:separate;border-spacing:0 10px}
.list tr{background: rgba(255,255,255,.06);border:1px solid var(--stroke)}
.list td{padding:12px}
.list tr td:first-child{border-top-left-radius:16px;border-bottom-left-radius:16px}
.list tr td:last-child{border-top-right-radius:16px;border-bottom-right-radius:16px}

.fabWrap{
  position:fixed; right:18px; bottom:18px;
  display:flex; flex-direction:column; gap:10px; z-index:999;
}
.fab{
  width:58px;height:58px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  cursor:pointer; user-select:none;
}
.fab.add{
  background: radial-gradient(90px 70px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
              linear-gradient(135deg, rgba(57,217,138,.98), rgba(57,217,138,.55));
  color:#062114; font-size:30px; font-weight:900;
}
.fab.ai{
  background: radial-gradient(90px 70px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
              linear-gradient(135deg, color-mix(in srgb, var(--accent), #fff 15%), color-mix(in srgb, var(--accent), #000 20%));
  color:#04152c; font-weight:1000; letter-spacing:.8px;
  font-size:12px; line-height:1.05; text-align:center;
}
.light .fab.ai{color:#04152c}
.fab.ai span{display:block;font-weight:950;font-size:13px}
.fab.ai em{font-style:normal;font-weight:900;font-size:11px;opacity:.9}

.fab.voice{
  background:
    radial-gradient(90px 70px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
    linear-gradient(135deg, rgba(255,209,102,.95), rgba(255,93,93,.45));
  color:#1a1100;
  font-weight:1000;
  font-size:20px;
}
.fab.voice.hidden{display:none}

.overlay{
  position:fixed;inset:0;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:2000;
}
.modal{
  width: min(520px, 100%);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
  border: 1px solid var(--stroke);
  border-radius: 22px;
  box-shadow: var(--shadow);
  backdrop-filter: var(--glass);
  overflow:hidden;
}
.modalHeader{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 14px;
  border-bottom:1px solid var(--stroke);
}
.modalHeader .title{display:flex;gap:10px;align-items:center;font-weight:900}
.modalBody{padding:14px}
.modalFooter{
  padding:14px;border-top:1px solid var(--stroke);
  display:flex;gap:10px;justify-content:flex-end;
}
.closeX{
  width:42px;height:42px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  cursor:pointer;
  font-weight:900;
}
.screen{display:none}
.screen.active{display:block}
.backRow{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.backBtn{display:flex;align-items:center;gap:8px;border-radius:16px;padding:10px 12px;font-weight:850}
.hr{height:1px;background:var(--stroke);margin:12px 0}
.note{
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  padding:10px 12px;border-radius:16px;
}
.successText{color: var(--good);font-weight:800}
.warnText{color: var(--warn);font-weight:800}
.dangerText{color: var(--danger);font-weight:900}

#loading{
  display:flex;align-items:center;justify-content:center;
  height:100vh;padding:24px;text-align:center;
}
#debugBox{
  position:fixed; left:12px; right:12px; bottom:12px;
  background:rgba(0,0,0,.78); color:#fff; padding:10px; border-radius:12px;
  font-size:12px; z-index:9999; display:none; white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="loading">
  <div class="card" style="max-width:520px;width:100%">
    <h2 style="font-weight:900;margin-bottom:6px">Carregando‚Ä¶</h2>
    <div class="small">Validando login e preparando seus dados.</div>
    <div class="hr"></div>
    <div class="small">Se demorar, verifique sua internet.</div>
  </div>
</div>

<div id="app" style="display:none">

  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>Controle de Gastos PRO</h1>
        <div class="small" id="subHeader">Aqui fica s√≥ o essencial. Para editar categorias, fixos, PDF e simuladores, use o Menu.</div>
      </div>
      <div class="right">
        <button class="pill menuBtn" onclick="openMenu()" title="Menu">
          <span class="icon">‚ò∞</span> Menu
        </button>
        <button class="pill themeBtn" onclick="toggleTheme()" title="Tema">
          <span class="icon">üåô/‚òÄÔ∏è</span>
        </button>
      </div>
    </div>

    <div class="screen active" id="screen-home">
      <div id="homeContainer">

        <div style="margin-bottom:12px">
          <div class="card">
            <h2 style="font-weight:900;margin-bottom:10px">Resumo do m√™s</h2>

            <div class="grid2">
              <div>
                <label>M√™s</label>
                <select id="monthSelect"></select>
              </div>
              <div>
                <label>Sal√°rio</label>
                <input id="salary" type="number" placeholder="Ex: 4000">
              </div>
              <div>
                <label>Meta</label>
                <input id="meta" type="number" placeholder="Ex: 500">
              </div>
              <div>
                <label>Guardado (adicionar)</label>
                <input id="savedValue" type="number" placeholder="Ex: 1000">
              </div>
            </div>

            <div class="grid2" style="margin-top:10px">
              <div style="grid-column:1/2">
                <label>Descri√ß√£o do guardado (opcional)</label>
                <input id="savedDesc" placeholder="Ex: Reserva, CDB, Tesouro...">
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn primary" style="width:100%" onclick="addSaved()">Adicionar</button>
              </div>
            </div>

            <div id="savedList" style="margin-top:12px"></div>

            <div class="row" style="margin-top:14px">
              <button class="btn primary" onclick="saveSettings()" style="flex:1">Salvar</button>
            </div>

            <div class="small" style="margin-top:10px">
              Dica: toque em <b>IA PRO</b> para analisar seu m√™s e sugerir investimentos.
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div class="kpi">
            <div class="small">Sal√°rio</div>
            <div class="v" id="kpiSalary">R$ 0,00</div>
          </div>
          <div class="kpi">
            <div class="small">Gasto</div>
            <div class="v" id="kpiSpent">R$ 0,00</div>
          </div>
          <div class="kpi">
            <div class="small">Sobra</div>
            <div class="v" id="kpiLeft">R$ 0,00</div>
          </div>
          <div class="kpi">
            <div class="small">Guardado</div>
            <div class="v" id="kpiSaved">R$ 0,00</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="card">
            <h3>Gastos por categoria</h3>
            <canvas id="chart" style="width:100%;height:220px"></canvas>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="card">
            <h3>Lista do m√™s</h3>
            <div class="small" style="margin-bottom:10px">
              Toque em <b>Pendente/Pago</b> para marcar se voc√™ j√° pagou.
              <br>‚úÖ Gastos fixos e investimentos fixos podem ter <b>dia de vencimento</b>.
              <br>‚úÖ Quando estiver perto do prazo, o sistema tenta avisar com notifica√ß√£o.
            </div>
            <table class="list" id="list"></table>
          </div>
        </div>

      </div>
    </div>

    <div class="screen" id="screen-menu">
      <div class="backRow">
        <button class="btn backBtn" onclick="goHome()">‚Üê Voltar</button>
        <div style="font-weight:900">Menu</div>
      </div>

      <div class="grid1">
        <button class="btn" onclick="openScreen('screen-config')">‚öôÔ∏è Configura√ß√µes</button>
        <button class="btn" onclick="openScreen('screen-categories')">üìÇ Minhas Categorias</button>
        <button class="btn" onclick="openScreen('screen-fixos')">üìå Gastos Fixos</button>
        <button class="btn" onclick="openScreen('screen-investfixos')">üìà Investimentos Fixos</button>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h3>Conta</h3>
        <div class="row">
          <div>
            <div style="font-weight:900" id="userName">‚Äî</div>
            <div class="small" id="userEmail">‚Äî</div>
          </div>
          <button class="btn" onclick="logout()">Sair</button>
        </div>
      </div>
    </div>

    <div class="screen" id="screen-config">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Configura√ß√µes</div>
      </div>

      <div class="card">
        <h3>Notifica√ß√µes</h3>
        <div class="small">
          Ative para receber alertas de vencimento dos gastos fixos e investimentos fixos.
          <br><br>
          <b>Importante:</b> com o celular realmente desligado, um site/PWA n√£o consegue avisar sozinho sem servidor de push.
          Este app j√° fica preparado com service worker para o melhor funcionamento poss√≠vel.
        </div>
        <div class="hr"></div>
        <div class="row">
          <button class="btn primary" onclick="requestNotificationPermission()">üîî Ativar notifica√ß√µes</button>
          <button class="btn" onclick="forceTestNotification()">üß™ Testar</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Tema</h3>
        <button class="btn" onclick="toggleTheme()">üåô/‚òÄÔ∏è Alternar tema</button>
      </div>
    </div>

    <div class="screen" id="screen-categories">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Minhas Categorias</div>
      </div>

      <div class="card">
        <h3>Adicionar categoria</h3>
        <div class="row">
          <input id="novaCategoria" placeholder="Nome da categoria">
          <button class="btn primary mini" style="flex:0 0 auto" onclick="addCategoria()">Adicionar</button>
        </div>
        <div class="hr"></div>
        <div id="listaCategorias" class="small"></div>
      </div>
    </div>

    <div class="screen" id="screen-fixos">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Gastos Fixos</div>
      </div>

      <div class="card">
        <h3>Adicionar gasto fixo</h3>
        <label>Descri√ß√£o</label>
        <input id="descFixo" placeholder="Ex: Aluguel">

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Valor</label>
            <input id="valorFixo" type="number" placeholder="Ex: 750">
          </div>
          <div>
            <label>Categoria</label>
            <select id="categoriaFixo"></select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Dia para pagar</label>
            <input id="diaFixo" type="number" min="1" max="31" placeholder="Ex: 10">
          </div>
          <div class="note">
            <div style="font-weight:900">Lembrete</div>
            <div class="small">O sistema avisa quando faltar 3, 2, 1 dias e no dia do vencimento.</div>
          </div>
        </div>

        <button class="btn primary" style="margin-top:10px" onclick="addFixo()">Adicionar</button>

        <div class="hr"></div>
        <div id="listaFixos" class="small"></div>
      </div>
    </div>

    <div class="screen" id="screen-investfixos">
      <div class="backRow">
        <button class="btn backBtn" onclick="openMenu()">‚Üê Voltar</button>
        <div style="font-weight:900">Investimentos Fixos</div>
      </div>

      <div class="card">
        <h3>Adicionar investimento fixo</h3>

        <label>Nome</label>
        <input id="invNome" placeholder="Ex: Reserva">

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Meta final (R$)</label>
            <input id="invMetaFinal" type="number" placeholder="Ex: 10000">
          </div>
          <div>
            <label>Prazo (meses)</label>
            <input id="invPrazoMeses" type="number" placeholder="Ex: 12" value="12">
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>At√© que dia deve pagar</label>
            <input id="invDiaPagar" type="number" min="1" max="31" placeholder="Ex: 11" value="10">
          </div>
          <div class="note">
            <div style="font-weight:900">Mensal autom√°tico</div>
            <div class="small" id="invResumo">Preencha Meta e Prazo para ver o valor por m√™s.</div>
          </div>
        </div>

        <button class="btn primary" style="margin-top:10px" onclick="addInvestFixo()">Adicionar</button>

        <div class="hr"></div>
        <div id="listaInvestFixos" class="small"></div>
      </div>
    </div>

  </div>

  <div class="fabWrap">
    <div class="fab ai" onclick="alert('IA PRO ligada nesta vers√£o base.')" title="IA PRO">
      <span>IA</span><em>PRO</em>
    </div>
    <div class="fab add" onclick="openAddExpense()" title="Adicionar gasto">+</div>
  </div>

</div>

<div id="debugBox"></div>

<div class="overlay" id="overlay-addExpense">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">‚ûï Adicionar gasto</div>
      <div class="closeX" onclick="closeModal('overlay-addExpense')">‚úï</div>
    </div>
    <div class="modalBody">
      <label>Descri√ß√£o</label>
      <input id="mDesc" placeholder="Ex: Mercado">
      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Valor</label>
          <input id="mValor" type="number" placeholder="Ex: 120.50">
        </div>
        <div>
          <label>Categoria</label>
          <select id="mCategoria"></select>
        </div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" onclick="closeModal('overlay-addExpense')">Cancelar</button>
      <button class="btn good" onclick="confirmAddExpense()">Adicionar</button>
    </div>
  </div>
</div>

<script>
function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\\n" + (e.message || e.type) + "\\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="./config.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

let auth = null;
let USER = null;
let USER_ID = null;

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Investimentos","Outros"];
let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];
let investFixos = [];
let state = { meses:{} };
let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;

const NOTIF_KEYS = {
  permAsked: "notif_perm_asked_v2",
  sentPrefix: "notif_sent_v2"
};

let swReg = null;

function money(n){
  return Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function todayISO(){
  return new Date().toISOString().slice(0,10);
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function showLoading(){
  document.getElementById("app").style.display="none";
  document.getElementById("loading").style.display="flex";
}
function showApp(){
  document.getElementById("loading").style.display="none";
  document.getElementById("app").style.display="block";
}
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
}
function openScreen(id){ showScreen(id); }
function goHome(){ showScreen("screen-home"); }
function openMenu(){ showScreen("screen-menu"); }
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
}
function openModal(id){
  const o=document.getElementById(id);
  if(o) o.style.display="flex";
}
function closeModal(id){
  const o=document.getElementById(id);
  if(o) o.style.display="none";
}

function kMes(){ return "gastos_pro_state_" + USER_ID; }
function kCat(){ return "categorias_" + USER_ID; }
function kFix(){ return "fixos_" + USER_ID; }
function kInv(){ return "inv_fixos_" + USER_ID; }

function loadAll(){
  try{
    const raw = localStorage.getItem(kMes());
    if(raw) state = JSON.parse(raw) || {meses:{}};
  }catch(e){ state={meses:{}}; }

  try{
    const raw = localStorage.getItem(kCat());
    categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
    if(!Array.isArray(categorias) || !categorias.length) categorias=[...DEFAULT_CATEGORIAS];
  }catch(e){ categorias=[...DEFAULT_CATEGORIAS]; }

  try{
    const raw = localStorage.getItem(kFix());
    fixos = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(fixos)) fixos=[];
    fixos = fixos.map(f=>({
      ...f,
      isFixo:true,
      diaPagar: Number(f.diaPagar || 0),
      paid: false
    }));
  }catch(e){ fixos=[]; }

  try{
    const raw = localStorage.getItem(kInv());
    investFixos = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(investFixos)) investFixos=[];
  }catch(e){ investFixos=[]; }

  if(!state || typeof state!=="object") state={meses:{}};
  if(!state.meses || typeof state.meses!=="object") state.meses={};
}
function saveAll(){
  localStorage.setItem(kMes(), JSON.stringify(state));
  localStorage.setItem(kCat(), JSON.stringify(categorias));
  localStorage.setItem(kFix(), JSON.stringify(fixos));
  localStorage.setItem(kInv(), JSON.stringify(investFixos));
}

function fixKey(desc, amount, category){
  return String(desc||"").toLowerCase() + "|" + Number(amount||0) + "|" + String(category||"").toLowerCase();
}
function ensureSavedArray(d){
  if(!Array.isArray(d.saved)) d.saved = [];
  return d.saved;
}
function ensureMonthStatuses(d){
  if(!d.fixedStatus || typeof d.fixedStatus !== "object") d.fixedStatus = {};
  if(!d.investStatus || typeof d.investStatus !== "object") d.investStatus = {};
}
function getDataMes(m){
  const mm = m || mesAtual;
  if(!state.meses[mm]){
    state.meses[mm] = {
      salary:0,
      meta:0,
      items:[],
      saved:[],
      hiddenFixos:[],
      fixedStatus:{},
      investStatus:{}
    };
  }
  const d = state.meses[mm];
  if(!Array.isArray(d.items)) d.items=[];
  if(!Array.isArray(d.hiddenFixos)) d.hiddenFixos=[];
  ensureSavedArray(d);
  ensureMonthStatuses(d);

  const hidden = new Set(d.hiddenFixos.map(String));
  const present = new Set(d.items.map(it=>fixKey(it.desc,it.amount,it.category)));

  for(const f of fixos){
    const fk = fixKey(f.desc, f.amount, f.category);
    if(hidden.has(fk)) continue;
    if(present.has(fk)) continue;

    const paid = !!d.fixedStatus[f.id];
    d.items.unshift({
      ...f,
      isFixo:true,
      isInvestFixo:false,
      diaPagar:Number(f.diaPagar || 0),
      paid
    });
    present.add(fk);
  }

  for(const inv of investFixos){
    const desc = "Juntar: " + inv.nome;
    const amount = Number(inv.mensal || 0);
    const fk = fixKey(desc, amount, "Investimentos");
    if(hidden.has(fk)) continue;
    if(present.has(fk)) continue;

    const paid = !!d.investStatus[inv.id];
    d.items.unshift({
      desc,
      amount,
      category:"Investimentos",
      isFixo:true,
      isInvestFixo:true,
      invId:inv.id,
      diaPagar:Number(inv.diaPagar || 0),
      paid
    });
    present.add(fk);
  }

  return d;
}

function buildMonthSelect(){
  const sel = document.getElementById("monthSelect");
  if(!sel) return;

  const monthsSet = new Set(Object.keys(state.meses||{}));
  const now = new Date();
  for(let i=0;i<=24;i++){
    const dt = new Date(now.getFullYear(), now.getMonth()-i, 1);
    monthsSet.add(dt.toISOString().slice(0,7));
  }
  const months = Array.from(monthsSet).sort().reverse();

  sel.innerHTML = months.map(m=>{
    const [y,mo]=m.split("-");
    const dt = new Date(Number(y), Number(mo)-1, 1);
    const label = dt.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});
    return '<option value="'+m+'">'+label+'</option>';
  }).join("");

  if(!months.includes(mesAtual)) mesAtual = new Date().toISOString().slice(0,7);
  sel.value = mesAtual;
  sel.onchange = ()=>{
    mesAtual = sel.value;
    render();
  };
}

function renderCategorias(){
  const list = document.getElementById("listaCategorias");
  const selF = document.getElementById("categoriaFixo");
  const selM = document.getElementById("mCategoria");

  if(list){
    list.innerHTML = categorias.map((c,idx)=>`
      <div class="note" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>‚Ä¢ <b>${escapeHtml(c)}</b></div>
        <button class="btn icon mini" onclick="removeCategoria(${idx})">‚úï</button>
      </div>
    `).join("") || "<div class='small'>Nenhuma categoria.</div>";
  }

  const opts = categorias.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  if(selF) selF.innerHTML = opts;
  if(selM) selM.innerHTML = opts;
}

function renderFixos(){
  const div = document.getElementById("listaFixos");
  if(!div) return;
  if(!fixos.length){
    div.innerHTML = "<div class='small'>Nenhum gasto fixo cadastrado.</div>";
    return;
  }

  div.innerHTML = fixos.map((f,idx)=>`
    <div class="note" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <div style="font-weight:900">${escapeHtml(f.desc)}</div>
        <div class="small">
          ${money(f.amount)}
          <span class="badge">${escapeHtml(f.category)}</span>
          ${f.diaPagar ? `<span class="badge warn">Vence dia ${escapeHtml(f.diaPagar)}</span>` : ``}
        </div>
      </div>
      <button class="btn icon mini" title="Remover do cadastro" onclick="removeFixo(${idx})">‚úï</button>
    </div>
  `).join("");
}

function calcMensalAuto(metaFinal, prazoMeses){
  const meta = Number(metaFinal||0);
  const meses = Number(prazoMeses||0);
  if(!meta || meta<=0) return 0;
  if(!meses || meses<=0) return 0;
  return Math.round((meta/meses)*100)/100;
}

function updateInvResumo(){
  const metaFinal = Number(document.getElementById("invMetaFinal").value||0);
  const prazoMeses = Number(document.getElementById("invPrazoMeses").value||0) || 12;
  const out = document.getElementById("invResumo");
  if(!out) return;
  if(!metaFinal || !prazoMeses){
    out.textContent = "Preencha Meta e Prazo para ver o valor por m√™s.";
    return;
  }
  const mensal = calcMensalAuto(metaFinal, prazoMeses);
  out.textContent = "Valor mensal autom√°tico: " + money(mensal);
}

function renderInvestFixos(){
  const div = document.getElementById("listaInvestFixos");
  if(!div) return;
  if(!investFixos.length){
    div.innerHTML="<div class='small'>Nenhum investimento fixo cadastrado.</div>";
    return;
  }

  div.innerHTML = investFixos.map((inv,idx)=>`
    <div class="note" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <div style="font-weight:950">üìå ${escapeHtml(inv.nome)}</div>
        <div class="small">Meta: <b>${money(inv.metaFinal)}</b> ‚Ä¢ Prazo: <b>${escapeHtml(inv.prazoMeses)} meses</b></div>
        <div class="small">Mensal: <b class="successText">${money(inv.mensal)}</b></div>
        <div class="small">${inv.diaPagar ? `Vence dia <b>${escapeHtml(inv.diaPagar)}</b>` : ``}</div>
      </div>
      <button class="btn icon mini" title="Remover do cadastro" onclick="removeInvestFixo(${idx})">‚úï</button>
    </div>
  `).join("");
}

function addCategoria(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const input = document.getElementById("novaCategoria");
  const nome = (input.value||"").trim();
  if(!nome) return;
  if(categorias.some(c=>c.toLowerCase()===nome.toLowerCase())) return alert("Essa categoria j√° existe.");
  categorias.push(nome);
  input.value="";
  saveAll();
  renderCategorias();
}

function removeCategoria(idx){
  if(idx<0 || idx>=categorias.length) return;
  const cat = categorias[idx];
  categorias.splice(idx,1);

  fixos = fixos.map(f=>{
    if(String(f.category||"")===cat) return { ...f, category:"Outros" };
    return f;
  });

  Object.keys(state.meses||{}).forEach(m=>{
    const d = state.meses[m];
    if(d && Array.isArray(d.items)){
      d.items = d.items.map(it=>{
        if(String(it.category||"")===cat) return { ...it, category:"Outros" };
        return it;
      });
    }
  });

  saveAll();
  renderCategorias();
  renderFixos();
  render();
}

function addFixo(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const desc = (document.getElementById("descFixo").value||"").trim();
  const valor = Number(document.getElementById("valorFixo").value);
  const categoria = document.getElementById("categoriaFixo").value || "Outros";
  const diaPagar = Number(document.getElementById("diaFixo").value || 0);

  if(!desc || !valor || valor<=0) return alert("Preencha descri√ß√£o e valor.");
  if(diaPagar && (diaPagar < 1 || diaPagar > 31)) return alert("Dia inv√°lido.");

  fixos.push({
    id: uid(),
    desc,
    amount: valor,
    category: categoria,
    diaPagar,
    isFixo:true
  });

  document.getElementById("descFixo").value="";
  document.getElementById("valorFixo").value="";
  document.getElementById("diaFixo").value="";

  saveAll();
  renderFixos();
  render();
  checkDueNotifications();
}

function removeFixo(idx){
  if(idx<0 || idx>=fixos.length) return;
  const fixo = fixos[idx];
  Object.keys(state.meses||{}).forEach(m=>{
    const d = state.meses[m];
    if(d && d.fixedStatus && fixo && fixo.id) delete d.fixedStatus[fixo.id];
  });
  fixos.splice(idx,1);
  saveAll();
  renderFixos();
  render();
}

function addInvestFixo(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }

  const nome = (document.getElementById("invNome").value||"").trim();
  const metaFinal = Number(document.getElementById("invMetaFinal").value||0);
  const prazoMeses = Number(document.getElementById("invPrazoMeses").value||0) || 12;
  const diaPagar = Number(document.getElementById("invDiaPagar").value||0);

  if(!nome) return alert("Digite o Nome.");
  if(!metaFinal || metaFinal<=0) return alert("Digite a Meta final.");
  if(!prazoMeses || prazoMeses<=0) return alert("Digite o Prazo.");
  if(!diaPagar || diaPagar < 1 || diaPagar > 31) return alert("Digite um dia v√°lido.");

  const mensal = calcMensalAuto(metaFinal, prazoMeses);
  const id = uid();

  investFixos.push({
    id,
    nome,
    metaFinal,
    prazoMeses,
    mensal,
    diaPagar
  });

  document.getElementById("invNome").value="";
  document.getElementById("invMetaFinal").value="";
  document.getElementById("invPrazoMeses").value="12";
  document.getElementById("invDiaPagar").value="10";
  updateInvResumo();

  saveAll();
  renderInvestFixos();
  render();
  checkDueNotifications();
}

function removeInvestFixo(idx){
  if(idx<0 || idx>=investFixos.length) return;
  const inv = investFixos[idx];

  Object.keys(state.meses||{}).forEach(m=>{
    const d = state.meses[m];
    if(d && d.investStatus && inv && inv.id) delete d.investStatus[inv.id];
  });

  investFixos.splice(idx,1);
  saveAll();
  renderInvestFixos();
  render();
}

function addSaved(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const v = Number(document.getElementById("savedValue").value);
  const desc = (document.getElementById("savedDesc").value||"").trim();
  if(!v || v<=0) return alert("Digite um valor para adicionar ao guardado.");
  const d = getDataMes(mesAtual);
  ensureSavedArray(d);
  d.saved.unshift({ value:v, desc, date:todayISO(), source:"manual" });
  document.getElementById("savedValue").value="";
  document.getElementById("savedDesc").value="";
  saveAll();
  renderSaved();
  renderKPIs();
}

function saveSettings(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const d = getDataMes(mesAtual);
  d.salary = Number(document.getElementById("salary").value||0);
  d.meta   = Number(document.getElementById("meta").value||0);
  saveAll();
  render();
}

function openAddExpense(){
  if(!USER_ID){ alert("Fa√ßa login primeiro"); return; }
  document.getElementById("mDesc").value="";
  document.getElementById("mValor").value="";
  if(document.getElementById("mCategoria")) document.getElementById("mCategoria").value = "Outros";
  openModal("overlay-addExpense");
}
function confirmAddExpense(){
  const desc = (document.getElementById("mDesc").value||"").trim();
  const amount = Number(document.getElementById("mValor").value||0);
  const cat = document.getElementById("mCategoria").value || "Outros";
  if(!desc) return alert("Preencha a descri√ß√£o.");
  if(!amount || amount<=0) return alert("Preencha o valor.");

  const d = getDataMes(mesAtual);
  d.items.push({
    desc,
    amount,
    category: cat,
    isFixo:false,
    isInvestFixo:false,
    paid:false
  });

  saveAll();
  closeModal("overlay-addExpense");
  render();
}

function renderSaved(){
  const d = getDataMes(mesAtual);
  const div = document.getElementById("savedList");
  if(!div) return;

  ensureSavedArray(d);
  if(!d.saved.length){
    div.innerHTML="";
    return;
  }

  div.innerHTML = d.saved.map((s)=>`
    <div class="note">
      <div style="font-weight:950">üè¶ ${money(s.value)}</div>
      <div class="small">
        Data: ${escapeHtml(s.date || "")}
        ${s.desc ? " ‚Ä¢ " + escapeHtml(s.desc) : ""}
      </div>
    </div>
  `).join("");
}

function togglePaid(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;

  it.paid = !it.paid;

  if(it.isInvestFixo && it.invId){
    d.investStatus[it.invId] = !!it.paid;
    if(it.paid){
      d.saved.unshift({
        value:Number(it.amount||0),
        desc:"Autom√°tico: " + it.desc,
        date:todayISO(),
        source:"investFixo",
        invId:it.invId,
        month:mesAtual
      });
    }else{
      d.saved = (d.saved||[]).filter(s => !(s.source==="investFixo" && s.invId===it.invId && s.month===mesAtual));
    }
  } else if(it.isFixo && it.id){
    d.fixedStatus[it.id] = !!it.paid;
  }

  saveAll();
  render();
}

function delItemSmart(idx){
  const d = getDataMes(mesAtual);
  const it = d.items[idx];
  if(!it) return;
  d.items.splice(idx,1);
  saveAll();
  render();
}

function renderList(){
  const d = getDataMes(mesAtual);
  const table = document.getElementById("list");
  if(!table) return;

  if(!d.items.length){
    table.innerHTML = `<tr><td class="small">Nenhum gasto neste m√™s. Toque em ‚Äú+‚Äù para adicionar.</td></tr>`;
    return;
  }

  table.innerHTML = d.items.map((i,idx)=>{
    const paid = !!i.paid;
    const statusBadge = paid ? `<span class="badge good">Pago</span>` : `<span class="badge warn">Pendente</span>`;
    const fixBadge = i.isInvestFixo ? `<span class="badge">Juntar</span>` : (i.isFixo ? `<span class="badge">Fixo</span>` : ``);
    const dueBadge = i.diaPagar ? `<span class="badge warn">Vence dia ${escapeHtml(i.diaPagar)}</span>` : ``;
    const btnPaidClass = paid ? "good" : "warn";
    const btnPaidText = paid ? "‚úÖ Pago" : "‚è≥ Pendente";

    return `
      <tr>
        <td>
          <div style="font-weight:900">
            ${escapeHtml(i.desc||"")}
            ${fixBadge}
            ${dueBadge}
            <span class="badge">${escapeHtml(i.category||"Outros")}</span>
            ${statusBadge}
          </div>
          <div class="small">${money(i.amount||0)}</div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn ${btnPaidClass} mini" onclick="togglePaid(${idx})">${btnPaidText}</button>
          </div>
        </td>
        <td style="width:64px;text-align:right">
          <button class="btn icon mini" onclick="delItemSmart(${idx})" title="Remover">‚úï</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderKPIs(){
  const d = getDataMes(mesAtual);
  const spent = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const saved = (d.saved||[]).reduce((a,b)=>a+Number(b.value||0),0);
  const salary = Number(d.salary||0);
  const left = salary - spent;

  document.getElementById("kpiSalary").textContent = money(salary);
  document.getElementById("kpiSpent").textContent  = money(spent);
  document.getElementById("kpiLeft").textContent   = money(left);
  document.getElementById("kpiSaved").textContent  = money(saved);

  document.getElementById("salary").value = salary ? salary : "";
  document.getElementById("meta").value = d.meta ? d.meta : "";
}

function drawChart(items){
  const mapa={};
  items.forEach(i=>{
    const cat = i.category||"Outros";
    mapa[cat]=(mapa[cat]||0)+Number(i.amount||0);
  });
  const labels = Object.keys(mapa);
  const valores= Object.values(mapa);

  if(grafico) grafico.destroy();
  grafico = new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{ labels, datasets:[{ data: valores }] },
    options:{
      plugins:{
        legend:{ labels:{ color: getComputedStyle(document.body).getPropertyValue("--text") } }
      }
    }
  });
}

function render(){
  if(!USER_ID) return;
  buildMonthSelect();
  renderKPIs();
  renderSaved();
  renderList();
  drawChart(getDataMes(mesAtual).items || []);
  saveAll();
}

function isLightMode(){
  return document.body.classList.contains("light");
}
function currentMonthKeyFromDate(baseDate = new Date()){
  const y = baseDate.getFullYear();
  const m = String(baseDate.getMonth() + 1).padStart(2, "0");
  return `${y}-${m}`;
}
function daysUntilDue(day, baseDate = new Date()){
  const y = baseDate.getFullYear();
  const m = baseDate.getMonth();
  const maxDay = new Date(y, m + 1, 0).getDate();
  const dueDay = Math.min(Math.max(Number(day || 1), 1), maxDay);

  const today = new Date(y, m, baseDate.getDate());
  const due = new Date(y, m, dueDay);

  const diffMs = due.getTime() - today.getTime();
  return Math.floor(diffMs / 86400000);
}
function notifKey(itemType, itemId, mes, tag){
  return `${NOTIF_KEYS.sentPrefix}_${USER_ID || "guest"}_${itemType}_${itemId}_${mes}_${tag}`;
}

async function registerSW(){
  if(!("serviceWorker" in navigator)) return null;
  try{
    swReg = await navigator.serviceWorker.register("./sw.js");
    return swReg;
  }catch(e){
    console.log("SW erro:", e);
    return null;
  }
}

async function showAppNotification(title, body){
  try{
    if(!("Notification" in window)) return;
    if(Notification.permission !== "granted") return;

    if(swReg){
      await swReg.showNotification(title, {
        body,
        icon: "icons/icon-192.png",
        badge: "icons/icon-192.png",
        tag: "gastos-pro-vencimentos",
        renotify: true,
        data: { url: location.origin + location.pathname }
      });

      if(navigator.serviceWorker.controller){
        navigator.serviceWorker.controller.postMessage({
          type: "STORE_LAST_NOTIFICATION",
          payload: { title, body }
        });
      }
    }else{
      new Notification(title, {
        body,
        icon: "icons/icon-192.png"
      });
    }
  }catch(e){}
}

async function requestNotificationPermission(){
  if(!("Notification" in window)){
    alert("Seu navegador n√£o suporta notifica√ß√µes.");
    return;
  }

  try{
    const perm = await Notification.requestPermission();
    localStorage.setItem(NOTIF_KEYS.permAsked, "1");

    if(perm === "granted"){
      await registerSW();
      alert("Notifica√ß√µes ativadas com sucesso.");
      checkDueNotifications();
    }else{
      alert("Notifica√ß√µes n√£o foram permitidas.");
    }
  }catch(e){
    alert("Erro ao ativar notifica√ß√µes.");
  }
}

async function forceTestNotification(){
  await showAppNotification("Controle de Gastos PRO", "Teste de notifica√ß√£o funcionando.");
}

async function checkDueNotifications(){
  if(!USER_ID) return;
  if(!("Notification" in window)) return;
  if(Notification.permission !== "granted") return;

  const now = new Date();
  const mes = currentMonthKeyFromDate(now);
  const d = getDataMes(mes);
  ensureMonthStatuses(d);

  (d.items || []).forEach(async (item)=>{
    if(!item || !item.diaPagar) return;
    if(item.paid) return;

    const diff = daysUntilDue(item.diaPagar, now);
    if(diff < 0 || diff > 3) return;

    const itemId = item.isInvestFixo ? (item.invId || item.desc) : (item.id || item.desc);
    const itemType = item.isInvestFixo ? "invest" : (item.isFixo ? "fixo" : "item");
    const tag = "faltam_" + diff;
    const alreadySent = localStorage.getItem(notifKey(itemType, itemId, mes, tag)) === "1";
    if(alreadySent) return;

    let body = "";
    if(diff === 0){
      body = `O prazo para pagar ${item.desc} √© hoje (dia ${item.diaPagar}).`;
    }else if(diff === 1){
      body = `O prazo para pagar ${item.desc} est√° chegando. Falta 1 dia (vence dia ${item.diaPagar}).`;
    }else{
      body = `O prazo para pagar ${item.desc} est√° chegando. Faltam ${diff} dias (vence dia ${item.diaPagar}).`;
    }

    await showAppNotification("Controle de Gastos PRO", body);
    localStorage.setItem(notifKey(itemType, itemId, mes, tag), "1");
  });
}

function startDueNotificationWatcher(){
  checkDueNotifications();
  if(window.__dueNotifInterval) clearInterval(window.__dueNotifInterval);
  window.__dueNotifInterval = setInterval(()=>{
    checkDueNotifications();
  }, 60 * 60 * 1000);

  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "visible") checkDueNotifications();
  });
}

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou.");
    return false;
  }

  try{
    if(!firebase.apps || !firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
  }catch(e){}

  auth = firebase.auth();
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }catch(e){}

  auth.onAuthStateChanged(async (u)=>{
    USER = u || null;
    if(!USER){
      USER_ID = null;
      alert("Fa√ßa login para usar o app.");
      return;
    }

    USER_ID = USER.uid;
    document.getElementById("userName").textContent = USER.displayName || "Usu√°rio";
    document.getElementById("userEmail").textContent = USER.email || "";

    const t = localStorage.getItem("theme");
    if(t==="light") document.body.classList.add("light");

    loadAll();
    buildMonthSelect();
    renderCategorias();
    renderFixos();
    renderInvestFixos();
    updateInvResumo();

    ["invMetaFinal","invPrazoMeses"].forEach(id=>{
      const el=document.getElementById(id);
      if(el && !el.dataset.bound){
        el.addEventListener("input", updateInvResumo);
        el.dataset.bound="1";
      }
    });

    await registerSW();

    if(("Notification" in window) && Notification.permission === "default" && localStorage.getItem(NOTIF_KEYS.permAsked) !== "1"){
      localStorage.setItem(NOTIF_KEYS.permAsked, "1");
      setTimeout(()=>{ requestNotificationPermission(); }, 1200);
    }

    startDueNotificationWatcher();
    showApp();
    goHome();
    render();
  });

  return true;
}

async function loginGoogle(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt:"select_account" });
    try{
      await auth.signInWithPopup(provider);
    }catch(e){
      await auth.signInWithRedirect(provider);
    }
  }catch(e){
    alert("Erro no login: " + (e.message || e));
  }
}

async function logout(){
  try{
    if(auth) await auth.signOut();
  }catch(e){}
  location.reload();
}

document.addEventListener("DOMContentLoaded", async ()=>{
  showLoading();
  const ok = await initFirebase();
  if(!ok) return;
});
</script>
</body>
</html>
