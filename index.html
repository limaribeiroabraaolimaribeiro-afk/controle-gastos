<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<style>
:root{ --bg:#0b1020; --card:#ffffff0f; --text:#eaf0ff; --accent:#569cff; --danger:#d9534f; --ok:#4CAF50; }
.light{ --bg:#f4f6ff; --card:#ffffff; --text:#111; }
*{box-sizing:border-box}
body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui; }
.wrap{max-width:980px;margin:auto;padding:16px}
.card{ background:var(--card); border-radius:14px; padding:14px; margin-bottom:12px; }
h1{font-size:20px;margin:0 0 10px}
h3{margin:0 0 10px}
input,select,button,textarea{ width:100%; padding:10px; border-radius:12px; border:none; margin-top:6px; }
textarea{ min-height:90px; resize:vertical; }
button{ background:var(--accent); color:#fff; cursor:pointer; touch-action:manipulation; }
button.ghost{ background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--text); }
.light button.ghost{ border:1px solid rgba(0,0,0,.18); }
button.danger{ background:var(--danger); }
.kpis{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.kpi{ background:var(--card); padding:10px; border-radius:12px; }
.success{color:var(--ok)}
#chart,#chartEvolucao{width:100%;height:220px}
.fab{ position:fixed; bottom:20px; right:20px; background:var(--ok); color:white; border-radius:50%; width:55px; height:55px; font-size:28px; display:flex; align-items:center; justify-content:center; }
.toggle{float:right;cursor:pointer; margin-left:10px;}
.small{opacity:.85;font-size:12px}
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); margin-left:6px; font-size:12px; }
.light .badge{background:rgba(0,0,0,.08);}
.row{ display:flex; gap:8px; align-items:center; }
.row > * {flex:1}
.row .mini {flex:0 0 auto; width:auto; padding:8px 10px; border-radius:12px;}
hr{border:0;border-top:1px solid rgba(255,255,255,.08);margin:10px 0}
.light hr{border-top:1px solid rgba(0,0,0,.08)}

/* DEBUG */
#debugBox{
  position:fixed; left:12px; right:12px; bottom:12px;
  background:rgba(0,0,0,.75); color:#fff; padding:10px; border-radius:12px;
  font-size:12px; z-index:9999; display:none; white-space:pre-wrap;
}

/* LOADING */
#loading{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  text-align:center;
  padding:24px;
  opacity:.9;
}

/* =========================
   ‚úÖ TELAS (APP / HIST√ìRICO)
========================= */
.screen{ display:none; min-height:100vh; }
.screen.show{ display:block; }

/* Topbar */
.topbar{
  position:sticky; top:0; z-index:20;
  background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
  backdrop-filter: blur(10px);
}
.light .topbar{
  background:linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,0));
}
.topbar-inner{
  max-width:980px; margin:auto; padding:14px 16px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.topbar-title{ font-weight:800; font-size:16px; }
.iconbtn{
  width:auto; padding:8px 10px; border-radius:12px;
  background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12);
  color:var(--text);
}
.light .iconbtn{
  background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.10);
}

/* Hist√≥rico bonito */
.histHeader{ padding:18px 16px 8px; }
.histHero{
  background:linear-gradient(135deg, rgba(86,156,255,.25), rgba(76,175,80,.18));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:14px;
}
.light .histHero{ border:1px solid rgba(0,0,0,.10); }
.histGrid{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
.histItem{
  background:var(--card);
  border-radius:16px;
  padding:12px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
  border:1px solid rgba(255,255,255,.08);
}
.light .histItem{ border:1px solid rgba(0,0,0,.08); }
.histLeft{ flex:1; }
.histMonth{ font-weight:900; font-size:14px; }
.histMeta{ margin-top:4px; }
.histNums{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.pill{
  display:inline-flex; gap:6px; align-items:center;
  padding:6px 10px; border-radius:999px;
  background:rgba(255,255,255,.10);
  font-size:12px;
}
.light .pill{ background:rgba(0,0,0,.06); }
.pill b{ font-weight:800; }
.histBtn{ width:auto; padding:10px 12px; border-radius:14px; }

/* =========================
   ‚úÖ MENU SIMULADORES (colaps√°vel)
========================= */
.menuCard{
  background:linear-gradient(135deg, rgba(86,156,255,.18), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.10);
}
.light .menuCard{ border:1px solid rgba(0,0,0,.10); }
.menuHeader{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.menuTitle{
  font-weight:900;
  display:flex; align-items:center; gap:10px;
}
.chev{
  width:auto;
  padding:8px 10px;
  border-radius:12px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
}
.light .chev{ background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.10); }
.collapsed{ display:none; }
</style>
</head>

<body>

<div id="loading">
  <div>
    <div style="font-size:18px;font-weight:700">Carregando...</div>
    <div style="opacity:.8;margin-top:6px">Validando login</div>
  </div>
</div>

<!-- ‚úÖ TELA PRINCIPAL -->
<div id="screenMain" class="screen">
  <div class="wrap">
    <h1>
      Controle de Gastos PRO
      <span class="toggle" onclick="abrirConfig()">‚öôÔ∏è</span>
      <span class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
    </h1>

    <!-- ‚úÖ CONFIG + HIST√ìRICO -->
    <div id="configBox" class="card" style="display:none">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <b id="userName"></b>

      <div style="margin-top:10px" class="row">
        <button class="ghost" onclick="abrirHistorico()">üìÖ Hist√≥rico de meses</button>
        <button class="ghost mini" onclick="googleLogin()">Google</button>
      </div>

      <button style="margin-top:10px" onclick="logout()">Sair da conta</button>

      <div class="small" style="margin-top:8px;opacity:.8">
        Dica: se o popup n√£o abrir no celular, o login usa redirecionamento.
      </div>
    </div>

    <div class="card">
      <h3>üìÇ Minhas Categorias</h3>
      <div class="row">
        <input id="novaCategoria" placeholder="Nome da categoria">
        <button class="mini" onclick="addCategoria()">Adicionar</button>
      </div>
      <div id="listaCategorias" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>üìå Gastos Fixos (Prioridades)</h3>
      <input id="descFixo" placeholder="Descri√ß√£o (ex: Aluguel)">
      <input id="valorFixo" type="number" placeholder="Valor (ex: 750)">
      <select id="categoriaFixo"></select>
      <button onclick="addFixo()">Adicionar gasto fixo</button>
      <div id="listaFixos" class="small" style="margin-top:8px"></div>
      <div class="small" style="margin-top:6px;opacity:.75">
        Dica: o bot√£o ‚ùå remove o gasto fixo para n√£o entrar nos pr√≥ximos meses.
      </div>
    </div>

    <div class="card">
      <label>Sal√°rio</label>
      <input id="salary" type="number">
      <label>M√™s</label>
      <input id="month" type="month">
      <label>Meta</label>
      <input id="meta" type="number">
      <label>Anota√ß√µes do m√™s</label>
      <textarea id="notes" placeholder="Ex: meta de cortar delivery, juntar para reserva..."></textarea>

      <button onclick="saveSettings()">Salvar</button>
      <div class="small" style="margin-top:6px;opacity:.8">
        Ao salvar, sal√°rio/meta/anota√ß√µes ficam guardados no hist√≥rico do m√™s.
      </div>
    </div>

    <!-- ‚úÖ MENU (colapsa / expande) -->
    <div class="card menuCard">
      <div class="menuHeader">
        <div class="menuTitle">üìå Menu de Simuladores</div>
        <button class="chev" onclick="toggleMenuSim()"><span id="menuSimIcon">‚ñº</span></button>
      </div>
      <div class="small" style="margin-top:6px;opacity:.85">
        Abra para ver <b>Investimento</b> e <b>Empr√©stimo/Compra</b>.
      </div>
    </div>

    <!-- ‚úÖ CONTE√öDO DO MENU (fica escondido por padr√£o) -->
    <div id="menuSimConteudo" class="collapsed">

      <!-- ‚úÖ SIMULADOR INVESTIMENTOS -->
      <div class="card">
        <h3>üìà Simulador de Investimentos (Mais op√ß√µes)</h3>

        <label>Tipo de investimento</label>
        <select id="invTipo" onchange="atualizarCamposInvestimento()">
          <option value="poupanca">Poupan√ßa</option>
          <option value="tesouro_selic">Tesouro Selic</option>
          <option value="cdb">CDB (CDI %)</option>
          <option value="lci_lca">LCI/LCA (CDI % ‚Äî isento IR)</option>
          <option value="fundo_di">Fundo DI (CDI % - taxa adm)</option>
          <option value="prefixado">Prefixado (% ao ano)</option>
          <option value="ipca_plus">Tesouro IPCA+ (IPCA + taxa real)</option>
          <option value="renda_variavel">Renda Vari√°vel (m√©dia % ao ano)</option>
        </select>

        <label>Valor inicial (R$)</label>
        <input id="invInicial" type="number" placeholder="Ex: 1000">

        <label>Aporte mensal (R$) (opcional)</label>
        <input id="invAporte" type="number" placeholder="Ex: 200">

        <label>Tempo</label>
        <div class="row">
          <input id="invMeses" type="number" placeholder="Meses (ex: 24)">
          <input id="invDias" type="number" placeholder="Dias (opcional)">
        </div>

        <div id="boxCDI" style="margin-top:10px">
          <label>CDI (% ao ano)</label>
          <input id="invCDI" type="number" placeholder="Ex: 10.65">
          <label>Percentual do CDI (%)</label>
          <input id="invPercCDI" type="number" placeholder="Ex: 110">
        </div>

        <div id="boxPrefixado" style="display:none;margin-top:10px">
          <label>Taxa prefixada (% ao ano)</label>
          <input id="invPrefixado" type="number" placeholder="Ex: 12">
        </div>

        <div id="boxIPCA" style="display:none;margin-top:10px">
          <label>IPCA (% ao ano)</label>
          <input id="invIPCA" type="number" placeholder="Ex: 4.5">
          <label>Taxa real (% ao ano)</label>
          <input id="invReal" type="number" placeholder="Ex: 5.5">
        </div>

        <div id="boxFundo" style="display:none;margin-top:10px">
          <label>Taxa de administra√ß√£o (% ao ano)</label>
          <input id="invAdm" type="number" placeholder="Ex: 1.0">
        </div>

        <div id="boxRV" style="display:none;margin-top:10px">
          <label>Retorno m√©dio (% ao ano)</label>
          <input id="invRV" type="number" placeholder="Ex: 15">
        </div>

        <div style="margin-top:10px">
          <label>
            <input id="invAplicarIOF" type="checkbox" style="width:auto;transform:scale(1.1);margin-right:8px">
            Aplicar IOF (se resgatar antes de 30 dias) ‚Äî estimativa
          </label>
        </div>

        <button onclick="simularInvestimentos()">Calcular</button>

        <div id="resultadoInv" style="margin-top:10px;font-weight:bold"></div>
        <div id="detalhesInv" class="small" style="margin-top:8px"></div>
      </div>

      <!-- ‚úÖ SIMULADOR EMPR√âSTIMO/COMPRA -->
      <div class="card">
        <h3>üí≥ Simulador de Empr√©stimo / Compra</h3>

        <label>Tipo</label>
        <select id="empTipo">
          <option value="financiamento">Financiamento (Price)</option>
          <option value="juros_simples">Juros simples</option>
        </select>

        <label>Valor emprestado / valor da compra (R$)</label>
        <input id="empValor" type="number" placeholder="Ex: 5000">

        <label>Parcelas</label>
        <input id="empParcelas" type="number" placeholder="Ex: 12">

        <label>Juros ao m√™s (%)</label>
        <input id="empJuros" type="number" placeholder="Ex: 3">

        <div id="empCamposExtras" style="margin-top:10px">
          <label>Entrada (R$) (opcional)</label>
          <input id="empEntrada" type="number" placeholder="Ex: 1000">
          <label>Tarifa / taxa fixa (R$) (opcional)</label>
          <input id="empTarifa" type="number" placeholder="Ex: 50">
        </div>

        <button onclick="simularEmprestimo()">Calcular</button>

        <div id="resultadoEmp" style="margin-top:10px;font-weight:bold"></div>
        <div id="detalhesEmp" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>

        <div class="small" style="margin-top:8px;opacity:.8">
          Dica: o app compara a parcela com sua sobra atual (Sal√°rio - Gastos).
        </div>
      </div>

    </div>
    <!-- ‚úÖ FIM DO MENU -->

    <!-- ‚úÖ IA -->
    <div class="card" id="iaCard">
      <h3>ü§ñ IA (Ollama)</h3>

      <label>Pergunta</label>
      <input id="iaPrompt" placeholder="Ex: com meus gastos, onde devo investir este m√™s?">

      <button onclick="iaPerguntar()">Perguntar</button>

      <div id="iaResposta" class="small" style="margin-top:10px; white-space:pre-wrap;"></div>

      <div class="small" style="margin-top:8px; opacity:.8">
        Status: <span id="iaStatus">Aguardando...</span>
      </div>
      <div class="small" style="margin-top:6px;opacity:.75">
        A IA usa automaticamente seu sal√°rio, gastos, categorias e anota√ß√µes do m√™s para responder.
      </div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card"><canvas id="chart"></canvas></div>
    <div class="card"><h3>Evolu√ß√£o</h3><canvas id="chartEvolucao"></canvas></div>
    <div class="card"><table id="list"></table></div>
  </div>

  <div class="fab" onclick="abrirAdd()">+</div>
</div>

<!-- ‚úÖ TELA HIST√ìRICO (separada, com voltar) -->
<div id="screenHistory" class="screen">
  <div class="topbar">
    <div class="topbar-inner">
      <button class="iconbtn" onclick="voltarDaTelaHistorico()">‚Üê Voltar</button>
      <div class="topbar-title">üìÖ Hist√≥rico de meses</div>
      <button class="iconbtn" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
    </div>
  </div>

  <div class="wrap">
    <div class="histHeader">
      <div class="histHero">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <div style="font-weight:900;font-size:16px">Seu hist√≥rico financeiro</div>
            <div class="small" style="opacity:.85;margin-top:4px">
              Toque em <b>Abrir</b> para carregar um m√™s no app.
            </div>
          </div>
          <div class="badge">Controle de Gastos PRO</div>
        </div>
      </div>

      <div class="histGrid" id="listaMeses"></div>
    </div>
  </div>
</div>

<div id="debugBox"></div>

<script>
function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="./config.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

const API = "https://api-rf1w.onrender.com";
let auth = null;

window.USER_ID = null;
let state = { meses:{} };

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Outros"];
let regras = [
  {palavra:"aluguel", categoria:"Casa"},
  {palavra:"luz", categoria:"Casa"},
  {palavra:"agua", categoria:"Casa"},
  {palavra:"√°gua", categoria:"Casa"},
  {palavra:"mercado", categoria:"Alimenta√ß√£o"},
  {palavra:"padaria", categoria:"Alimenta√ß√£o"},
  {palavra:"gasolina", categoria:"Transporte"},
  {palavra:"uber", categoria:"Transporte"},
  {palavra:"ra√ß√£o", categoria:"Pets"},
  {palavra:"pet", categoria:"Pets"}
];

let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];
let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;
let graficoEvolucao = null;

/* =========================
   ‚úÖ MENU (colaps√°vel)
========================= */
window.toggleMenuSim = function(){
  const box = document.getElementById("menuSimConteudo");
  const icon = document.getElementById("menuSimIcon");
  const aberto = box && !box.classList.contains("collapsed");
  if(!box) return;
  if(aberto){
    box.classList.add("collapsed");
    if(icon) icon.textContent = "‚ñº";
  }else{
    box.classList.remove("collapsed");
    if(icon) icon.textContent = "‚ñ≤";
    // rola suavemente para o come√ßo do menu
    box.scrollIntoView({ behavior:"smooth", block:"start" });
  }
};

/* =========================
   ‚úÖ TELA / NAVEGA√á√ÉO
========================= */
function showLoading(){
  document.getElementById("screenMain").classList.remove("show");
  document.getElementById("screenHistory").classList.remove("show");
  document.getElementById("loading").style.display = "flex";
}
function hideLoading(){ document.getElementById("loading").style.display = "none"; }
function showMain(){
  hideLoading();
  document.getElementById("screenHistory").classList.remove("show");
  document.getElementById("screenMain").classList.add("show");
}
function showHistory(){
  hideLoading();
  document.getElementById("screenMain").classList.remove("show");
  document.getElementById("screenHistory").classList.add("show");
}

window.abrirHistorico = function(){
  renderListaMeses();
  showHistory();
};
window.voltarDaTelaHistorico = function(){ showMain(); };

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou (sem internet ou bloqueio).");
    return false;
  }
  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
  }catch(e){}
  auth = firebase.auth();
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }catch(e){
    dbg("Persist√™ncia:\n" + (e.code||"") + " - " + (e.message||e));
  }
  return true;
}

window.logout = function(){
  if(!auth) return;
  auth.signOut()
    .then(()=> location.replace("./login.html"))
    .catch(e=>alert((e.code||"")+" - "+e.message));
};

window.googleLogin = async function(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });
    await auth.signInWithRedirect(provider);
  }catch(e){
    alert((e.code||"")+" - "+e.message);
  }
};

function salvarCategorias(){ localStorage.setItem("categorias_" + window.USER_ID, JSON.stringify(categorias)); }
function carregarCategorias(){
  const raw = localStorage.getItem("categorias_" + window.USER_ID);
  categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
  if(!Array.isArray(categorias) || !categorias.length) categorias = [...DEFAULT_CATEGORIAS];
}
function salvarFixos(){ localStorage.setItem("fixos_" + window.USER_ID, JSON.stringify(fixos)); }
function carregarFixos(){
  const raw = localStorage.getItem("fixos_" + window.USER_ID);
  fixos = raw ? JSON.parse(raw) : [];
  if(!Array.isArray(fixos)) fixos = [];
  fixos = fixos.map(f=>({ ...f, isFixo:true }));
}

window.toggleTheme = ()=> document.body.classList.toggle("light");
window.abrirConfig = ()=>{
  const box = document.getElementById("configBox");
  box.style.display = box.style.display==="none" ? "block" : "none";
};

window.getMes = ()=>{
  const el = document.getElementById("month");
  const v = el && el.value ? el.value : new Date().toISOString().slice(0,7);
  return v;
};

function keyItem(i){ return `${(i.desc||"").toLowerCase()}|${Number(i.amount||0)}|${(i.category||"Outros").toLowerCase()}|${i.isFixo?1:0}`; }
function garantirFixosNoMes(d){
  const set = new Set((d.items||[]).map(keyItem));
  for(const f of fixos){
    const obj = { ...f, isFixo:true };
    const k = keyItem(obj);
    if(!set.has(k)){ d.items.unshift(obj); set.add(k); }
  }
}

window.getDataMes = ()=>{
  if(!state.meses[mesAtual]){
    state.meses[mesAtual] = {
      salary: 0,
      items: fixos.map(f=>({ ...f, isFixo:true })),
      meta: 0,
      notes: ""
    };
  }else{
    garantirFixosNoMes(state.meses[mesAtual]);
    if(typeof state.meses[mesAtual].notes !== "string") state.meses[mesAtual].notes = "";
  }
  return state.meses[mesAtual];
};

function detectarCategoria(desc){
  const txt=(desc||"").toLowerCase();
  for(const r of regras){ if(txt.includes(r.palavra)) return r.categoria; }
  return "Outros";
}

window.addCategoria = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const input=document.getElementById("novaCategoria");
  const nome=(input.value||"").trim();
  if(!nome) return;
  if(categorias.some(c=>c.toLowerCase()===nome.toLowerCase())){ alert("Essa categoria j√° existe."); return; }
  categorias.push(nome); input.value="";
  salvarCategorias(); renderCategorias();
};

function renderCategorias(){
  document.getElementById("listaCategorias").innerHTML = categorias.map(c=>`<div>‚Ä¢ ${c}</div>`).join("");
  document.getElementById("categoriaFixo").innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");
}

window.addFixo = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const desc=(document.getElementById("descFixo").value||"").trim();
  const valor=Number(document.getElementById("valorFixo").value);
  const categoria=document.getElementById("categoriaFixo").value||"Outros";
  if(!desc || !valor || valor<=0){ alert("Preencha descri√ß√£o e valor (maior que 0)."); return; }

  fixos.push({ desc, amount:valor, category:categoria, isFixo:true });
  document.getElementById("descFixo").value="";
  document.getElementById("valorFixo").value="";

  salvarFixos(); renderFixos();
  garantirFixosNoMes(window.getDataMes());
  salvarTudoLocal();
  window.render();
};

window.removerFixo = function(idx){
  if(idx<0 || idx>=fixos.length) return;
  if(!confirm("Remover este gasto fixo? (ele n√£o vai entrar nos pr√≥ximos meses)")) return;

  const alvo = fixos[idx];
  fixos.splice(idx, 1);
  salvarFixos();
  renderFixos();

  const d = window.getDataMes();
  d.items = (d.items||[]).filter(it => !(it.isFixo && keyItem(it) === keyItem(alvo)));
  salvarTudoLocal();
  window.render();
};

function renderFixos(){
  const div=document.getElementById("listaFixos");
  if(!fixos.length){
    div.innerHTML = "<div>Nenhum gasto fixo cadastrado.</div>";
    return;
  }
  div.innerHTML = fixos.map((f,idx)=>`
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div style="flex:1">
        ‚Ä¢ ${f.desc} ‚Äî R$ ${Number(f.amount).toFixed(2)}
        <span class="badge">${f.category}</span>
      </div>
      <button class="mini danger" onclick="removerFixo(${idx})">‚ùå</button>
    </div>
  `).join("");
}

window.abrirAdd = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  mesAtual = window.getMes();
  const d = window.getDataMes();
  const desc = prompt("Descri√ß√£o");
  const valor = parseFloat(prompt("Valor"));
  if(!desc || isNaN(valor)) return;
  const categoria = detectarCategoria(desc);
  d.items.push({ desc, amount:valor, category:categoria, isFixo:false });

  fetch(API+"/addGasto",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId:window.USER_ID,mes:mesAtual,desc,amount:valor,category:categoria})
  }).catch(()=>{});

  salvarTudoLocal();
  window.render();
};

window.del = (i)=>{
  mesAtual=window.getMes();
  const d=window.getDataMes();
  const item = d.items[i];
  if(!item) return;

  if(item.isFixo){
    const k = keyItem(item);
    fixos = fixos.filter(f => keyItem(f) !== k);
    salvarFixos();
    renderFixos();
  }

  d.items.splice(i,1);
  salvarTudoLocal();
  window.render();
};

window.saveSettings = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  mesAtual=window.getMes();
  const d=window.getDataMes();
  d.salary=Number(document.getElementById("salary").value);
  d.meta=Number(document.getElementById("meta").value);
  d.notes=String(document.getElementById("notes").value || "");

  salvarTudoLocal();

  fetch(API+"/salvarMes",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId:window.USER_ID,mes:mesAtual,salary:d.salary,meta:d.meta,notes:d.notes})
  }).catch(()=>{});

  window.render();
};

function salvarTudoLocal(){ localStorage.setItem("gastos_pro", JSON.stringify(state)); }

function drawChart(items){
  const mapa={}; items.forEach(i=>{ const cat=i.category||"Outros"; mapa[cat]=(mapa[cat]||0)+Number(i.amount||0); });
  const labels=Object.keys(mapa), valores=Object.values(mapa);
  if(grafico) grafico.destroy();
  grafico=new Chart(document.getElementById("chart"),{type:"doughnut",data:{labels,datasets:[{data:valores}]}} );
}
function drawEvolucao(){
  const meses=Object.keys(state.meses).sort();
  const valores=meses.map(m=>(state.meses[m].items||[]).reduce((a,b)=>a+Number(b.amount||0),0));
  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao=new Chart(document.getElementById("chartEvolucao"),{type:"line",data:{labels:meses,datasets:[{data:valores}]}} );
}
function paint(){
  const d=window.getDataMes();

  document.getElementById("salary").value=Number(d.salary||0);
  document.getElementById("month").value=mesAtual;
  document.getElementById("meta").value=d.meta||"";
  document.getElementById("notes").value = d.notes || "";

  const total=(d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const sobra=Number(d.salary||0)-total;

  document.getElementById("kpis").innerHTML=`
    <div class="kpi">Sal√°rio<br><b>R$ ${Number(d.salary||0).toFixed(2)}</b></div>
    <div class="kpi">Gasto<br><b>R$ ${total.toFixed(2)}</b></div>
    <div class="kpi">Sobra<br><b>R$ ${sobra.toFixed(2)}</b></div>
    <div class="success">Voc√™ economizou R$ ${sobra.toFixed(2)}</div>
  `;

  document.getElementById("list").innerHTML=(d.items||[]).map((i,idx)=>`
    <tr>
      <td>
        ${i.desc}
        ${i.isFixo?` <span class="badge">Fixo</span>`:""}
        <span class="badge">${i.category||"Outros"}</span>
      </td>
      <td>R$ ${Number(i.amount||0).toFixed(2)}</td>
      <td><button onclick="del(${idx})">X</button></td>
    </tr>
  `).join("");

  drawChart(d.items||[]);
  drawEvolucao();
}

/* =========================
   ‚úÖ HIST√ìRICO
========================= */
function formatBRL(n){ return "R$ " + Number(n||0).toFixed(2).replace(".", ","); }
function renderListaMeses(){
  const el = document.getElementById("listaMeses");
  const meses = Object.keys(state.meses||{}).sort().reverse();
  if(!meses.length){
    el.innerHTML = `<div class="card"><div class="small">Nenhum m√™s salvo ainda.</div></div>`;
    return;
  }
  el.innerHTML = meses.map(m=>{
    const d = state.meses[m] || {};
    const total = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
    const sal = Number(d.salary||0);
    const sobra = sal - total;
    const isAtual = (m === mesAtual);
    const tag = isAtual ? `<span class="badge">Atual</span>` : ``;
    const corSobra = sobra >= 0 ? "var(--ok)" : "var(--danger)";
    return `
      <div class="histItem">
        <div class="histLeft">
          <div class="histMonth">${m} ${tag}</div>
          <div class="small histMeta">${(d.notes||"").trim() ? (d.notes||"").trim().slice(0,90) + ((d.notes||"").trim().length>90?"‚Ä¶":"") : "Sem anota√ß√µes."}</div>
          <div class="histNums">
            <span class="pill">üí∞ <b>${formatBRL(sal)}</b></span>
            <span class="pill">üßæ <b>${formatBRL(total)}</b></span>
            <span class="pill">‚úÖ <b style="color:${corSobra}">${formatBRL(sobra)}</b></span>
          </div>
        </div>
        <button class="histBtn" onclick="abrirMesDoHistorico('${m}')">Abrir</button>
      </div>
    `;
  }).join("");
}
window.abrirMesDoHistorico = function(m){
  const monthEl = document.getElementById("month");
  if(monthEl) monthEl.value = m;
  mesAtual = m;
  window.render();
  showMain();
  const box = document.getElementById("configBox");
  if(box) box.style.display = "none";
};

window.render = ()=>{
  if(!window.USER_ID) return;
  mesAtual = window.getMes();
  const d = window.getDataMes();
  paint();

  fetch(API+"/mes/"+window.USER_ID+"/"+mesAtual)
    .then(r=>r.json())
    .then(data=>{
      const apiItems = Array.isArray(data)
        ? data.filter(x=>x && x.desc).map(x=>({desc:x.desc,amount:Number(x.amount||0),category:x.category||detectarCategoria(x.desc),isFixo:false}))
        : [];

      if(Array.isArray(data) && data.length){
        d.salary = Number(data[0].salary||d.salary||0);
        d.meta   = Number(data[0].meta||d.meta||0);
        if(typeof data[0].notes === "string") d.notes = data[0].notes;
      }

      const merged=[], seen=new Set();
      for(const f of fixos){
        const obj={...f,isFixo:true};
        const k=keyItem(obj);
        if(!seen.has(k)){merged.push(obj); seen.add(k);}
      }
      for(const it of apiItems){
        const k=keyItem(it);
        if(!seen.has(k)){merged.push(it); seen.add(k);}
      }
      d.items = merged;

      salvarTudoLocal();
      paint();
      if(document.getElementById("screenHistory").classList.contains("show")) renderListaMeses();
    })
    .catch(()=>{
      salvarTudoLocal();
      paint();
      if(document.getElementById("screenHistory").classList.contains("show")) renderListaMeses();
    });
};

/* ==========================================================
   ‚úÖ SIMULADOR INVESTIMENTOS
========================================================== */
function clampNum(v, def=0){ v = Number(v); return Number.isFinite(v) ? v : def; }
function anualParaMensalEfetivo(taxaAnual){ const r = taxaAnual/100; return Math.pow(1+r, 1/12) - 1; }
function aliquotaIR(dias){
  if(dias <= 180) return 0.225;
  if(dias <= 360) return 0.20;
  if(dias <= 720) return 0.175;
  return 0.15;
}
function iofAprox(dias){
  if(dias >= 30) return 0;
  if(dias <= 0) return 0.96;
  return (30 - dias) / 30 * 0.96;
}
function simularComAporte(inicial, aporteMensal, meses, taxaMensal){
  let saldo = inicial;
  for(let m=1; m<=meses; m++){
    saldo = saldo * (1 + taxaMensal) + aporteMensal;
  }
  const investido = inicial + aporteMensal * meses;
  const lucroBruto = saldo - investido;
  return { final: saldo, investido, lucroBruto };
}
function atualizarCamposInvestimento(){
  const tipo = document.getElementById("invTipo").value;
  const boxCDI = document.getElementById("boxCDI");
  const boxPrefixado = document.getElementById("boxPrefixado");
  const boxIPCA = document.getElementById("boxIPCA");
  const boxFundo = document.getElementById("boxFundo");
  const boxRV = document.getElementById("boxRV");

  boxCDI.style.display = "none";
  boxPrefixado.style.display = "none";
  boxIPCA.style.display = "none";
  boxFundo.style.display = "none";
  boxRV.style.display = "none";

  if(tipo === "poupanca" || tipo === "tesouro_selic" || tipo === "cdb" || tipo === "lci_lca" || tipo === "fundo_di"){
    boxCDI.style.display = "block";
  }
  if(tipo === "prefixado"){ boxPrefixado.style.display = "block"; }
  if(tipo === "ipca_plus"){ boxIPCA.style.display = "block"; }
  if(tipo === "fundo_di"){ boxFundo.style.display = "block"; }
  if(tipo === "renda_variavel"){ boxRV.style.display = "block"; }
}
window.simularInvestimentos = function(){
  const tipo = document.getElementById("invTipo").value;

  const inicial = Math.max(0, clampNum(document.getElementById("invInicial").value, 0));
  const aporte  = Math.max(0, clampNum(document.getElementById("invAporte").value, 0));
  let meses     = Math.max(0, Math.floor(clampNum(document.getElementById("invMeses").value, 0)));
  let diasExtra = Math.max(0, Math.floor(clampNum(document.getElementById("invDias").value, 0)));

  if(meses === 0 && diasExtra > 0){
    meses = Math.floor(diasExtra / 30);
    diasExtra = diasExtra % 30;
  }

  const diasTotais = meses*30 + diasExtra;
  const aplicarIOF = !!document.getElementById("invAplicarIOF").checked;

  const out = document.getElementById("resultadoInv");
  const det = document.getElementById("detalhesInv");

  if(inicial <= 0 && aporte <= 0){
    out.textContent = "Informe um valor inicial ou um aporte mensal.";
    det.textContent = "";
    return;
  }
  if(meses <= 0 && diasExtra <= 0){
    out.textContent = "Informe o tempo (meses ou dias).";
    det.textContent = "";
    return;
  }

  let taxaMensal = 0;
  let textoTaxa = "";

  if(tipo === "poupanca"){
    const cdi = clampNum(document.getElementById("invCDI").value, 10.5);
    const anual = cdi * 0.70;
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `Poupan√ßa (aprox. 70% do CDI): ~${anual.toFixed(2)}% a.a.`;
  }

  if(tipo === "tesouro_selic"){
    const cdi = clampNum(document.getElementById("invCDI").value, 10.5);
    taxaMensal = anualParaMensalEfetivo(cdi);
    textoTaxa = `Tesouro Selic (aprox CDI): ${cdi.toFixed(2)}% a.a.`;
  }

  if(tipo === "cdb" || tipo === "lci_lca" || tipo === "fundo_di"){
    const cdi = clampNum(document.getElementById("invCDI").value, 10.5);
    const perc = clampNum(document.getElementById("invPercCDI").value, 100);
    let anual = cdi * (perc/100);

    if(tipo === "fundo_di"){
      const adm = clampNum(document.getElementById("invAdm").value, 1.0);
      anual = Math.max(0, anual - adm);
      textoTaxa = `Fundo DI: CDI ${cdi.toFixed(2)}% * ${perc.toFixed(0)}% - adm ${adm.toFixed(2)}% ‚âà ${anual.toFixed(2)}% a.a.`;
    }else if(tipo === "lci_lca"){
      textoTaxa = `LCI/LCA: CDI ${cdi.toFixed(2)}% * ${perc.toFixed(0)}% ‚âà ${anual.toFixed(2)}% a.a. (isento IR)`;
    }else{
      textoTaxa = `CDB: CDI ${cdi.toFixed(2)}% * ${perc.toFixed(0)}% ‚âà ${anual.toFixed(2)}% a.a.`;
    }

    taxaMensal = anualParaMensalEfetivo(anual);
  }

  if(tipo === "prefixado"){
    const anual = clampNum(document.getElementById("invPrefixado").value, 12);
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `Prefixado: ${anual.toFixed(2)}% a.a.`;
  }

  if(tipo === "ipca_plus"){
    const ipca = clampNum(document.getElementById("invIPCA").value, 4.5);
    const real = clampNum(document.getElementById("invReal").value, 5.5);
    const anual = ( (1+ipca/100) * (1+real/100) - 1 ) * 100;
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `IPCA+ (aprox): IPCA ${ipca.toFixed(2)}% + real ${real.toFixed(2)}% ‚âà ${anual.toFixed(2)}% a.a.`;
  }

  if(tipo === "renda_variavel"){
    const anual = clampNum(document.getElementById("invRV").value, 15);
    taxaMensal = anualParaMensalEfetivo(anual);
    textoTaxa = `Renda vari√°vel (m√©dia): ${anual.toFixed(2)}% a.a.`;
  }

  const res = simularComAporte(inicial, aporte, meses, taxaMensal);

  let final = res.final;
  if(diasExtra > 0){
    final = final * (1 + taxaMensal * (diasExtra/30));
  }

  const investido = inicial + aporte * meses;
  let lucroBruto = final - investido;

  let imposto = 0;
  let iof = 0;

  const temIR = (tipo === "cdb" || tipo === "tesouro_selic" || tipo === "fundo_di" || tipo === "prefixado" || tipo === "ipca_plus");
  const isentoIR = (tipo === "lci_lca" || tipo === "poupanca" || tipo === "renda_variavel");

  if(temIR){
    const aliq = aliquotaIR(diasTotais);
    imposto = Math.max(0, lucroBruto) * aliq;
  }else if(!isentoIR && tipo === "renda_variavel"){
    imposto = 0;
  }

  if(aplicarIOF){
    const fator = iofAprox(diasTotais);
    iof = Math.max(0, lucroBruto) * fator;
  }

  const lucroLiquido = lucroBruto - imposto - iof;

  out.textContent = `Final: ${formatBRL(final)} ‚Ä¢ Lucro l√≠quido: ${formatBRL(lucroLiquido)}`;
  det.textContent =
    `${textoTaxa}\n` +
    `Investido: ${formatBRL(investido)}\n` +
    `Lucro bruto: ${formatBRL(lucroBruto)}\n` +
    `IR (estimado): ${formatBRL(imposto)}\n` +
    `IOF (estimado): ${formatBRL(iof)}\n` +
    `Per√≠odo: ~${diasTotais} dias`;
};

/* ==========================================================
   ‚úÖ SIMULADOR EMPR√âSTIMO / COMPRA
========================================================== */
function empCalcPrice(valor, jurosMensal, n){
  if(n <= 0) return 0;
  if(jurosMensal <= 0) return valor / n;
  const i = jurosMensal;
  return valor * ( i / (1 - Math.pow(1+i, -n)) );
}
function empCalcJurosSimples(valor, jurosMensal, n){
  if(n <= 0) return { total: 0, parcela: 0 };
  const total = valor * (1 + jurosMensal * n);
  return { total, parcela: total / n };
}
function empFormat(n){ return "R$ " + Number(n||0).toFixed(2).replace(".", ","); }

window.simularEmprestimo = function(){
  const tipo = document.getElementById("empTipo").value;

  const valorBruto = Math.max(0, clampNum(document.getElementById("empValor").value, 0));
  const entrada = Math.max(0, clampNum(document.getElementById("empEntrada").value, 0));
  const tarifa = Math.max(0, clampNum(document.getElementById("empTarifa").value, 0));
  const parcelas = Math.max(1, Math.floor(clampNum(document.getElementById("empParcelas").value, 0)));
  const juros = Math.max(0, clampNum(document.getElementById("empJuros").value, 0)) / 100;

  const out = document.getElementById("resultadoEmp");
  const det = document.getElementById("detalhesEmp");

  if(valorBruto <= 0){
    out.textContent = "Informe o valor.";
    det.textContent = "";
    return;
  }
  if(parcelas <= 0){
    out.textContent = "Informe as parcelas.";
    det.textContent = "";
    return;
  }

  const pv = Math.max(0, valorBruto - entrada) + tarifa;

  let parcela = 0;
  let total = 0;
  let jurosTotal = 0;

  if(tipo === "financiamento"){
    parcela = empCalcPrice(pv, juros, parcelas);
    total = parcela * parcelas;
    jurosTotal = total - pv;
  }else{
    const r = empCalcJurosSimples(pv, juros, parcelas);
    parcela = r.parcela;
    total = r.total;
    jurosTotal = total - pv;
  }

  const d = window.getDataMes();
  const gastos = (d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const salario = Number(d.salary||0);
  const sobra = salario - gastos;
  const sobraPosParcela = sobra - parcela;

  let sinal = "üü°";
  let msg = "Cuidado";
  if(sobraPosParcela >= salario*0.3){ sinal = "üü¢"; msg = "D√° pra pagar com folga"; }
  else if(sobraPosParcela > 0){ sinal = "üü°"; msg = "D√° pra pagar, mas aperta"; }
  else { sinal = "üî¥"; msg = "N√£o recomendado (fica negativo)"; }

  out.textContent = `${sinal} Parcela: ${empFormat(parcela)} ‚Ä¢ Total: ${empFormat(total)}`;

  det.textContent =
`Tipo: ${tipo === "financiamento" ? "Financiamento (Price)" : "Juros simples"}
Valor informado: ${empFormat(valorBruto)}
Entrada: ${empFormat(entrada)}
Tarifa/taxa fixa: ${empFormat(tarifa)}
Valor financiado (PV): ${empFormat(pv)}
Juros a.m.: ${(juros*100).toFixed(2)}%
Parcelas: ${parcelas}
Juros pagos (estimado): ${empFormat(jurosTotal)}

Sobra atual (Sal√°rio - Gastos): ${empFormat(sobra)}
Sobra ap√≥s parcela: ${empFormat(sobraPosParcela)}
An√°lise: ${msg}`;
};

/* ==========================================================
   ‚úÖ IA (Ollama)
========================================================== */
function getIaBase(){ return (window.API_BASE_URL || "").replace(/\/$/, ""); }
function resumoDoMesParaIA(){
  const d = window.getDataMes();
  const items = d.items || [];
  const total = items.reduce((a,b)=>a+Number(b.amount||0),0);
  const sobra = Number(d.salary||0) - total;

  const porCat = {};
  for(const it of items){
    const c = it.category || "Outros";
    porCat[c] = (porCat[c] || 0) + Number(it.amount||0);
  }

  const topCats = Object.entries(porCat)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,6)
    .map(([c,v])=>`${c}: R$ ${v.toFixed(2)}`)
    .join(", ");

  const fixosTotal = items.filter(x=>x.isFixo).reduce((a,b)=>a+Number(b.amount||0),0);

  return `
M√äS: ${mesAtual}
SAL√ÅRIO: R$ ${Number(d.salary||0).toFixed(2)}
META: R$ ${Number(d.meta||0).toFixed(2)}
GASTO TOTAL: R$ ${total.toFixed(2)}
GASTO FIXO TOTAL: R$ ${fixosTotal.toFixed(2)}
SOBRA: R$ ${sobra.toFixed(2)}
TOP CATEGORIAS: ${topCats || "sem dados"}
ANOTA√á√ïES: ${(d.notes||"").trim() || "(vazio)"}
  `.trim();
}
async function iaHealth(){
  try{
    const base = getIaBase();
    if(!base) throw new Error("API_BASE_URL n√£o definido no config.js");
    const r = await fetch(base + "/");
    const j = await r.json();
    const el = document.getElementById("iaStatus");
    if(el) el.textContent = (j && j.message) ? j.message : "Online ‚úÖ";
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    const el = document.getElementById("iaStatus");
    if(el) el.textContent = "Offline: " + msg;
  }
}
window.iaPerguntar = async function(){
  const promptEl = document.getElementById("iaPrompt");
  const outEl = document.getElementById("iaResposta");
  const statusEl = document.getElementById("iaStatus");

  const pergunta = (promptEl.value || "").trim();
  if(!pergunta){
    outEl.textContent = "Digite uma pergunta.";
    return;
  }

  try{
    outEl.textContent = "Pensando...";
    if(statusEl) statusEl.textContent = "Consultando IA...";

    const base = getIaBase();
    if(!base) throw new Error("API_BASE_URL n√£o definido no config.js");

    const url = base + "/api/chat";
    const contexto = resumoDoMesParaIA();

    const promptFinal =
`Voc√™ √© um consultor financeiro pessoal. Use os dados abaixo para responder de forma pr√°tica.
- Se eu perguntar sobre investimento, sugira 1 a 3 op√ß√µes coerentes com minha SOBRA e perfil conservador por padr√£o.
- Se a SOBRA estiver negativa, explique como ajustar gastos antes de investir.
- Responda em portugu√™s, direto, com passos.

DADOS DO USU√ÅRIO:
${contexto}

PERGUNTA:
${pergunta}
`;

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama3.2:3b",
        prompt: promptFinal
      })
    });

    const data = await resp.json();
    outEl.textContent = data.response || JSON.stringify(data, null, 2);
    if(statusEl) statusEl.textContent = "Online ‚úÖ";
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    outEl.textContent = "Erro: " + msg;
    if(statusEl) statusEl.textContent = "Erro ‚ùå";
  }
};

/* =========================
   ‚úÖ INIT
========================= */
document.addEventListener("DOMContentLoaded", async ()=>{
  showLoading();

  const ok = await initFirebase();
  if(!ok) return;

  const monthEl = document.getElementById("month");
  if(monthEl && !monthEl.value){
    monthEl.value = new Date().toISOString().slice(0,7);
  }

  atualizarCamposInvestimento();

  document.getElementById("month").addEventListener("change", ()=>{
    mesAtual = window.getMes();
    window.render();
  });

  try{ await auth.getRedirectResult(); }catch(e){}

  const unsub = auth.onAuthStateChanged(async (user)=>{
    unsub && unsub();

    if(!user){
      location.replace("./login.html");
      return;
    }

    window.USER_ID = user.uid;
    document.getElementById("userName").innerText = user.displayName || user.email;

    carregarCategorias();
    carregarFixos();
    renderCategorias();
    renderFixos();

    try{
      const raw = localStorage.getItem("gastos_pro");
      if(raw) state = JSON.parse(raw) || { meses:{} };
    }catch(e){ state = { meses:{} }; }

    mesAtual = window.getMes();

    showMain();
    window.render();
    iaHealth();
  });
});
</script>

</body>
</html>
