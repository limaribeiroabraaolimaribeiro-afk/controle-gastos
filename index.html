<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<style>
:root{ --bg:#0b1020; --card:#ffffff0f; --text:#eaf0ff; --accent:#569cff; }
.light{ --bg:#f4f6ff; --card:#ffffff; --text:#111; }
body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui; }
.wrap{max-width:980px;margin:auto;padding:16px}
.card{ background:var(--card); border-radius:12px; padding:14px; margin-bottom:12px; }
h1{font-size:20px;margin:0 0 10px}
input,select,button{ width:100%; padding:10px; border-radius:10px; border:none; margin-top:5px; }
button{ background:var(--accent); color:#fff; cursor:pointer; touch-action:manipulation; }
.kpis{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.kpi{ background:var(--card); padding:10px; border-radius:10px; }
.success{color:#4CAF50}
#chart,#chartEvolucao{width:100%;height:220px}
.fab{ position:fixed; bottom:20px; right:20px; background:#4CAF50; color:white; border-radius:50%; width:55px; height:55px; font-size:28px; display:flex; align-items:center; justify-content:center; }
.toggle{float:right;cursor:pointer; margin-left:10px;}
.small{opacity:.8;font-size:12px}
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); margin-left:6px; font-size:12px; }
.light .badge{background:rgba(0,0,0,.08);}
.row{ display:flex; gap:8px; align-items:center; }
.row > * {flex:1}
.row .mini {flex:0 0 auto; width:auto; padding:8px 10px; border-radius:10px;}

#debugBox{
  position:fixed; left:12px; right:12px; bottom:12px;
  background:rgba(0,0,0,.75); color:#fff; padding:10px; border-radius:12px;
  font-size:12px; z-index:9999; display:none; white-space:pre-wrap;
}

/* ‚úÖ tela simples de carregamento */
#loading{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  text-align:center;
  padding:24px;
  opacity:.9;
}
</style>
</head>

<body>

<div id="loading">
  <div>
    <div style="font-size:18px;font-weight:700">Carregando...</div>
    <div style="opacity:.8;margin-top:6px">Validando login</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="wrap">
    <h1>
      Controle de Gastos PRO
      <span class="toggle" onclick="abrirConfig()">‚öôÔ∏è</span>
      <span class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
    </h1>

    <div id="configBox" class="card" style="display:none">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <b id="userName"></b><br><br>
      <button onclick="logout()">Sair da conta</button>
    </div>

    <div class="card">
      <h3>üìÇ Minhas Categorias</h3>
      <div class="row">
        <input id="novaCategoria" placeholder="Nome da categoria">
        <button class="mini" onclick="addCategoria()">Adicionar</button>
      </div>
      <div id="listaCategorias" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>üìå Gastos Fixos (Prioridades)</h3>
      <input id="descFixo" placeholder="Descri√ß√£o (ex: Aluguel)">
      <input id="valorFixo" type="number" placeholder="Valor (ex: 750)">
      <select id="categoriaFixo"></select>
      <button onclick="addFixo()">Adicionar gasto fixo</button>
      <div id="listaFixos" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <label>Sal√°rio</label>
      <input id="salary" type="number">
      <label>M√™s</label>
      <input id="month" type="month">
      <label>Meta</label>
      <input id="meta" type="number">
      <button onclick="saveSettings()">Salvar</button>
    </div>

    <!-- ‚úÖ SIMULADOR NOVO (ADICIONADO) -->
    <div class="card">
      <h3>üß† Simulador de Investimentos (Completo)</h3>

      <label>Tipo de investimento</label>
      <select id="invTipo">
        <option value="poupanca">Poupan√ßa</option>
        <option value="tesouro_selic">Tesouro Selic</option>
        <option value="cdb">CDB (CDI %)</option>
        <option value="lci_lca">LCI/LCA (CDI % ‚Äî isento IR)</option>
        <option value="fundo_di">Fundo DI (CDI % - taxa adm)</option>
        <option value="prefixado">Prefixado (% ao ano)</option>
        <option value="ipca_plus">Tesouro IPCA+ (IPCA + taxa real)</option>
        <option value="renda_variavel">Renda Vari√°vel (m√©dia % ao ano)</option>
      </select>

      <label>Valor inicial (R$)</label>
      <input id="invInicial" type="number" placeholder="Ex: 1000">

      <label>Aporte mensal (R$) (opcional)</label>
      <input id="invAporte" type="number" placeholder="Ex: 200">

      <label>Tempo</label>
      <div class="row">
        <input id="invMeses" type="number" placeholder="Meses (ex: 24)">
        <input id="invDias" type="number" placeholder="Dias (opcional)">
      </div>

      <div id="boxCDI" style="margin-top:10px">
        <label>CDI (% ao ano)</label>
        <input id="invCDI" type="number" placeholder="Ex: 10.65">
        <label>Percentual do CDI (%)</label>
        <input id="invPercCDI" type="number" placeholder="Ex: 110">
      </div>

      <div id="boxPrefixado" style="display:none;margin-top:10px">
        <label>Taxa prefixada (% ao ano)</label>
        <input id="invPrefixado" type="number" placeholder="Ex: 12">
      </div>

      <div id="boxIPCA" style="display:none;margin-top:10px">
        <label>IPCA (% ao ano)</label>
        <input id="invIPCA" type="number" placeholder="Ex: 4.5">
        <label>Taxa real (% ao ano)</label>
        <input id="invReal" type="number" placeholder="Ex: 5.5">
      </div>

      <div id="boxFundo" style="display:none;margin-top:10px">
        <label>Taxa de administra√ß√£o (% ao ano)</label>
        <input id="invAdm" type="number" placeholder="Ex: 1.0">
      </div>

      <div id="boxRV" style="display:none;margin-top:10px">
        <label>Retorno m√©dio (% ao ano)</label>
        <input id="invRV" type="number" placeholder="Ex: 15">
      </div>

      <div style="margin-top:10px">
        <label>
          <input id="invAplicarIOF" type="checkbox" style="width:auto;transform:scale(1.1);margin-right:8px">
          Aplicar IOF (se resgatar antes de 30 dias)
        </label>
      </div>

      <button onclick="simularInvestimentos()">Calcular</button>

      <div id="resultadoSimulacao" style="margin-top:10px;font-weight:bold"></div>
      <div id="detalhesSimulacao" class="small" style="margin-top:8px"></div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card"><canvas id="chart"></canvas></div>
    <div class="card"><h3>Evolu√ß√£o</h3><canvas id="chartEvolucao"></canvas></div>
    <div class="card"><table id="list"></table></div>
  </div>

  <div class="fab" onclick="abrirAdd()">+</div>
</div>

<div id="debugBox"></div>

<script>
function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}
window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

const API = "https://api-rf1w.onrender.com";
let auth = null;

window.USER_ID = null;
let state = { meses:{} };

const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Outros"];
let regras = [
  {palavra:"aluguel", categoria:"Casa"},
  {palavra:"luz", categoria:"Casa"},
  {palavra:"agua", categoria:"Casa"},
  {palavra:"√°gua", categoria:"Casa"},
  {palavra:"mercado", categoria:"Alimenta√ß√£o"},
  {palavra:"padaria", categoria:"Alimenta√ß√£o"},
  {palavra:"gasolina", categoria:"Transporte"},
  {palavra:"uber", categoria:"Transporte"},
  {palavra:"ra√ß√£o", categoria:"Pets"},
  {palavra:"pet", categoria:"Pets"}
];

let categorias = [...DEFAULT_CATEGORIAS];
let fixos = [];
let mesAtual = new Date().toISOString().slice(0,7);
let grafico = null;
let graficoEvolucao = null;

function showApp(){
  document.getElementById("loading").style.display = "none";
  document.getElementById("app").style.display = "block";
}
function showLoading(){
  document.getElementById("app").style.display = "none";
  document.getElementById("loading").style.display = "flex";
}

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase n√£o carregou (sem internet ou bloqueio).");
    return false;
  }

  if(!firebase.apps || !firebase.apps.length){
    firebase.initializeApp(FIREBASE_CONFIG);
  }

  auth = firebase.auth();

  // ‚úÖ aguarda persist√™ncia antes de validar estado
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }catch(e){
    dbg("Persist√™ncia:\n" + (e.code||"") + " - " + (e.message||e));
  }

  return true;
}

window.logout = function(){
  if(!auth) return;
  auth.signOut()
    .then(()=> location.replace("./login.html"))
    .catch(e=>alert((e.code||"")+" - "+e.message));
};

function salvarCategorias(){ localStorage.setItem("categorias_" + window.USER_ID, JSON.stringify(categorias)); }
function carregarCategorias(){
  const raw = localStorage.getItem("categorias_" + window.USER_ID);
  categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
  if(!Array.isArray(categorias) || !categorias.length) categorias = [...DEFAULT_CATEGORIAS];
}
function salvarFixos(){ localStorage.setItem("fixos_" + window.USER_ID, JSON.stringify(fixos)); }
function carregarFixos(){
  const raw = localStorage.getItem("fixos_" + window.USER_ID);
  fixos = raw ? JSON.parse(raw) : [];
  if(!Array.isArray(fixos)) fixos = [];
  fixos = fixos.map(f=>({ ...f, isFixo:true }));
}

window.toggleTheme = ()=> document.body.classList.toggle("light");
window.abrirConfig = ()=>{
  const box = document.getElementById("configBox");
  box.style.display = box.style.display==="none" ? "block" : "none";
};
window.getMes = ()=> (document.getElementById("month").value || new Date().toISOString().slice(0,7));

function keyItem(i){ return ${(i.desc||"").toLowerCase()}|${Number(i.amount||0)}|${(i.category||"Outros").toLowerCase()}|${i.isFixo?1:0}; }
function garantirFixosNoMes(d){
  const set = new Set((d.items||[]).map(keyItem));
  for(const f of fixos){
    const obj = { ...f, isFixo:true };
    const k = keyItem(obj);
    if(!set.has(k)){ d.items.unshift(obj); set.add(k); }
  }
}
window.getDataMes = ()=>{
  if(!state.meses[mesAtual]){
    state.meses[mesAtual]={ salary:0, items:fixos.map(f=>({ ...f, isFixo:true })), meta:0 };
  }else{
    garantirFixosNoMes(state.meses[mesAtual]);
  }
  return state.meses[mesAtual];
};
function detectarCategoria(desc){
  const txt=(desc||"").toLowerCase();
  for(const r of regras){ if(txt.includes(r.palavra)) return r.categoria; }
  return "Outros";
}

window.addCategoria = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const input=document.getElementById("novaCategoria");
  const nome=(input.value||"").trim();
  if(!nome) return;
  if(categorias.some(c=>c.toLowerCase()===nome.toLowerCase())){ alert("Essa categoria j√° existe."); return; }
  categorias.push(nome); input.value="";
  salvarCategorias(); renderCategorias();
};
function renderCategorias(){
  document.getElementById("listaCategorias").innerHTML = categorias.map(c=><div>‚Ä¢ ${c}</div>).join("");
  document.getElementById("categoriaFixo").innerHTML = categorias.map(c=><option value="${c}">${c}</option>).join("");
}

window.addFixo = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  const desc=(document.getElementById("descFixo").value||"").trim();
  const valor=Number(document.getElementById("valorFixo").value);
  const categoria=document.getElementById("categoriaFixo").value||"Outros";
  if(!desc || !valor || valor<=0){ alert("Preencha descri√ß√£o e valor (maior que 0)."); return; }
  fixos.push({ desc, amount:valor, category:categoria, isFixo:true });
  document.getElementById("descFixo").value="";
  document.getElementById("valorFixo").value="";
  salvarFixos(); renderFixos();
  garantirFixosNoMes(window.getDataMes());
  window.render();
};
function renderFixos(){
  const div=document.getElementById("listaFixos");
  div.innerHTML = fixos.length
    ? fixos.map(f=><div>‚Ä¢ ${f.desc} ‚Äî R$ ${Number(f.amount).toFixed(2)} <span class="badge">${f.category}</span></div>).join("")
    : "<div>Nenhum gasto fixo cadastrado.</div>";
}

window.abrirAdd = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  mesAtual = window.getMes();
  const d = window.getDataMes();
  const desc = prompt("Descri√ß√£o");
  const valor = parseFloat(prompt("Valor"));
  if(!desc || isNaN(valor)) return;
  const categoria = detectarCategoria(desc);
  d.items.push({ desc, amount:valor, category:categoria, isFixo:false });
  fetch(API+"/addGasto",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:window.USER_ID,mes:mesAtual,desc,amount:valor,category:categoria})}).catch(()=>{});
  window.render();
};
window.del = (i)=>{
  mesAtual=window.getMes();
  const d=window.getDataMes();
  d.items.splice(i,1);
  window.render();
};
window.saveSettings = ()=>{
  if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }
  mesAtual=window.getMes();
  const d=window.getDataMes();
  d.salary=Number(document.getElementById("salary").value);
  d.meta=Number(document.getElementById("meta").value);
  fetch(API+"/salvarMes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:window.USER_ID,mes:mesAtual,salary:d.salary,meta:d.meta})}).catch(()=>{});
  window.render();
};

function drawChart(items){
  const mapa={}; items.forEach(i=>{ const cat=i.category||"Outros"; mapa[cat]=(mapa[cat]||0)+Number(i.amount||0); });
  const labels=Object.keys(mapa), valores=Object.values(mapa);
  if(grafico) grafico.destroy();
  grafico=new Chart(document.getElementById("chart"),{type:"doughnut",data:{labels,datasets:[{data:valores}]}} );
}
function drawEvolucao(){
  const meses=Object.keys(state.meses).sort();
  const valores=meses.map(m=>(state.meses[m].items||[]).reduce((a,b)=>a+Number(b.amount||0),0));
  if(graficoEvolucao) graficoEvolucao.destroy();
  graficoEvolucao=new Chart(document.getElementById("chartEvolucao"),{type:"line",data:{labels:meses,datasets:[{data:valores}]}} );
}
function paint(){
  const d=window.getDataMes();
  document.getElementById("salary").value=Number(d.salary||0);
  document.getElementById("month").value=mesAtual;
  document.getElementById("meta").value=d.meta||"";
  const total=(d.items||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const sobra=Number(d.salary||0)-total;

  document.getElementById("kpis").innerHTML=`
    <div class="kpi">Sal√°rio<br><b>R$ ${Number(d.salary||0).toFixed(2)}</b></div>
    <div class="kpi">Gasto<br><b>R$ ${total.toFixed(2)}</b></div>
    <div class="kpi">Sobra<br><b>R$ ${sobra.toFixed(2)}</b></div>
    <div class="success">Voc√™ economizou R$ ${sobra.toFixed(2)}</div>
  `;
  document.getElementById("list").innerHTML=(d.items||[]).map((i,idx)=>`
    <tr>
      <td>${i.desc}${i.isFixo?` <span class="badge">Fixo</span>`:""} <span class="badge">${i.category||"Outros"}</span></td>
      <td>R$ ${Number(i.amount||0).toFixed(2)}</td>
      <td><button onclick="del(${idx})">X</button></td>
    </tr>
  `).join("");

  drawChart(d.items||[]);
  drawEvolucao();
}
window.render = ()=>{
  if(!window.USER_ID) return;
  mesAtual=window.getMes();
  const d=window.getDataMes();
  paint();

  fetch(API+"/mes/"+window.USER_ID+"/"+mesAtual)
    .then(r=>r.json())
    .then(data=>{
      const apiItems = Array.isArray(data)
        ? data.filter(x=>x && x.desc).map(x=>({desc:x.desc,amount:Number(x.amount||0),category:x.category||detectarCategoria(x.desc),isFixo:false}))
        : [];
      if(Array.isArray(data) && data.length){
        d.salary=Number(data[0].salary||d.salary||0);
        d.meta=Number(data[0].meta||d.meta||0);
      }
      const merged=[], seen=new Set();
      for(const f of fixos){ const obj={...f,isFixo:true}; const k=keyItem(obj); if(!seen.has(k)){merged.push(obj); seen.add(k);} }
      for(const it of apiItems){ const k=keyItem(it); if(!seen.has(k)){merged.push(it); seen.add(k);} }
      d.items=merged;
      localStorage.setItem("gastos_pro", JSON.stringify(state));
      paint();
    })
    .catch(()=>paint());
};




/* ==========================================================
   ‚úÖ SIMULADOR NOVO (COMPLETO) ‚Äî ADICIONADO
========================================================== */
function clampNum(v, def=0){
  v = Number(v);
  return Number.isFinite(v) ? v : def;
}
function formatBRL(n){
  return "R$ " + Number(n||0).toFixed(2).replace(".", ",");
}
function anualParaMensalEfetivo(taxaAnual){
  const r = taxaAnual/100;
  return Math.pow(1+r, 1/12) - 1;
}
function aliquotaIR(dias){
  if(dias <= 180) return 0.225;
  if(dias <= 360) return 0.20;
  if(dias <= 720) return 0.175;
  return 0.15;
}
function iofAprox(dias){
  if(dias >= 30) return 0;
  if(dias <= 0) return 0.96;
  return (30 - dias) / 30 * 0.96;
}
function simularComAporte(inicial, aporteMensal, meses, taxaMensal){
  let saldo = inicial;
  for(let m=1; m<=meses; m++){
    saldo = saldo * (1 + taxaMensal) + aporteMensal;
  }
  const investido = inicial + aporteMensal * meses;
  const lucroBruto = saldo - investido;
  return { final: saldo, investido, lucroBruto };
}

window.simularInvestimentos = function(){
  const tipo = document.getElementById("invTipo").value;

  const inicial = Math.max(0, clampNum(document.getElementById("invInicial").value, 0));
  const aporte = Math.max(0, clampNum(document.getElementById("invAporte").value, 0));

  let meses = Math.max(0, Math.floor(clampNum(document.getElementById("invMeses").value, 0)));
  let diasExtra = Math.max(0, Math.floor(clampNum(document.getElementById("invDias").value, 0)));

  if(meses === 0 && diasExtra > 0){
    meses = Math.floor(diasExtra / 30);
    diasExtra = diasExtra % 30;
  }

  const diasTotais = meses*30 + diasExtra;
  const aplicarIOF = !!document.getElementById("invAplicarIOF").checked;

  const out = document.getElementById("resultadoSimulacao");
  const det = document.getElementById("detalhesSimulacao");

  if(inicial <= 0 && aporte <= 0){
    out.innerHTML = "Informe um valor inicial ou um aporte mensal.";
    det.innerHTML = "";
    return;
  }
  if(meses <= 0){
    out.innerHTML = "Informe pelo menos 1 m√™s.";
    det.innerHTML = "";
    return;
  }

  const cdiAnual = Math.max(0, clampNum(document.getElementById("invCDI")?.value, 0));
  const percCDI = Math.max(0, clampNum(document.getElementById("invPercCDI")?.value, 100));
  const taxaPrefixadoAnual = Math.max(0, clampNum(document.getElementById("invPrefixado")?.value, 0));
  const ipcaAnual = Math.max(0, clampNum(document.getElementById("invIPCA")?.value, 0));
  const taxaRealAnual = clampNum(document.getElementById("invReal")?.value, 0);
  const taxaAdm = Math.max(0, clampNum(document.getElementById("invAdm")?.value, 0));
  const rvAnual = clampNum(document.getElementById("invRV")?.value, 0);

  let taxaMensal = 0;
  let isRendaFixaTributavel = false;
  let isIsentoIR = false;

  if(tipo === "poupanca"){
    if(cdiAnual > 0){
      const aproxAnual = cdiAnual * 0.70;
      taxaMensal = anualParaMensalEfetivo(aproxAnual);
    }else{
      taxaMensal = 0.005;
    }
    isIsentoIR = true;
  }

  if(tipo === "tesouro_selic"){
    const base = (cdiAnual > 0 ? cdiAnual : 10);
    taxaMensal = anualParaMensalEfetivo(base);
    isRendaFixaTributavel = true;
  }

  if(tipo === "cdb"){
    const base = (cdiAnual > 0 ? cdiAnual : 10);
    const efetiva = base * (percCDI/100);
    taxaMensal = anualParaMensalEfetivo(efetiva);
    isRendaFixaTributavel = true;
  }

  if(tipo === "lci_lca"){
    const base = (cdiAnual > 0 ? cdiAnual : 10);
    const efetiva = base * (percCDI/100);
    taxaMensal = anualParaMensalEfetivo(efetiva);
    isIsentoIR = true;
  }

  if(tipo === "fundo_di"){
    const base = (cdiAnual > 0 ? cdiAnual : 10);
    const efetiva = base * (percCDI/100);
    const efetivaLiquida = Math.max(0, efetiva - taxaAdm);
    taxaMensal = anualParaMensalEfetivo(efetivaLiquida);
    isRendaFixaTributavel = true;
  }

  if(tipo === "prefixado"){
    const base = (taxaPrefixadoAnual > 0 ? taxaPrefixadoAnual : 10);
    taxaMensal = anualParaMensalEfetivo(base);
    isRendaFixaTributavel = true;
  }

  if(tipo === "ipca_plus"){
    const ip = ipcaAnual/100;
    const rr = taxaRealAnual/100;
    const anual = (1+ip)*(1+rr)-1;
    taxaMensal = Math.pow(1+anual, 1/12)-1;
    isRendaFixaTributavel = true;
  }

  if(tipo === "renda_variavel"){
    taxaMensal = anualParaMensalEfetivo(rvAnual);
    isRendaFixaTributavel = false;
  }

  const sim = simularComAporte(inicial, aporte, meses, taxaMensal);

  let lucroLiquido = sim.lucroBruto;
  let impostosTxt = "";

  if(isRendaFixaTributavel){
    const aliq = aliquotaIR(diasTotais);
    let ir = Math.max(0, sim.lucroBruto) * aliq;

    let iof = 0;
    if(aplicarIOF && diasTotais < 30){
      iof = Math.max(0, sim.lucroBruto) * iofAprox(diasTotais);
    }

    lucroLiquido = sim.lucroBruto - ir - iof;

    impostosTxt =
      IR aprox (${(aliq*100).toFixed(1)}%): ${formatBRL(ir)}
      + (iof > 0 ? <br>IOF aprox: ${formatBRL(iof)} : "");
  }else if(isIsentoIR){
    impostosTxt = "Isento de IR (aprox).";
  }else{
    impostosTxt = "Sem IR calculado (depende do tipo/realiza√ß√£o do lucro).";
  }

  const finalLiquido = sim.investido + lucroLiquido;

  out.innerHTML =
    Valor final (aprox): <b>${formatBRL(finalLiquido)}</b><br> +
    Total investido: <b>${formatBRL(sim.investido)}</b><br> +
    Lucro (aprox): <b>${formatBRL(lucroLiquido)}</b>;

  det.innerHTML =
    Taxa mensal usada: ${(taxaMensal*100).toFixed(3)}%<br> +
    Prazo: ${meses} m√™s(es) (${diasTotais} dias aprox)<br> +
    ${impostosTxt};
};

// ‚úÖ mant√©m compatibilidade: se algum lugar ainda chamar simularCompleto(), ele funciona.
window.simularCompleto = function(){
  window.simularInvestimentos();
};

function updateInvestBoxes(){
  const sel = document.getElementById("invTipo");
  if(!sel) return;

  const t = sel.value;
  const boxCDI = document.getElementById("boxCDI");
  const boxPrefix = document.getElementById("boxPrefixado");
  const boxIPCA = document.getElementById("boxIPCA");
  const boxFundo = document.getElementById("boxFundo");
  const boxRV = document.getElementById("boxRV");

  boxCDI.style.display = "none";
  boxPrefix.style.display = "none";
  boxIPCA.style.display = "none";
  boxFundo.style.display = "none";
  boxRV.style.display = "none";

  if(t === "poupanca" || t === "tesouro_selic" || t === "cdb" || t === "lci_lca" || t === "fundo_di"){
    boxCDI.style.display = "block";
  }
  if(t === "prefixado"){
    boxPrefix.style.display = "block";
  }
  if(t === "ipca_plus"){
    boxIPCA.style.display = "block";
  }
  if(t === "fundo_di"){
    boxFundo.style.display = "block";
  }
  if(t === "renda_variavel"){
    boxRV.style.display = "block";
  }
}

/* ===========================
   ‚úÖ INIT
=========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  showLoading();

  const ok = await initFirebase();
  if(!ok) return;

  // ‚úÖ listeners antigos (se existir elemento)
  const tipoSim = document.getElementById("tipoSimulacao");
  if(tipoSim){
    tipoSim.addEventListener("change", function(){
      const a = document.getElementById("areaCompra");
      const b = document.getElementById("areaInvestimento");
      if(a) a.style.display = this.value==="compra" ? "block" : "none";
      if(b) b.style.display = this.value==="investimento" ? "block" : "none";
    });
  }

  const month = document.getElementById("month");
  if(month){
    month.addEventListener("change", ()=>{
      mesAtual = window.getMes();
      window.render();
    });
  }

  // ‚úÖ init do simulador novo
  const invTipo = document.getElementById("invTipo");
  if(invTipo){
    invTipo.addEventListener("change", updateInvestBoxes);
    updateInvestBoxes();
  }

  // ‚úÖ anti-loop: espera estado REAL do Firebase
  auth.onAuthStateChanged(async (user)=>{
    if(!user){
      await new Promise(r=>setTimeout(r, 1000));
      user = auth.currentUser;
    }

    if(!user){
      location.replace("./login.html");
      return;
    }

    window.USER_ID = user.uid;
    document.getElementById("userName").innerText = user.displayName || user.email;

    carregarCategorias();
    carregarFixos();
    renderCategorias();
    renderFixos();

    try{
      const raw = localStorage.getItem("gastos_pro");
      if(raw) state = JSON.parse(raw) || { meses:{} };
    }catch(e){ state = { meses:{} }; }

    mesAtual = window.getMes();
    showApp();
    window.render();
  });
});
</script>

</body>
</html>
