<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle de Gastos PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#569cff">

<style>
:root{
  --bg:#0b1020;
  --card:#ffffff0f;
  --text:#eaf0ff;
  --accent:#569cff;
}
.light{
  --bg:#f4f6ff;
  --card:#ffffff;
  --text:#111;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
}
h1{font-size:20px;margin:0 0 10px}
input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:5px;
}
button{
  background:var(--accent);
  color:#fff;
  cursor:pointer;
}
.kpis{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}
.kpi{
  background:var(--card);
  padding:10px;
  border-radius:10px;
}
.success{color:#4CAF50}
.warn{color:#ffd166}
.danger{color:#ff6b6b}
#chart,#chartEvolucao{width:100%;height:220px}
.fab{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#4CAF50;
  color:white;
  border-radius:50%;
  width:55px;
  height:55px;
  font-size:28px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.toggle{float:right;cursor:pointer}
.small{opacity:.8;font-size:12px}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  margin-left:6px;
  font-size:12px;
}
.light .badge{background:rgba(0,0,0,.08);}
.row{
  display:flex;
  gap:8px;
  align-items:center;
}
.row > * {flex:1}
.row .mini {flex:0 0 auto; width:auto; padding:8px 10px; border-radius:10px;}
</style>
</head>

<body>

<div id="loginScreen" style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center">
  <h2>Controle de Gastos PRO</h2>

  <input id="email" type="email" placeholder="Seu e-mail">
  <input id="senha" type="password" placeholder="Sua senha">

  <button onclick="loginEmail()">Entrar com Email</button>
  <button onclick="registrarEmail()">Criar conta</button>

  <hr style="margin:10px 0;width:80%">

  <button onclick="loginGoogle()">Entrar com Google</button>
</div>

<div id="app" style="display:none">
  <div class="wrap">

    <h1>
      Controle de Gastos PRO
      <span class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
      <span class="toggle" onclick="abrirConfig()">‚öôÔ∏è</span>
    </h1>

    <!-- ‚öôÔ∏è CONFIGURA√á√ïES -->
    <div id="configBox" class="card" style="display:none">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <b id="userName"></b>
      <br><br>
      <button onclick="logout()">Sair da conta</button>
    </div>

    <!-- üìÇ CATEGORIAS -->
    <div class="card">
      <h3>üìÇ Minhas Categorias</h3>

      <div class="row">
        <input id="novaCategoria" placeholder="Nome da categoria">
        <button class="mini" onclick="addCategoria()">Adicionar</button>
      </div>

      <div id="listaCategorias" class="small" style="margin-top:8px"></div>
    </div>

    <!-- üìå FIXOS -->
    <div class="card">
      <h3>üìå Gastos Fixos (Prioridades)</h3>

      <input id="descFixo" placeholder="Descri√ß√£o (ex: Aluguel)">
      <input id="valorFixo" type="number" placeholder="Valor (ex: 750)">
      <select id="categoriaFixo"></select>

      <button onclick="addFixo()">Adicionar gasto fixo</button>

      <div id="listaFixos" class="small" style="margin-top:8px"></div>
    </div>

    <!-- SAL√ÅRIO / M√äS / META -->
    <div class="card">
      <label>Sal√°rio</label>
      <input id="salary" type="number">

      <label>M√™s</label>
      <input id="month" type="month">

      <label>Meta</label>
      <input id="meta" type="number">

      <button onclick="saveSettings()">Salvar</button>
    </div>

    <!-- üß† SIMULADOR COMPLETO -->
    <div class="card">
      <h3>üß† Simulador Financeiro</h3>

      <label>Tipo</label>
      <select id="tipoSimulacao">
        <option value="compra">Compra / Empr√©stimo</option>
        <option value="investimento">Investimento</option>
      </select>

      <div id="areaCompra">
        <label>Valor total</label>
        <input id="valorSimulacao" type="number">

        <label>Parcelas</label>
        <input id="parcelasSimulacao" type="number">

        <label>Juros mensal (%)</label>
        <input id="jurosSimulacao" type="number">
      </div>

      <div id="areaInvestimento" style="display:none">
        <label>Valor a investir</label>
        <input id="valorInvestimento" type="number">

        <label>Meses</label>
        <input id="mesesInvestimento" type="number">

        <label>% do CDI</label>
        <input id="percentualInvest" type="number">
      </div>

      <button onclick="simularCompleto()">Calcular</button>

      <div id="resultadoSimulacao" style="margin-top:10px;font-weight:bold"></div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card">
      <canvas id="chart"></canvas>
    </div>

    <div class="card">
      <h3>Evolu√ß√£o</h3>
      <canvas id="chartEvolucao"></canvas>
    </div>

    <div class="card">
      <table id="list"></table>
    </div>

  </div>

  <div class="fab" onclick="abrirAdd()">+</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
/**
 * ‚úÖ VERS√ÉO COMPLETA CORRIGIDA
 * - Sem vari√°veis duplicadas (seu bug principal)
 * - Categorias do usu√°rio + fixos do usu√°rio salvos por USER_ID no localStorage
 * - Fixos aparecem em TODO m√™s automaticamente
 * - Gr√°fico por CATEGORIA
 * - Lista mostra categoria + marca FIXO
 */

window.addEventListener("DOMContentLoaded", ()=>{

  // ====== CONFIG ======
  const API = "https://api-rf1w.onrender.com";

  firebase.initializeApp({
    apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
    authDomain:"controle-gastos-pro.firebaseapp.com",
    projectId:"controle-gastos-pro"
  });

  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  // ====== STATE ======
  window.USER_ID = null;

  let state = { meses:{} };

  const DEFAULT_CATEGORIAS = ["Casa","Alimenta√ß√£o","Transporte","Lazer","Pets","Outros"];

  // üëâ regras autom√°ticas (pode editar depois)
  let regras = [
    {palavra:"aluguel", categoria:"Casa"},
    {palavra:"luz", categoria:"Casa"},
    {palavra:"√°gua", categoria:"Casa"},
    {palavra:"mercado", categoria:"Alimenta√ß√£o"},
    {palavra:"padaria", categoria:"Alimenta√ß√£o"},
    {palavra:"gasolina", categoria:"Transporte"},
    {palavra:"uber", categoria:"Transporte"},
    {palavra:"ra√ß√£o", categoria:"Pets"},
    {palavra:"pet", categoria:"Pets"}
  ];

  let categorias = [...DEFAULT_CATEGORIAS]; // ‚úÖ s√≥ 1 vez
  let fixos = []; // {desc, amount, category, isFixo:true}

  let mesAtual = new Date().toISOString().slice(0,7);
  let grafico = null;
  let graficoEvolucao = null;

  // ====== ELEMENTOS ======
  const monthInput = document.getElementById("month");
  const salaryInput = document.getElementById("salary");
  const metaInput = document.getElementById("meta");

  // ====== STORAGE (por usu√°rio) ======
  function salvarCategorias(){
    localStorage.setItem("categorias_" + window.USER_ID, JSON.stringify(categorias));
  }
  function carregarCategorias(){
    const raw = localStorage.getItem("categorias_" + window.USER_ID);
    categorias = raw ? JSON.parse(raw) : [...DEFAULT_CATEGORIAS];
    if(!Array.isArray(categorias) || categorias.length === 0) categorias = [...DEFAULT_CATEGORIAS];
  }
  function salvarFixos(){
    localStorage.setItem("fixos_" + window.USER_ID, JSON.stringify(fixos));
  }
  function carregarFixos(){
    const raw = localStorage.getItem("fixos_" + window.USER_ID);
    fixos = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(fixos)) fixos = [];
    // garantir marca
    fixos = fixos.map(f=>({ ...f, isFixo:true }));
  }

  // ====== UI HELPERS ======
  window.toggleTheme = ()=> document.body.classList.toggle("light");

  window.abrirConfig = ()=>{
    let box = document.getElementById("configBox");
    box.style.display = box.style.display=="none" ? "block" : "none";
  };

  window.getMes = ()=> monthInput.value || new Date().toISOString().slice(0,7);

  monthInput.addEventListener("change", ()=>{
    mesAtual = getMes();
    render();
  });

  document.getElementById("tipoSimulacao").addEventListener("change", function(){
    if(this.value==="compra"){
      areaCompra.style.display="block";
      areaInvestimento.style.display="none";
    }else{
      areaCompra.style.display="none";
      areaInvestimento.style.display="block";
    }
  });

  // ====== L√ìGICA DE M√äS ======
  function keyItem(i){
    // chave simples pra evitar duplicar fixos no mesmo m√™s
    return `${(i.desc||"").toLowerCase()}|${Number(i.amount||0)}|${(i.category||"Outros").toLowerCase()}|${i.isFixo?1:0}`;
  }

  window.getDataMes = ()=>{
    if(!state.meses[mesAtual]){
      // ‚úÖ todo m√™s nasce com os fixos
      state.meses[mesAtual] = {
        salary: 0,
        items: fixos.map(f=>({ ...f })), // c√≥pia
        meta: 0
      };
    }else{
      // ‚úÖ se j√° existe m√™s, garante que os fixos est√£o l√° (sem duplicar)
      const d = state.meses[mesAtual];
      const set = new Set(d.items.map(keyItem));
      for(const f of fixos){
        const k = keyItem(f);
        if(!set.has(k)){
          d.items.unshift({ ...f });
          set.add(k);
        }
      }
    }
    return state.meses[mesAtual];
  };

  // ====== CATEGORIAS ======
  window.addCategoria = ()=>{
    if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

    let nome = (document.getElementById("novaCategoria").value || "").trim();
    if(!nome) return;

    // evita duplicar (case-insensitive)
    const exists = categorias.some(c => c.toLowerCase() === nome.toLowerCase());
    if(exists){ alert("Essa categoria j√° existe."); return; }

    categorias.push(nome);
    document.getElementById("novaCategoria").value = "";
    salvarCategorias();
    renderCategorias();
  };

  function renderCategorias(){
    const div = document.getElementById("listaCategorias");
    const select = document.getElementById("categoriaFixo");

    div.innerHTML = categorias.map(c=>`<div>‚Ä¢ ${c}</div>`).join("");

    select.innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");
  }

  // ====== FIXOS ======
  window.addFixo = ()=>{
    if(!window.USER_ID){ alert("Fa√ßa login primeiro"); return; }

    let desc = (document.getElementById("descFixo").value || "").trim();
    let valor = Number(document.getElementById("valorFixo").value);
    let categoria = document.getElementById("categoriaFixo").value || "Outros";

    if(!desc || !valor || valor <= 0){
      alert("Preencha descri√ß√£o e valor (maior que 0).");
      return;
    }

    fixos.push({ desc, amount: valor, category: categoria, isFixo:true });

    document.getElementById("descFixo").value = "";
    document.getElementById("valorFixo").value = "";

    salvarFixos();
    renderFixos();

    // ‚úÖ aplica no m√™s atual tamb√©m imediatamente
    getDataMes();
    render();
  };

  function renderFixos(){
    const div = document.getElementById("listaFixos");
    if(fixos.length === 0){
      div.innerHTML = "<div>Nenhum gasto fixo cadastrado.</div>";
      return;
    }
    div.innerHTML = fixos.map(f=>`
      <div>‚Ä¢ ${f.desc} ‚Äî R$ ${Number(f.amount).toFixed(2)} <span class="badge">${f.category}</span></div>
    `).join("");
  }

  // ====== DETEC√á√ÉO AUTOM√ÅTICA ======
  function detectarCategoria(desc){
    const txt = (desc||"").toLowerCase();
    for(const r of regras){
      if(txt.includes(r.palavra)) return r.categoria;
    }
    return "Outros";
  }

  // ====== CRUD GASTOS ======
  window.abrirAdd = ()=>{
    if(!window.USER_ID){
      alert("Fa√ßa login primeiro");
      return;
    }

    mesAtual = getMes();
    const d = getDataMes();

    const desc = prompt("Descri√ß√£o");
    const valor = parseFloat(prompt("Valor"));
    if(!desc || isNaN(valor)) return;

    const categoria = detectarCategoria(desc);

    d.items.push({ desc, amount: valor, category: categoria, isFixo:false });

    // envia para API (salva s√≥ os gastos normais; fixos ficam no localStorage do usu√°rio)
    fetch(API + "/addGasto", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        userId: window.USER_ID,
        mes: mesAtual,
        desc: desc,
        amount: valor,
        category: categoria
      })
    }).catch(()=>{});

    render();
  };

  window.del = (i)=>{
    mesAtual = getMes();
    const d = getDataMes();
    d.items.splice(i,1);
    render();
  };

  // ====== SETTINGS ======
  window.saveSettings = ()=>{
    if(!window.USER_ID){
      alert("Fa√ßa login primeiro");
      return;
    }

    mesAtual = getMes();
    const d = getDataMes();

    d.salary = Number(salaryInput.value);
    d.meta = Number(metaInput.value);

    fetch(API + "/salvarMes", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        userId: window.USER_ID,
        mes: mesAtual,
        salary: d.salary,
        meta: d.meta
      })
    }).catch(()=>{});

    render();
  };

  // ====== GR√ÅFICOS ======
  function drawChart(items){
    // ‚úÖ gr√°fico por categoria
    const mapa = {};
    items.forEach(i=>{
      const cat = i.category || "Outros";
      mapa[cat] = (mapa[cat] || 0) + Number(i.amount||0);
    });

    const labels = Object.keys(mapa);
    const valores = Object.values(mapa);

    if(grafico) grafico.destroy();
    grafico = new Chart(document.getElementById("chart"),{
      type:"doughnut",
      data:{ labels, datasets:[{ data: valores }] }
    });
  }

  function drawEvolucao(){
    const meses = Object.keys(state.meses).sort();
    const valores = meses.map(m=>{
      const it = state.meses[m].items || [];
      return it.reduce((a,b)=>a+Number(b.amount||0),0);
    });

    if(graficoEvolucao) graficoEvolucao.destroy();
    graficoEvolucao = new Chart(document.getElementById("chartEvolucao"),{
      type:"line",
      data:{ labels: meses, datasets:[{ data: valores }] }
    });
  }

  // ====== SIMULADOR ======
  window.simularCompleto = function(){
    const tipo = document.getElementById("tipoSimulacao").value;

    const d = getDataMes();
    const gastos = d.items.reduce((a,b)=>a+Number(b.amount||0),0);
    const salario = Number(d.salary||0);

    if(tipo==="compra"){
      let valor = Number(valorSimulacao.value);
      let parcelas = Number(parcelasSimulacao.value);
      let juros = Number(jurosSimulacao.value)/100;

      let i = juros;
      let n = parcelas;

      let parcela = valor * ( i / (1 - Math.pow(1+i, -n)) );
      let total = parcela * n;
      let jurosTotal = total - valor;

      parcela = Number(parcela.toFixed(2));
      total = Number(total.toFixed(2));
      jurosTotal = Number(jurosTotal.toFixed(2));

      let sobra = salario - gastos - parcela;

      let resultado = sobra>salario*0.3 ? "üü¢ Vale a pena" : sobra>0 ? "üü° Cuidado" : "üî¥ N√£o recomendado";

      resultadoSimulacao.innerHTML = `
        Parcela real: R$ ${parcela.toFixed(2)}<br>
        Total pago: R$ ${total.toFixed(2)}<br>
        Juros pagos: R$ ${jurosTotal.toFixed(2)}<br>
        Sobra ap√≥s pagar: R$ ${sobra.toFixed(2)}<br><br>
        ${resultado}
      `;
    }else{
      let valor = Number(valorInvestimento.value);
      let meses = Number(mesesInvestimento.value);
      let perc = Number(percentualInvest.value)/100;

      let taxaCDI = 0.012; // exemplo

      let total = valor*(1+(taxaCDI*perc))**meses;
      let lucro = total-valor;

      resultadoSimulacao.innerHTML = `
        Valor final: R$ ${total.toFixed(2)}<br>
        Lucro: R$ ${lucro.toFixed(2)}
      `;
    }
  };

  // ====== RENDER ======
  window.render = ()=>{
    if(!window.USER_ID) return;

    mesAtual = getMes();
    const d = getDataMes();

    // 1) puxa gastos do m√™s na API (gastos normais)
    fetch(API + "/mes/" + window.USER_ID + "/" + mesAtual)
      .then(r=>r.json())
      .then(data=>{
        // data pode vir vazio
        const apiItems = Array.isArray(data)
          ? data.filter(x=>x && x.desc).map(x=>({
              desc: x.desc,
              amount: Number(x.amount||0),
              category: x.category || detectarCategoria(x.desc),
              isFixo: false
            }))
          : [];

        // 2) aplica salary/meta da API se existir
        if(Array.isArray(data) && data.length){
          d.salary = Number(data[0].salary || d.salary || 0);
          d.meta = Number(data[0].meta || d.meta || 0);
        }

        // 3) mistura fixos + apiItems (sem duplicar fixos)
        const merged = [];
        const seen = new Set();

        // primeiro fixos
        for(const f of fixos){
          const obj = { ...f, isFixo:true };
          const k = keyItem(obj);
          if(!seen.has(k)){
            merged.push(obj);
            seen.add(k);
          }
        }
        // depois api
        for(const it of apiItems){
          const k = keyItem(it);
          if(!seen.has(k)){
            merged.push(it);
            seen.add(k);
          }
        }

        d.items = merged;

        // salva estado local do app
        localStorage.setItem("gastos_pro", JSON.stringify(state));

        // atualiza UI depois de carregar
        paint();
      })
      .catch(()=>{
        // se API falhar, pelo menos mostra o que tem local (fixos)
        paint();
      });

    // pinta r√°pido com o que j√° tem (e depois paint() roda de novo ao terminar fetch)
    paint();
  };

  function paint(){
    const d = getDataMes();

    salaryInput.value = Number(d.salary||0);
    monthInput.value = mesAtual;
    metaInput.value = d.meta || "";

    const total = d.items.reduce((a,b)=>a+Number(b.amount||0),0);
    const sobra = Number(d.salary||0) - total;

    kpis.innerHTML = `
      <div class="kpi">Sal√°rio<br><b>R$ ${Number(d.salary||0).toFixed(2)}</b></div>
      <div class="kpi">Gasto<br><b>R$ ${total.toFixed(2)}</b></div>
      <div class="kpi">Sobra<br><b>R$ ${sobra.toFixed(2)}</b></div>
      <div class="success">Voc√™ economizou R$ ${sobra.toFixed(2)}</div>
    `;

    // lista
    list.innerHTML = d.items.map((i,idx)=>`
      <tr>
        <td>
          ${i.desc}
          ${i.isFixo ? `<span class="badge">Fixo</span>` : ``}
          <span class="badge">${i.category || "Outros"}</span>
        </td>
        <td>R$ ${Number(i.amount||0).toFixed(2)}</td>
        <td><button onclick="del(${idx})">X</button></td>
      </tr>
    `).join("");

    drawChart(d.items);
    drawEvolucao();
  }

  // ====== AUTH ======
  window.loginGoogle = ()=> auth.signInWithPopup(provider).catch(e=>alert(e.message));
  window.logout = ()=> auth.signOut();

  window.loginEmail = ()=>{
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value.trim();

    if(!email || !senha){ alert("Preencha email e senha"); return; }
    if(!email.includes("@")){ alert("Digite um email v√°lido"); return; }

    auth.signInWithEmailAndPassword(email, senha).catch(e=>alert(e.message));
  };

  window.registrarEmail = ()=>{
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value.trim();

    if(!email || !senha){ alert("Preencha email e senha"); return; }
    if(!email.includes("@")){ alert("Digite um email v√°lido"); return; }
    if(senha.length < 6){ alert("A senha deve ter pelo menos 6 caracteres"); return; }

    auth.createUserWithEmailAndPassword(email, senha)
      .then(()=>alert("Conta criada com sucesso!"))
      .catch(e=>alert(e.message));
  };

  auth.onAuthStateChanged(user=>{
    window.USER_ID
