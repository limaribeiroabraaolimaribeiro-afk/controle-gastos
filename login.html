<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Login - Controle de Gastos PRO</title>

<meta name="theme-color" content="#569cff">

<style>
:root{
  --bg1:#0b1020;
  --bg2:#0a1b2f;
  --card: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.7);
  --accent:#569cff;
  --shadow: 0 20px 60px rgba(0,0,0,.45);
}
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:22px;
  background:
    radial-gradient(1200px 600px at 50% 20%, rgba(86,156,255,.25), transparent 60%),
    linear-gradient(180deg, var(--bg2), var(--bg1));
}
.card{
  width:min(520px, 100%);
  background: var(--card);
  border: 1px solid var(--stroke);
  border-radius: 22px;
  box-shadow: var(--shadow);
  padding: 22px;
  backdrop-filter: blur(10px);
}
.brand{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  margin-bottom: 16px;
  text-align:center;
}
.logo{
  width:68px;height:68px;
  border-radius:18px;
  display:grid; place-items:center;
  background: linear-gradient(135deg, rgba(86,156,255,.9), rgba(66,220,180,.8));
  box-shadow: 0 10px 25px rgba(0,0,0,.35);
  font-weight:900;
  font-size:22px;
}
h1{ margin:0; font-size:28px; letter-spacing:.2px; }
.sub{ margin:0; color:var(--muted); font-size:14px; }
.group{
  margin-top: 14px;
  padding: 16px;
  border-radius: 18px;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.12);
}
label{
  display:block;
  font-size:13px;
  color: var(--muted);
  margin-top: 10px;
}
input{
  width:100%;
  margin-top: 6px;
  padding: 14px 14px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(10,16,32,.55);
  color: var(--text);
  outline: none;
}
input:focus{
  border-color: rgba(86,156,255,.65);
  box-shadow: 0 0 0 4px rgba(86,156,255,.15);
}
.row{
  display:flex;
  gap:12px;
  margin-top: 16px;
}
.btn{
  width:100%;
  padding: 14px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.08);
  color: var(--text);
  font-weight: 700;
  cursor:pointer;
}
.btn.primary{
  background: var(--accent);
  border-color: rgba(86,156,255,.9);
}
.btn:disabled{ opacity:.6; cursor:not-allowed; }

.sep{
  display:flex;
  align-items:center;
  gap:10px;
  margin:14px 0 10px;
  color: rgba(234,240,255,.55);
  font-size:12px;
}
.sep::before,.sep::after{
  content:"";
  height:1px;
  flex:1;
  background: rgba(255,255,255,.10);
}

.btn.google{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  background: rgba(255,255,255,.10);
}
.gIcon{
  width:18px;height:18px;
  display:inline-block;
}

.small{
  margin-top: 10px;
  text-align:center;
  font-size: 12px;
  color: rgba(234,240,255,.6);
}
#debugBox{
  margin-top: 12px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.12);
  padding: 10px;
  border-radius: 14px;
  font-size: 12px;
  white-space: pre-wrap;
  display:none;
}
</style>
</head>

<body>

<div class="card">
  <div class="brand">
    <div class="logo">R$</div>
    <h1>Controle de Gastos PRO</h1>
    <p class="sub">Entre para acessar seu painel</p>
  </div>

  <div class="group">
    <label for="email">E-mail</label>
    <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email"/>

    <label for="senha">Senha</label>
    <input id="senha" type="password" placeholder="••••••••" autocomplete="current-password"/>

    <div class="row">
      <button class="btn primary" id="btnLoginEmail">Entrar</button>
      <button class="btn" id="btnCriarConta">Criar conta</button>
    </div>

    <div class="sep">ou</div>

    <!-- ✅ NOVO: Google -->
    <button class="btn google" id="btnGoogle">
      <svg class="gIcon" viewBox="0 0 48 48" aria-hidden="true">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.72 1.22 9.23 3.62l6.9-6.9C35.9 2.38 30.3 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.02 6.23C12.49 13.04 17.76 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.1 24.5c0-1.57-.14-3.08-.4-4.5H24v8.5h12.4c-.54 2.9-2.16 5.36-4.6 7.02l7.08 5.5C43.1 36.94 46.1 31.2 46.1 24.5z"/>
        <path fill="#FBBC05" d="M10.58 28.55a14.5 14.5 0 0 1 0-9.1l-8.02-6.23A23.97 23.97 0 0 0 0 24c0 3.87.92 7.54 2.56 10.78l8.02-6.23z"/>
        <path fill="#34A853" d="M24 48c6.3 0 11.6-2.08 15.47-5.64l-7.08-5.5c-1.96 1.32-4.47 2.1-8.39 2.1-6.24 0-11.51-3.54-13.42-8.95l-8.02 6.23C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      Entrar com Google
    </button>

    <div class="small">A senha deve ter pelo menos 6 caracteres.</div>
    <div id="debugBox"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyAlzYNuMGe1UZbgYjCDATv8ChO0ysrEPLE",
  authDomain:"controle-gastos-pro.firebaseapp.com",
  projectId:"controle-gastos-pro"
};

function dbg(msg){
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent = String(msg);
}

window.addEventListener("error", (e)=>{
  dbg("Erro JS:\n" + (e.message || e.type) + "\n" + (e.filename||"") + ":" + (e.lineno||"") + ":" + (e.colno||""));
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("Promise rejeitada:\n" + (e.reason && (e.reason.code || e.reason.message) ? (e.reason.code + " - " + e.reason.message) : String(e.reason)));
});

let auth = null;

function setLoading(isLoading){
  const b1 = document.getElementById("btnLoginEmail");
  const b2 = document.getElementById("btnCriarConta");
  const b3 = document.getElementById("btnGoogle");
  b1.disabled = b2.disabled = b3.disabled = isLoading;
}

async function initFirebase(){
  if(!window.firebase){
    dbg("Firebase não carregou (sem internet ou bloqueado).");
    return false;
  }

  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
  }catch(e){}

  auth = firebase.auth();

  // ✅ sessão persistente
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }catch(e){
    dbg("Persistência:\n" + (e.code||"") + " - " + (e.message||e));
  }

  return true;
}

function loginEmail(){
  const email = (document.getElementById("email").value||"").trim();
  const senha = (document.getElementById("senha").value||"").trim();
  if(!email || !senha){ alert("Preencha email e senha"); return; }

  setLoading(true);
  auth.signInWithEmailAndPassword(email, senha)
    .then(()=> location.replace("./index.html"))
    .catch(e=>{
      setLoading(false);
      alert((e.code||"") + " - " + e.message);
    });
}

function criarConta(){
  const email = (document.getElementById("email").value||"").trim();
  const senha = (document.getElementById("senha").value||"").trim();
  if(!email || !senha){ alert("Preencha email e senha"); return; }
  if(senha.length < 6){ alert("A senha deve ter pelo menos 6 caracteres"); return; }

  setLoading(true);
  auth.createUserWithEmailAndPassword(email, senha)
    .then(()=> location.replace("./index.html"))
    .catch(e=>{
      setLoading(false);
      alert((e.code||"") + " - " + e.message);
    });
}

// ✅ Google com seletor de conta
async function loginGoogle(){
  try{
    setLoading(true);

    const provider = new firebase.auth.GoogleAuthProvider();

    // força o “escolher conta” sempre
    provider.setCustomParameters({
      prompt: "select_account"
    });

    // em mobile, popup pode falhar -> fallback para redirect
    try{
      await auth.signInWithPopup(provider);
      location.replace("./index.html");
    }catch(e){
      // se o popup for bloqueado, usa redirect
      if(String(e.code||"").includes("popup") || String(e.message||"").toLowerCase().includes("popup")){
        await auth.signInWithRedirect(provider);
      }else{
        throw e;
      }
    }
  }catch(e){
    setLoading(false);
    alert((e.code||"") + " - " + e.message);
  }
}

document.addEventListener("DOMContentLoaded", async ()=>{
  const ok = await initFirebase();
  if(!ok) return;

  // ✅ se voltar de redirect do google
  try{
    const res = await auth.getRedirectResult();
    if(res && res.user){
      location.replace("./index.html");
      return;
    }
  }catch(e){
    // não bloqueia a tela
  }

  // ✅ se já estiver logado, entra direto
  auth.onAuthStateChanged((user)=>{
    if(user){
      location.replace("./index.html");
    }else{
      setLoading(false);
    }
  });

  document.getElementById("btnLoginEmail").addEventListener("click", loginEmail);
  document.getElementById("btnCriarConta").addEventListener("click", criarConta);
  document.getElementById("btnGoogle").addEventListener("click", loginGoogle);
});
</script>

</body>
</html>
